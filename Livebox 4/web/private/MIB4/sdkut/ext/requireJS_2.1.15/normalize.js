define(function(){var slashes=/([^:])\/+/g;var removeDoubleSlashes=function(uri){return uri.replace(slashes,"$1/")};var protocolRegEx=/[^\:\/]*:\/\/([^\/])*/;var absUrlRegEx=/^(\/|data:)/;function convertURIBase(uri,fromBase,toBase){if(uri.match(absUrlRegEx)||uri.match(protocolRegEx))return uri;uri=removeDoubleSlashes(uri);var toBaseProtocol=toBase.match(protocolRegEx);var fromBaseProtocol=fromBase.match(protocolRegEx);if(fromBaseProtocol&&(!toBaseProtocol||toBaseProtocol[1]!=fromBaseProtocol[1]||toBaseProtocol[2]!=fromBaseProtocol[2]))return absoluteURI(uri,fromBase);else{return relativeURI(absoluteURI(uri,fromBase),toBase)}}function absoluteURI(uri,base){if(uri.substr(0,2)=="./")uri=uri.substr(2);if(uri.match(absUrlRegEx)||uri.match(protocolRegEx))return uri;var baseParts=base.split("/");var uriParts=uri.split("/");baseParts.pop();while(curPart=uriParts.shift())if(curPart=="..")baseParts.pop();else baseParts.push(curPart);return baseParts.join("/")}function relativeURI(uri,base){var baseParts=base.split("/");baseParts.pop();base=baseParts.join("/")+"/";i=0;while(base.substr(i,1)==uri.substr(i,1))i++;while(base.substr(i,1)!="/")i--;base=base.substr(i+1);uri=uri.substr(i+1);baseParts=base.split("/");var uriParts=uri.split("/");out="";while(baseParts.shift())out+="../";while(curPart=uriParts.shift())out+=curPart+"/";return out.substr(0,out.length-1)}var normalizeCSS=function(source,fromBase,toBase){fromBase=removeDoubleSlashes(fromBase);toBase=removeDoubleSlashes(toBase);var urlRegEx=/@import\s*("([^"]*)"|'([^']*)')|url\s*\(\s*(\s*"([^"]*)"|'([^']*)'|[^\)]*\s*)\s*\)/gi;var result,url,source;while(result=urlRegEx.exec(source)){url=result[3]||result[2]||result[5]||result[6]||result[4];var newUrl;newUrl=convertURIBase(url,fromBase,toBase);var quoteLen=result[5]||result[6]?1:0;source=source.substr(0,urlRegEx.lastIndex-url.length-quoteLen-1)+newUrl+source.substr(urlRegEx.lastIndex-quoteLen-1);urlRegEx.lastIndex=urlRegEx.lastIndex+(newUrl.length-url.length)}return source};normalizeCSS.convertURIBase=convertURIBase;normalizeCSS.absoluteURI=absoluteURI;normalizeCSS.relativeURI=relativeURI;return normalizeCSS});