define(["utils/console","engine/callStack"],function(console,callStack){"use strict";var toHex=function(str){var i,hex;hex="";for(i=0;i<str.length;i+=1){hex+=""+str.charCodeAt(i).toString(16)}return hex},toStr=function(hex){var i,v,str;str="";for(i=0;i<hex.length;i+=2){v=parseInt(hex.substr(i,2),16);if(v){str+=String.fromCharCode(v)}}return str},generateAndCheckId=function(aLength){var attempt;function generateId(l){var result,charSet,i;result="";charSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(i=0;i<l;i+=1){result+=charSet.charAt(Math.floor(Math.random()*charSet.length))}return result}attempt=generateId(aLength);while(window.document.getElementById(attempt)){attempt=generateId(aLength)}return attempt};return{getMemoryState:{name:"Returns the memory state of the device",description:"This method returns the memory state of the local device.",fields:{uuid:null,nbStep:0,mxStep:0,status:0,data:{}},call:function(aStep,aResult){var result;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.data={flashTotalSize:256,ramTotalSize:64,ramFreeSize:48,ramUsage:40};this.fields.nbStep=0;this.fields.mxStep=0;this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Hardware.GetFlashSize","1",this);this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Hardware.GetSystemRamSize","2",this);this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Hardware.GetFreeSystemRamSize","3",this);this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Hardware.GetSystemRamUsage","4",this)}else{this.fields.nbStep+=1;switch(aStep){case"1":if(aResult.status===0){this.fields.data.flashTotalSize=parseInt(aResult.data.result,10)}else{callStack.logMessage("SEM_SYN_ERROR")}break;case"2":if(aResult.status===0){this.fields.data.ramTotalSize=parseInt(aResult.data.result,10)}else{callStack.logMessage("SEM_SYN_ERROR")}break;case"3":if(aResult.status===0){this.fields.data.ramFreeSize=parseInt(aResult.data.result,10)}else{callStack.logMessage("SEM_SYN_ERROR")}break;case"4":if(aResult.status===0){this.fields.data.ramUsage=parseInt(aResult.data.result,10)}else{callStack.logMessage("SEM_SYN_ERROR")}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},softReset:{name:"Performs a soft reset of the device",description:"This method performs a soft reset of the current device.",fields:{uuid:null,nbStep:0,mxStep:0,sessionTypeList:[],indSessionType:0,sessionType:"",sessionNameList:[],indSessionName:0,sessionName:"",status:0},call:function(aStep,aResult){var result;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;this.fields.indSessionType=0;this.fields.sessionTypeList=["LIVE","MEDIA","VOD","TUNE","HDD","REC"];this.fields.mxStep+=1;callStack.reCall(this,"1",0)}else{this.fields.nbStep+=1;switch(aStep){case"1":if(this.fields.indSessionType<this.fields.sessionTypeList.length){this.fields.sessionType=this.fields.sessionTypeList[this.fields.indSessionType];this.fields.indSessionType+=1;this.fields.mxStep+=1;callStack.push("api","com.softathome.Session.List","2",this,this.fields.sessionType)}break;case"2":if(aResult.status===0){if(aResult.data.result&&aResult.data.result.length>0&&aResult.data.result[0]){this.fields.sessionNameList=aResult.data.result;this.fields.indSessionName=0;this.fields.mxStep+=1;callStack.reCall(this,"3",0)}else{this.fields.mxStep+=1;callStack.reCall(this,"1",0)}}else{this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}break;case"3":if(!aResult||aResult.status===0){if(this.fields.indSessionName<this.fields.sessionNameList.length){this.fields.sessionName=this.fields.sessionNameList[this.fields.indSessionName];this.fields.indSessionName+=1;switch(this.fields.sessionType){case"LIVE":this.fields.mxStep+=1;callStack.push("api","com.softathome.Media.Player.Live.Common.GetState","4",this,this.fields.sessionName);break;case"HDD":this.fields.mxStep+=1;callStack.push("api","com.softathome.Media.Player.Playback.Control.GetState","4",this,this.fields.sessionName);break;case"MEDIA":this.fields.mxStep+=1;callStack.push("api","com.softathome.Media.Player.Resource.Common.GetState","4",this,this.fields.sessionName);break;case"VOD":this.fields.mxStep+=1;callStack.push("api","com.softathome.Media.Player.Vod.Common.GetState","4",this,this.fields.sessionName);break;case"REC":this.fields.mxStep+=1;callStack.push("api","com.softathome.Media.Recorder.Control.GetRecordState","4",this,this.fields.sessionName);break;case"TUNE":this.fields.mxStep+=1;callStack.push("api","com.softathome.Session.Delete","3",this,this.fields.sessionName);break;default:console.warn("Unexpected session type '"+this.fields.sessionType+'"');this.fields.mxStep+=1;callStack.reCall(this,"3",0);break}}else{this.fields.mxStep+=1;callStack.reCall(this,"1",0)}}else{this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}break;case"4":if(aResult.status===0||aResult.status===-999||aResult.status===-1005){switch(this.fields.sessionType){case"LIVE":if(aResult.status!==0||aResult.data.result!=="LIVE_STATE_STOP"){this.fields.mxStep+=1;callStack.push("api","com.softathome.Media.Player.Live.Control.Stop","5",this,this.fields.sessionName)}else{this.fields.mxStep+=1;callStack.push("api","com.softathome.Session.Delete","3",this,this.fields.sessionName)}break;case"HDD":if(aResult.status!==0||aResult.data.result!=="STOPPED"){this.fields.mxStep+=1;callStack.push("api","com.softathome.Media.Player.Playback.Control.Stop","5",this,this.fields.sessionName)}else{this.fields.mxStep+=1;callStack.push("api","com.softathome.Session.Delete","3",this,this.fields.sessionName)}break;case"MEDIA":if(aResult.status!==0||aResult.data.result!=="STOPPED"){this.fields.mxStep+=1;callStack.push("api","com.softathome.Media.Player.Resource.Common.Stop","5",this,this.fields.sessionName)}else{this.fields.mxStep+=1;callStack.push("api","com.softathome.Session.Delete","3",this,this.fields.sessionName)}break;case"VOD":if(aResult.status!==0||aResult.data.result!=="STOPPED"){this.fields.mxStep+=1;callStack.push("api","com.softathome.Media.Player.Vod.Common.Stop","5",this,this.fields.sessionName)}else{this.fields.mxStep+=1;callStack.push("api","com.softathome.Session.Delete","3",this,this.fields.sessionName)}break;case"REC":if(aResult.status!==0||aResult.data.result!=="STOPPED"){this.fields.mxStep+=1;callStack.push("api","com.softathome.Media.Recorder.Control.Stop","6",this,this.fields.sessionName)}else{this.fields.mxStep+=1;callStack.reCall(this,"3",0)}break;default:console.warn("Unexpected session type '"+this.fields.sessionType+'"');this.fields.mxStep+=1;callStack.reCall(this,"3",0);break}}else{this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}break;case"5":if(aResult.status!==0){callStack.logMessage("SEM_VALUE_WORK","No way to detect whether session is already stopped or not")}this.fields.mxStep+=1;callStack.push("api","com.softathome.Session.Delete","3",this,this.fields.sessionName);break;case"6":callStack.logMessage("SEM_VALUE_WORK","API com.softathome.Media.Recorder.Control.Stop considered as synchronous to avoid issues");callStack.logMessage("SEM_VALUE_WORK","No way to delete REC sessions");this.fields.mxStep+=1;callStack.reCall(this,"3",0);break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},hardReset:{name:"Performs a hard reset of the device",description:"This method performs a hard reset of the current device.",fields:{uuid:null,nbStep:0,mxStep:0,status:0},call:function(aStep,aResult){var result;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;this.fields.mxStep+=1;if(callStack.isOnHgw()){callStack.push("api","pcb.NMC.reset","1",this,{})}else{callStack.push("api","com.softathome.Config.Common.FactoryReset","1",this)}}else{this.fields.nbStep+=1;switch(aStep){case"1":if(!callStack.isOnHgw()){if(aResult.status!==0){this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},reboot:{name:"Reboots the device",description:"This method reboots the current device.",fields:{uuid:null,nbStep:0,mxStep:0,status:0},call:function(aStep,aResult){var result;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;this.fields.mxStep+=1;if(callStack.isOnHgw()){callStack.push("api","pcb.NMC.reboot","1",this,{})}else{callStack.push("api","com.softathome.System.Power.Reboot","1",this)}}else{this.fields.nbStep+=1;switch(aStep){case"1":if(!callStack.isOnHgw()){if(aResult.status!==0){this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},backupLocal:{name:"Requests and puts into a file a backup of the device",description:"This method requests and puts into a file a backup of the settings of the device.",fields:{uuid:null,nbStep:0,mxStep:0,status:0,initialParameters:{}},call:function(aStep,aResult){var result,par,req,iframe,tempId;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;this.fields.mxStep+=1;if(typeof aResult.inputList[0]!=="undefined"){this.fields.initialParameters=aResult.inputList[0]}else{this.fields.initialParameters=""}par=callStack.getRequest();if(window.navigator.userAgent.indexOf("Safari")!==-1&&window.navigator.userAgent.indexOf("Chrome")===-1){tempId=generateAndCheckId(8);iframe=window.document.createElement("iframe");iframe.id=tempId;if(par.proxyUrl===""){iframe.src="http://"+par.ip+"/backup?nocache&context="+par.contextId}else{iframe.src=par.proxyUrl+"?url="+encodeURIComponent("http://"+par.ip+"/backup?nocache&context="+par.contextId)}iframe.style.display="none";window.document.body.appendChild(iframe)}else{req=new XMLHttpRequest;if(par.proxyUrl===""){req.open("GET","http://"+par.ip+"/backup?nocache&context="+par.contextId,true)}else{req.open("GET",par.proxyUrl+"?url="+encodeURIComponent("http://"+par.ip+"/backup?nocache&context="+par.contextId),true)}req.onreadystatechange=function(){var windowUrl,tempId,blob,url,link,defaultFilename,disposition,filenameRegex=/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/,matches;if(req.readyState===4&&req.status===200){windowUrl=window.URL||window.webkitURL;tempId=generateAndCheckId(8);disposition=req.getResponseHeader("Content-Disposition");if(disposition&&disposition.indexOf("attachment")!==-1){matches=filenameRegex.exec(disposition);if(matches!==null&&matches[1]){defaultFilename=matches[1].replace(/['"]/g,"")}}if(typeof windowUrl.createObjectURL==="function"){if(window.navigator.appVersion.toString().indexOf(".NET")>0){blob=new Blob([req.responseText],{type:"application/octet-stream"});url=windowUrl.createObjectURL(blob);if(this.fields.initialParameters){if(typeof this.fields.initialParameters.filename==="string"){window.navigator.msSaveBlob(blob,this.fields.initialParameters.filename)}else{window.navigator.msSaveBlob(blob,defaultFilename)}}else{window.navigator.msSaveBlob(blob,defaultFilename)}}else{blob=new Blob([req.responseText],{type:"application/octet-stream"});url=windowUrl.createObjectURL(blob);link=window.document.createElement("a");link.setAttribute("href",url);link.setAttribute("id",tempId);if(this.fields.initialParameters){if(typeof this.fields.initialParameters.filename==="string"){link.setAttribute("download",this.fields.initialParameters.filename)}else{link.setAttribute("download",defaultFilename)}}else{link.setAttribute("download",defaultFilename)}link.setAttribute("style","display:none");window.document.body.appendChild(link);window.document.getElementById(tempId).click()}}else{console.log("error: html5 blob not supported")}}}.bind(this);req.send()}callStack.reCall(this,"1",0)}else{this.fields.nbStep+=1;switch(aStep){case"1":break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},restoreLocal:{name:"Restores a backup of the device",description:"This method requests a restore from a backup of the settings of the device",fields:{uuid:null,nbStep:0,mxStep:0,status:0,initialParameters:{}},call:function(aStep,aResult){var result,par,fileP,formData,req,iframeIndex;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;this.fields.mxStep+=1;this.fields.initialParameters=aResult.inputList[0];par=callStack.getRequest();if(typeof this.fields.initialParameters==="object"){if(typeof this.fields.initialParameters.fileInputId==="string"){if(window.document.getElementById(this.fields.initialParameters.fileInputId)){fileP=window.document.getElementById(this.fields.initialParameters.fileInputId).files[0]}else if(window.document.getElementsByTagName("iframe")){for(iframeIndex=0;window.document.getElementsByTagName("iframe").length;iframeIndex=iframeIndex+1){if(window.document.getElementsByTagName("iframe")[iframeIndex].contentWindow.document.getElementById(this.fields.initialParameters.fileInputId)){fileP=window.document.getElementsByTagName("iframe")[iframeIndex].contentWindow.document.getElementById(this.fields.initialParameters.fileInputId).files[0];break}}}else{this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}formData=new FormData;formData.append("restore",fileP);req=new XMLHttpRequest;if(par.proxyUrl===""){req.open("PUT","http://"+par.ip+"/restore",true)}else{req.open("PUT",par.proxyUrl+"?url="+encodeURIComponent("http://"+par.ip+"/restore"),true)}req.setRequestHeader("X-Context",par.contextId);req.onreadystatechange=function(){var tempId,target,myScript,i;if(req.readyState===4&&req.status===200){tempId=generateAndCheckId(8);target=window.document.createElement("div");target.setAttribute("id",tempId);target.setAttribute("style","display:none");window.document.body.appendChild(target);window.document.getElementById(tempId).innerHTML=req.responseText;myScript=window.document.getElementById(tempId).getElementsByTagName("script");for(i=0;i<myScript.length;i+=1){eval(myScript[i].innerHTML)}}};req.send(formData);callStack.reCall(this,"1",0)}else{this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}}else{this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}}else{this.fields.nbStep+=1;switch(aStep){case"1":break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},enableNetworkBR:{name:"enableNetworkBR",description:"enableNetworkBR",fields:{uuid:null,nbStep:0,mxStep:0,status:0,initialParameters:{}},call:function(aStep,aResult){var result,inputObj={state:true};if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;if(callStack.isOnHgw()){if(aResult.inputList[0]&&Object.typeOf(aResult.inputList[0].state)==="boolean"){this.fields.mxStep+=1;inputObj.state=aResult.inputList[0].state;callStack.push("api","pcb.NetworkConfig.enableNetworkBR","1",this,inputObj)}else{callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1}}}else{this.fields.nbStep+=1;switch(aStep){case"1":if(aResult.status!==0&&aResult.status!==true){callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if((this.fields.status===0||this.fields.status===true)&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},backupNetwork:{name:"backupNetwork",description:"backupNetwork",fields:{uuid:null,nbStep:0,mxStep:0,status:0,initialParameters:{}},call:function(aStep,aResult){var result,inputObj={delay:true};if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;if(callStack.isOnHgw()){if(aResult.inputList[0]&&Object.typeOf(aResult.inputList[0].activate)==="boolean"){this.fields.mxStep+=1;inputObj.delay=aResult.inputList[0].activate;callStack.push("api","pcb.NetworkConfig.launchNetworkBackup","1",this,inputObj)}else{callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1}}}else{this.fields.nbStep+=1;switch(aStep){case"1":if(aResult.status!==0&&aResult.status!==true){callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if((this.fields.status===0||this.fields.status===true)&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},restoreNetwork:{name:"restoreNetwork",description:"restoreNetwork",fields:{uuid:null,nbStep:0,mxStep:0,status:0,initialParameters:{}},call:function(aStep,aResult){var result;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;if(callStack.isOnHgw()){this.fields.mxStep+=1;callStack.push("api","pcb.NetworkConfig.launchNetworkRestore","1",this)}}else{this.fields.nbStep+=1;switch(aStep){case"1":if(aResult.status!==0&&aResult.status!==true){callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if((this.fields.status===0||this.fields.status===true)&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},getBackupAndRestoreNetworkState:{name:"getBackupAndRestoreNetworkState",description:"getBackupAndRestoreNetworkState",fields:{uuid:null,nbStep:0,mxStep:0,status:0,data:{Enable:true},initialParameters:{}},call:function(aStep,aResult){var result;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;if(callStack.isOnHgw()){this.fields.mxStep+=1;callStack.push("api","pcb.NetworkConfig.get","1",this)}}else{this.fields.nbStep+=1;switch(aStep){case"1":if(aResult.status!==0&&aResult.status!==true){callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}else{this.fields.data.state=aResult.data.Status;this.fields.data.lastBackupDate=aResult.data.ConfigDate;this.fields.data.Enable=aResult.data.Enable}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if((this.fields.status===0||this.fields.status===true)&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},cryptMessage:{name:"Crypts a message",description:"This method crypts a message based on a chosen crypting method.",fields:{uuid:null,nbStep:0,mxStep:0,status:0,data:null},call:function(aStep,aResult){var result,configObj;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;this.fields.data=null;configObj=aResult.inputList[0];if(configObj.method==="md5"){this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Cipher.MD5.ApplyOnMessage","1",this,{data:configObj.message})}else if(configObj.method==="sha256"){this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Cipher.SHA256.ApplyOnMessage","1",this,{data:configObj.message})}else if(configObj.method==="aes"){this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Cipher.AES.ApplyOnMessage","2",this,{key:configObj.aes.key,message:configObj.message,encryption:"ENCRYPT"})}else if(configObj.method==="des_cbc"||configObj.method==="des_ecb"){this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Cipher.TripleDES.ApplyOnMessage","2",this,{keys:{key1:configObj.des.key1,key2:configObj.des.key2,key3:configObj.des.key3},message:toHex(configObj.message),encryption:"ENCRYPT",mode:configObj.method==="des_cbc"?"CBC":"ECB"})}}else{this.fields.nbStep+=1;switch(aStep){case"1":if(aResult.status===0){this.fields.data={message:aResult.data.hash}}else{this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}break;case"2":if(aResult.status===0){this.fields.data={message:aResult.data.message}}else{this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},decryptMessage:{name:"Decrypts a message",description:"This method decrypts a message based on a chosen crypting method.",fields:{uuid:null,nbStep:0,mxStep:0,status:0,data:null},call:function(aStep,aResult){var result,configObj;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;this.fields.data=null;configObj=aResult.inputList[0];if(configObj.method==="aes"){this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Cipher.AES.ApplyOnMessage","1",this,{key:configObj.aes.key,message:configObj.message,encryption:"DECRYPT"})}else if(configObj.method==="des_cbc"||configObj.method==="des_ecb"){this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Cipher.TripleDES.ApplyOnMessage","2",this,{keys:{key1:configObj.des.key1,key2:configObj.des.key2,key3:configObj.des.key3},message:configObj.message,encryption:"DECRYPT",mode:configObj.method==="des_cbc"?"CBC":"ECB"})}}else{this.fields.nbStep+=1;switch(aStep){case"1":if(aResult.status===0){this.fields.data={message:aResult.data.message}}else{this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}break;case"2":if(aResult.status===0){this.fields.data={message:toStr(aResult.data.message)}}else{this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},getServicesState:{name:"Returns the service state of the device",description:"This method returns the service state of the local device.",fields:{uuid:null,nbStep:0,mxStep:0,status:false,data:{}},call:function(aStep,aResult){var result,par,req;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;this.fields.mxStep+=1;par=callStack.getRequest();req=new XMLHttpRequest;if(par.proxyUrl===""){req.open("PUT","http://"+par.ip+"/sysbus/DeviceInfo",true)}else{req.open("PUT",par.proxyUrl+"?url="+encodeURIComponent("http://"+par.ip+"/sysbus/DeviceInfo"),true)}req.onreadystatechange=function(){if(req.readyState===4&&req.status===200){this.fields.status=true}else{this.fields.status=false}}.bind(this);req.send();callStack.reCall(this,"1",2e3)}else{this.fields.nbStep+=1;switch(aStep){case"1":break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}}}});