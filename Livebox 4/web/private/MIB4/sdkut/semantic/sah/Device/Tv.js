define(["utils/console","engine/callStack"],function(console,callStack){"use strict";return{getServiceState:{name:"Returns a basic tv description",description:"This method returns a basic description of the tv.",fields:{uuid:null,nbStep:0,mxStep:0,status:0,data:{}},call:function(aStep,aResult){var result,indexVOD,indexZapping,indexMulticast,indexTV,flagsTab,indexFlag,service;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.data={};this.fields.data.serviceList=[];this.fields.nbStep=0;this.fields.mxStep=0;this.fields.mxStep+=1;callStack.push("api","pcb.NMC.getIPTVStatus","1",this)}else{this.fields.nbStep+=1;switch(aStep){case"1":if(aResult.status===true){this.fields.data.state=aResult.data.IPTVStatus!=="Unavailable";this.fields.mxStep+=1;callStack.push("api","pcb.NMC.getIPTVConfig","2",this)}else{this.fields.status=-1;this.fields.mxStep=-1;callStack.logMessage("SEM_SYN_ERROR")}break;case"2":if(aResult.status===0||aResult.status===true){indexVOD=1;indexZapping=1;indexMulticast=1;for(indexTV=0;indexTV<aResult.data.length;indexTV+=1){flagsTab=aResult.data[indexTV].ChannelFlags.split(" ");for(indexFlag=0;indexFlag<flagsTab.length;indexFlag+=1){service={};switch(flagsTab[indexFlag]){case"VOD":service.serviceId=flagsTab[indexFlag]+indexVOD;indexVOD+=1;break;case"Zapping":service.serviceId=flagsTab[indexFlag]+indexZapping;indexZapping+=1;break;case"Multicast":if(indexMulticast<3){service.serviceId=flagsTab[indexFlag]+indexMulticast;indexMulticast+=1}break}service.isEnabled=aResult.data[indexTV].ChannelStatus;service.vlan="";service.vpvc="";if(aResult.data[indexTV].ChannelType==="VPVC"){service.vpvc=aResult.data[indexTV].ChannelNumber}else{service.vlan=aResult.data[indexTV].ChannelNumber}this.fields.data.serviceList.push(service)}}}else{callStack.logMessage("SEM_SYN_ERROR")}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if((this.fields.status===0||this.fields.status===true)&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}}}});