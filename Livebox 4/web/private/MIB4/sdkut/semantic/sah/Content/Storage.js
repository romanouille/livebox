define(["utils/console","engine/callStack"],function(console,callStack){"use strict";return{getStoragePoints:{name:"Returns the RUI clients description",description:"This method returns the description of RUI clients.",fields:{uuid:null,nbStep:0,mxStep:0,indDevice:0,deviceList:null,indVolume:0,volumeList:null,status:0,data:{}},call:function(aStep,aResult){var result,indDevice,listDevice,deviceObj,volumeObj;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.data={physicalMediumList:[]};this.fields.nbStep=0;this.fields.mxStep=0;this.fields.mxStep+=1;if(callStack.isOnHgw()){callStack.push("api","pcb.DeviceManager.getUsbDevices","1",this)}else{callStack.push("api","com.softathome.System.Storage.Device.List","2",this)}}else{this.fields.nbStep+=1;switch(aStep){case"1":if(aResult.status===0||aResult.status===true){listDevice=aResult.data;this.fields.data.physicalMediumList=listDevice.length>0?[]:this.fields.data.physicalMediumList;for(indDevice=0;indDevice<listDevice.length;indDevice+=1){if(listDevice[indDevice].deviceSource==="storage"){deviceObj={};deviceObj.deviceType={};deviceObj.name=listDevice[indDevice].name;deviceObj.status=listDevice[indDevice].status;deviceObj.flags=listDevice[indDevice].flags;deviceObj.physicalReference=listDevice[indDevice].physicalReference;deviceObj.physicalURI=listDevice[indDevice].physicalURI;deviceObj.fileSystem=listDevice[indDevice].fileSystem;deviceObj.capacity=listDevice[indDevice].capacity;deviceObj.usedSpace=listDevice[indDevice].usedSpace;deviceObj.encrypted=listDevice[indDevice].encrypted;deviceObj.folderNumberOfEntries=listDevice[indDevice].folderNumberOfEntries;deviceObj.mountPoint=listDevice[indDevice].mountPoint;deviceObj.lastError=listDevice[indDevice].lastError;deviceObj.uri=listDevice[indDevice].uri;deviceObj.PhysicalMedium={};deviceObj.PhysicalMedium.name=listDevice[indDevice].PhysicalMedium.name;deviceObj.PhysicalMedium.vendor=listDevice[indDevice].PhysicalMedium.vendor;deviceObj.PhysicalMedium.serialNumber=listDevice[indDevice].PhysicalMedium.serialNumber;deviceObj.PhysicalMedium.firmwareVersion=listDevice[indDevice].PhysicalMedium.firmwareVersion;deviceObj.PhysicalMedium.connectionType=listDevice[indDevice].PhysicalMedium.connectionType;deviceObj.PhysicalMedium.removable=listDevice[indDevice].PhysicalMedium.removable;deviceObj.PhysicalMedium.capacity=listDevice[indDevice].PhysicalMedium.capacity;deviceObj.PhysicalMedium.status=listDevice[indDevice].PhysicalMedium.status;deviceObj.PhysicalMedium.uptime=listDevice[indDevice].PhysicalMedium.uptime;deviceObj.PhysicalMedium.smartcapable=listDevice[indDevice].PhysicalMedium.smartcapable;deviceObj.PhysicalMedium.health=listDevice[indDevice].PhysicalMedium.health;deviceObj.PhysicalMedium.hotSwappable=listDevice[indDevice].PhysicalMedium.hotSwappable;deviceObj.PhysicalMedium.uri=listDevice[indDevice].PhysicalMedium.uri;deviceObj.kernel={};deviceObj.kernel.uuid=listDevice[indDevice].Kernel.uuid;deviceObj.kernel.label=listDevice[indDevice].Kernel.label;deviceObj.CIFS={};deviceObj.CIFS.uri=listDevice[indDevice].CIFS.uri;deviceObj.CIFS.name=listDevice[indDevice].CIFS.name;deviceObj.deviceType=listDevice[indDevice].deviceType;deviceObj.deviceSource=listDevice[indDevice].deviceSource;deviceObj.deviceID=listDevice[indDevice].deviceID;this.fields.data.physicalMediumList.push(deviceObj)}}}else{callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break;case"2":if(aResult.status===0){this.fields.deviceList=aResult.data.device_list;if(this.fields.deviceList.length>0){this.fields.indDevice=0;this.fields.mxStep+=1;callStack.reCall(this,"3",0)}else{callStack.logMessage("SEM_VALUE_WORK","Unexpected empty list of devices");this.fields.mxStep=-1}}else{callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break;case"3":if(this.fields.indDevice<this.fields.deviceList.length){this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Storage.Device.GetInfo","4",this,{device_id:this.fields.deviceList[this.fields.indDevice]});this.fields.indDevice+=1}break;case"4":if(aResult.status===0){deviceObj={};deviceObj.name=aResult.data.name;deviceObj.vendor=aResult.data.vendor;deviceObj.model=aResult.data.model;deviceObj.serialNumber=aResult.data.serial_number;deviceObj.firmwareVersion="";deviceObj.removable=aResult.data.removable;deviceObj.capacity=0;deviceObj.status="Online";deviceObj.uptime=0;deviceObj.smartcapable=false;deviceObj.health="OK";deviceObj.hotSwappable=false;deviceObj.uri=aResult.data.device_id;deviceObj.logicalVolumeList=[];if(aResult.data.type==="1"){deviceObj.connectionType="HDD"}else if(aResult.data.type==="2"){deviceObj.connectionType="USB 2.0"}this.fields.data.physicalMediumList.push(deviceObj);this.fields.volumeList=aResult.data.volume_id;if(this.fields.volumeList.length>0){this.fields.indVolume=0;this.fields.mxStep+=1;callStack.reCall(this,"5",0)}}else{callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break;case"5":if(this.fields.indVolume<this.fields.volumeList.length){this.fields.mxStep+=1;callStack.push("api","com.softathome.System.Storage.Volume.GetInfo","6",this,{volume_id:this.fields.volumeList[this.fields.indVolume]});this.fields.indVolume+=1}else{this.fields.mxStep+=1;callStack.reCall(this,"3",0)}break;case"6":if(aResult.status===0){volumeObj={};volumeObj.name=aResult.data.name;volumeObj.status=aResult.data.mount_state?"Online":"Offline";volumeObj.enable=true;volumeObj.flags="";volumeObj.physicalReference="StorageService.PhysicalMedium."+aResult.data.device_id;volumeObj.physicalURI=aResult.data.device_id;volumeObj.fileSystem=aResult.data.fs;volumeObj.capacity=aResult.data.size;volumeObj.usedSpace=aResult.data.used_space;volumeObj.encrypted=false;volumeObj.folderNumberOfEntries=0;volumeObj.mountPoint=aResult.data.mount_path;volumeObj.lastError="";volumeObj.uri=aResult.data.volume_id;volumeObj.kernel={uuid:"E840-1B68",label:aResult.data.name};volumeObj.deviceType=["Storage"];volumeObj.deviceSource="storage";volumeObj.deviceID="storage_1";this.fields.data.physicalMediumList[this.fields.indDevice-1].logicalVolumeList.push(volumeObj);this.fields.mxStep+=1;callStack.reCall(this,"5",0)}else{callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},browseStorage:{name:"Browses an entry of a storage point",description:"This method browses storage content from a given entry identifier",fields:{uuid:null,nbStep:0,mxStep:0,path:"",uri:"",entry:{},entryList:[],odjContent:{},status:0,data:{}},call:function(aStep,aResult){var inputArg,result,indContent,listContent,entry;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;inputArg=aResult.inputList[0];this.fields.path=inputArg.path.lastIndexOf("/")!==inputArg.path.length-1?inputArg.path+"/":inputArg.path;if(callStack.isOnHgw()){this.fields.uri=inputArg.volumeId.toString()}this.fields.data={entryList:[]};this.fields.nbStep=0;this.fields.mxStep=0;this.fields.mxStep+=1;this.fields.entryList=[];if(callStack.isOnHgw()){callStack.push("api","pcb.StorageService.readDirectory","1",this,{path:this.fields.path,uri:this.fields.uri})}else{callStack.push("api","com.softathome.FS.Common.DirectoryContent","2",this,{directory:this.fields.path})}}else{this.fields.nbStep+=1;switch(aStep){case"1":if(aResult.status===0||aResult.status===true){listContent=aResult.data;this.fields.data.entryList=[];for(indContent=0;indContent<listContent.length;indContent+=1){this.fields.data.entryList.push(listContent[indContent])}}else{callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break;case"2":if(aResult.status===0){this.fields.entryList=aResult.data.list;this.fields.mxStep+=1;callStack.reCall(this,"3",0)}else{callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break;case"3":if(this.fields.entryList.length>0){entry=this.fields.entryList.pop();this.fields.entry={type:"",name:entry,size:0,created:"",modified:""};this.fields.mxStep+=1;callStack.push("api","com.softathome.FS.Info.GetPathType","4",this,this.fields.path+entry)}break;case"4":if(aResult.status===0){if(aResult.data.result==="FILE"){this.fields.entry.type="file"}else if(aResult.data.result==="DIR"){this.fields.entry.type="directory"}else{this.fields.entry.type="invalid"}if(this.fields.entry.type==="FILE"){this.fields.mxStep+=1;callStack.push("api","com.softathome.FS.Info.GetFileSize","5",this,this.fields.path+this.fields.entry.name)}else{this.fields.entry.size=0;this.fields.mxStep+=1;callStack.push("api","com.softathome.FS.Info.GetLastModificationDate","6",this,this.fields.path+this.fields.entry.name)}}else{callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break;case"5":if(aResult.status===0){this.fields.entry.size=parseInt(aResult.data.result,10);this.fields.mxStep+=1;callStack.push("api","com.softathome.FS.Info.GetLastModificationDate","6",this,this.fields.path+this.fields.entry.name)}else{callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break;case"6":if(aResult.status===0){this.fields.entry.creationDate=aResult.data.result;this.fields.entry.modificationDate=aResult.data.result;this.fields.data.entryList.push(this.fields.entry);this.fields.mxStep+=1;callStack.reCall(this,"3",0)}else{callStack.logMessage("SEM_SYN_ERROR");this.fields.status=-1;this.fields.mxStep=-1}break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}},getFileProperties:{name:"Retrieves properties of a file",description:"This method returns the properties of a file.",fields:{uuid:null,nbStep:0,mxStep:0,filePath:"",status:0,data:{}},call:function(aStep,aResult){var result;if(aStep==="0"){this.fields.uuid=aResult.uuid;this.fields.status=0;this.fields.nbStep=0;this.fields.mxStep=0;this.fields.filePath=aResult.inputList[0];this.fields.data={type:"invalid",name:this.fields.filePath.substr(this.fields.filePath.lastIndexOf("/")+1,this.fields.filePath.length-this.fields.filePath.lastIndexOf("/")),size:-1,created:"",modified:""};this.fields.mxStep+=1;callStack.push("api","com.softathome.FS.Info.GetPathType","1",this,this.fields.filePath);callStack.logMessage("SEM_MISSING_API","Missing API com.softathome.FS.Info.GetCreationDate")}else{this.fields.nbStep+=1;switch(aStep){case"1":if(aResult.status===0){if(aResult.data.result==="FILE"){this.fields.data.type="file"}else if(aResult.data.result==="DIR"){this.fields.data.type="directory"}else{this.fields.data.type="invalid"}if(this.fields.data.type!=="invalid"){this.fields.mxStep+=1;callStack.push("api","com.softathome.FS.Info.GetFileSize","2",this,this.fields.filePath);this.fields.mxStep+=1;callStack.push("api","com.softathome.FS.Info.GetLastModificationDate","3",this,this.fields.filePath)}else{this.fields.mxStep=-1;this.fields.status=0}}else{this.fields.mxStep=-1;this.fields.status=-1;callStack.logMessage("SEM_SYN_ERROR")}break;case"2":if(aResult.status===0){this.fields.data.size=aResult.data.result}else{this.fields.data.size=-1;callStack.logMessage("SEM_SYN_ERROR")}break;case"3":if(aResult.status===0){this.fields.data.modified=aResult.data.result}else{this.fields.data.modified="";callStack.logMessage("SEM_SYN_ERROR")}break;default:console.warn("Unexpected step '"+aStep+"' in call stack");this.fields.nbStep-=1;break}}if(this.fields.nbStep>=this.fields.mxStep){result={status:this.fields.status};if(this.fields.status===0&&this.fields.data){result.data=this.fields.data}callStack.popAll("api",result,this.fields.uuid)}}}}});