define(["external/rsvp/rsvp","utils/compatibility","utils/basics","json!engine/config/sdkutConfig.json","engine/sopws","engine/eventHandler","engine/cache","engine/statProcessor","json!engine/errorCodes.json","utils/console","json!engine/config/projConfig.json","json!engine/config/capabilities.json","engine/callPool","json!engine/config/emulated.json"],function(RSVP,compatibility,basicUtilities,sdkutConfig,SOPWS,eventHandler,cache,statProcessor,errorCodes,console,projConf,stackCapabilities,theStack,emulatedApis){"use strict";var currState={},aCallStackLog=[],aIsOnHgw=false,aIsOnStb=false,aFunCallStack={},aConfig={},aReporter=null,env_id=null,logLevel="E_ALL",aIsOnRemote=false,aUseApplicationMode=false,stackConf={},consoleCallback=null,progressBarCallback=null,dim_errors={},dim_err_uuids=[],do_compact_errors=false,dim_unprocessed={},aNbExecSuites=0,aNbSuitesOK=0,aNbSuitesSkipped=0,aNbSuitesNOK=0,aNbTotalSuites=1,aLastSuiteExecuted="",aLastSuiteResult="OK",aNbFuncOK=0,aNbFuncSkip=0,aNbFuncNok=0,aNbFuncTotal=0,optimizer={previous:"",current:"",next:""},aReportTree=[],aGetPuuid=function(aStackObj){if(aStackObj.handler&&aStackObj.handler.fields&&aStackObj.handler.fields.uuid){return aStackObj.handler.fields.uuid}return 0},aIsEmulated=function(aMode,aApiName){if(aMode==="api"){return sdkutConfig.useApiSimulationMode||emulatedApis.api.indexOf(aApiName)>=0}return sdkutConfig.useSemanticSimulationMode||emulatedApis.semantic.indexOf(aApiName)>=0},aGetCurrState=function(){if(!consoleCallback){return}if(currState.error||currState.path){consoleCallback.call(this,currState)}},aPushLogTrace=function(logTrace){var i,ok_nok_ne=logTrace.hasError?"NOK":"OK",report_stack,resultat;if(logTrace.ErrorCode==="SKIPPED"){ok_nok_ne="NE"}if(logTrace.type==="functional"&&aFunCallStack.hasOwnProperty(logTrace.name)===false){aFunCallStack[logTrace.name]=ok_nok_ne;aNbFuncTotal+=1;switch(ok_nok_ne){case"OK":aNbFuncOK+=1;break;case"NOK":aNbFuncNok+=1;break;case"NE":aNbFuncSkip+=1;break;default:break}if(progressBarCallback){progressBarCallback.call(this,{type:"functional",total:aNbFuncTotal,nbOk:aNbFuncOK,nbSkip:aNbFuncSkip,nbNok:aNbFuncNok,lastExec:"",lastRes:""})}}aCallStackLog.push(logTrace);if(sdkutConfig.useValidationMode&&env_id!==null&&!sdkutConfig.useApiSimulationMode&&!sdkutConfig.useSemanticSimulationMode){report_stack=[];for(i=0;i<aCallStackLog.length;i+=1){report_stack.push(aCallStackLog[i].type+":"+aCallStackLog[i].name)}console.debug("{Reporting callstack} : "+report_stack.join("\n                     -> "));report_stack=[];resultat=SOPWS.directPostSynchronous(JSON.stringify(aCallStackLog),aReporter+"?_action=addTest")}aCallStackLog=[];return true},aGenerateLog=function(aStackObj,aConstant,aMessage,aResult){var undef,aLevel=3,logTrace,logMessage,date;if(aUseApplicationMode){return}if(!aStackObj){aStackObj=theStack.getLast();if(aStackObj===null){console.error("CallStack/CallPool: stack empty, complete log cannot be generated. Error code: "+aConstant+", Message: "+aMessage);return}aStackObj.hasError=false}if(aMessage===undef&&errorCodes[aConstant]!==undef){aMessage=errorCodes[aConstant].message}if(aConstant===undef){aConstant="GENERIC"}if(errorCodes[aConstant]!==undef){if(errorCodes[aConstant].type==="ERROR"){aLevel=1;if(aStackObj){aStackObj.hasError=true}}else if(errorCodes[aConstant].type==="WARNING"){aLevel=2}}else{console.error("Unmapped error code <"+aConstant+">")}if(dim_errors[aConstant]===undef){dim_errors[aConstant]=0}dim_errors[aConstant]+=1;if(aConstant.indexOf("WORK")>=0){aLevel=-1}if(aStackObj!==undef){if(do_compact_errors&&aStackObj.details&&(aStackObj.details.uuid&&errorCodes[aConstant]!==undef)&&errorCodes[aConstant].type==="ERROR"){if(dim_err_uuids.indexOf(aStackObj.details.uuid)<0){dim_err_uuids.push(aStackObj.details.uuid)}else{if(aConstant.indexOf("_NOK")>=0){console.info("log ",aConstant," from ",aStackObj.identifier," IGNORED. UUID=",aStackObj.details.uuid);return}}}date=new Date;logTrace={envid:env_id,type:aStackObj.type,name:aStackObj.name,parameters:aStackObj.parameters!==undef?aStackObj.parameters:{},result:aStackObj.type==="api"?aStackObj.apiResult:aResult,ErrorCode:aConstant,description:aMessage,duration:aStackObj.delay?date.getTime()-aStackObj.delay:-1,hasError:aStackObj.hasError,uuid:aStackObj.details.uuid,puuid:aGetPuuid(aStackObj)};aPushLogTrace(logTrace);if(logTrace.result===undef){logTrace.result="null"}logTrace.parameters=JSON.stringify(logTrace.parameters);logTrace.result=typeof logTrace.result==="object"?JSON.stringify(logTrace.result):logTrace.result.toString();if(aStackObj.hasError===false&&aNbTotalSuites>100){logTrace.parameters=logTrace.parameters.substr(0,100);logTrace.result=logTrace.result.substr(0,100)}logMessage="{"+aConstant+"} "+(logTrace.description||"")+"\n    name: "+logTrace.name+"\n    parameters: "+JSON.stringify(logTrace.parameters)+"\n    result: "+JSON.stringify(logTrace.result)+"\n    (duration: "+logTrace.duration+"ms, level: "+logTrace.type+", envId: "+logTrace.envid+", uuid: "+logTrace.uuid+", puuid: "+logTrace.puuid;if(aLevel===-1){console.warn(logMessage)}else if(aLevel===1){console.error(logMessage)}else if(aLevel===2){console.info(logMessage)}else{console.log(logMessage)}if(theStack.size(aStackObj.handler.stackId)===1){currState.log=logTrace;currState.path=logTrace.name;aGetCurrState()}if(!aIsOnStb&&(sdkutConfig.useValidationMode&&env_id!==null)===false){delete logTrace.env_id;delete logTrace.hasError;aReportTree.push(logTrace)}}else{if(aLevel===-1){console.warn(aMessage)}else if(aLevel===1){console.error(aMessage)}else if(aLevel===2){console.info(aMessage)}else{console.log(aMessage)}}},aFakeLog=function(aType,aNameTab,aUuid){var indName,logTrace,aLevel=2,len=aNameTab.length,logMessage;if(aUseApplicationMode){return}for(indName=0;indName<len;indName+=1){if(aFunCallStack.hasOwnProperty(aNameTab[indName])===false){logTrace={envid:env_id,type:aType,name:aNameTab[indName],parameters:{},result:null,ErrorCode:"SKIPPED",description:"Function not called due to previous errors",duration:0,hasError:true,uuid:basicUtilities.generateUUID(),puuid:aUuid};aPushLogTrace(logTrace);logMessage="{SKIPPED} "+(logTrace.description||"")+"\n    name: "+logTrace.name+"\n    (level: "+logTrace.type+", envId: "+logTrace.envid+", uuid: "+logTrace.uuid+", puuid: "+logTrace.puuid;if(aLevel===1){console.error(logMessage)}else if(aLevel===2){console.info(logMessage)}else{console.log(logMessage)}if(!aIsOnStb&&(sdkutConfig.useValidationMode&&env_id!==null)===false){delete logTrace.env_id;delete logTrace.hasError;aReportTree.push(logTrace)}}}},aSetLogLevel=function(){if(logLevel.indexOf("E_ALL")>=0){return}if(logLevel.indexOf("E_NONE")>=0){console.log=function(){return};console.debug=function(){return};console.info=function(){return};console.warn=function(){return};console.error=function(){return};return}if(logLevel.indexOf("E_ERROR")<0){console.error=function(){return}}if(logLevel.indexOf("E_WARN")<0){console.warn=function(){return}}if(logLevel.indexOf("E_INFO")<0){console.info=function(){return}}if(logLevel.indexOf("E_DEBUG")<0&&logLevel.indexOf("E_LOG")<0){console.log=function(){return};console.log=function(){return}}return},aReportSuiteProgress=function(){if(progressBarCallback){progressBarCallback.call(this,{type:"suite",total:aNbTotalSuites,nbOk:aNbSuitesOK,nbSkip:aNbSuitesSkipped,nbNok:aNbSuitesNOK,lastExec:aLastSuiteExecuted,lastRes:aLastSuiteResult})}},aReportErrors=function(){var nb_total=0,err_code,msg_final,lost_uuid,nb_ok=0,nb_nok=0,nb_ne=0,elt;for(err_code in dim_errors){if(dim_errors.hasOwnProperty(err_code)){if(errorCodes[err_code]){if(errorCodes[err_code].type!=="WARNING"){nb_total+=dim_errors[err_code]}else if(errorCodes[err_code].type==="SUCCESS"){nb_ok+=dim_errors[err_code]}}}}msg_final=JSON.stringify(dim_errors).replace(/,/g,",\n")+"\n"+"TOTAL TESTS: "+nb_total+". OK: "+nb_ok+", NOK:"+(nb_total-nb_ok)+"\nCallStack Log length="+aCallStackLog.length;if(Object.keys(dim_unprocessed).length>0){msg_final+="\n\nUNPROCESSED : "+Object.keys(dim_unprocessed).length+" calls";for(lost_uuid in dim_unprocessed){if(dim_unprocessed.hasOwnProperty(lost_uuid)){msg_final+="\n - "+dim_unprocessed[lost_uuid].identifier}}}msg_final+="\n---------\nFUNCTIONAL TESTS\n";for(elt in aFunCallStack){if(aFunCallStack.hasOwnProperty(elt)){if(aFunCallStack[elt]==="OK"){nb_ok+=1}else if(aFunCallStack[elt]==="NOK"){nb_nok+=1}else if(aFunCallStack[elt]==="NE"){nb_ne+=1}}}msg_final+="  OK  : "+nb_ok+"\n  NOK : "+nb_nok+"\n  SKIP: "+nb_ne+"\n-------------\nTOTAL : "+(nb_ok+nb_nok+nb_ne);console.info(msg_final)},aSetConsoleOutput=function(aCallback){consoleCallback=aCallback},aSetProgressBarCallback=function(aCallback){progressBarCallback=aCallback},aLogMessage=function(aConstant,aMessage,aStackObj){aGenerateLog(aStackObj,aConstant,aMessage)},aLogErrorMessage=function(aConstant,aMessage,aStackId,aUuid){var aStackObj=theStack.getByIdInStack(aUuid,aStackId);aLogMessage(aConstant,aMessage,aStackObj)},aCheckObjectFormat=function(aCurrentResult,aExpectedResult,optionalFields){var type,param,field,result,i,aType;for(param in aExpectedResult){if(aExpectedResult.hasOwnProperty(param)){type="undefined";if(param==="*"){for(field in aCurrentResult){if(aCurrentResult.hasOwnProperty(field)){result=aCheckObjectFormat(aCurrentResult[field],aExpectedResult[param],optionalFields);if(!result){return result}}}}else if(aIsOnHgw&&Array.isArray(aExpectedResult[param])&&aCurrentResult.hasOwnProperty(param)){if(typeof aExpectedResult[param][0]==="string"){aType=aExpectedResult[param][0].substr(1,aExpectedResult[param][0].length-2);result=true;for(i=0;i<aCurrentResult[param].length;i+=1){if(typeof aCurrentResult[param][i]!==aType){result=false}}return result}for(i=0;i<aCurrentResult[param].length;i+=1){result=aCheckObjectFormat(aCurrentResult[param][i],aExpectedResult[param][0],optionalFields);if(!result){return result}}}else{if(optionalFields.indexOf(param)<0&&typeof aCurrentResult[param]==="undefined"){aLogMessage("SYN_OBJECT_FIELD","Mandatory field '"+param+"' not found in "+JSON.stringify(aCurrentResult));return false}switch(aExpectedResult[param]){case"[int]":type="number";break;case"[string]":type="string";break;case"[boolean]":case"[bool]":type="boolean";break;default:type="object";break}if(optionalFields.indexOf(param)<0&&typeof aCurrentResult[param]!==type){aLogMessage("SYN_OBJECT_TYPE",errorCodes.SYN_OBJECT_TYPE.message+" ("+param+")");return false}if(Object.typeOf(aCurrentResult[param])==="object"){result=aCheckObjectFormat(aCurrentResult[param],aExpectedResult[param],optionalFields);if(!result){return result}}}}}return true},aCheckResultStatus=function(aDetails,aStatus){var status,message="",indStatus;if(typeof aStatus!=="boolean"){switch(parseInt(aStatus,10)){case-995:case-996:case-997:case-999:status=-1;break;case-998:status=-4;break;default:status=parseInt(aStatus,10);break}}else{status=aStatus?0:-1}for(indStatus=0;indStatus<aDetails.possibleStatus.length;indStatus+=1){if(typeof aStatus==="boolean"){if(aStatus===aDetails.possibleStatus[indStatus]){break}}else{if(status===parseInt(aDetails.possibleStatus[indStatus],10)){break}}}if(typeof aStatus==="boolean"){if(status===-1){message="method returned FALSE"}}else{switch(parseInt(aStatus,10)){case-995:message="Gbus error "+-995+": Programming error";break;case-996:message="Gbus error "+-996+": Method reply does not match";break;case-997:message="Gbus error "+-997+": Bus error";break;case-998:message="Gbus error "+-998+": Invalid arguments";break;case-999:message="Gbus error "+-999+": Unknown method";break;default:if(indStatus>=aDetails.possibleStatus.length&&aDetails.possibleStatus.length>0){message="Unexpected status error code '"+aStatus+"' compared to possible status ["+aDetails.possibleStatus.join(",")+"]"}break}}if(message.length>0){aLogMessage("SYN_STATUS_CODE",message)}if(indStatus>=aDetails.possibleStatus.length&&aDetails.possibleStatus.length>0){return false}return true},aCheckApiFormat=function(aStackObj){var undef,result,intd,ii,indValues,api_status;if(aIsOnHgw){if(aStackObj.apiResult.result!==undef){aStackObj.apiResult=aStackObj.apiResult.result}if(aStackObj.apiResult.data===undef&&aStackObj.apiResult.status!==undef){if(aStackObj.apiResult.errors!==undef){aStackObj.apiResult.status=-1;aStackObj.apiResult.data=aStackObj.apiResult.errors}else if(aStackObj.apiResult.status===false){aStackObj.apiResult.data=aStackObj.apiResult.status}else{aStackObj.apiResult.data=aStackObj.apiResult.status;aStackObj.apiResult.status=true}}if(aStackObj.apiResult.data===undef){aStackObj.apiResult.data={}}if(aStackObj.apiResult.status===undef||aStackObj.apiResult.status===null){aStackObj.apiResult.status=true}}result=aStackObj.apiResult;if(aStackObj.details.type==="string"&&aStackObj.format==="statusOnly"&&aStackObj.apiResult.status!==undef){intd=parseInt(aStackObj.apiResult.status,10);if(intd>0){intd=-intd}aStackObj.apiResult={status:intd,data:null};if(result.data&&result.data.length>0){aLogMessage("SYN_STRING_FORMAT",errorCodes.SYN_STRING_FORMAT.message+" (statusOnly API containing data)",aStackObj)}}if(!aIsOnHgw&&!aIsOnStb){if(aStackObj.apiResult.status!==undef&&aStackObj.apiResult.status!==null&&(aStackObj.details.type!=="string"&&aStackObj.format!=="statusOnly")){if(typeof aStackObj.apiResult.status==="number"){intd=parseInt(aStackObj.apiResult.status,10);aStackObj.apiResult.status=intd}}if(aStackObj.apiResult.data!==undef&&aStackObj.apiResult.data!==null&&aStackObj.apiResult.data.result!==undef){intd=aStackObj.apiResult.data.result;aStackObj.apiResult.data=intd}}if(aIsOnHgw){if(aStackObj.format==="dataOnly"){aStackObj.apiResult={status:0,data:aStackObj.apiResult.status}}else{if(aStackObj.apiResult.status!==undef){if(aStackObj.apiResult.status===null){aStackObj.apiResult.status=-1}}}}if((aIsOnStb||aIsEmulated("api",aStackObj.name))&&typeof result==="string"){if(aStackObj.format==="statusAndData"&&result.indexOf(",")>=0){intd=result.split(",");api_status=parseInt(intd[0],10);if(api_status>0){api_status=-api_status}aStackObj.apiResult={status:api_status,data:intd.slice(1,intd.length).join(",")}}else if(aStackObj.format==="statusAndData"&&result.indexOf(",")<0){api_status=parseInt(result,10);if(api_status>0){api_status=-api_status}aStackObj.apiResult={status:api_status,data:null}}else{aStackObj.apiResult={status:0,data:result}}}if(aStackObj.format!=="dataOnly"||aStackObj.format==="statusOrData"&&aStackObj.apiResult.status!==undef){if(!aCheckResultStatus(aStackObj.details,aStackObj.apiResult.status)){return aStackObj.apiResult}}if(typeof aStackObj.apiResult!=="object"&&aStackObj.apiResult.status===0&&aStackObj.details.type==="object"&&aStackObj.format!=="statusOnly"&&aStackObj.format!=="statusOrData"){aLogMessage("SYN_OBJECT_FORMAT",errorCodes.SYN_STRING_FORMAT.message+" (malformed object)",aStackObj);aStackObj.apiResult.status=-1;return aStackObj.apiResult}if(typeof aStackObj.apiResult.data!=="string"&&aStackObj.apiResult.status===0&&aStackObj.details.type==="string"&&aStackObj.format!=="statusOnly"&&aStackObj.format!=="statusOrData"){aLogMessage("SYN_STRING_FORMAT",errorCodes.SYN_STRING_FORMAT.message+" (malformed string)",aStackObj);aStackObj.apiResult.status=-1;return aStackObj.apiResult}if(aStackObj.apiResult.status!==undef&&aStackObj.apiResult.status!==0&&!aIsOnHgw){if(aStackObj.details.type==="string"){return{status:aStackObj.apiResult.status,data:{result:aStackObj.apiResult.data}}}return aStackObj.apiResult}switch(aStackObj.details.type){case"object":if(typeof aStackObj.apiResult.status!=="number"&&typeof aStackObj.apiResult.status!=="boolean"&&!aIsOnHgw){aLogMessage("SYN_OBJECT_STATUS",errorCodes.SYN_OBJECT_STATUS.message+" "+JSON.stringify(aStackObj.apiResult),aStackObj);aStackObj.apiResult.status=-1;break}if(!aCheckObjectFormat(aStackObj.apiResult,JSON.parse(aStackObj.details.resourceDescription.output.objectFormat),aStackObj.details.resourceDescription.output.optionalFields)){aStackObj.apiResult.status=-1;break}if(aStackObj.apiResult.data===undef){aStackObj.apiResult.data=null}result=aStackObj.apiResult;break;case"string":if(aStackObj.apiResult.data&&aStackObj.apiResult.data.length<=0){aLogMessage("SYN_STRING_FORMAT",errorCodes.SYN_STRING_FORMAT.message+" (empty string result)",aStackObj);aStackObj.apiResult.status=-1;break}if(aStackObj.details.resourceDescription.output.listDelimiter&&aStackObj.apiResult.data!==undef){if(aStackObj.apiResult.data){intd=aStackObj.apiResult.data.split(aStackObj.details.resourceDescription.output.listDelimiter);aStackObj.apiResult.data=intd}else{aStackObj.apiResult.data=[]}if(aStackObj.details.resourceDescription.output.listMinimumSize>0&&aStackObj.apiResult.data.length<aStackObj.details.resourceDescription.output.listMinimumSize){aLogMessage("SYN_NB_VALUES",errorCodes.SYN_NB_VALUES.message+" ("+aStackObj.apiResult.data.length+" while expected at least "+aStackObj.details.resourceDescription.output.listMinimumSize+")",aStackObj);aStackObj.apiResult.status=-1;break}}if(aStackObj.details.resourceDescription.output.outputPossibleValuesList&&aStackObj.details.resourceDescription.output.outputPossibleValuesList.length>0&&aStackObj.format!=="statusOnly"){intd=aStackObj.details.resourceDescription.output.outputPossibleValuesList;if(Array.isArray(aStackObj.apiResult.data)){for(indValues=0;indValues<intd.length;indValues+=1){if(aStackObj.apiResult.data[indValues]){if(intd[indValues].outputPossibleValuesTab&&intd[indValues].outputPossibleValuesTab.outputPossibleValues&&intd[indValues].outputPossibleValuesTab.outputPossibleValues.length>0){for(ii=0;ii<intd[indValues].outputPossibleValuesTab.outputPossibleValues.length;ii+=1){if(aStackObj.apiResult.data[indValues]===intd[indValues].outputPossibleValuesTab.outputPossibleValues[ii].possibleValues){break}}if(ii>=intd[indValues].outputPossibleValuesTab.outputPossibleValues.length){aLogMessage("SYN_VALUE_RANGE",errorCodes.SYN_VALUE_RANGE.message+" ("+aStackObj.apiResult.data[indValues]+" out of range ["+intd[indValues].outputPossibleValuesTab.outputPossibleValues.join(",")+"])",aStackObj);aStackObj.apiResult.status=-1}}}}}else{if(intd[0].outputPossibleValuesTab&&intd[0].outputPossibleValuesTab.outputPossibleValues&&intd[0].outputPossibleValuesTab.outputPossibleValues.length>0){for(indValues=0;indValues<intd[0].outputPossibleValuesTab.outputPossibleValues.length;indValues+=1){if(aStackObj.apiResult.data===intd[0].outputPossibleValuesTab.outputPossibleValues[indValues].possibleValues){break}}if(indValues>=intd[0].outputPossibleValuesTab.outputPossibleValues.length){aLogMessage("SYN_VALUE_RANGE",errorCodes.SYN_VALUE_RANGE.message+" ("+aStackObj.apiResult.data+" out of range ["+intd[0].outputPossibleValuesTab.outputPossibleValues.join(",")+"])",aStackObj);aStackObj.apiResult.status=-1}}}}result={status:aStackObj.apiResult.status,data:{result:aStackObj.apiResult.data,error:aStackObj.apiResult.errors}};break;default:aLogMessage("GENERIC","Unhandled outputDataType ("+aStackObj.details.type+")",aStackObj);return aStackObj.apiResult}return result},aCheckApiResult=function(aStackObj){var undef,format,intd,api_status,original_api_type,original_api_format,checkedResult;original_api_type=aStackObj.details.type=aStackObj.details.resourceDescription.output.outputDataType;original_api_format=aStackObj.details.resourceDescription.output.globalFormat;if(aStackObj.details.type===undef){console.error("Invalid API description: <"+aStackObj.identifier+"> (resourceDescription.output.outputDataType is mandatory)");return aStackObj.apiResult}if(aStackObj.details.type==="object"){aStackObj.format="statusAndData"}else{format=aStackObj.details.resourceDescription.output.globalFormat;if(format==="dataString"){try{original_api_format="dataString";aStackObj.details.type="object";aStackObj.format=format="object";aStackObj.apiResult={status:aStackObj.apiResult===""?-1:0,data:JSON.parse(aStackObj.apiResult)};aStackObj.details.possibleStatus=aStackObj.details.resourceDescription.output.possibleStatusTab.statusList;original_api_type=aStackObj.details.resourceDescription.output.objectFormat;aStackObj.details.resourceDescription.output.objectFormat='{"status":"[int]", "data":{'+aStackObj.details.resourceDescription.output.objectFormat+"}";checkedResult=aCheckApiFormat(aStackObj);aStackObj.details.resourceDescription.output.objectFormat=original_api_type;return checkedResult}catch(e){aStackObj.details.resourceDescription.output.globalFormat=original_api_format;aStackObj.details.resourceDescription.output.outputDataType=original_api_type;console.error("CallStack: invalid API return. Type: dataString. The returned string cannot be parsed into a valid JSON: "+aStackObj.apiResult);return aStackObj.apiResult}}if(window.navigator.userAgent.toLowerCase().indexOf("qtrabrowser")>=0){if(format==="statusOrData"||format==="dataOnly"){if(format==="dataOnly"){console.warn("CallStack: Enforcing format of the API result '"+aStackObj.apiResult+"' from 'dataOnly' to 'statusAndData' for SOP Browser 2 compatibility");intd=aStackObj.apiResult.split(",");if(intd.length===1){console.warn("CallStack: Assuming SOP Browser 2 is used without the support for the new API format");aStackObj.apiResult="0,"+aStackObj.apiResult}format="statusAndData"}if(format==="statusOrData"){intd=aStackObj.apiResult.split(",");if(intd.length>1){api_status=parseInt(intd[1],10)}else{api_status=parseInt(aStackObj.apiResult,10)}if(api_status!==0&&api_status<15){console.warn("CallStack: Enforcing format of the API result '"+aStackObj.apiResult+"' from 'statusOrData' to 'statusOnly' with value '"+intd[1]+"' for SOP Browser 2 compatibility");if(intd.length>1){aStackObj.apiResult=intd[1]}else{console.warn("CallStack: Assuming SOP Browser 2 is used without the support for the new API format");aStackObj.apiResult=api_status.toString()}format="statusOnly"}else{console.warn("CallStack: Enforcing format of the API result '"+aStackObj.apiResult+"' from 'statusOrData' to 'statusAndData' for SOP Browser 2 compatibility");if(intd.length===1){console.warn("CallStack: Assuming SOP Browser 2 is used without the support for the new API format");aStackObj.apiResult="0,"+aStackObj.apiResult}format="statusAndData"}}}}aStackObj.format=aStackObj.details.format=format}if(aStackObj.format===undef){console.error("Invalid API description: <"+aStackObj.identifier+"> (resourceDescription.output.globalFormat is mandatory)");return aStackObj.apiResult}if(aStackObj.format!=="dataOnly"){aStackObj.details.possibleStatus=aStackObj.details.resourceDescription.output.possibleStatusTab.statusList;if(aStackObj.details.possibleStatus===undef){console.error("Invalid API description: <"+aStackObj.identifier+"> (resourceDescription.output.possibleStatusTab.statusList is mandatory)");return aStackObj.apiResult}}if(aStackObj.apiResult===undef){console.error("Undefined API result");return aStackObj.apiResult}checkedResult=aCheckApiFormat(aStackObj);aStackObj.details.type=original_api_type;aStackObj.format=aStackObj.details.format=original_api_format;return checkedResult},aCheckSynResult=function(aStackObj){if(!aStackObj.apiResult){return}if(typeof aStackObj.apiResult.status==="boolean"&&aStackObj.apiResult.status||aStackObj.apiResult.status===0){aGenerateLog(aStackObj,"SYN_OK")}else if(aIsOnHgw&&typeof aStackObj.apiResult.status==="string"){aGenerateLog(aStackObj,"SYN_OK")}else{aStackObj.has_error=true;if(do_compact_errors){dim_err_uuids.push(aStackObj.details.uuid)}aGenerateLog(aStackObj,"SYN_NOK","API call returned an error status ("+JSON.stringify(aStackObj.result)+")")}},aProcessApi=function(aStackObj){var formatedResult,msg,the_parent;if(!aIsEmulated("api",aStackObj.name)){aStackObj.result=aStackObj.apiResult=aStackObj.details.call()}else{aStackObj.result=aStackObj.apiResult=aStackObj.details.emulatedResult}formatedResult=aCheckApiResult(aStackObj);if(theStack.hasUuid(aStackObj.details.uuid,aStackObj.handler.stackId)){if(aStackObj.isAsync&&aStackObj.result.status===0){if(!aUseApplicationMode){console.log("--- API *ASYNC CALL* "+aStackObj.name+" (stackId="+aStackObj.handler.stackId.substr(0,3)+")")}}else{aCheckSynResult(aStackObj);if(!aUseApplicationMode){console.log("<-- API "+aStackObj.name+" (stackId="+aStackObj.handler.stackId.substr(0,3)+")")}}if(!aUseApplicationMode){if(aStackObj.handler.fields&&aStackObj.handler.fields.uuid&&theStack.hasUuid(aStackObj.handler.fields.uuid,aStackObj.handler.stackId)){the_parent=theStack.getById(aStackObj.handler.fields.uuid,aStackObj.handler.stackId);msg="[-] "+the_parent.type.toUpperCase()+" "+the_parent.name+" step "+aStackObj.stage+" (stackId="+aStackObj.handler.stackId.substr(0,3)+")"}else{msg="[-] No parent"}console.log(msg)}theStack.remove(aStackObj.details.uuid,aStackObj.handler.stackId)}else if(dim_unprocessed[aStackObj.details.uuid]){aCheckSynResult(aStackObj);if(!aUseApplicationMode){console.log("<-- API (delayed) "+aStackObj.name)}delete dim_unprocessed[aStackObj.details.uuid]}else{if(!aUseApplicationMode){console.log("<-- API (ghost) "+aStackObj.name)}}return formatedResult},aProcessResult=function(stackObj){stackObj.details.call=function(aCallback){return SOPWS.send(stackObj,aCallback)};var ret=aProcessApi(stackObj);stackObj.details.call=null;return ret},aWaitForEvent=function(aRef,aHandler,aReason,aStep,aTimeout){var uuid,eventTimeOut;console.log("CallStack: Start waiting for event handler <"+aHandler+"> with timeout ("+aTimeout+"s)");eventTimeOut=window.setTimeout(function(){console.info("CallStack: Stop waiting for event handler <"+aHandler+">. timeout ("+aTimeout+"s) expired!");window.clearTimeout(eventTimeOut);aRef.call(aStep,{status:0,data:{result:-1}})},aTimeout*1e3);uuid=eventHandler.register(aHandler,aReason,"aWaitForEvent",function(handler,reason,session,attributes){console.info("{Received success event} Handler<"+handler+">, Reason<"+reason+">, Session<"+session+"> Attributes<"+JSON.stringify(attributes)+">");console.log("CallStack: Release waiting for event handler <"+aHandler+">");window.clearTimeout(eventTimeOut);eventHandler.unregister(aHandler,aReason,"aWaitForEvent",uuid);aRef.call(aStep,{status:0,data:{result:attributes}})})},aReportSyntaxError=function(typeTest,err){if(err.fileName){currState={error:"ERROR IN "+typeTest+" TEST CODE\n In "+err.fileName+" : "+err.lineNumber+"\n"+err.message,path:theStack.printShortStack()};aLastSuiteResult="STOP";aReportSuiteProgress();aGetCurrState();console.error(JSON.stringify(currState))}},aConstructParams=function(aObjStack){var undef,idx=0,cc,param,i,parameters={};if(aIsOnHgw){if(aObjStack.details.resourceDescription.languageTab.WS!==undef){if(aObjStack.input[0]!==undef&&aObjStack.details.resourceDescription.languageTab.WS.indexOf("@@")>=0){aObjStack.details.resourceDescription.languageTab.WS_org=aObjStack.details.resourceDescription.languageTab.WS;aObjStack.details.resourceDescription.languageTab.WS=aObjStack.details.resourceDescription.languageTab.WS.replace("@@",aObjStack.input[0])}else if(aObjStack.details.resourceDescription.languageTab.WS_org){aObjStack.details.resourceDescription.languageTab.WS=aObjStack.details.resourceDescription.languageTab.WS_org.replace("@@",aObjStack.input[0])}if(aObjStack.input.length>1&&aObjStack.input[1]!==undef){parameters={service:aObjStack.details.resourceDescription.languageTab.WS.split("|")[3],method:aObjStack.details.resourceDescription.languageTab.WS.split("|")[4],parameters:aObjStack.input.length>0?aObjStack.input[1]:{}}}else if(aObjStack.input.length===1&&aObjStack.input[0]!==undef){parameters={service:aObjStack.details.resourceDescription.languageTab.WS.split("|")[3],method:aObjStack.details.resourceDescription.languageTab.WS.split("|")[4],parameters:aObjStack.input.length>0?aObjStack.input[0]:{}}}else{parameters={service:aObjStack.details.resourceDescription.languageTab.WS.split("|")[3],method:aObjStack.details.resourceDescription.languageTab.WS.split("|")[4],parameters:{}}}}else{aLogMessage("CALLSTACK_API_DESCRIPTION","Missing primordial parameter 'WS' in resourceDescription.languageTab",aObjStack)}}else{if(aObjStack.input.length<=0){aObjStack.parameters=""}else{if(aObjStack.details.resourceDescription.output.outputDataType==="string"){aObjStack.parameters={};if(aObjStack.details.resourceDescription.inputList.length===undef){parameters[aObjStack.details.resourceDescription.inputList.inputId]=aObjStack.input[0]}else{for(i=0;i<aObjStack.details.resourceDescription.inputList.length;i+=1){if(aObjStack.input[i]===undef&&aObjStack.details.resourceDescription.inputList[i].isOptional!=="1"){aLogMessage("CALLSTACK_API_DESCRIPTION","Missing parameter '"+aObjStack.details.resourceDescription.inputList[i].inputId+"' on API '"+aObjStack.details.parentPath.replace(/\//g,".")+"."+aObjStack.details.resourceId+"'",aObjStack);break}else{if(aObjStack.input[i]!==undef){if(aIsOnStb){if(i===0){parameters.stb=JSON.stringify(aObjStack.input[i])}else{parameters.stb+=","+JSON.stringify(aObjStack.input[i])}}else{parameters[aObjStack.details.resourceDescription.inputList[i].inputId]=aObjStack.input[i]}}}}}}else{if(aObjStack.details.resourceDescription.inputList.length===undef){if(aObjStack.details.resourceDescription.inputList.inputDataType==="object"&&typeof(JSON.parse(aObjStack.details.resourceDescription.inputList.objectFormat)==="object")&&Array.isArray(aObjStack.input[0])){idx=0;cc=JSON.parse(aObjStack.details.resourceDescription.inputList.objectFormat);for(param in cc){if(cc.hasOwnProperty(param)){cc[param]=aObjStack.input[0][idx];idx+=1}}parameters=cc;aLogMessage("SYN_BAD_ARGS","Wrong input Fields (Should be an Object) <"+JSON.stringify(aObjStack.input)+">. Used service <"+aObjStack.name+">",aObjStack)}else if(aObjStack.details.resourceDescription.inputList.inputDataType==="object"&&typeof(JSON.parse(aObjStack.details.resourceDescription.inputList.objectFormat)==="object")&&typeof aObjStack.input[0]==="object"){parameters=aObjStack.input[0]}else{aLogMessage("SYN_BAD_ARGS","Unhandled input Fields <"+JSON.stringify(aObjStack.input)+">. Used service <"+aObjStack.name+">",aObjStack)}}else if(aObjStack.details.resourceDescription.inputList.length===1){if(aObjStack.details.resourceDescription.inputList[0].inputDataType==="string"&&typeof aObjStack.input[0]==="string"){if(aIsOnStb){parameters={stb:JSON.stringify(aObjStack.input[0])}}else{parameters={SESSION_NAME:aObjStack.input[0]}}}else if(aObjStack.details.resourceDescription.inputList[0].inputDataType==="string"&&aObjStack.input[0].SESSION_NAME){if(aIsOnStb){parameters={stb:JSON.stringify(aObjStack.input[0].SESSION_NAME)}}else{parameters=aObjStack.input[0]}}else if(aObjStack.details.resourceDescription.inputList[0].inputDataType==="object"&&typeof(JSON.parse(aObjStack.details.resourceDescription.inputList[0].objectFormat)==="object")&&Array.isArray(aObjStack.input[0])){idx=0;cc=JSON.parse(aObjStack.details.resourceDescription.inputList[0].objectFormat);for(param in cc){if(cc.hasOwnProperty(param)){cc[param]=aObjStack.input[0][idx];idx+=1}}parameters=cc;aLogMessage("SYN_BAD_ARGS","Wrong input Fields (Should be an Object) <"+JSON.stringify(aObjStack.input)+">. Used service <"+aObjStack.name+">",aObjStack)}else if(aObjStack.details.resourceDescription.inputList[0].inputDataType==="object"&&typeof(JSON.parse(aObjStack.details.resourceDescription.inputList[0].objectFormat)==="object")&&typeof aObjStack.input[0]==="object"){parameters=aObjStack.input[0]}else{aLogMessage("SYN_BAD_ARGS","Unhandled input Fields <"+JSON.stringify(aObjStack.input)+">. Used service <"+aObjStack.name+">",aObjStack)}}else if(aObjStack.details.resourceDescription.inputList.length===2){if(aIsOnStb){parameters={stb:JSON.stringify(aObjStack.input[0])+","+JSON.stringify(aObjStack.input[1])};console.debug("Object API with session name "+JSON.stringify(parameters))}else{parameters={SESSION_NAME:aObjStack.input[0]};for(param in aObjStack.input[1]){if(aObjStack.input[1].hasOwnProperty(param)){parameters[param]=aObjStack.input[1][param]}}}}else{aLogMessage("SYN_BAD_ARGS","Unhandled number of params in inputList in the API description <"+aObjStack.name+">",aObjStack);parameters={}}}}}aObjStack.parameters=parameters;
return aObjStack},aHandleCallBack=function(stackObj){var i,j,k,eventTabs,sessionName,registredEvents,uuid,eventTimeOut,asyncRslt,d,date,key,attributes_checked,ret;stackObj=aConstructParams(stackObj);if(!aIsEmulated("api",stackObj.name)&&!stackObj.handler.skipEvents&&stackObj.details.resourceDescription.isAsynchronous==="1"){eventTabs=stackObj.details.resourceDescription.output.possibleEventTab;sessionName="ANY";stackObj.isAsync=true;registredEvents=[];if(Object.typeOf(eventTabs.successTab)==="object"){eventTabs.successTab=[eventTabs.successTab]}if(Object.typeOf(eventTabs.failureTab)==="object"){eventTabs.failureTab=[eventTabs.failureTab]}if(stackObj.parameters.SESSION_NAME){sessionName=stackObj.parameters.SESSION_NAME}console.log("CallStack: Initiating events timer (15s) for <"+stackObj.identifier+">");eventTimeOut=window.setTimeout(function(){var errorDescr=[];for(i=0;i<eventTabs.successTab.length;i+=1){errorDescr.push(eventTabs.successTab[i].handler+"/"+eventTabs.successTab[i].reason)}for(i=0;i<registredEvents.length;i+=1){eventHandler.unregister(registredEvents[i].handler,registredEvents[i].reason,registredEvents[i].sessionName,registredEvents[i].uuid)}aLogMessage("SYN_STATUS_EVENT","Expected one of the following events: "+errorDescr.join(", ")+". None of them received.",stackObj);console.log("CallStack: Clear events timeout (15s) for <"+stackObj.identifier+">");stackObj.hasError=true;try{if(stackObj.defered){stackObj.defered.reject({status:-1,data:{error:stackObj.apiResult?stackObj.apiResult.errors:null}})}else{stackObj.handler.call(stackObj.stage,{status:-1,data:{result:null,error:stackObj.apiResult?stackObj.apiResult.errors:null}})}}catch(e){aReportSyntaxError("SEMANTIC",e)}},15e3);for(i=0;i<eventTabs.successTab.length;i+=1){uuid=eventHandler.register(eventTabs.successTab[i].handler,eventTabs.successTab[i].reason,sessionName,function(handler,reason,session,attributes){console.info("{Received success event} Handler<"+handler+">, Reason<"+reason+">, Session<"+session+"> Attributes<"+JSON.stringify(attributes)+"> Identifier<"+stackObj.identifier+">");attributes_checked=true;for(k=0;k<eventTabs.successTab.length;k+=1){if(eventTabs.successTab[k].handler===handler&&eventTabs.successTab[k].reason===reason){if(attributes&&eventTabs.successTab[k].attributes){attributes_checked=false;for(key in attributes){if(attributes.hasOwnProperty(key)){if(eventTabs.successTab[k].attributes.hasOwnProperty(key)&&attributes[key]===eventTabs.successTab[k].attributes[key]){attributes_checked=true;break}}}}else if(!eventTabs.successTab[k].attributes){attributes_checked=true}break}}if(!attributes_checked){console.debug("Skipping event as attributes do not match exptected ones. Waiting for other event...");return}console.log("{Releasing event timer} (15s) for <"+stackObj.identifier+">");window.clearTimeout(eventTimeOut);for(j=0;j<registredEvents.length;j+=1){eventHandler.unregister(registredEvents[j].handler,registredEvents[j].reason,registredEvents[j].sessionName,registredEvents[j].uuid)}aCheckSynResult(stackObj);if(!aUseApplicationMode){console.log("<-- API *ASYNC* "+stackObj.name)}if(attributes_checked){try{if(stackObj.defered){stackObj.defered.resolve({status:0,data:{result:attributes,eventHandler:handler,eventReason:reason}})}else{stackObj.handler.call(stackObj.stage,{status:0,data:{result:attributes,eventHandler:handler,eventReason:reason}})}}catch(e){aReportSyntaxError("SEMANTIC",e)}}});registredEvents.push({handler:eventTabs.successTab[i].handler,reason:eventTabs.successTab[i].reason,attributes:eventTabs.successTab[i].attributes,sessionName:sessionName,uuid:uuid})}for(i=0;i<eventTabs.failureTab.length;i+=1){uuid=eventHandler.register(eventTabs.failureTab[i].handler,eventTabs.failureTab[i].reason,sessionName,function(handler,reason,session,attributes){console.error("{API_ERROR} Handler<"+handler+">, Reason<"+reason+">, Session<"+session+"> Attributes<"+JSON.stringify(attributes)+"> Identifier:<"+stackObj.identifier+">");console.log("{Releasing event timer} (15s) for <"+stackObj.identifier+">");window.clearTimeout(eventTimeOut);for(j=0;j<registredEvents.length;j+=1){eventHandler.unregister(registredEvents[j].handler,registredEvents[j].reason,registredEvents[j].sessionName,registredEvents[j].uuid)}stackObj.hasError=true;stackObj.result={status:-1,data:{result:reason,error:stackObj.apiResult?stackObj.apiResult.errors:null}};aLogMessage("SEM_SYN_ERROR","Received a failure event: "+handler+"/"+reason,stackObj);stackObj.apiResult=stackObj.result;if(!aUseApplicationMode){console.log("<-- API *ASYNC* "+stackObj.name)}aCheckSynResult(stackObj);try{if(stackObj.defered){stackObj.defered.reject({status:-1,data:{result:null,eventHandler:handler,eventReason:reason,error:stackObj.apiResult?stackObj.apiResult.errors:null}})}else{stackObj.handler.call(stackObj.stage,{status:-1,data:{result:null,eventHandler:handler,eventReason:reason,error:stackObj.apiResult?stackObj.apiResult.errors:null}})}}catch(e){aReportSyntaxError("SEMANTIC",e)}});registredEvents.push({handler:eventTabs.failureTab[i].handler,reason:eventTabs.failureTab[i].reason,sessionName:sessionName,uuid:uuid})}if(!aUseApplicationMode){d=new Date;date=new Date(d.getTime()+15e3);currState={path:theStack.printShortStack(stackObj.handler.stackId),name:stackObj.name,msg:"Waiting 15s for event on asynchronous API ("+date.toLocaleTimeString()+")",params:stackObj.parameters,waiting:15e3};aGetCurrState()}asyncRslt=aProcessResult(stackObj);if(asyncRslt.status&&parseInt(asyncRslt.status,10)!==0){aLogMessage("SYN_STATUS_CODE",errorCodes.SYN_STATUS_CODE.message+" '"+asyncRslt.status+"'",stackObj);stackObj.hasError=true;window.clearTimeout(eventTimeOut);for(j=0;j<registredEvents.length;j+=1){eventHandler.unregister(registredEvents[j].handler,registredEvents[j].reason,registredEvents[j].sessionName,registredEvents[j].uuid)}try{if(stackObj.defered){stackObj.defered.reject({status:-1,data:{result:null,error:stackObj.apiResult?stackObj.apiResult.errors:null}})}else{stackObj.handler.call(stackObj.stage,{status:-1,data:{result:null,error:stackObj.apiResult?stackObj.apiResult.errors:null}})}}catch(e){aReportSyntaxError("SEMANTIC",e)}return}}else{if(!aUseApplicationMode){currState={path:theStack.printShortStack(stackObj.handler.stackId),name:stackObj.name,params:stackObj.parameters};aGetCurrState()}try{ret=aProcessResult(stackObj);if(stackObj.defered){if(ret.status===0){stackObj.defered.resolve(ret)}else{stackObj.defered.reject(ret)}}else{stackObj.handler.call(stackObj.stage,ret)}}catch(e1){aReportSyntaxError("SEMANTIC",e1)}}},aPush=function(){var stackObj={},uuid,arg;stackObj.hasError=false;stackObj.input=Array.prototype.slice.call(arguments,0);if(stackObj.input.length<=1){console.error("Missing mandatory arguments in list <"+JSON.stringify(stackObj.input)+">");throw"Internal error"}stackObj.type=stackObj.input.shift();if(stackObj.type!=="api"&&stackObj.type!=="semantic"&&stackObj.type!=="functional"&&stackObj.type!=="suite"){console.error("Invalid function type '"+JSON.stringify(stackObj.type)+"'");throw"Internal error <Unmanaged "+stackObj.type+" level>"}stackObj.name=stackObj.input.shift();if(typeof stackObj.name!=="string"){console.error("Invalid <"+stackObj.type+">name <"+JSON.stringify(stackObj.name)+">");throw"Internal error"}stackObj.identifier=stackObj.type+":"+stackObj.name;arg=stackObj.input.shift();if(parseInt(arg,10)){stackObj.stage=arg}else{stackObj.defered=RSVP.defer()}stackObj.handler=stackObj.input.shift();stackObj.delay=(new Date).getTime();if(!stackObj.handler.stackId&&stackObj.handler.fields&&stackObj.handler.fields.uuid){stackObj.handler.stackId=stackObj.handler.fields.uuid}stackObj.details={uuid:basicUtilities.generateUUID()};stackObj.nbError=0;if(stackObj.type!=="api"){currState={msg:"{Processing} <"+stackObj.identifier+">"};aGetCurrState()}if(stackObj.type==="api"){uuid=stackObj.details.uuid;if(aConfig.excludedApis.indexOf(stackObj.name)>=0){console.log("x-> API "+stackObj.name+" not included in the project");stackObj.handler.call(stackObj.stage,{status:-1005,data:{result:"API not included in the project",error:"API not included in the project"}});return}if(!aIsEmulated("api",stackObj.name)){require(["json!apis/"+stackObj.name.replace(/\./g,"/")+".json"],function(aStackObj,sdk_method){var el;for(el in sdk_method){if(sdk_method.hasOwnProperty(el)){aStackObj.details=sdk_method[el]}}aStackObj.details.uuid=uuid;aStackObj.details.inputList=aStackObj.input;theStack.push(aStackObj,aStackObj.details.uuid);if(!aUseApplicationMode){console.log("--> API "+aStackObj.name+" (stackId="+aStackObj.handler.stackId.substr(0,3)+")")}aHandleCallBack(aStackObj)}.bind(this,stackObj))}else{require(["json!apis/"+stackObj.name.replace(/\./g,"/")+".json","json!apis/debug/"+stackObj.name.replace(/\./g,"/")+".json?bust="+(new Date).getTime()],function(aStackObj,sdk_method,simulValue){var el;for(el in sdk_method){if(sdk_method.hasOwnProperty(el)){aStackObj.details=sdk_method[el]}}aStackObj.details.emulatedResult=simulValue;aStackObj.details.uuid=uuid;theStack.push(aStackObj,aStackObj.details.uuid);if(!aUseApplicationMode){console.log("--> API "+aStackObj.name+" (stackId="+aStackObj.handler.stackId.substr(0,3)+")")}aHandleCallBack(aStackObj)}.bind(this,stackObj))}}else if(stackObj.type==="semantic"){stackObj.parameters=stackObj.input;if(!aIsEmulated("semantic",stackObj.name)){require(["semantic/"+stackObj.name.split(".").slice(0,-1).join("/")],function(aStackObj,client){var new_caller;aStackObj.details.inputList=aStackObj.input;theStack.push(aStackObj,aStackObj.details.uuid);if(!aUseApplicationMode){console.log("--> SEMANTIC "+aStackObj.name+" step 0"+" (stackId="+aStackObj.handler.stackId.substr(0,3)+")")}new_caller=aStackObj.name.split(".").pop();if(false&&theStack.isFirst(aStackObj.handler.stackId)){client[new_caller].skipEvents=aStackObj.handler.skipEvents||false;client[new_caller].stackId=aStackObj.handler.stackId||false;client[new_caller].call("0",aStackObj.details)}else{try{client[new_caller].skipEvents=aStackObj.handler.skipEvents||false;client[new_caller].stackId=aStackObj.handler.stackId||false;client[new_caller].call("0",aStackObj.details)}catch(e){console.warn("CallStack: check whether the method "+aStackObj.identifier+" is implemented");aReportSyntaxError("SEMANTIC",e)}}}.bind(this,stackObj))}else{require(["json!semantic/debug/"+stackObj.name.split(".").join("/")+".json?bust="+(new Date).getTime()],function(aStackObj,result){theStack.push(aStackObj,aStackObj.details.uuid);if(!aUseApplicationMode){console.log("--> SEMANTIC "+aStackObj.name+" (stackId="+aStackObj.handler.stackId.substr(0,3)+")")}try{if(aStackObj.defered){if(result.status===0){aStackObj.defered.resolve(result)}else{aStackObj.defered.reject(result)}}else{aStackObj.handler.call(aStackObj.stage,result)}}catch(e){aReportSyntaxError("SEMANTIC",e)}}.bind(this,stackObj))}}else if(stackObj.type==="functional"){stackObj.parameters=stackObj.input;require(["functional/"+stackObj.name.split(".").slice(0,-1).join("/")],function(aStackObj,scenario){aStackObj.details.inputList=aStackObj.input;theStack.push(aStackObj,aStackObj.details.uuid);console.log("--> FUNCTIONAL "+aStackObj.name+" step 0"+" (stackId="+aStackObj.handler.stackId.substr(0,3)+")");if(false&&theStack.isFirst(aStackObj.handler.stackId)){scenario[aStackObj.name.split(".").pop()].stackId=aStackObj.handler.stackId||false;scenario[aStackObj.name.split(".").pop()].call("0",aStackObj.details)}else{try{scenario[aStackObj.name.split(".").pop()].stackId=aStackObj.handler.stackId||false;scenario[aStackObj.name.split(".").pop()].call("0",aStackObj.details)}catch(e){aReportSyntaxError("FUNCTIONAL",e)}}}.bind(this,stackObj))}else if(stackObj.type==="suite"){stackObj.parameters=stackObj.input;if(stackObj.name==="Global.Engine"){aNbTotalSuites=Math.max(1,stackObj.parameters[0].length)}require(["suite/"+stackObj.name.split(".").slice(0,-1).join("/")],function(suite){stackObj.details.inputList=stackObj.input;theStack.push(stackObj,stackObj.details.uuid);console.log("--> SUITE "+stackObj.name+" step 0"+" (stackId="+stackObj.handler.stackId.substr(0,3)+")");if(false&&theStack.isFirst(stackObj.handler.stackId)){suite[stackObj.name.split(".").pop()].call("0",stackObj.details)}else{try{suite[stackObj.name.split(".").pop()].stackId=stackObj.handler.stackId||false;suite[stackObj.name.split(".").pop()].call("0",stackObj.details)}catch(e){aReportSyntaxError("SUITE",e)}}})}else{console.error("Missing or invalid function "+stackObj.identifier);throw"Internal error"}return stackObj.defered?stackObj.defered.promise:null},aPopAll=function(aType,result,uuid){var aStackObj,i,list_of_children,obj_to_pop,resultCode="",the_parent=null,msg;aStackObj=theStack.getById(uuid);if(!aStackObj){if(uuid){console.log("--xx Pop All: uuid="+uuid+", aType="+aType+". Cannot locate a corresponding StackObj")}else if(!aUseApplicationMode){console.log("--x leaving callStack. Finished invokeApi call")}return}list_of_children=theStack.findChildren(uuid,aStackObj.handler.stackId||uuid);if(list_of_children.length>0){console.log("-xxxx- node "+aStackObj.identifier+" has "+list_of_children.length+" children. TO REMOVE");for(i=0;i<list_of_children.length;i+=1){obj_to_pop=theStack.getById(list_of_children[i]);if(!aUseApplicationMode&&aStackObj){console.log("--x CLEANING STACK. Delete "+obj_to_pop.identifier+", child of "+(!aStackObj?"UNKNOWN PARENT":aStackObj.identifier))}dim_unprocessed[list_of_children[i]]=basicUtilities.cloneObj(obj_to_pop);theStack.remove(list_of_children[i],aStackObj.handler.stackId||uuid)}}if(theStack.hasUuid(uuid,aStackObj.handler.stackId||uuid)){if(aStackObj.type==="api"){console.error("CallStack: ABNORMAL STATE: API CALLS REMAIN IN popAll(): ",aStackObj.identifier)}else{if(aStackObj.type==="semantic"){resultCode="SEM_OK";if(result.status!==0){resultCode="SEM_NOK"}}else if(aStackObj.type==="functional"){resultCode="FUN_OK";if(result.status!==0){resultCode="FUN_NOK"}}else if(aStackObj.type==="suite"){resultCode="SUI_OK";if(result.status!==0){resultCode="SUI_NOK"}}else{console.error("CallStack: UNKNOWN CALL TYPE: ",aStackObj.type)}}aGenerateLog(aStackObj,resultCode,errorCodes[resultCode].message,result);theStack.remove(uuid,aStackObj.handler.stackId||uuid);if(!aUseApplicationMode){console.log("<-- "+aStackObj.type.toUpperCase()+" "+aStackObj.name+" (stackId="+aStackObj.handler.stackId.substr(0,3)+")")}if(aStackObj.type==="suite"){aLastSuiteExecuted=aStackObj.name;aNbExecSuites+=1;if(aStackObj.hasError){aNbSuitesNOK+=1;aLastSuiteResult="NOK"}else{aNbSuitesOK+=1;aLastSuiteResult="OK"}aReportSuiteProgress()}if(aStackObj.handler){if(aStackObj.handler.call){if(aStackObj.handler.fields&&aStackObj.handler.fields.uuid&&theStack.hasUuid(aStackObj.handler.fields.uuid,aStackObj.handler.stackId)){the_parent=theStack.getById(aStackObj.handler.fields.uuid,aStackObj.handler.stackId||uuid);msg="[-] "+the_parent.type.toUpperCase()+" "+the_parent.name+" step "+aStackObj.stage+" (stackId="+aStackObj.handler.stackId.substr(0,3)+")"}else{msg="[-] No parent"}if(!aUseApplicationMode){console.log(msg)}if(theStack.isFirst(aStackObj.handler.stackId)){aStackObj.handler.call(aStackObj.stage,result)}else{try{if(aStackObj.defered){if(result.status===0){aStackObj.defered.resolve(result)}else{aStackObj.defered.reject(result)}}else{aStackObj.handler.call(aStackObj.stage,result)}}catch(e){if(the_parent){aReportSyntaxError(the_parent.type.toUpperCase(),e)}else{aReportSyntaxError("UNKNOWN",e)}}}return}console.error("popAll : parent of "+aStackObj.name+" / "+aStackObj.uuid+" has no call function")}else{console.error("popAll : "+aStackObj.name+" / "+aStackObj.uuid+" has no parent")}}else{if(dim_unprocessed[uuid]){console.log("<-xx- RECEIVED LATE RESPONSE from "+dim_unprocessed[uuid].identifier);return}}if(!aUseApplicationMode){console.log("CallStack: All tests have been processed")}return},aReCall=function(aCallerObj,aStep,timeout){var d,date,aStackObj,defered;if(theStack.hasUuid(aCallerObj.fields.uuid,aCallerObj.stackId)){aStackObj=theStack.getById(aCallerObj.fields.uuid,aCallerObj.stackId);if(!aUseApplicationMode){console.log("[-] "+aStackObj.type.toUpperCase()+" RECALL "+aStackObj.name+" with step "+aStep+" (stackId="+aStackObj.handler.stackId.substr(0,3)+")")}}else{console.error("CallStack: Re-call requested on unknown stack object '"+aCallerObj.fields.uuid+"'")}if(timeout>0){console.info("Test paused for "+timeout+"ms");d=new Date;date=new Date(d.getTime()+timeout);currState={msg:"Waiting "+Math.floor(timeout/1e3)+"s for next operation ("+date.toLocaleTimeString()+")",path:theStack.printShortStack(aStackObj.handler.stackId),waiting:timeout};if(aStackObj&&aStackObj.type==="api"){currState.name=aStackObj.name}aGetCurrState();if(sdkutConfig.useApiSimulationMode||sdkutConfig.useSemanticSimulationMode){if(timeout>5e3){timeout=5e3}}}defered=!aStep?RSVP.defer():null;if(timeout===0){timeout=2}window.setTimeout(function(){if(!aStep){defered.resolve({status:0})}else{aCallerObj.call(aStep)}},timeout);return defered?defered.promise:null},aResolvedPromise=function(aValue){return RSVP.resolve(aValue)},aRejectedPromise=function(aValue){return RSVP.reject(aValue)},aStopPolling=function(){if(!aIsOnStb){eventHandler.stopAll();console.info("CallStack: Stop listening to events")}},aDoNothing=function(){console.log("calling dummy function")},aGetCapabilities=function(){var capability,display;if(!aConfig.capabilities){aConfig.capabilities={};if(aConfig&&aConfig.project&&aConfig.hardware){if(stackCapabilities&&stackCapabilities.Any&&stackCapabilities.Any.Any){aConfig.capabilities=basicUtilities.cloneObj(stackCapabilities.Any.Any);if(stackCapabilities[aConfig.hardware]&&stackCapabilities[aConfig.hardware][aConfig.project]){for(capability in stackCapabilities[aConfig.hardware][aConfig.project]){if(stackCapabilities[aConfig.hardware][aConfig.project].hasOwnProperty(capability)){if(capability==="display"){for(display in stackCapabilities[aConfig.hardware][aConfig.project][capability]){if(stackCapabilities[aConfig.hardware][aConfig.project][capability].hasOwnProperty(display)){aConfig.capabilities.display[display]=stackCapabilities[aConfig.hardware][aConfig.project][capability][display]}}}else{aConfig.capabilities[capability]=stackCapabilities[aConfig.hardware][aConfig.project][capability]}}}}else{console.error("CallStack: Missing capabilities for project '"+aConfig.project+"' and hardware '"+aConfig.hardware+"'");aConfig.capabilities={}}}else{console.error("CallStack: Missing default list of capabilities")}}else{console.error("CallStack: Missing mandatory project '"+aConfig.project+"' and/or hardware '"+aConfig.hardware+"'")}}return aConfig.capabilities};statProcessor.setEventHandler(eventHandler);return{reset:function(){var date;if(!aUseApplicationMode){date=new Date;aCallStackLog=[];aFunCallStack=[];aReportTree=[];aNbExecSuites=0;aNbTotalSuites=1;aNbSuitesNOK=0;aNbSuitesOK=0;aNbSuitesSkipped=0;aLastSuiteExecuted="";aLastSuiteResult="OK";aNbFuncOK=0;aNbFuncSkip=0;aNbFuncNok=0;aNbFuncTotal=0;console.debug("CallStack: Soft reset")}},init:function(callback){var envRsp,requiredList=["engine/environment"],undef;this.reset();theStack.init();env_id=null;if(aIsOnStb){if(typeof SOP!=="undefined"&&typeof SOP.Set!=="undefined"){requiredList.push("apis/com/softathome")}else{console.info("CallStack: Skipping softathome.js for SOP Browser 2")}}require(requiredList,function(env){var envConf=env.init(aIsOnHgw,sdkutConfig.useSemanticSimulationMode||sdkutConfig.useApiSimulationMode),key;for(key in envConf){if(envConf.hasOwnProperty(key)){aConfig[key]=envConf[key]}}if(sdkutConfig.useValidationMode&&!sdkutConfig.useApiSimulationMode&&!sdkutConfig.useSemanticSimulationMode){envRsp=SOPWS.directPostSynchronous(JSON.stringify(aConfig),aReporter+"?_action=addEnv");env_id=envRsp.env_id!==undef?envRsp.env_id:null;console.warn("[[[CURR_ENV_ID:"+env_id+"]]]");currState={msg:"Creating ENV ID",path:"suite:Global.Engine",env_id:env_id};aGetCurrState()}if(callback!==undef){callback()}})},getEnv:function(aKey){if(aKey){return aConfig[aKey]}return aConfig},setEnv:function(soSdkUtVersion,projectVersion,referer,location,hardware){aConfig.project=projectVersion;aConfig.so_sdkut=soSdkUtVersion;aConfig.referer=referer;if(location){aConfig.location=location;if(hardware){aConfig.hardware=hardware}}else{aConfig.location="softathome"}aConfig.excludedApis=[];require(["text!engine/config/excluded_apis/"+aConfig.project+".exclude"],function(aTxt){aConfig.excludedApis=aTxt.replace(/\r/g,"").split("\n");console.info("EXCLUDED APIS: "+aConfig.excludedApis.length)})},logIn:function(aUser,aPass){if(sdkutConfig.useApiSimulationMode||sdkutConfig.useSemanticSimulationMode){return true}return SOPWS.logIn(aUser,aPass)},logOut:function(){if(sdkutConfig.useApiSimulationMode||sdkutConfig.useSemanticSimulationMode){return}SOPWS.logOut()},isLoggedIn:function(){if(sdkutConfig.useApiSimulationMode||sdkutConfig.useSemanticSimulationMode){return false}return SOPWS.isLoggedIn()},stopPollingForAuthentication:function(){SOPWS.stopPollingForAuthentication()},setProxy:function(aPath,aPort){SOPWS.setProxy(aPath,aPort)},setRequest:function(aIP,aPort,aDefaultContentType,aProtocol){var undef;if(aDefaultContentType!==undef){SOPWS.setContentType(aDefaultContentType)}SOPWS.setRequestUrl(aIP,aPort,aProtocol)},getRequest:function(){return SOPWS.getRequestParameters()},getSynchronous:function(aUrl){SOPWS.getSynchronous(aUrl)},setOnHgw:function(isOnHgw){aIsOnHgw=isOnHgw;SOPWS.setOnHGW(isOnHgw);eventHandler.setOnHgw(isOnHgw)},isOnHgw:function(){return aIsOnHgw},setOnStb:function(isOnStb){aIsOnStb=isOnStb;SOPWS.setOnStb(isOnStb)},setRemoteMode:function(isOnRemote){aIsOnRemote=isOnRemote},isOnRemote:function(){return aIsOnRemote},setApplicationMode:function(useApplicationMode){aUseApplicationMode=useApplicationMode},isOnStb:function(){return aIsOnStb},setReporter:function(reporter){aReporter=reporter},useValidationMode:function(useValidationMode){sdkutConfig.useValidationMode=useValidationMode},listenEvent:function(aHandler,aCallback){if(aHandler.indexOf("sah.")>=0){return eventHandler.registerSahEvent(aHandler,aCallback)}return eventHandler.listenEvent(aHandler,aCallback)},unlistenEvent:function(aHandler,aEventUUID){if(aHandler.indexOf("sah.")>=0){return eventHandler.unregisterSahEvent(aHandler,aEventUUID)}return eventHandler.unlistenEvent(aHandler,aEventUUID)},triggerEvent:function(aHandler,aReason,aSessionId,aAttributes){return eventHandler.generateExpectedEvent(aHandler,aReason,aSessionId,aAttributes)},setSemanticSimulationMode:function(useSemanticSimulationMode){sdkutConfig.useSemanticSimulationMode=useSemanticSimulationMode},setApiSimulationMode:function(useApiSimulationMode){sdkutConfig.useApiSimulationMode=useApiSimulationMode},useSimulationMode:function(){return sdkutConfig.useSemanticSimulationMode||sdkutConfig.useApiSimulationMode},isApiEmulated:aIsEmulated,setLogLevel:function(alogLevel){logLevel=alogLevel;aSetLogLevel()},getCapabilities:aGetCapabilities,hasCapability:function(aCapability){if(!aConfig.capabilities){aGetCapabilities()}return aConfig.capabilities[aCapability]},loadResources:function(callback){var undef;if(aConfig.location){require(["json!engine/config/"+aConfig.location+".json"],function(conf){stackConf=conf;console.debug("CallStack: Resources loaded from "+aConfig.location+".json");if(callback!==undef){callback()}})}else{console.error("CallStack: Failed to load resources as environment is not set")}},getResources:function(){var resource,resourceList,stackResources;resourceList={};if(aConfig&&aConfig.project&&aConfig.hardware&&aConfig.referer){stackResources=basicUtilities.cloneObj(stackConf);if(stackResources.Common){if(stackResources.Common.Any){if(stackResources.Common.Any.Common){for(resource in stackResources.Common.Any.Common){if(stackResources.Common.Any.Common.hasOwnProperty(resource)){resourceList[resource]=stackResources.Common.Any.Common[resource]}}}if(stackResources.Common.Any[aConfig.project]){for(resource in stackResources.Common.Any[aConfig.project]){if(stackResources.Common.Any[aConfig.project].hasOwnProperty(resource)){resourceList[resource]=stackResources.Common.Any[aConfig.project][resource]}}}}if(stackResources.Common[aConfig.referer]){if(stackResources.Common[aConfig.referer].Common){for(resource in stackResources.Common[aConfig.referer].Common){if(stackResources.Common[aConfig.referer].Common.hasOwnProperty(resource)){resourceList[resource]=stackResources.Common[aConfig.referer].Common[resource]}}}if(stackResources.Common[aConfig.referer][aConfig.project]){for(resource in stackResources.Common[aConfig.referer][aConfig.project]){if(stackResources.Common[aConfig.referer][aConfig.project].hasOwnProperty(resource)){resourceList[resource]=stackResources.Common[aConfig.referer][aConfig.project][resource]}}}}}if(stackResources[aConfig.hardware]){if(stackResources[aConfig.hardware].Any){if(stackResources[aConfig.hardware].Any.Common){for(resource in stackResources[aConfig.hardware].Any.Common){if(stackResources[aConfig.hardware].Any.Common.hasOwnProperty(resource)){resourceList[resource]=stackResources[aConfig.hardware].Any.Common[resource]}}}if(stackResources[aConfig.hardware].Any[aConfig.project]){for(resource in stackResources[aConfig.hardware].Any[aConfig.project]){if(stackResources[aConfig.hardware].Any[aConfig.project].hasOwnProperty(resource)){resourceList[resource]=stackResources[aConfig.hardware].Any[aConfig.project][resource]}}}}if(stackResources[aConfig.hardware][aConfig.referer]){if(stackResources[aConfig.hardware][aConfig.referer].Common){for(resource in stackResources[aConfig.hardware][aConfig.referer].Common){if(stackResources[aConfig.hardware][aConfig.referer].Common.hasOwnProperty(resource)){resourceList[resource]=stackResources[aConfig.hardware][aConfig.referer].Common[resource]}}}if(stackResources[aConfig.hardware][aConfig.referer][aConfig.project]){for(resource in stackResources[aConfig.hardware][aConfig.referer][aConfig.project]){if(stackResources[aConfig.hardware][aConfig.referer][aConfig.project].hasOwnProperty(resource)){resourceList[resource]=stackResources[aConfig.hardware][aConfig.referer][aConfig.project][resource]}}}}}}else{console.error("CallStack: Missing resources for project '"+aConfig.project+"', hardware '"+aConfig.hardware+"' and referrer '"+aConfig.referer+"'");resourceList={}}return resourceList},getTestList:function(){var testList,source="stb";if(aIsOnHgw){source="hgw"}if(aConfig&&aConfig.project&&aConfig.hardware&&aConfig.referer&&projConf[source][aConfig.project]&&projConf[source][aConfig.project][aConfig.hardware]&&projConf[source][aConfig.project][aConfig.hardware][aConfig.referer]){testList=projConf[source][aConfig.project][aConfig.hardware][aConfig.referer]}else{console.error("CallStack: Missing list of tests suites for project '"+aConfig.project+"', hardware '"+aConfig.hardware+"' and referrer '"+aConfig.referer+"'");testList=[]}return testList},waitForEvent:aWaitForEvent,setContextHeader:SOPWS.setContextHeader,removeContextHeader:SOPWS.removeContextHeader,postAsynchronous:function(aData,aUrl,aCallback,aTimer){SOPWS.postAsynchronous(aData,aUrl,aCallback,aTimer)},setContentType:function(aContentType){SOPWS.setContentType(aContentType)},logMessage:aLogMessage,logErrorMessage:aLogErrorMessage,fakeMessage:aFakeLog,getCurrState:aGetCurrState,push:aPush,popAll:aPopAll,reCall:aReCall,resolvedPromise:aResolvedPromise,rejectedPromise:aRejectedPromise,realPush:aPush,realPopAll:aPopAll,realReCall:aReCall,doNothing:aDoNothing,setConsoleOutput:aSetConsoleOutput,setProgressBarCallback:aSetProgressBarCallback,reportErrors:aReportErrors,cache:cache,startPolling:function(){eventHandler.makeListen();eventHandler.init(aIsOnStb,sdkutConfig.useApiSimulationMode||sdkutConfig.useSemanticSimulationMode,aUseApplicationMode);console.info("CallStack: Start listenning to events")},stopPolling:aStopPolling,setOptimizer:function(aPreviousCall,aCurrentCall,aNextCall){if(aPreviousCall&&aNextCall){optimizer={previous:aPreviousCall,current:aCurrentCall,next:aNextCall}}else{optimizer={previous:"",current:"",next:""}}},getOptimizer:function(){return optimizer},checkOptimizer:function(aWay){var firstTab,secondTab;if(aWay<0){if(optimizer.previous&&optimizer.current){firstTab=optimizer.previous.split(".");firstTab.pop();firstTab.pop();secondTab=optimizer.current.split(".");secondTab.pop();secondTab.pop();if(firstTab.join(".")===secondTab.join(".")){return true}return false}return false}if(aWay>0){if(optimizer.next&&optimizer.current){firstTab=optimizer.next.split(".");firstTab.pop();firstTab.pop();secondTab=optimizer.current.split(".");secondTab.pop();secondTab.pop();if(firstTab.join(".")===secondTab.join(".")){return true}return false}return false}},getExecResults:function(){return aReportTree},statProcessor:function(){return statProcessor},updateEventHandlersList:function(aNewEventHandler){eventHandler.updateHandlersList(aNewEventHandler)}}});