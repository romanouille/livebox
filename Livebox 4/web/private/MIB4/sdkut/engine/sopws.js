define(["utils/console"],function(console){"use strict";var localErrors=0,priv_undef,priv_start,priv_checkTimer,priv_timer,priv_isOnStb=false,priv_currUser="none",priv_xContext=null,priv__isOnHgw=false,priv_comChecker,priv_authChecker=null,priv_this,priv_etag="",priv_headers={Accept:"*/*"},getEtag=function(){var req,etag;if(!priv_etag){req=new XMLHttpRequest;req.open("GET",window.document.location,false);req.send(null);etag=req.getResponseHeader("etag");priv_etag=etag||"livebox"}return priv_etag},createHttpResquest=function(){var request;if(window.XMLHttpRequest){request=new XMLHttpRequest;if(request.overrideMimeType){request.overrideMimeType("text/plain")}}else if(window.ActiveXObject){try{request=new ActiveXObject("Msxml2.XMLHTTP")}catch(err1){try{request=new ActiveXObject("Microsoft.XMLHTTP")}catch(err2){console.error("SOPWS: Ajax requests not supported!");throw"Unsupported browser"}}}return request},check=function(req,fonction){var now=new Date,elapsed=now.getTime()-priv_start.getTime(),timeover;timeover=elapsed>priv_timer;if(timeover&&req.readyState===1){req.abort();if(priv_checkTimer){window.clearTimeout(priv_checkTimer)}fonction()}else{priv_checkTimer=window.setTimeout(function(){check(req,fonction)},1e3)}},prepareHttpRequest=function(aRequest,aRequestParameter){var url,useProxy=false,key;if(typeof aRequestParameter.proxyUrl==="string"&&aRequestParameter.proxyUrl){url=aRequestParameter.proxyUrl+"?url="+encodeURIComponent(aRequestParameter.url)}else{url=aRequestParameter.url}if(aRequestParameter.mode==="GET"){aRequest.open("GET",url,aRequestParameter.isAsynchronous)}else{aRequest.open("POST",url,aRequestParameter.isAsynchronous);if(!useProxy&&typeof aRequestParameter.contentType==="string"&&aRequestParameter.contentType){aRequest.setRequestHeader("Content-Type",aRequestParameter.contentType)}else{aRequest.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}}if(aRequestParameter.headers){for(key in aRequestParameter.headers){if(aRequestParameter.headers.hasOwnProperty(key)){aRequest.setRequestHeader(key.toLowerCase(),aRequestParameter.headers[key])}}}},processHttpResquest=function(aIsAsynchronous,aRequest,aCallback){var result,logoutEvent;if(parseInt(aRequest.status,10)===200){result={httpStatus:0,httpData:aRequest.responseText};if(priv__isOnHgw&&aRequest.responseText&&aRequest.responseText.indexOf("Permission denied")>=0){console.info("SOPWS: Login session timed out detected on API result");if(priv_authChecker!==null){window.clearTimeout(priv_authChecker);priv_authChecker=null}logoutEvent=window.document.createEvent("Event");logoutEvent.initEvent("sahLogout",true,false);window.document.dispatchEvent(logoutEvent)}}else{console.error("SOPWS: Error "+aRequest.status+" detected on HTTP request ("+aRequest.statusText+")");result={httpStatus:aRequest.status};localErrors+=1;if(localErrors>=20){console.warn("SOPWS: Device is unreachable!!")}}if(aCallback){aCallback(result);return null}return result},sendHttpResquest=function(aRequestParameter,aCallback,aTimer){var request=createHttpResquest();priv_start=new Date;priv_timer=aTimer===priv_undef?0:aTimer;prepareHttpRequest(request,aRequestParameter);if(aRequestParameter.isAsynchronous){if(priv_timer!==0){check(request,function(){request=sendHttpResquest(aRequestParameter,aCallback,aTimer)})}request.onreadystatechange=function(){if(request.readyState===4){if(priv_checkTimer){window.clearTimeout(priv_checkTimer)}processHttpResquest(true,request,aCallback)}}}try{if(aRequestParameter.mode==="GET"){request.send()}else{aRequestParameter.data=typeof aRequestParameter.data==="object"?JSON.stringify(aRequestParameter.data):aRequestParameter.data;request.send(aRequestParameter.data)}if(!aRequestParameter.isAsynchronous){return processHttpResquest(false,request)}}catch(e){console.error(e);if(typeof process!=="undefined"&&process){process.exit(1)}}return true},poll_for_authentication=function(){var header,data,result,isTimedOut,indError,logoutEvent;if(priv_authChecker!==null){window.clearTimeout(priv_authChecker);priv_authChecker=null}console.debug("SOPWS: Polling for authentication");header={Accept:"*/*",ContentType:"application/x-sah-ws-4-call+json",Authorization:"X-Sah "+priv_xContext,"X-Context":priv_xContext,"X-Sah-Request-Type":"idle"};data={service:"HTTPService",method:"getCurrentUser",parameters:{}};isTimedOut=false;result=priv_this.sopStbApi(data,header);if(typeof result.errors!=="undefined"&&result.errors.length>0){for(indError>0;indError<result.errors.length;indError+=1){if(result.errors[indError].error===13){isTimedOut=true;break}}}else if(typeof result.data!=="undefined"&&(result.data.currentUser==="anonymous"||result.data.currentUser==="permission denied")){isTimedOut=true}if(isTimedOut){console.info("SOPWS: Login session has timed out");logoutEvent=window.document.createEvent("Event");logoutEvent.initEvent("sahLogout",true,false);window.document.dispatchEvent(logoutEvent)}else{priv_authChecker=window.setTimeout(poll_for_authentication.bind(this),15e3)}};priv_this={ip:"",port:"",proxyUrl:null,proxyPort:null,contentType:"application/x-www-form-urlencoded",requestUrl:"",setProxy:function(aProxyUrl,aProxyPort){this.proxyUrl=aProxyUrl;this.proxyPort=aProxyPort},setContentType:function(aContentType){this.contentType=aContentType},setRequestUrl:function(aIP,aPort,aProtocol){this.ip=aIP;this.port=aPort;this.requestUrl=(aProtocol||"http:")+"//"+this.ip+(this.port?":"+this.port:"");if(this.contentType==="application/x-sah-ws-4-call+json"){this.requestUrl+="/ws"}},getRequestParameters:function(){return{ip:this.ip,port:this.port,proxyUrl:this.proxyUrl,proxyPort:this.proxyPort,requestUrl:this.requestUrl,contextId:priv_xContext}},logIn:function(aUser,aPass){var undef,header,data,result;if(!priv_xContext){header={Accept:"*/*",Authorization:"X-Sah-Login"};data={service:"sah.Device.Information",method:"createContext",parameters:{applicationName:"so_sdkut",username:aUser!==undef?aUser:"admin",password:aPass!==undef?aPass:"admin"}};result=this.sopStbApi(data,header);if(typeof result==="object"&&result&&typeof result.data==="object"&&result.data&&typeof result.data.contextID==="string"&&result.data.contextID){priv_xContext=result.data.contextID;window.document.cookie=getEtag()+"/contextId="+window.escape(result.data.contextID)+"; expires="+new Date(2100,0,1).toUTCString()+"; path=/;";priv_authChecker=window.setTimeout(poll_for_authentication.bind(this),15e3);return true}return false}return true},logOut:function(){var header,data;if(!priv__isOnHgw){console.warn("SOPWS: Authentication is mandatory on STB");return}if(priv_authChecker!==null){window.clearTimeout(priv_authChecker);priv_authChecker=null}header={Accept:"*/*",Authorization:"X-Sah-Logout "+priv_xContext};data={service:"sah.Device.Information",method:"releaseContext",parameters:{applicationName:"so_sdkut"}};this.sopStbApi(data,header);priv_xContext=null;priv_currUser="none";priv_headers={Accept:"*/*"};window.document.cookie=getEtag()+"/contextId=; expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/;"},isLoggedIn:function(){var cookieRef,cookieTab,indCookie,itemTab,cookieName;if(priv_xContext){return true}cookieRef=getEtag()+"/contextId";cookieTab=window.document.cookie.split(";");for(indCookie=0;indCookie<cookieTab.length;indCookie+=1){itemTab=cookieTab[indCookie].split("=");cookieName=itemTab[0].replace(/^\s+|\s+$/g,"");if(cookieName===cookieRef){priv_xContext=window.unescape(itemTab[1].replace(/^\s+|\s+$/g,""));priv_authChecker=window.setTimeout(poll_for_authentication.bind(this),15e3);return true}}return false},stopPollingForAuthentication:function(){if(priv_authChecker!==null){window.clearTimeout(priv_authChecker);priv_authChecker=null}},setContextHeader:function(xContext){priv_xContext=xContext},removeContextHeader:function(){priv_xContext=null},send:function(aObjStack,aCallback){var result,headers;if(priv__isOnHgw){if(aCallback){return this.postAsynchronous(aObjStack.parameters,priv_undef,aCallback,3e4)}else{return this.postSynchronous(aObjStack.parameters)}}headers=priv_headers;if(priv_xContext!==null){headers.Authorization="X-Sah "+priv_xContext}if(priv_isOnStb){if(typeof com==="undefined"){console.error("SOPWS: com object is not defined! Loading com.softathome ...");if(priv_comChecker){window.clearTimeout(priv_comChecker)}priv_comChecker=window.setTimeout(function(){priv_this.send(aObjStack)},2e3)}else{if(!aObjStack.parameters){aObjStack.parameters={}}console.debug("SOPWS: Calling STB API "+aObjStack.details.parentPath.replace(/\//g,".")+"."+aObjStack.details.resourceId+" with parameters "+(aObjStack.parameters.stb||JSON.stringify(aObjStack.parameters)));try{result=eval(aObjStack.details.parentPath.replace(/\//g,".")+"."+aObjStack.details.resourceId+"("+(aObjStack.parameters.stb?aObjStack.parameters.stb:JSON.stringify(aObjStack.parameters))+")")}catch(e){result={status:-999}}console.debug("SOPWS: Result is '"+JSON.stringify(result)+"' (type "+typeof result+")");return result}}else{console.debug("SOPWS: Calling WS API "+aObjStack.details.parentPath.replace(/\//g,".")+"."+aObjStack.details.resourceId+" with parameters "+JSON.stringify(aObjStack.parameters));result=this.sopStbApi({service:aObjStack.details.parentPath.replace(/\//g,"."),method:aObjStack.details.resourceId,parameters:aObjStack.parameters},headers);console.debug("SOPWS: Result is "+JSON.stringify(result));return result}},postSynchronous:function(aData,aUrl){aUrl=aUrl===priv_undef?this.requestUrl:aUrl;var response,headers=priv_headers;if(priv_xContext!==null){headers["X-Context"]=priv_xContext;headers.Authorization="X-Sah "+priv_xContext}response=sendHttpResquest({mode:"POST",isAsynchronous:false,url:aUrl,headers:headers,proxyUrl:this.proxyUrl,proxyPort:this.proxyPort,contentType:this.contentType,data:aData});try{if(response.httpStatus!==0){return{status:response.httpStatus===401?-1001:-1e3}}return JSON.parse(response.httpData)}catch(e){console.error(e);if(typeof process!=="undefined"&&process){process.exit(1)}}},directPostSynchronous:function(aData,aUrl){aUrl=aUrl===priv_undef?this.requestUrl:aUrl;var response,headers=priv_headers;if(priv_xContext!==null){headers["X-Context"]=priv_xContext}response=sendHttpResquest({mode:"POST",isAsynchronous:false,url:aUrl,headers:headers,proxyUrl:null,proxyPort:null,contentType:this.contentType,data:aData});if(response.httpStatus!==0){return{status:response.httpStatus===401?-1001:-1e3}}return JSON.parse(response.httpData)},directPostAsynchronous:function(aData,aUrl){aUrl=aUrl===priv_undef?this.requestUrl:aUrl;var response,headers=priv_headers;if(priv_xContext!==null){headers["X-Context"]=priv_xContext}response=sendHttpResquest({mode:"POST",isAsynchronous:true,url:aUrl,headers:headers,proxyUrl:null,proxyPort:null,contentType:this.contentType,data:aData})},getSynchronous:function(aUrl){if(priv__isOnHgw){aUrl=aUrl===priv_undef?this.requestUrl.split("/ws")[0]:this.requestUrl.split("/ws")[0]+aUrl}else{aUrl=aUrl===priv_undef?this.requestUrl:aUrl}var result,response,headers=priv_headers;if(priv_xContext!==null){headers["X-Context"]=priv_xContext}if(priv_xContext!==null){headers.Authorization="X-Sah "+priv_xContext}response=sendHttpResquest({mode:"GET",isAsynchronous:false,url:aUrl,headers:headers,proxyUrl:this.proxyUrl,proxyPort:this.proxyPort,contentType:this.contentType});if(response.httpStatus!==0){return{status:response.httpStatus===401?-1001:-1e3}}try{result=JSON.parse(response.httpData)}catch(error){return{status:response.httpStatus===401?-1001:-1e3}}return result},postAsynchronous:function(aData,aUrl,aCallback,aTimer){aUrl=aUrl===priv_undef?this.requestUrl:aUrl;aCallback=aCallback===priv_undef?function(){return}:aCallback;sendHttpResquest({mode:"POST",isAsynchronous:true,url:aUrl,proxyUrl:this.proxyUrl,proxyPort:this.proxyPort,contentType:this.contentType,data:aData},aCallback,aTimer);return true},getAsynchronous:function(aData,aUrl,aCallback,aTimer){aUrl=aUrl===priv_undef?this.requestUrl:aUrl;aCallback=aCallback===priv_undef?function(){return}:aCallback;aData=typeof aData==="object"?JSON.params(aData):aData;sendHttpResquest({mode:"GET",isAsynchronous:true,url:aUrl,proxyUrl:this.proxyUrl,proxyPort:this.proxyPort,data:aData},aCallback,aTimer);return true},sopStbApi:function(aData,headers){var undef,apiType,requestOptions,response;if(priv_isOnStb){if(typeof com==="undefined"){console.error("SOPWS: com object is not defined! Loading com.softathome ...");if(priv_comChecker){window.clearTimeout(priv_comChecker)}priv_comChecker=window.setTimeout(function(){priv_this.sopStbApi(aData,headers)},2e3);return}try{apiType=typeof eval(aData.service+"."+aData.method)}catch(err1){apiType="undefined"}if(apiType==="function"){return{data:{result:eval(aData.service+"."+aData.method+"("+JSON.stringify(aData.parameters)+")")}}}console.warn("SOPWS: Skipping invocation of local STB API '"+aData.service+"."+aData.method+"' as it does not exists");return{status:-9999}}requestOptions={mode:"POST",isAsynchronous:false,headers:headers!==undef?headers:{},url:this.requestUrl.indexOf("/ws")>0?this.requestUrl:this.requestUrl+"/ws",proxyUrl:this.proxyUrl,proxyPort:this.proxyPort,contentType:this.contentType,data:JSON.stringify(aData)};response=sendHttpResquest(requestOptions);if(response.httpStatus!==0){console.error("SOPWS: Unexpected HTTP Request Status "+response.httpStatus+" received",requestOptions);return{status:response.httpStatus===401?-1001:-1e3}}try{return JSON.parse(response.httpData)}catch(err2){console.error("SOPWS: Unexpected JSON parse error on result from request",requestOptions,err2,response);return{status:response.httpStatus===401?-1001:-1e3}}},sopStbEvent:function(aHandlerList,aChannelId,aCallback,aTimer){var indHandler,headers,response,eventObj={events:[]};if(aChannelId){eventObj.channelid=aChannelId}for(indHandler=0;indHandler<aHandlerList.length;indHandler+=1){eventObj.events.push(aHandlerList[indHandler])}headers=priv_headers;if(priv__isOnHgw){if(priv_xContext!==null){headers["X-Context"]=priv_xContext;headers.Authorization="X-Sah "+priv_xContext;headers["X-Sah-Request-Type"]="idle"}}response=sendHttpResquest({mode:"POST",isAsynchronous:true,url:this.requestUrl.indexOf("/ws")>0?this.requestUrl:this.requestUrl+"/ws",proxyUrl:this.proxyUrl,proxyPort:this.proxyPort,headers:headers,contentType:"application/x-sah-event-4-call+json",data:JSON.stringify(eventObj)},aCallback,aTimer);return true},invokeSopStbApi:function(aData){var headers=priv_headers;if(priv_xContext!==null){headers.Authorization="X-Sah "+priv_xContext}return this.sopStbApi(aData,headers)},setOnStb:function(isOnStb){priv_isOnStb=isOnStb},setOnHGW:function(isOnHgw){priv__isOnHgw=isOnHgw}};return priv_this});