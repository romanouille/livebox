define(["jquery","jquery-ui","lib/sah-core/sah"],function($){"use strict";$.widget("sah.grid",{options:{tile:{size:{width:120,height:120},margin:{horizontal:10,vertical:10}},autoresize:true,longpress:true,autoposition:false,insert:false,dropzone:undefined,enableDrag:true,tileClass:"tile"},_create:function(){var tile_dimensions=this.options.tile;this._placeholder=$('<div class="tile_placeholder" style="display:none;"></div>').appendTo(this.element).zIndex(2e3);this.columns=Math.floor(this.element.width()/(tile_dimensions.size.width+tile_dimensions.margin.horizontal));var margins=(this.element.width()-this.columns*(tile_dimensions.size.width+tile_dimensions.margin.horizontal))/2;this.element.css({"margin-left":margins,"margin-right":margins});var _this=this;if(this.options.autoresize){var resizeTimeout=-1;$(window).resize(function(){if(resizeTimeout!=-1){clearTimeout(resizeTimeout)}resizeTimeout=setTimeout(function(){resizeTimeout=-1;_this.resize();_this.arrangeTiles()},500)})}},maxColumns:function(){return this.columns},resize:function(){var tile_dimensions=this.options.tile;this.columns=Math.floor(this.element.width()/(tile_dimensions.size.width+tile_dimensions.margin.horizontal));var margins=(this.element.width()-this.columns*(tile_dimensions.size.width+tile_dimensions.margin.horizontal))/2;this.element.css({"margin-left":margins,"margin-right":margins})},addTile:function(width,height,id,body,nonremovable){width=width||1;height=height||1;var tile_dimensions=this.tileDimensions();var tile_margins=this.tileMargins();var pos=this.findFreeSpace(width,height)[0];var tiles=this.element.find("."+this.options.tileClass);var tile='<div class="'+this.options.tileClass+'"';if(id!=undefined){tile+=' id="'+id+'"'}tile+=">";if(body!=undefined){tile+=body}tile+="</div>";$(tile).appendTo(this.element).grid_tile({width:width,height:height,longpress:this.options.longpress}).grid_tile("setAt",pos[0],pos[1]).attr("grid-index",tiles.length).attr("nonremovable",nonremovable);this.reIndex();$(tile).zIndex(this.element.zIndex()+1);return tile},tileDimensions:function(width,height){if(width==undefined||height==undefined){return this.options.tile.size}this.options.tile.size.width=width;this.options.tile.size.height=height;this.element.find("."+this.options.tileClass).grid_tile("resize");var tile_dimensions=this.options.tile;this.columns=Math.floor(this.element.width()/(tile_dimensions.size.width+tile_dimensions.margin.horizontal));this.arrangeTiles();var margins=(this.element.width()-this.columns*(tile_dimensions.size.width+tile_dimensions.margin.horizontal))/2;this.element.css({"margin-left":margins,"margin-right":margins})},tileMargins:function(hotizontal,vertical){if(hotizontal==undefined||vertical==undefined){return this.options.tile.margin}this.options.tile.margin.horizontal=horizontal;this.options.tile.margin.vertical=vertical;this.element.find("."+this.options.tileClass).grid_tile("resize");var tile_dimensions=this.options.tile;this.columns=Math.floor(this.element.width()/(tile_dimensions.size.width+tile_dimensions.margin.horizontal));this.arrangeTiles()},findFreeSpace:function(width,height){var _this=this;var row=0;var column=0;var positions=[];var verify_tiles=[];var sort_column=function(a,b){return $(a).grid_tile("column")-$(b).grid_tile("column")};var sort_rows=function(a,b){return $(a).grid_tile("row")-$(b).grid_tile("row")};var tiles=_this.element.find("."+_this.options.tileClass).sort(sort_rows);var highest_row=tiles.length?$(tiles[tiles.length-1]).grid_tile("row")+1:0;var build_verify_array=function(row){var tiles=_this.element.find("."+_this.options.tileClass+"[grid-row="+row+"]");$(verify_tiles).each(function(index,tile){var tile_row=$(tile).grid_tile("row");var tile_height=$(tile).grid_tile("height");if(tile_row+tile_height>row){tiles.push(tile)}});verify_tiles=tiles;verify_tiles.sort(sort_column)};var verify_row=function(column,row){var tiles=_this.element.find("."+_this.options.tileClass+"[grid-row="+row+"]").sort(sort_column);var hit=true;$(tiles).each(function(index,tile){var tile_column=$(tile).grid_tile("column");var tile_width=$(tile).grid_tile("width");var overlap=!(tile_column+tile_width<=column||tile_column>=column+width);if(overlap){hit=false}});return hit};var is_available=function(diff,column,row){for(var x=0;x<diff-width+1;x++){if(_this.tilesInRange(column+x,row,width,height).length==0){positions.push([column+x,row])}}return undefined};build_verify_array(row);while(row<=highest_row){column=0;verify_tiles.each(function(index,tile){var current_column=$(tile).grid_tile("column");var diff=current_column-column;if(diff>=width){is_available(diff,column,row)}column=current_column+$(tile).grid_tile("width");if(column>_this.columns){return false}});var diff=_this.columns-column;if(diff>=width){is_available(diff,column,row)}row+=1;build_verify_array(row)}positions.push([0,highest_row+1]);return positions},overlaps:function(tile,column,row,width,height){var rect1={top:$(tile).grid_tile("row"),bottom:$(tile).grid_tile("row")+$(tile).grid_tile("height"),left:$(tile).grid_tile("column"),right:$(tile).grid_tile("column")+$(tile).grid_tile("width")};var rect2={};switch(arguments.length){case 2:var tile2=column;rect2={top:$(tile2).grid_tile("row"),bottom:$(tile2).grid_tile("row")+$(tile2).grid_tile("height"),left:$(tile2).grid_tile("column"),right:$(tile2).grid_tile("column")+$(tile2).grid_tile("width")};break;case 5:rect2={top:row,bottom:row+height,left:column,right:column+width};break}return!(rect1.bottom<=rect2.top||rect1.top>=rect2.bottom||rect1.left>=rect2.right||rect1.right<=rect2.left)},tileAt:function(column,row){var _this=this;var theTile=[];var tiles=_this.element.find("."+_this.options.tileClass);$(tiles).each(function(index,tile){if(_this.overlaps(tile,column,row,1,1)){theTile=$(tile)}});return theTile},tilesInRange:function(column,row,width,height){var _this=this;var theTiles=[];var sort_rows=function(a,b){return $(a).grid_tile("row")-$(b).grid_tile("row")};var tiles=_this.element.find("."+_this.options.tileClass).sort(sort_rows);var h=height||(tiles.length?row-$(tiles[tiles.length-1]).grid_tile("row")+1:1);var w=width||column-this._columns+1;$(tiles).each(function(index,tile){if($(tile).hasClass("drag")){return true}if(_this.overlaps(tile,column,row,w,h)){theTiles.push($(tile))}});return theTiles},showPlaceHolder:function(column,row,width,height){var tile_dimensions=this.tileDimensions();var tile_margins=this.tileMargins();this._placeholder.css({position:"absolute",width:width*tile_dimensions.width+(width-1)*tile_margins.horizontal,height:height*tile_dimensions.height+(height-1)*tile_margins.vertical,"margin-top":tile_margins.vertical/2,"margin-bottom":tile_margins.vertical/2,"margin-left":tile_margins.horizontal/2,"margin-right":tile_margins.horizontal/2,left:column*(tile_dimensions.width+tile_margins.horizontal),top:row*(tile_dimensions.height+tile_margins.vertical)}).show()},hidePlaceHolder:function(){this._placeholder.fadeOut("slow")},movePlaceHolder:function(column,row){var tile_dimensions=this.tileDimensions();var tile_margins=this.tileMargins();this._placeholder.css({left:column*(tile_dimensions.width+tile_margins.horizontal),top:row*(tile_dimensions.height+tile_margins.vertical)});this._placeholder.show(0)},reIndex:function(){var _this=this;var grid_index=1;var sort_rows=function(a,b){return $(a).grid_tile("row")-$(b).grid_tile("row")};var sort_column=function(a,b){return $(a).grid_tile("column")-$(b).grid_tile("column")};var tiles=this.element.find("."+this.options.tileClass).sort(sort_rows);var highest_row=tiles.length?$(tiles[tiles.length-1]).grid_tile("row")+1:0;for(var row=0;row<highest_row;row++){var tiles=_this.element.find("."+this.options.tileClass+"[grid-row="+row+"]").sort(sort_column);$(tiles).each(function(index,tile){$(tile).attr("grid-index",grid_index);grid_index++})}if(this.options.autoposition){this.arrangeTiles()}},arrangeTiles:function(){var _this=this;var sort_index=function(a,b){return $(a).attr("grid-index")-$(b).attr("grid-index")};var tiles=this.element.find("."+this.options.tileClass).sort(sort_index);var row=0;var column=0;$(tiles).each(function(index,tile){var grid_index=parseInt($(tile).attr("grid-index"));do{if(column+$(tile).grid_tile("width")>_this.columns){column=0;row++}var overlappingTiles=_this.tilesInRange(column,row,$(tile).grid_tile("width"),$(tile).grid_tile("height"));var isOccupied=false;$(overlappingTiles).each(function(index,overlap){if(parseInt($(overlap).attr("grid-index"))<grid_index){isOccupied=true;column=$(overlap).grid_tile("column")+$(overlap).grid_tile("width");if(column>_this.columns){row++;column=0}}})}while(isOccupied);$(tile).grid_tile("moveTo",column,row);column+=$(tile).grid_tile("width");if(column>_this.columns){row++;column=0}})},shiftTiles:function(startIndex,offset,stopIndex){var _this=this;var sort_index=function(a,b){if(offset<0){return $(b).attr("grid-index")-$(a).attr("grid-index")}else{return $(a).attr("grid-index")-$(b).attr("grid-index")}};var tiles=this.element.find("."+this.options.tileClass).sort(sort_index);$(tiles).each(function(index,tile){var grid_index=parseInt($(tile).attr("grid-index"));if(offset<0){if(grid_index<=startIndex&&grid_index>=stopIndex){$(tile).attr("grid-index",grid_index+offset)}}else{if(grid_index>=startIndex&&grid_index<=stopIndex){$(tile).attr("grid-index",grid_index+offset)}}})},tiles:function(){var sort_index=function(a,b){return $(a).attr("grid-index")-$(b).attr("grid-index")};var tiles=this.element.find("."+this.options.tileClass).sort(sort_index);return tiles},tile:function(index){return this.element.find("."+this.options.tileClass+"[grid-index="+index+"]")},select:function(index){if(index==undefined){var selected=this.element.find("."+this.options.tileClass+".selected");if(selected.length==0){return 0}return parseInt(selected.attr("grid-index"))}this.element.find("."+this.options.tileClass+".selected").removeClass("selected");this.element.find("."+this.options.tileClass+"[grid-index="+index+"]").addClass("selected")},selectByHover:function(elt){this.element.find("."+this.options.tileClass+".selected").removeClass("selected");elt.addClass("selected")},activateSelected:function(){this.element.find("."+this.options.tileClass+".selected").trigger("activate")},inDropZone:function(tile){if(this.options.dropzone==undefined){return{}}var dropzones=this.element.parent().find(this.options.dropzone);var dropzone={};var tile_position=$(tile).position();var grid_position=this.element.position();tile_position.left+=grid_position.left;tile_position.top+=grid_position.top;var tile_rect={top:tile_position.top,bottom:tile_position.top+$(tile).outerHeight(),left:tile_position.left,right:tile_position.left+$(tile).outerWidth()};$.each(dropzones,function(key,value){var dropzone_pos=$(this).position();var rect={top:dropzone_pos.top,bottom:dropzone_pos.top+$(this).outerHeight(),left:dropzone_pos.left,right:dropzone_pos.left+$(this).outerWidth()};var overlaps=!(tile_rect.bottom<=rect.top||tile_rect.top>=rect.bottom||tile_rect.left>=rect.right||tile_rect.right<=rect.left);if(overlaps){dropzone=this;return false}return true});return dropzone},dropzones:function(){if(this.options.dropzone==undefined){return $()}return this.element.parent().find(this.options.dropzone)},insertTiles:function(){return this.options.insert},isDragEnable:function(){return this.options.enableDrag}});$.widget("sah.grid_tile",{options:{width:1,height:1,longpress:true,downEvent:"mousedown",moveEvent:"mousemove",upEvent:"mouseup"},_create:function(){var _this=this;var tile_dimensions=this.element.parent().grid("tileDimensions");var tile_margins=this.element.parent().grid("tileMargins");var width=this.options.width;var height=this.options.height;this.element.css({width:width*tile_dimensions.width+(width-1)*tile_margins.horizontal,height:height*tile_dimensions.height+(height-1)*tile_margins.vertical,position:"absolute","margin-top":tile_margins.vertical/2,"margin-bottom":tile_margins.vertical/2,"margin-left":tile_margins.horizontal/2,"margin-right":tile_margins.horizontal/2}).attr("grid-column",0).attr("grid-row",0);var browser=window["get_browser_info"]();if(browser.name=="msie"&&browser.version==10){this.options.downEvent="MSPointerDown";this.options.moveEvent="MSPointerMove";this.options.upEvent="MSPointerUp"}var longpress=-1;var zindex=0;var start_row=0;var start_column=0;var pos_left=function(position){var grid_column=position.left/(tile_dimensions.width+tile_margins.horizontal);var max_columns=_this.element.parent().grid("maxColumns");if(grid_column<0){grid_column=0}if(grid_column+_this.width()>max_columns){grid_column=max_columns-_this.width()}var column_left=Math.floor(grid_column);var column_right=Math.ceil(grid_column);if(grid_column-column_left<column_right-grid_column){return column_left}else{return column_right}};var pos_top=function(position){var grid_row=position.top/(tile_dimensions.height+tile_margins.vertical);if(grid_row<0){grid_row=0}var row_top=Math.floor(grid_row);var row_bottom=Math.ceil(grid_row);if(grid_row-row_top<row_bottom-grid_row){return row_top}else{return row_bottom}};var pos_drag=function(e){e=jQuery.event.fix(e);var left=0,top=0;var position={left:0,top:0};if(e.type=="touchstart"||e.type=="touchmove"||e.type=="touchend"){position.left=e.originalEvent.changedTouches[0].pageX-_this.element.parent().offset().left;position.top=e.originalEvent.changedTouches[0].pageY-_this.element.parent().offset().top}else{var px=e.pageX;var py=e.pageY;if(px==undefined||py==undefined){px=jQuery.event.pageX;py=jQuery.event.pageY}position.left=px-_this.element.parent().offset().left;position.top=py-_this.element.parent().offset().top}return position};var start_drag=function(){if(longpress==-1){console.log("unexpected longpress timeout");return}longpress=-1;var offset_left=0;var offset_top=0;var drag_started=false;_this.element.off(_this.options.moveEvent+" touchmove pointermove");_this.element.off(_this.options.downEvent+" touchstart pointerdown");_this.element.off(_this.options.upEvent+" touchend pointerup");_this.element.addClass("drag");_this.element.parent().on(_this.options.upEvent+" touchend pointerup",function(e){_this.element.parent().off(_this.options.moveEvent+" touchmove pointermove");_this.element.parent().off(_this.options.upEvent+" touchend pointerup");stop_drag(e,offset_left,offset_top)});_this.element.trigger("tiledrag_start",_this.element);_this.element.zIndex(2010);_this.element.parent().grid("showPlaceHolder",_this.column(),_this.row(),_this.options.width,_this.options.height);_this.element.parent().on(_this.options.moveEvent+" touchmove pointermove",function(e){var pos=pos_drag(e);if(!drag_started){var position=_this.element.position();offset_left=position.left-pos.left;offset_top=position.top-pos.top;drag_started=true;start_row=_this.row();start_column=_this.column()}pos.left+=offset_left;pos.top+=offset_top;_this.element.css({left:pos.left,top:pos.top});var dropzone=_this.element.parent().grid("inDropZone",_this.element);if(!$.isEmptyObject(dropzone)){$(dropzone).addClass("sah_ui_drop_here");_this.element.parent().grid("hidePlaceHolder")}else{_this.element.parent().grid("dropzones").removeClass("sah_ui_drop_here");_this.element.parent().grid("movePlaceHolder",pos_left(pos),pos_top(pos))}e.preventDefault();e.stopPropagation()})};var stop_drag=function(e,offset_left,offset_top){var sort_size=function(a,b){var size_a=$(a).grid_tile("width")*$(a).grid_tile("height");var size_b=$(b).grid_tile("width")*$(b).grid_tile("height");if(size_a!=size_b){return size_b-size_a}return $(a).grid_tile("index")-$(b).grid_tile("index")};var pos=pos_drag(e);pos.left+=offset_left;pos.top+=offset_top;var column=pos_left(pos);var row=pos_top(pos);var dropzone=_this.element.parent().grid("inDropZone",_this.element);if(!$.isEmptyObject(dropzone)){column=start_column;row=start_row}var tilesToMove=_this.element.parent().grid("tilesInRange",column,row,_this.options.width,_this.options.height);_this.element.parent().grid("hidePlaceHolder");_this.element.removeClass("drag");_this.element.animate({left:column*(tile_dimensions.width+tile_margins.horizontal),top:row*(tile_dimensions.height+tile_margins.vertical)},"fast",function(){_this.element.zIndex(zindex);if(_this.element.parent().grid("isDragEnable")==true){_this.element.on(_this.options.downEvent+" touchstart pointerdown",start_longpress)}});$(tilesToMove).sort(sort_size);if(!_this.element.parent().grid("insertTiles")||tilesToMove.length==0){_this.element.attr("grid-column",column);_this.element.attr("grid-row",row);$(tilesToMove).each(function(index,tile){$(tile).attr("grid-column",-1).attr("grid-row",-1)});$(tilesToMove).each(function(index,tile){var width=$(tile).grid_tile("width");var height=$(tile).grid_tile("height");var freeSpaces=_this.element.parent().grid("findFreeSpace",width,height);$(tile).grid_tile("moveTo",freeSpaces[0][0],freeSpaces[0][1])});_this.element.parent().grid("reIndex")}else{if(tilesToMove.length!=0){var offset=1;var stopIndex=_this.index();var startIndex=$(tilesToMove[0]).grid_tile("index");if(_this.index()<$(tilesToMove[0]).grid_tile("index")){offset=-1}_this.index(0);_this.element.parent().grid("shiftTiles",startIndex,offset,stopIndex);_this.index(startIndex);_this.element.parent().grid("arrangeTiles")}}_this.element.trigger("tiledrag_end",_this.element);if(!$.isEmptyObject(dropzone)){_this.element.trigger("tiledrop",_this.element,dropzone)}};var start_longpress=function(e){if(e.which>1)return false;if(longpress!=-1){return}var index=parseInt(_this.element.attr("grid-index"));_this.element.parent().grid("select",index);var position=pos_drag(e);var startX=position.left,startY=position.top;_this.element.on(_this.options.moveEvent+" touchmove pointermove",function(e){var position=pos_drag(e);if(Math.abs(position.left-startX)>10||Math.abs(position.top-startY)>10){_this.element.off(_this.options.moveEvent+" touchmove pointermove "+_this.options.upEvent+" touchend pointerup");if(longpress!=-1){clearTimeout(longpress);longpress=-1}}});_this.element.on(_this.options.upEvent+" touchend pointerup",function(e){if(longpress!=-1){clearTimeout(longpress);longpress=-1}_this.element.off(_this.options.upEvent+" touchend pointerup");_this.element.trigger("activate")});if(_this.element.parent().grid("isDragEnable")==true&&_this.element.attr("nonremovable")!="1"){if(_this.options.longpress){longpress=setTimeout(start_drag,1e3)}else{longpress=setTimeout(start_drag,200)}}};this.element.on(this.options.downEvent+" touchstart pointerdown",start_longpress)},resize:function(width,height){width=width||this.options.width;height=height||this.options.height;var tile_dimensions=this.element.parent().grid("tileDimensions");var tile_margins=this.element.parent().grid("tileMargins");this.element.animate({width:width*tile_dimensions.width+(width-1)*tile_margins.horizontal,height:height*tile_dimensions.height+(height-1)*tile_margins.vertical},"fast");this.options.width=width;this.options.height=height},column:function(){return parseInt(this.element.attr("grid-column"),10)},row:function(){return parseInt(this.element.attr("grid-row"),10)},width:function(){return this.options.width},height:function(){return this.options.height},index:function(new_index){if(new_index==undefined){return parseInt(this.element.attr("grid-index"),10)}else{this.element.attr("grid-index",new_index)}},setAt:function(column,row){var tile_dimensions=this.element.parent().grid("tileDimensions");var tile_margins=this.element.parent().grid("tileMargins");this.element.css({left:column*(tile_dimensions.width+tile_margins.horizontal),top:row*(tile_dimensions.height+tile_margins.vertical)}).attr("grid-column",column).attr("grid-row",row)},moveTo:function(column,row){var tile_dimensions=this.element.parent().grid("tileDimensions");var tile_margins=this.element.parent().grid("tileMargins");var position=this.element.position();var _this=this;var new_pos={};var new_left=column*(tile_dimensions.width+tile_margins.horizontal);var new_top=row*(tile_dimensions.height+tile_margins.vertical);if(Math.ceil(new_top)==Math.ceil(position.top)&&Math.ceil(new_left)==Math.ceil(position.left)){return _this}if(Math.ceil(new_left)!=Math.ceil(position.left)){new_pos["left"]=new_left}if(Math.ceil(new_top)!=Math.ceil(position.top)){new_pos["top"]=new_top}this.element.zIndex(2e3);this.element.animate(new_pos,"slow",function(){_this.element.zIndex("auto").css({left:new_left,top:new_top})}).attr("grid-column",column).attr("grid-row",row)}})});