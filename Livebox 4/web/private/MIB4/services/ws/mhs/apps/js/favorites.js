define(["jquery","jquery-ui","lib/sah-core/sah"],function($){"use strict";$.widget("sah.favapp",{_create:function(){this.element.addClass("favapp");this.collectFavoriteData();this.displayFavorites();this.element.append("<div class='back-container'><button id='back'><span translate='common.back'></span></button><div>");this.setAppCloseButton("back");SAH.currentTranslator().run(this.element);console.log("loaded favorites app")},_destroy:function(){this.element.removeClass("favapp");console.log("destroyed favorites app")},collectFavoriteData:function(){this.manifests=SAH.Manifests.manifests;this.categories=SAH.Manifests.category.slice();this.apps={};for(var i=0;i<this.categories.length;i++){this.apps[this.categories[i]]=[]}for(var i=0;i<this.manifests.length;i++){for(var app=0;app<this.manifests[i].option("applets");app++){console.log(this.manifests[i].option("category"));if(this.manifests[i].option("category")=="Favorites")continue;this.apps[this.manifests[i].option("category")].push({manifest:this.manifests[i],index:app})}}},displayFavorites:function(){var node=$("<div></div>");for(var i=0;i<this.categories.length;i++){node.append(this.addCategorySection(this.categories[i]))}$(".sah_app").append(node);SAH.TranslateObj.putTranslation(".sah_app")},addCategorySection:function(cat){var node=$("<div class=category><div class=title></div></div>");node.find(".title").translate("categories."+cat);for(var i=0;i<this.apps[cat].length;i++){node.append(this.addApp(this.apps[cat][i]))}return node},addApp:function(app){var node=$('<div class=item><input type="checkbox"></input><label></label><label></label></div>');if(app.manifest.isFavorite(app.index)){node.find("input").prop("checked",true)}else{node.find("input").prop("checked",false)}var title=app.manifest.applet()[app.index].settings.title||app.manifest.applet()[app.index].name||app.manifest.option("title");node.find("label").eq(1).addClass("Translation");node.find("label").eq(1).attr("data-translation",title);node.click(function(){SAH.WM.addToFavorites(app.manifest,app.index);if(app.manifest.isFavorite(app.index)){console.log("App favorited");node.find("input").prop("checked",true)}else{console.log("App unfavorited");node.find("input").prop("checked",false)}});return node},setAppCloseButton:function(aId){$(document).off("click","#"+aId);$(document).off("keypress","#"+aId);if(typeof window.parent.SAH!=="undefined"){$(document).on("click","#"+aId,function(){$("#"+aId).off("click");this.closeApp(this._launchedAppManifest)}.bind(window.parent.SAH.WM))}else{$(document).on("click","#"+aId,function(){$("#"+aId).off("click");window.history.back()})}$(document).on("keypress","#"+aId,function(event){var keyCode=event.keyCode||event.which;if(keyCode===13){event.preventDefault();$("#"+aId).trigger("click");$("#"+aId).off("keypress")}})}})});