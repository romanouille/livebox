define(["jquery","jquery-ui","lib/sah-core/sah"],function($){"use strict";$.widget("sah.slider2",{options:{slides:[],useRandomAnimations:undefined},_count:0,_animRunning:false,_timerId:undefined,_tileUpDuration:3e3,_randomTimerId:undefined,_obj:undefined,_create:function(){console.log("app slider: slides = "+this.options.slides);var self=this;$(this.element.find(".title")).attr("translate",this.options.title||this.options.manifest.option("title"));var element=this.element.find(".slider");for(var index=0;index<this.options.slides.length;index++){var content=this.options.slides[index];var pattern="{{title}}";if(content.indexOf(pattern)>=0){content=content.replace(pattern,this.options.title||this.options.manifest.option("title"))}var item='<div class="slider-item">'+content+"</div>";if(index>0){item="<div class=empty></div>"+item}console.log("adding slider item"+item);element.append(item)}if(this._popup){this._popup()}else if(this.options.manifest.isApplication()){this.element.on("activate",function(){SAH.WM.launchApp(this.options.manifest)}.bind(this))}SAH.currentTranslator().run(self.element).done(function(){var height=self.element.find(".title:first-child").outerHeight();self.element.find(".empty").css("height",height+"px")})},_retrieveElem:function(){var self=this;if(this.options.apicalls!=undefined){var ac=this.options.apicalls;var prom;if(self._handleApi){var obj=this._obj=new SAH.Object(ac.ws);prom=this._handleApi()}else if(ac.ws!=undefined){var ws=ac.ws.split(":");var obj=this._obj=new SAH.Object(ws[0]);prom=obj.invoke(ws[1])}if(prom!=undefined){$.when(SAH.currentTranslator().isLoaded(),prom).then(function(a1,a2){var a2a,a2b;if(a2 instanceof Array){a2a=a2[0];a2b=a2[1]}else{a2a=a2}self._updateElem(ac,a2a,a2b)})}}},_updateElem:function(ac,data,data2){var result;var lookupid;var tr=SAH.currentTranslator();if(ac.filter==undefined&&ac.filter2==undefined){result=data}else if(ac.filter){result=data[ac.filter]}else if(ac.filter2){var p=ac.filter2.split(".");var val=data2;for(var j=0;j<p.length&&val!=undefined;j++){val=val[p[j]]}if(typeof val=="boolean"){lookupid=val?"common.enabled":"common.disabled"}else if(val==undefined){lookupid=ac.onerror_string?ac.onerror_string:"common.error"}result=val}if(ac.translate_prefix){lookupid=ac.translate_prefix+"."+result.toLowerCase();var prev=result;result=tr.lookup(lookupid);if(result==lookupid){result=prev;lookupid=undefined}}var el=this.element.find(".slider-item > div ."+ac["class"]);var prev=el.html();if(prev!=result){if(lookupid){el.translate(lookupid)}else{el.html(result)}this._startAnim()}},_handleEvents:function(obj,ac,f){var self=this;var ev=ac.event;if(ev==undefined)return;for(var i=0;i<ev.length;i++){obj.subscribe(ev[i],function(e){console.log("ev incoming");var prom;if(self._handleApi){prom=self._handleApi(e)}else{prom=obj.invoke(f)}prom.done(function(d,d2){self._updateElem(ac,d,d2)})})}},start:function(){var self=this;if(this.options.slides.length==0){return}this._retrieveElem();if(this.options.apicalls!=undefined){var ac=this.options.apicalls;if(ac.ws!=undefined){var ws=ac.ws.split(":");var obj=this._obj;self._handleEvents(obj,ac,ws[1])}}var anims=this.options.useRandomAnimations===undefined?SAH.WM.options.useRandomAnimations:this.options.useRandomAnimations;if(anims){this._startRandomAnim()}},_startAnim:function(){var self=this;if(!self._animRunning&&self.options.slides.length>1){var height=this.element.height();var element=this.element.find(".slider");if(height!=self.element.height()){self.stop();self.start()}self._animRunning=true;element.animate({top:"-="+height+"px"},400,"swing");self._timerId=setTimeout(function(){element.animate({top:"+="+height+"px"},400,"swing");self._animRunning=false},self._tileUpDuration)}},_startRandomAnim:function(){var self=this;var interval=Math.floor(Math.random()*6e3+8e3);this._randomTimerId=setTimeout(function(){self._startAnim();self._startRandomAnim()},interval)},stop:function(){var element=$(this.element).find(".slider");element.finish();clearTimeout(this._timerId);clearTimeout(this._randomTimerId);element.css({top:"0px"});this._animRunning=false;if(this._obj)this._obj.unsubscribe();this._count=0},resize:function(){}})});