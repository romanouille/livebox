define(["jquery","jquery-ui","lib/sah-core/sah","tiles/slider"],function($){"use strict";$.widget("sah.slider_access",$.sah.slider2,{_updateElem:function(ac,data,data2){this._super(ac,data,data2);this.element.find(".slider-item > div .accesstype").html(data.LinkType);this.element.find(".slider-item > div .accessproto").html(data.ConnectionProtocol)}});$.widget("sah.slider_wificount",$.sah.slider2,{_handleApi:function(){var deferred=$.Deferred();this._obj.invoke("Devices","find",{expression:".Active == true and (wifi physical)"}).done(function(data){deferred.resolve(data.length)});return deferred.promise()}});$.widget("sah.slider_phone",$.sah.slider2,{_handleApi:function(){var deferred=$.Deferred();this._obj.invoke("VoiceService.VoiceApplication","getCallList",{}).done(function(data){var cnt=0;for(var i=0;i<data.length;i++){if(data[i].callType=="failed"||data[i].callType=="missed")cnt++}deferred.resolve(cnt)});return deferred.promise()},_popup:function(){console.log("loading slider_4g popup");var self=this;var popup=this.element.find(".sah_popup");this.popup=popup;var manifest=this.options.manifest;this.enabled=false;$(popup).sah_dialog({buttons:[{translate:"common.back",click:function(){popup.sah_dialog("close")}}],actions:{close:false,back:true,favorite:true,remove:false,reload:false},manifest:this.options.manifest,index:this.options.index});popup.find(".sah_dialog_body .title").translate(manifest.option("title"));var html=$("<div class=textCenter translate=sah_phone.reset></div>"+"<div class=textCenter><button></button></div>");popup.find(".sah_dialog_body").append(html);html.find("button").button().click(function(){self._obj.invoke("VoiceService.VoiceApplication","clearCallList",{}).done(function(data){self._retrieveElem()})}).find(".ui-button-text").attr("translate","sah_phone.clear");SAH.currentTranslator().run(popup.find(".sah_dialog_body"));this.element.on("activate",function(){popup.sah_dialog("open")})}});$.widget("sah.slider_notification",$.sah.slider2,{_handleApi:function(){var deferred=$.Deferred();this._obj.invoke("Message","listMessages").done(function(data){var msg=data.length>0?data[data.length-1].Message.substr(0,40)+"...":"no messages";deferred.resolve(msg)});return deferred.promise()}});$.widget("sah.slider_contact",$.sah.slider2,{_handleEvents:function(obj,ac,f){var self=this;var ev=ac.event;if(ev==undefined)return;for(var i=0;i<ev.length;i++){obj.subscribe(ev[i],function(e){obj.invoke(f).done(function(d,d2){self._updateElem(ac,d,d2);var ev=e.object;if(ev.reason=="contactCreated"||ev.reason=="contactDeleted"){self.element.find(".slider-item:last-child").append('<div class="status contactevent" style="top:45%"><span class=caption>'+"<span class=black><span translate=sah_contacts."+ev.reason+"></span>: <span class=sah_green_dark>"+ev.attributes.contact.formattedName+"</span></div>");SAH.currentTranslator().run(self.element);setTimeout(function(){self.element.find(".slider-item:last-child > .contactevent").remove()},8e3)}})})}}});Array.prototype.max=function(){return this.reduce(function(p,v){return p>v?p:v})};$.widget("sah.slider_4g",$.sah.slider2,{_popup:function(){console.log("loading slider_4g popup");var self=this;var popup=this.element.find(".sah_popup");this.popup=popup;var manifest=this.options.manifest;this.enabled=false;$(popup).sah_dialog({buttons:[{translate:"common.enable",click:function(){if(self.enabled)self.disable4G();else self.enable4G()}}],defaultButton:"Enter",actions:{close:false,back:true,favorite:true,remove:false,reload:false},manifest:this.options.manifest,index:this.options.index,close:function(){clearInterval(self.timer);this._super()}});popup.find(".sah_dialog_body .title").translate(manifest.option("title"));var html=$('<div class="dark s1"><span translate=fourg.state1></span>: <span class=white translate=common.disabled></span></div>'+"<br><div class=dark translate=fourg.stats></div>"+'<div class="dark stats1 statstext"><span translate=fourg.rx></span>: <span class=white>0</span><span class=white> KB</span> (<span class=white>0</span><span class=white> kbps</span>)</div>'+'<div class="dark stats2 statstext"><span translate=fourg.tx></span>: <span class=white>0</span><span class=white> KB</span> (<span class=white>0</span><span class=white> kbps</span>)</div>');popup.find(".sah_dialog_body").append(html);SAH.currentTranslator().run(popup.find(".sah_dialog_body"));$("<div class=stats></div>").appendTo(popup.find(".sah_dialog_body"));this.element.on("activate",function(){popup.parent().css("width","400px");popup.sah_dialog("open");self.stats={rx:new Array,tx:new Array};self.initGraph();self.is4GEnabled().done(function(state){if(state){self.popup.next().find("button").translate("common.disable");self.popup.find(".s1 span:last-child").translate("common.enabled");self.enabled=true;self.startTimer()}else{self.popup.next().find("button").translate("common.enable");self.enabled=false}})});this.element.find(".dialog_action_back").click(function(){clearInterval(self.timer)})},enable4G:function(){var self=this;self.popup.find(".s1 span:last-child").translate("common.enabling");var obj=new SAH.Object;obj.invoke("NMC.WWAN","setWWanMode",{mode:"Enable"}).done(function(res){self.popup.find(".s1 span:last-child").translate("common.enabled");self.popup.next().find("button").translate("common.disable");self.enabled=true}).fail(function(){self.popup.find(".s1 span:last-child").translate("common.error")});$.get("http://bridgeserver/tr-shaping.php?enable=0").done(function(){console.log("tr shaping set to 0")}).fail(function(){console.warn("tr shaping FAILED!")});obj.invoke("QueueManagement","setPolicyClassification",{Id:"test",Key:100,Enable:true,SourceIP:"192.168.1.66",SourceMac:"",Policy:100,Persistent:true}).done(function(){console.log("setting policy classification: done")}).fail(function(){console.warn("setting policy classification FAILED")});self.startTimer()},disable4G:function(){var self=this;self.popup.find(".s1 span:last-child").translate("common.disabling");var obj=new SAH.Object;obj.invoke("NMC.WWAN","setWWanMode",{mode:"Disable"}).done(function(res){self.popup.find(".s1 span:last-child").translate("common.disabled");self.popup.next().find("button").translate("common.enable");self.enabled=false}).fail(function(){self.popup.find(".s1 span:last-child").translate("common.error")});$.get("http://bridgeserver/tr-shaping.php?enable=1").done(function(){console.log("tr shaping set to 1")}).fail(function(){console.warn("tr shaping FAILED!")});obj.invoke("QueueManagement","setPolicyClassification",{Id:"test",Key:100,Enable:false}).done(function(){console.log("removing policy classification: done")}).fail(function(){console.warn("removing policy classification FAILED")});clearInterval(self.timer)},is4GEnabled:function(){var deferred=$.Deferred();var obj=new SAH.Object;obj.invoke("NMC.WWAN","getWWanMode").done(function(res){deferred.resolve(res=="Enable")}).fail(function(){deferred.reject()});return deferred},statlen:25,getStats:function(){var self=this;var obj=new SAH.Object;obj.invoke("NeMo.Intf.wwan","getNetDevStats").done(function(res){var t=(new Date).getTime();var dt=t-self.prev_time;var rxspeed=Math.round((res.RxBytes-self.prev_rx)/dt);var txspeed=Math.round((res.TxBytes-self.prev_tx)/dt);self.stats.rx.push(rxspeed);self.stats.tx.push(txspeed);self.popup.find(".stats1 span:nth-child(2)").html(Math.round(res.RxBytes/1e3));self.popup.find(".stats1 span:nth-child(4)").html(rxspeed*8);self.popup.find(".stats2 span:nth-child(2)").html(Math.round(res.TxBytes/1e3));self.popup.find(".stats2 span:nth-child(4)").html(txspeed*8);if(self.stats.rx.length>self.statlen){self.stats.rx.splice(0,1);self.stats.tx.splice(0,1)}self.prev_time=t;self.prev_rx=res.RxBytes;self.prev_tx=res.TxBytes;self.updateGraph()}).fail(function(){})},initGraph:function(){var self=this;var div=self.popup.find(".stats");var rxgraph=$('<div class="rx graph"></div>');var txgraph=$('<div class="tx graph"></div>');var barwidth=250/self.statlen;for(var i=0;i<self.statlen;i++){$("<div class=bar></div>").css({left:barwidth*i+5+"px",height:5+"px",width:barwidth+"px"}).appendTo(rxgraph);$("<div class=bar></div>").css({left:barwidth*i+5+"px",height:5+"px",width:barwidth+"px"}).appendTo(txgraph)}div.html(rxgraph).append(txgraph)},updateGraph:function(){var self=this;var rx=self.stats.rx;var tx=self.stats.tx;var maxrx=rx.max();var maxtx=tx.max();if(maxrx<20)maxrx=20;if(maxtx<20)maxtx=20;var div=self.popup.find(".stats");for(var i=0;i<self.statlen;i++){div.find(".rx .bar:nth-child("+(i+1)+")").css("height",Math.round(self.stats.rx[i]/maxrx*60)+"px");div.find(".tx .bar:nth-child("+(i+1)+")").css("height",Math.round(self.stats.tx[i]/maxtx*60)+"px")}},startTimer:function(){var self=this;self.getStats();if(self.timer)clearInterval(self.timer);self.timer=setInterval(function(){self.getStats()},2e3)},log:function(str){var el=this.popup.find(".console");el.html(str)}});$.widget("sah.slider_bluetooth",$.sah.slider2,{_expression:".Active == true and (bluetooth device physical)",_handleApi:function(){var deferred=$.Deferred();this._obj.invoke("Devices","find",{expression:this._expression}).done(function(data){deferred.resolve(data.length)});return deferred.promise()},_handleEvents:function(obj,ac,f){var self=this;var ev=ac.event;if(ev==undefined)return;for(var i=0;i<ev.length;i++){obj.subscribe(ev[i],function(e){obj.invoke("Devices","find",{expression:self._expression}).done(function(d){self._tileUpDuration=8e3;self._updateElem(ac,d.length);self._tileUpDuration=3e3;var ev=e.object;var device;for(var key in ev.attributes){device=ev.attributes[key];break}if(!device)device={Name:"Unnamed"};if(ev.reason=="bluetooth_active"||ev.reason=="bluetooth_inactive"){self.element.find(".slider-item:last-child").append('<div class="status btevent" style="top:30%"><span class=caption>'+"<span class=black><span translate=sah_bluetooth."+ev.reason+"></span> <span class=sah_green_dark>"+device.Name+"</span></div>");self.element.find(".slider-item:last-child > div:first-child").hide();SAH.currentTranslator().run(self.element);setTimeout(function(){self.element.find(".slider-item:last-child > .btevent").remove();self.element.find(".slider-item:last-child > div:first-child").show()},9e3)}})})}}})});