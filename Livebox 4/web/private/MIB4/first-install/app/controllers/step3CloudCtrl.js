define(["utils/console","utils/basics","lib/stateCtrlInterface"],function(console,basicUtilities,StateCtrlClass){"use strict";function Step3CloudCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,setLanguage=function(aCallback,aLangId){basicUtilities.queue([function(aNext){fields.sahObj.invokeApi("semantic","sah.Device.Information.setLanguage",aNext,[{languageId:aLangId}])},function(aNext,aResult){if(aResult.status!==0){console.error("Step3CloudCtrlClass: Failed to update default language")}basicUtilities.callback(null,false,0,null)}],this)},onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("Step3CloudCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));if(aData&&aData.langId){setLanguage.call(this,null,aData.langId)}}else if(aEventId==="ViewCancelled"){console.debug("Step3CloudCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewSubmitted"){console.debug("Step3CloudCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));basicUtilities.queue([function(aNext){this.restoreNetwork(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.checkRestoreStatus(aNext)}else{basicUtilities.callback(aNext,false,-1,null);this.getViewObj().notifyError("Step3CloudCtrlClass: Internal error restoreNetwork failed","rra0145")}},function(aNext,aResult){if(!aResult||aResult.status===0){window.setTimeout(function(){aStateManager.switchState(aNext,"step3Success",null)},2e3)}else{window.setTimeout(function(){aStateManager.switchState(aNext,"step3Fail",null)},2e3);this.getViewObj().notifyError("Step3CloudCtrlClass: Internal error checkRestoreStatus failed","rra0145")}}],this)}else{console.warn("Step3CloudCtrlClass: Unexpected event '"+aEventId+"'");this.getViewObj().notifyError("Step3CloudCtrlClass: Unexpected event '"+aEventId+"'","rra0142")}};fields={sahObj:aSahObj,restoreTimer:null};StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("Step3CloudCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("Step3CloudCtrlClass: Initialising state '"+this.getId()+"'","rra0143")}}],this)};this.quit=function(aCallback){console.debug("Step3CloudCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("Step3CloudCtrlClass: Releasing state '"+this.getId()+"'","rra0144")}}],this)};this.enable=function(aCallback){console.debug("Step3CloudCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().enable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("Step3CloudCtrlClass: Enabling state '"+this.getId()+"'","rra0145")}}],this)};this.disable=function(aCallback){console.debug("Step3CloudCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("Step3CloudCtrlClass: Disabling state '"+this.getId()+"'","rra0146")}}],this)};this.checkRestoreStatus=function(aCallback){basicUtilities.queue([function(aNext){this.getNetworkConfig(aNext)},function(aNext,aResult){if(aResult.status===0){if(fields.restoreTimer!==null){window.clearTimeout(fields.restoreTimer)}if(aResult.data.state==="Enabled"){this.backupNetwork(true,aNext)}else{fields.restoreTimer=window.setTimeout(function(){this.checkRestoreStatus(aNext)}.bind(this),5e3)}}else{console.error("Step3CloudCtrlClass: Internal error getNetworkConfig failed");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("Step3CloudCtrlClass: Internal error getNetworkConfig failed","rra0135")}},function(){basicUtilities.callback(aCallback,false,0,null)}],this)};this.restoreNetwork=function(aCallback){console.debug("Step3CloudCtrlClass: restore Network");basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.System.restoreNetwork",aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("Step3CloudCtrlClass: restore Network","rra0109")}}],this)};this.getNetworkConfig=function(aCallback){console.debug("Step3CloudCtrlClass: getNetworkConfig ");basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.System.getBackupAndRestoreNetworkState",aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,aResult.data)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("Step3CloudCtrlClass: getBackupAndRestoreNetworkState failed","rra0142")}}],this)};this.backupNetwork=function(activate,aCallback){console.debug("Step3CloudCtrlClass: backupNetwork ");basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.System.backupNetwork",aNext,{activate:activate})},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("Step3CloudCtrlClass: backupNetwork failed","rra0110")}}],this)};this.restart=function(aCallback){console.debug("Step3CloudCtrlClass: Restarting the box");basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.System.reboot",aNext,null)},function(aNext,aResult){if(aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("Step3CloudCtrlClass: Restarting the box failed","rra0163")}}],this)};this.checkUpBoxAndGoMHS=function(){var self=this;console.debug("Step3CloudCtrlClass: Check up the box status");basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.System.getServicesState",aNext,{serviceList:[]})},function(aNext,aResult){if(aResult.status===0||aResult.status){this.goToHomePage(aNext)}else{window.setTimeout(function(){self.checkUpBoxAndGoMHS()},5e3)}}],this)};this.goToHomePage=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Installation.setInstallationState",aNext,{isInstallationRequired:false,isFirstConnectionRequired:true})},function(aNext,aResult){if(aResult.status===0||aResult.status){this.goToMhs()}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("Step3CloudCtrlClass: Internal Error setInstallationState failed","rra0164")}}],this)}}return Step3CloudCtrlClass});