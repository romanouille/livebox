define(["jquery","jquery-ui"],function($){"use strict";window.SAH=function(){var _currentSession=undefined;var _currentEvm=undefined;var _currentTranslator=undefined;var _currentLanguage="fr";var _etag_d=undefined;var _sessions={};var _eventCallbacks={};var _version=undefined;return{currentSession:function(session){if(session==undefined){return _currentSession}function switchSession(session){if(_currentSession==session){return session}if(_currentSession!=undefined){_currentSession.logout()}_currentSession=session;return session}if(session instanceof SAH.Session){return switchSession(session)}if(typeof session=="string"){if(_sessions[session]!=undefined){session=_sessions[session]}else{session=new SAH.Session(session)}return switchSession(session)}return undefined},currentEvm:function(){if(_currentEvm==undefined){_currentEvm=new SAH.EventManager}return _currentEvm},currentTranslator:function(){if(_currentTranslator==undefined){_currentTranslator=new SAH.Translator(_currentLanguage)}return _currentTranslator},loadLanguage:function(lang){_currentLanguage=lang;_currentTranslator=new SAH.Translator(_currentLanguage);if(_eventCallbacks["language_changed"]){_eventCallbacks["language_changed"].fire(_currentTranslator)}},etag:function(){if(this._etag_d==undefined){this._etag_d=$.Deferred();$.get(document.location).done(function(json,textStatus,jqXHR){var etag=jqXHR.getResponseHeader("etag");this._etag_d.resolve(etag)}.bind(this))}return this._etag_d.promise()},on:function(event,callback){if(_eventCallbacks[event]==undefined){_eventCallbacks[event]=new $.Callbacks}_eventCallbacks[event].add(callback)},off:function(event,callback){if(_eventCallbacks[event]==undefined){return}if(callback==undefined){_eventCallbacks[event].empty()}else{_eventCallbacks[event].remove(callback)}},sessions:function(){return _sessions},closeSession:function(session){if(session==undefined){if(_currentSession==undefined){return}session=_currentSession}var name="";if(typeof session=="string"){name=session}if(session instanceof SAH.Session){name=session.userName()}if(_sessions[name]!=undefined){if(_sessions[name].userName()==_currentSession.userName()){_currentSession=undefined}delete _sessions[name]}},headers:function(idle){var hdr={"Content-Type":"application/x-sah-ws-4-call+json"};if(_currentSession!=undefined){_currentSession.checkSession();hdr["Authorization"]="X-Sah "+_currentSession.context()}if(idle==true){hdr["X-Sah-Request-Type"]="idle"}return hdr},version:function(){var deferred=$.Deferred();if(_version){deferred.resolve(_version);return deferred}$.ajax({type:"GET",url:"/version.txt",success:function(data,textStatus,jqXHR){var version_data=data.split("\n");_version={};for(var i=0;i<version_data.length;i++){var parts=version_data[i].split("=");if(parts[0].length){_version[parts[0]]=parts[1]}}deferred.resolve(_version)},error:function(data,textStatus,jqXHR){deferred.reject()}});return deferred},Session:function(user){var _this=this;var _context=undefined;var _sessid=undefined;var _etag=undefined;var _groups=undefined;var _user_name=user;var _open=false;var _active=$.Deferred();var _keepalive=true;if(_sessions[_user_name]!=undefined){return _sessions[_user_name]}_sessions[_user_name]=_this;$.cookie.raw=true;_this.restore=function(){var deferred=$.Deferred();var obj=new SAH.Object("HTTPService");$.when(SAH.etag()).then(function(etag){SAH.currentSession(_this);_context=$.cookie(etag+"/context");$.when(obj.invoke("getCurrentUser")).then(function(data){if(user&&data.user==user||!user&&data.user!="anonymous"){if(_context==undefined){_context=$.cookie(etag+"/context")}if(!user)_user_name=data.user;$.cookie(etag+"/login",_user_name,{path:"/"});_sessid=$.cookie(etag+"/sessid");_etag=etag;_groups=data.groups;_open=true;SAH.currentSession(_this);_this.setKeepAlive(_keepalive);deferred.resolve()}else{deferred.reject(data)}},function(data,textStatus,jqXHR){deferred.reject(data)});SAH.currentSession(undefined);_context=undefined});return deferred.promise()};_this.login=function(pass){var data={service:"sah.Device.Information",method:"createContext",parameters:{applicationName:"webui",username:_user_name,password:pass}};if(SAH.currentSession()!=undefined){SAH.currentSession().logout()}var deferred=$.Deferred();$.ajax({type:"POST",url:"/ws",headers:{"Content-Type":"application/x-sah-ws-4-call+json",Authorization:"X-Sah-Login"},data:JSON.stringify(data),success:function(json,textStatus,jqXHR){if(json.data){_context=json.data.contextID;SAH.etag().done(function(etag){$.cookie(etag+"/context",_context,{path:"/"});_sessid=$.cookie(etag+"/sessid");$.cookie(etag+"/login",_user_name,{path:"/"});_etag=etag});_groups=json.data.groups.split(",");_open=true;SAH.currentSession(_this);_this.setKeepAlive(_keepalive);deferred.resolve(json);_active.resolve()}else{deferred.reject(json)}},error:function(data,textStatus,jqXHR){deferred.reject()}});return deferred.promise()};_this.logout=function(){var deferred=$.Deferred();if(!_this.isOpen()){deferred.resolve({});return deferred.promise()}var data={service:"sah.Device.Information",method:"releaseContext",parameters:{applicationName:"webui"}};$.ajax({type:"POST",url:"/ws",headers:{"Content-Type":"application/x-sah-ws-4-call+json",Authorization:"X-Sah-Logout "+_context},data:JSON.stringify(data),complete:function(json){_context=undefined;_sessid=undefined;if(_etag){$.removeCookie(_etag+"/context",{path:"/"});$.removeCookie(_etag+"/login",{path:"/"})}_groups=undefined;_open=false;deferred.resolve(json)}});return deferred.promise()};_this.context=function(){return _context};_this.isOpen=function(){return _open};_this.isAvailable=function(){return _active.promise()};_this.userName=function(){return _user_name};_this.setKeepAlive=function(enable){_keepalive=enable;if(enable){if(_timeout_timer){clearTimeout(_timeout_timer);_timeout_timer=undefined}}else{if(!_timeout_timer)pollForTimeout()}};_this.hasKeepAliveEnabled=function(){return _keepalive};_this.checkSession=function(){var sessid_cookie=$.cookie(_etag+"/sessid");if(_etag&&_sessid&&_sessid!=sessid_cookie){if(!_timeout_timer||sessid_cookie){_sessid=undefined;console.warn("session hijacked!");if(_eventCallbacks["session_hijacked"]){_eventCallbacks["session_hijacked"].fire()}}}};var _timeout_timer=undefined;var pollForTimeout=function(){_timeout_timer=setTimeout(function(){var obj=new SAH.Object;$.when(obj.invoke("HTTPService","getCurrentUser",{},true)).then(function(data){if(_user_name){if(data.user==_user_name){pollForTimeout()}else{handleTimeout()}}},function(s,d,e){handleTimeout()})},1e4);var handleTimeout=function(){_timeout_timer=undefined;if(_sessid){_context=undefined;_sessid=undefined;if(_etag){$.removeCookie(_etag+"/context",{path:"/"});$.removeCookie(_etag+"/login",{path:"/"});$.removeCookie(_etag+"/sessid",{path:"/"})}_groups=undefined;_open=false;console.warn("session timed out!");if(_eventCallbacks["session_timeout"])_eventCallbacks["session_timeout"].fire()}}}},EventManager:function(){var subscriptions={};this.subscribe=function(service,event,cb){if(!service||!event||!cb){return}if(!subscriptions[service]){subscriptions[service]={}}if(!subscriptions[service][event]){subscriptions[service][event]=[]}subscriptions[service][event].push(cb);if(subscriptions[service][event].length==1){reopenEventChannel()}};this.unsubscribe=function(service,event,cb){var subs=subscriptions[service][event];if(subs){for(var i=0;i<subs.length;i++){if(subs[i]==cb){subs.splice(i,1);if(subs.length==0){reopenEventChannel()}break}}}};this.trigger=function(events){for(var k=0;k<events.length;k++){var ev=events[k].data;var service=ev.handler;var event=ev.object.reason;var servicelist=service.split(".");var subservice="";for(var i=0;i<servicelist.length;i++){subservice+=servicelist[i];var s=subscriptions[subservice];if(s&&s[event]){for(var j=0;j<s[event].length;j++){s[event][j](ev)}}subservice+="."}}};var eventparams={service:"eventmanager",method:"get_events",parameters:{channelid:0,events:[]}};var latestChannel=0;var timer=null;var reopenEventChannel=function(){if(timer==null){timer=setTimeout(function(){openEventChannel(0)},100)}};var openEventChannel=function(chan){timer=null;latestChannel++;eventparams.parameters.channelid=chan;eventparams.parameters.events=getEventList();var idleflag=false;if(SAH.currentSession()){idleflag=!SAH.currentSession().hasKeepAliveEnabled()}$.ajax({type:"POST",url:"/ws",headers:SAH.headers(idleflag),data:JSON.stringify(eventparams)}).done(function(lc,json){if(latestChannel==lc){var chan=json&&json.status?json.status.channelid:0;openEventChannel(chan)}if(json.status){this.trigger(json.status.events)}else{console.warn("invalid event reply")}}.bind(this,latestChannel)).fail(function(lc,json,textStatus,jqXHR){if(latestChannel==lc){if(textStatus=="parsererror"){console.warn("unable to create event channel, retrying...");setTimeout(function(){openEventChannel(0)},1e3)}else{handleConnectionDown(json)}}}.bind(this,latestChannel))}.bind(this);var getEventList=function(){var evlist=[];for(var s in subscriptions){if(subscriptions.hasOwnProperty(s)){for(var e in subscriptions[s]){if(subscriptions[s].hasOwnProperty(e)&&subscriptions[s][e].length>0){evlist.push({service:s,event:e})}}}}return evlist};var timer=undefined;var handleConnectionDown=function(json){if(timer)return;console.warn("connection lost! retrying in 10s...");if(_eventCallbacks["connection_down"]){_eventCallbacks["connection_down"].fire()}timer=setTimeout(function(){var session=SAH.currentSession();if(session){session.restore().done(function(){handleConnectionRestored();var chan=json&&json.status?json.status.channelid:0;openEventChannel(chan)}).fail(function(data){if(data===-1){handleConnectionDown()}else{handleSessionLost()}})}else{handleSessionLost()}timer=undefined},1e4)};var handleSessionLost=function(){console.warn("connection is back, but could not restore session!");if(_eventCallbacks["session_lost"]){_eventCallbacks["session_lost"].fire()}};var handleConnectionRestored=function(){console.log("connection restored!");if(_eventCallbacks["connection_restored"]){_eventCallbacks["connection_restored"].fire()}};openEventChannel(0)},Object:function(service){var _this=this;_this._loaded=false;_this.service=service||"";_this.subscriptions={}},DMObject:function(service){var _this=this;SAH.Object.call(_this,service);_this.load()},Function:function(object,function_def){var _this=this;_this.name=function_def.name;_this.type=function_def.type;_this.arguments=function_def.arguments||[];if(object instanceof SAH.Object){_this.object=object}},Parameter:function(object,parameter_def){var _this=this;_this.name=parameter_def.name;_this.type=parameter_def.type;_this.value=parameter_def.value;if(object instanceof SAH.Object){_this.object=object}},Translator:function(lang){var self=this;var _lang=lang;var _dictionary={};var loaded;this.load=function(language){loaded=$.Deferred();SAH.etag().done(function(etag){$.getJSON("lang/"+language+".json"+"?"+etag).done(function(json,textStatus,jqXHR){$.each(json,function(key,value){_dictionary[key]=value});loaded.resolve()}).fail(function(data,textStatus,jqXHR){console.error("Language file error: "+textStatus);loaded.reject()})})};this.isLoaded=function(){return loaded};$.fn.translate=function(textid){this.attr("translate",textid).html(self.lookup(textid));return this};this.load(lang);this.lookup=function(id){var ids=id.split(".");var tr=_dictionary;for(var i=0;i<ids.length;i++){tr=tr[ids[i]];if(tr==undefined){tr=id;break}}return tr};this.lookup_lc=function(id){return this.lookup(id).toLowerCase()};this.run=function(el){var self=this;var deferred=$.Deferred();if(el==undefined){el=$("body")}loaded.done(function(){$.map($(el),function(obj){if($(obj).attr("translate")!==undefined){var str=self.lookup($(obj).attr("translate"));$(obj).html(str)}else{$(obj).find("[translate]").each(function(){var str=self.lookup($(this).attr("translate"));$(this).html(str)})}});deferred.resolve()});return deferred.promise()};this.add=function(group,translations){_dictionary[group]=translations};this.currentLanguage=function(){return _lang};this.getCookieLanguage=function(){var lang_d=$.Deferred();var lang=undefined;$.cookie.raw=true;etag().done(function(etag){lang=$.cookie(etag+"/language");lang_d.resolve(lang)});return lang_d}}}}();SAH.Object.prototype.invoke=function(){var deferred=$.Deferred();var service=this.service;var method="";var args={};var idle=false;var arg_array=Array.prototype.slice.call(arguments,0,arguments.length);switch(arg_array.length){case 0:var errors=[{error:404,description:"Not found",info:""}];deferred.reject(errors);return deferred.promise();break;case 1:method=arg_array[0];break;case 2:if($.isPlainObject(arg_array[1])){method=arg_array[0];args=arg_array[1]}else{service=arg_array[0];method=arg_array[1]}break;case 3:service=arg_array[0];method=arg_array[1];args=arg_array[2];break;case 4:service=arg_array[0];method=arg_array[1];args=arg_array[2];idle=arg_array[3];break}var data={service:service,method:method,parameters:args};var deferred=$.Deferred();$.ajax({type:"POST",url:"/ws",headers:SAH.headers(idle),data:JSON.stringify(data),success:function(json){if(typeof json=="undefined"||json==null){deferred.reject(-1,{},[{error:-1,description:"Unknown error",info:""}])}var status=json.status||0;var data=json.data||{};var errors=json.errors||[];if(errors.length==0){deferred.resolve(status,data,errors)}else{deferred.reject(status,data,errors)}},error:function(jqXHR,textStatus){var errors=[{error:jqXHR.status,description:jqXHR.statusText,info:""}];deferred.reject(-1,{},errors)}});return deferred.promise()};SAH.Object.prototype.inspect=function(service){var _this=this;service=service||_this.service;var deferred=$.Deferred();var slash_path=service.replace(/\./g,"/");var url="/ws/"+slash_path+"?_restAttributes=noObject_template_info&_restDepth=0";$.ajax({type:"GET",url:url,headers:SAH.headers(),success:function(json){if(json.error){var errors=[];errors.push(json);deferred.reject(errors);return}var object_functions=json.functions||[];var object_children=json.children||[];var object_instances=json.instances||[];var object_parameters=json.parameters||[];var info=json.objectInfo.attributes||{};var functions=[];var objects=[];var parameters=[];for(var i=0;i<object_functions.length;i++){functions.push(new SAH.Function(service,object_functions[i]))}for(var i=0;i<object_children.length;i++){var child=object_children[i].objectInfo.key;objects.push(child)}for(var i=0;i<object_instances.length;i++){var child=object_instances[i].objectInfo.key;objects.push(child)}for(var i=0;i<object_parameters.length;i++){parameters.push(new SAH.Parameter(service,object_parameters[i]))}deferred.resolve(service,functions,objects,parameters,info)},error:function(jqXHR,textStatus){var errors=[];if(jqXHR.status==200){var pos=jqXHR.responseText.indexOf("[");if(pos!=-1){var data=jqXHR.responseText.substring(pos);var extra_errors=JSON.parse(data);errors.push.apply(errors,extra_errors)}}else{errors=[{error:jqXHR.status,description:jqXHR.statusText,info:""}]}deferred.reject(errors)}});return deferred.promise()};SAH.Object.prototype.load=function(){var _this=this;var deferred=$.Deferred();_this.inspect().then(function(service,functions,objects){for(var i=0;i<functions.length;i++){if(_this[functions[i].name]!=undefined){continue}_this[functions[i].name]=function(){var _this=this;var arg_array=Array.prototype.slice.call(arguments,0,arguments.length);var pcb_arg={};for(var i=0;i<arguments.callee.func_def.arguments.length;i++){if(i<arg_array.length){pcb_arg[arguments.callee.func_def.arguments[i].name]=arg_array[i]}else{break}}return _this.invoke(_this.service,arguments.callee.func_def.name,pcb_arg)};_this[functions[i].name].func_def=functions[i]}_this.loaded=true;deferred.resolve(_this)},function(errors){deferred.reject(errors)});return deferred.promise()};SAH.Object.prototype.isLoaded=function(){return this._loaded};SAH.Object.prototype.isAvailable=function(){var _this=this;var deferred=$.Deferred();if(_this.loaded){deferred.resolve(_this);return deferred.promise()}else{return _this.load()}};SAH.Object.prototype.set=function(){var _this=this;var service=_this.service;var parameter=undefined;var value=undefined;var data={};var arg_array=Array.prototype.slice.call(arguments,0,arguments.length);switch(arg_array.length){case 0:return;break;case 1:data=arg_array[0];break;case 2:if(typeof arg_array[1]=="object"){service=arg_array[0];data=arg_array[1]}else{data[arg_array[0]]=arg_array[1]}break;case 3:service=arg_array[0];data[arg_array[1]]=arg_array[2];break}var deferred=$.Deferred();var slash_path=service.replace(/\./g,"/");var url="/ws/"+slash_path;$.ajax({type:"PUT",url:url,data:JSON.stringify(data),headers:SAH.headers(),success:function(json){var object_parameters=json.parameters||[];var parameters=[];for(var i=0;i<object_parameters.length;i++){parameters[object_parameters[i].name]=object_parameters[i].value}deferred.resolve(parameters)},error:function(jqXHR,textStatus){var errors=[];if(jqXHR.status==200){var pos=jqXHR.responseText.indexOf("[");if(pos!=-1){var data=jqXHR.responseText.substring(pos);var extra_errors=JSON.parse(data);errors.push.apply(errors,extra_errors)}}else{errors=[{error:jqXHR.status,description:jqXHR.statusText,info:""}]}deferred.reject(errors)}});return deferred.promise()};SAH.Object.prototype.get=function(){var _this=this;var service=_this.service;var arg_array=Array.prototype.slice.call(arguments,0,arguments.length);switch(arg_array.length){case 0:break;case 1:service=arg_array[0];break;default:service=arg_array[0];break}var deferred=$.Deferred();var slash_path=service.replace(/\./g,"/");var url="/ws/"+slash_path+"?_restAttributes=noObject_template_info,noObject_instances,noObject_children,noObject_functions&_restDepth=0";$.ajax({type:"GET",url:url,headers:SAH.headers(),success:function(json){var object_parameters=json.parameters||[];var parameters={};for(var i=0;i<object_parameters.length;i++){parameters[object_parameters[i].name]=object_parameters[i].value}deferred.resolve(parameters)},error:function(jqXHR,textStatus){var errors=[];if(jqXHR.status==200){var pos=jqXHR.responseText.indexOf("[");if(pos!=-1){var data=jqXHR.responseText.substring(pos);var extra_errors=JSON.parse(data);errors.push.apply(errors,extra_errors)}}else{errors=[{error:jqXHR.status,description:jqXHR.statusText,info:""}]}deferred.reject(errors)}});return deferred.promise()};SAH.Object.prototype.addInstance=function(){var _this=this;var service=_this.service;var parameter=undefined;var value=undefined;var data={};var arg_array=Array.prototype.slice.call(arguments,0,arguments.length);switch(arg_array.length){case 0:break;case 1:if($.isPlainObject(arg_array[0])){data=arg_array[0]}else{service=arg_array[0]}break;case 2:if($.isPlainObject(arg_array[1])){service=arg_array[0];data=arg_array[1]}else{data[arg_array[0]]=arg_array[1]}break;case 3:service=arg_array[0];data[arg_array[1]]=arg_array[2];break}var deferred=$.Deferred();var slash_path=service.replace(/\./g,"/");var url="/ws/"+slash_path;var hdrs=SAH.headers();hdrs["Content-Type"]="application/json";$.ajax({type:"POST",url:url,data:JSON.stringify(data),headers:hdrs,success:function(json){var object_parameters=json.parameters||[];var parameters=[];for(var i=0;i<object_parameters.length;i++){parameters[object_parameters[i].name]=object_parameters[i].value}deferred.resolve(parameters)},error:function(jqXHR,textStatus){var errors=[];if(jqXHR.status==200){var pos=jqXHR.responseText.indexOf("[");if(pos!=-1){var data=jqXHR.responseText.substring(pos);var extra_errors=JSON.parse(data);errors.push.apply(errors,extra_errors)}}else{errors=[{error:jqXHR.status,description:jqXHR.statusText,info:""}]}deferred.reject(errors)}});return deferred.promise()};SAH.Object.prototype.deleteInstance=function(){var _this=this;var service=_this.service;var arg_array=Array.prototype.slice.call(arguments,0,arguments.length);switch(arg_array.length){case 0:break;case 1:service=arg_array[0];break}var deferred=$.Deferred();var slash_path=service.replace(/\./g,"/");var url="/ws/"+slash_path;$.ajax({type:"DELETE",url:url,data:JSON.stringify(data),headers:SAH.headers(),success:function(json){deferred.resolve()},error:function(jqXHR,textStatus){var errors=[];if(jqXHR.status==200){var pos=jqXHR.responseText.indexOf("[");if(pos!=-1){var data=jqXHR.responseText.substring(pos);var extra_errors=JSON.parse(data);errors.push.apply(errors,extra_errors)}}else{errors=[{error:jqXHR.status,description:jqXHR.statusText,info:""}]}deferred.reject(errors)}});return deferred.promise()};SAH.Object.prototype.subscribe=function(){var service=this.service;var event=undefined;var cb=undefined;var arg_array=Array.prototype.slice.call(arguments,0,arguments.length);switch(arg_array.length){case 0:case 1:return;break;case 2:event=arg_array[0];cb=arg_array[1];break;case 3:if(service.length==0){service=arg_array[0]}else{service+="."+arg_array[0]}event=arg_array[1];cb=arg_array[2];break}if(service.length==0||!event||!cb){return}if(!this.subscriptions[service]){this.subscriptions[service]={}}if(!this.subscriptions[service][event]){this.subscriptions[service][event]=[]}this.subscriptions[service][event].push(cb);SAH.currentEvm().subscribe(service,event,cb)};SAH.Object.prototype.unsubscribe=function(){if(arguments.length==0){for(var s in this.subscriptions){if(this.subscriptions.hasOwnProperty(s)){for(var e in this.subscriptions[s]){if(this.subscriptions[s].hasOwnProperty(e)){var subs=this.subscriptions[s][e];for(var i=0;i<subs.length;i++)SAH.currentEvm().unsubscribe(s,e,subs[i])}}}}}else{var service=this.service;var event=undefined;var cb=undefined;var arg_array=Array.prototype.slice.call(arguments,0,arguments.length);switch(arg_array.length){case 1:return;break;case 2:event=arg_array[0];cb=arg_array[1];break;case 3:if(service.length==0){service=arg_array[0]}else{service+="."+arg_array[0]}method=arg_array[1];args=arg_array[2];break}if(service.length){service=arg_array[0]}else{service+="."+arg_array[0]}SAH.currentEvm().unsubscribe(service,event,cb)}};SAH.Function.prototype.toString=function(){var fn=this.name+"(";var separator="";for(var i=0;i<this.arguments.length;i++){fn=fn+separator+this.arguments[i].name+":"+this.arguments[i].type;separator=", "}fn=fn+"):"+this.type;return fn};SAH.Parameter.prototype.toString=function(){var parameter=this.name+"="+this.value;return parameter};SAH.DMObject.prototype=Object.create(SAH.Object.prototype)});