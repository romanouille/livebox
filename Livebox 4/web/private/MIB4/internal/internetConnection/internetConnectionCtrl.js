define(["utils/console","utils/basics","lib/stateCtrlInterface"],function(console,basicUtilities,StateCtrlClass){"use strict";function InternetConnectionCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,regexReplaceType,regexLoginFTI,onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("InternetConnectionCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewCancelled"){console.debug("InternetConnectionCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewSubmitted"){console.debug("InternetConnectionCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));if(aData.action==="connect"){this.ConnectWithCredentials(aData.login,aData.password,aData.choice,aData.reload)}else{console.warn("InternetConnectionCtrlClass: Unexpected event '"+aEventId+"'")}}};regexLoginFTI=new RegExp(/^fti\//);fields={IsConnectionRunning:false,connectionTimer:null,errorType:1};StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("InternetConnectionCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("InternetConnectionCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("InternetConnectionCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().enable(aNext)},function(aNext){this.getWanState(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getLogin(aNext)}else{basicUtilities.callback(aNext,false,-1,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("InternetConnectionCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getWanState=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Client.Wan.getStatus",aNext,null)},function(aNext,aResult){if(aResult.status===0){this.getViewObj().initChoice(aResult.data.linkMode);basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getLogin=function(){var login;basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Client.Wan.getStatus",aNext,null)},function(aNext,aResult){if(aResult.status===0){if(regexLoginFTI.test(aResult.data.PPP.login)){login=aResult.data.PPP.login.split("fti/")}else{login=aResult.data.PPP.login}this.getViewObj().initLogin(login[1]);basicUtilities.callback(null,false,0,null)}else{this.getViewObj().notifyError("InternetConnectionClass:  Internal error as WAN status is invalid"+JSON.stringify(aResult),"yke0005");basicUtilities.callback(null,false,-1,null)}}],this)};this.isValidCredential=function(login,password){if(login===""||login.length>85){this.getViewObj().displayLoginError(false);this.getViewObj().displayPasswordError(true);return false}if(password===""||password.length>29){this.getViewObj().displayLoginError(true);this.getViewObj().displayPasswordError(false);return false}this.getViewObj().displayLoginError(true);this.getViewObj().displayPasswordError(true);return true};this.ConnectWithCredentials=function(login,password,choice,reload){if(reload||this.isValidCredential(login,password)){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Client.Wan.getStatus",aNext,null)},function(aNext,aResult){var prefix,arr;if(aResult.status===0&&aResult.data.linkType!==""){regexReplaceType=aResult.data.linkType.replace(/^[^_]*/,"");if(reload||aResult.data.linkType.toLowerCase().indexOf("dhcp")>=0){this.callSahApi("sah.Connection.Client.Wan.connect",aNext,{linkMode:choice,linkType:choice+regexReplaceType})}else{prefix="";if(this.getCapabilities().isOrange){prefix="fti/"}else{prefix=""}arr=login.split("fti/");if(arr[0]===""){arr=arr.slice(1)}login=arr.join("");if(this.getCapabilities().isOrange){login=prefix+arr.join("fti/")}this.callSahApi("sah.Connection.Client.Wan.connect",aNext,{linkMode:choice,linkType:choice+regexReplaceType,login:login,password:password})}}else{console.error("InternetConnectionClass: Internal error as WAN status is invalid "+JSON.stringify(aResult));basicUtilities.callback(null,false,-1,null);this.getViewObj().notifyError("InternetConnectionClass:  Internal error as WAN status is invalid"+JSON.stringify(aResult),"yke0002")}},function(aNext,aResult){if(aResult.status===0){fields.IsConnectionRunning=true;this.getViewObj().displayConnectionState("connecting");if(fields.connectionTimer!==null){window.clearTimeout(fields.connectionTimer)}fields.connectionTimer=window.setTimeout(function(){this.checkConnection(aNext,choice)}.bind(this),15e3)}else{console.error("InternetConnectionClass: Internal error as connection request failed "+JSON.stringify(aResult));basicUtilities.callback(null,false,-1,null);console.error("InternetConnectionCtrlClass: Internal error as connection request failed "+JSON.stringify(aResult))}},function(){basicUtilities.callback(null,false,0,null)}],this)}};this.checkConnection=function(aCallback,choice){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Client.getConnectionState",aNext,null)},function(aNext,aResult){if(aResult.status===0){if(aResult.data.linkModeList[0].state==="OK"){fields.IsConnectionRunning=false;this.getViewObj().displayConnectionState("connected");this.getViewObj().leaveApplication();this.getViewObj().showLoadingScreen(aCallback)}else{fields.IsConnectionRunning=true;if(fields.connectionTimer!==null){window.clearTimeout(fields.connectionTimer)}if(fields.errorType===0&&aResult.data.linkModeList[0].state==="ERROR"){fields.errorType=1;if(aResult.data.linkModeList[0].lastError==="ERROR_AUTHENTICATION_FAILURE"){this.getViewObj().displayPasswordError(false);this.getViewObj().displayConnectionState("disconnected",choice)}else{this.getViewObj().displayConnectionState("disconnected",choice)}}else{if(aResult.data.linkModeList[0].state==="ERROR"){this.getViewObj().displayConnectionState("disconnected",choice);fields.errorType-=1}else{fields.errorType=1}fields.connectionTimer=window.setTimeout(function(){this.checkConnection(null,choice)}.bind(this),5e3)}}}else{console.error("InternetConnectionClass: Internal error as connection state information is invalid "+JSON.stringify(aResult));basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("InternetConnectionClass: Internal error as connection state information is invalid "+JSON.stringify(aResult),"yke0003")}}],this)}}return InternetConnectionCtrlClass});