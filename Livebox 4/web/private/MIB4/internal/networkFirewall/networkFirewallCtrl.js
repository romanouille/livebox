define(["utils/console","utils/basics","lib/stateCtrlInterface"],function(console,basicUtilities,StateCtrlClass){"use strict";function NetworkFirewallCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,currentState,ipVersion,regexRange,regexCutRange,onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("NetworkFirewallCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));this.addRule(aData.aData)}else if(aEventId==="ViewCancelled"){console.debug("NetworkFirewallCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));this.quit()}else if(aEventId==="ViewSubmitted"){console.debug("NetworkFirewallCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));if(aData.action==="switch"){this.goToCustom()}else{this.setCurrentState(aData.state)}}else{console.warn("NetworkFirewallCtrlClass: Unexpected event '"+aEventId+"'")}};fields={};ipVersion="4";regexRange=new RegExp(/-/);regexCutRange=new RegExp(/([0-9]+)-([0-9]+)/);StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("NetworkFirewallCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("NetworkFirewallCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("NetworkFirewallCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().enable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getIpVersion(aNext)}else{basicUtilities.callback(aCallback,false,-1,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getCurrentState(aNext)}else{basicUtilities.callback(aCallback,false,-1,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getListDevices(aNext);basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getRulesList(aNext)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("NetworkFirewallCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.setCurrentState=function(state){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.Firewall.Level.setLevel",aNext,{level:state})},function(aNext,aResult){if(!aResult||aResult.status===0){if(state==="Custom"){window.ipVersion=ipVersion}basicUtilities.callback(null,false,0,null)}else{this.getViewObj().notifyError("NetworkFirewallCtrlClass: Failed to set state ","yke0001");basicUtilities.callback(null,false,-1,null)}}],this)};this.getListDevices=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.NetworkMap.listDevices",aNext,{filter:{isActive:true}})},function(aNext,aResult){if(!aResult||aResult.status===0){this.getViewObj().setListDevices(aResult.data.deviceList);basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("NetworkFirewallCtrlClass: Failed to get rules list ","yke0002");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getIpVersion=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.Firewall.getState",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){if(aResult.data.isInIpv6Mode){ipVersion="6";window.ipVersion=ipVersion;this.getViewObj().displayIPV6(true)}else{this.getViewObj().displayIPV6(false)}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("NetworkFirewallCtrlClass: Failed to get ip version","yke0003");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getCurrentState=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.Firewall.Level.getLevel",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){currentState=aResult.data.level;if(currentState.length>0){this.getViewObj().displayFirewallState(currentState)}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("NetworkFirewallCtrlClass: Failed to get firewall state","yke0003");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getRulesList=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.Firewall.CustomRulesIPv6.listRules",aNext,null)},function(aNext,aResult){var rulesList;if(!aResult||aResult.status===0){rulesList=aResult.data.ruleList;if(rulesList.length>0){this.getViewObj().displayInfo(rulesList)}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("NetworkFirewallCtrlClass: Failed to get ipv6 rules","yke0004");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.addRule=function(aData,aCallback){var arrayPort,minPortRange,maxPortRange;basicUtilities.queue([function(aNext){if(regexRange.test(aData.externalPortRange)){arrayPort=regexCutRange.exec(aData.externalPortRange);minPortRange=arrayPort===null?"":arrayPort[1];maxPortRange=arrayPort===null?"":arrayPort[2];if(minPortRange<minPortRange&&minPortRange>0&&minPortRange<65535&&maxPortRange>0&&maxPortRange<65535){this.callSahApi("sah.HomeNetwork.Firewall.CustomRulesIPv6.addRule",aNext,aData)}}else{if(aData.externalPortRange>0&&aData.externalPortRange<65535){this.callSahApi("sah.HomeNetwork.Firewall.CustomRulesIPv6.addRule",aNext,aData)}}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getRulesList(aCallback)}else{this.getViewObj().notifyError("NetworkFirewallCtrlClass: Failed to add this rule","yke0005");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.deleteRule=function(aData,aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.Firewall.CustomRulesIPv6.deleteRule",aNext,aData)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getRulesList(aCallback)}else{this.getViewObj().notifyError("NetworkFirewallCtrlClass: Failed to delete this rules","yke0006");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.goToCustom=function(){aStateManager.switchState(null,"NetworkFirewallIPv4",null)}}return NetworkFirewallCtrlClass});