define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","text!app/config/networkFirewallIpv4.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function NetworkFirewallIPv4ViewClass(aStateId,aTranslateObj){var fields,self;fields={application:[],rules:{HTTP:{Id:"HTTP",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6",DestinationPort:"80",SourcePort:"80",DestinationPrefix:"",SourcePrefix:"",TargetChain:"",Description:"HTTP",Enable:false},HTTPS:{Id:"HTTPS",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6",DestinationPort:"443-443",SourcePort:"6666-6667",DestinationPrefix:"0.0.0.1/16",SourcePrefix:"192.168.1.1/16",TargetChain:"",Description:"HTTPS",Enable:false},POP3:{Id:"POP3",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6",DestinationPort:"110-110",SourcePort:"6666-6667",DestinationPrefix:"0.0.0.1/16",SourcePrefix:"192.168.1.1/16",TargetChain:"",Description:"POP3",Enable:false},POP3S:{Id:"POP3S",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6",DestinationPort:"995",SourcePort:"",DestinationPrefix:"",SourcePrefix:"",TargetChain:"",Description:"POP3S",Enable:false},SMTPAuth:{Id:"SMTPAuth",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6",DestinationPort:"587",SourcePort:"",DestinationPrefix:"",SourcePrefix:"",TargetChain:"",Description:"SMTPAuth",Enable:false},SMTP:{Id:"SMTP",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6",DestinationPort:"25",SourcePort:"",DestinationPrefix:"",SourcePrefix:"",TargetChain:"",Description:"SMTP",Enable:false},FTP:{Id:"FTP",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6",DestinationPort:"20-21",SourcePort:"",DestinationPrefix:"",SourcePrefix:"",TargetChain:"",Description:"FTP",Enable:false},SSH:{Id:"SSH",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6",DestinationPort:"22",SourcePort:"",DestinationPrefix:"",SourcePrefix:"",TargetChain:"",Description:"SSH",Enable:false},NTP:{Id:"NTP",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"17",DestinationPort:"123",SourcePort:"",DestinationPrefix:"",SourcePrefix:"",TargetChain:"",Description:"NTP",Enable:false},NNTP:{Id:"NNTP",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6",DestinationPort:"119",SourcePort:"",DestinationPrefix:"",SourcePrefix:"",TargetChain:"",Description:"NNTP",Enable:false},NNTPS:{Id:"NNTPS",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6",DestinationPort:"563",SourcePort:"",DestinationPrefix:"",SourcePrefix:"",TargetChain:"",Description:"NNTPS",Enable:false},DNS:{Id:"DNS",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6,17",DestinationPort:"53",SourcePort:"",DestinationPrefix:"",SourcePrefix:"",TargetChain:"",Description:"DNS",Enable:false},IMAP:{Id:"IMAP",Target:"Accept",Status:"Disabled",Class:"Forward",IPVersion:4,Protocol:"6",DestinationPort:"143",SourcePort:"",DestinationPrefix:"",SourcePrefix:"",TargetChain:"",Description:"IMAP",Enable:false},nouveau:{Id:"nouveau..."}}};self=this;StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("NetworkFirewallIPv4ViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("NetworkFirewallIPv4ViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("NetworkFirewallIPv4ViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setAppCloseButton(aNext,"app_close")},function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("NetworkFirewallIPv4ViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+aResult.data+"</style>")}if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);this.translate();this.setPageTitle(null,$(".header-title").find("h1").find("span").html());this.selectListener();$("#modalTitle").css("text-align","center");$("#firewall_list_table").css("width","100%");$('input[name="DHCPCheckbox"]').prop("checked",true);$("#addRules").on("click keypress",function(event){if(event.which===13||event.type==="click"){TemplateClass.showPopup($("#popup_confirm"));$("#popup_confirm_submit").on("click",function(){var aData={aData:{name:$("#application").val(),isEnabled:true,protocol:$("#prococole").val().toLowerCase(),action:$("#action").val(),externalIpAddress:$("#IPdest").val(),externalMask:$("#maskSource").val(),externalPortRange:$("#portSource").val(),internalIpAddress:$("#IPsource").val(),internalMask:$("#maskDest").val(),internalPortRange:$("#portDest").val(),ipVersion:"4"}};this.fireEvent("ViewUpdated",aData)}.bind(this));$("#popup_confirm_cancel").on("click",function(){$("#addRules").attr("disabled",false);TemplateClass.hidePopup($("#popup_confirm"))}.bind(this))}}.bind(this));$("#app_close").on("click",function(event){event.preventDefault();event.stopPropagation();self.fireEvent("ViewCancelled",null)});$(document).on("click",".conf-table-button-delete",function(){self.fireEvent("ViewCancelled",{aData:{name:$(this).attr("id"),ipVersion:window.ipVersion}})});$("#cancel").on("click",function(){self.fireEvent("ViewCancelled",null)});$("#add").on("click",function(){if($("#IPv4Serv_true").is(":checked")){self.fireEvent("ViewSubmitted",{state:true})}else{self.fireEvent("ViewSubmitted",{state:false})}});basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.fillSelect=function(){$.each(fields.rules,function(key,value){if(jQuery.inArray(value.Id,fields.application)===-1){$("#application").append("<option value="+value.Id+">"+value.Id+"</option>")}});if($("#application").val()==="nouveau..."){$("#application").parents(".select-container").replaceWith("<input class='txtandfield-field' id='application' value='' type='text'>"+"<div  class='txtandfield-warning' id='application_warning'>"+"<span class='redtxt'>"+"<span style='font-size:0.7em;' class='warning Translation' data-translation='networkFirewall.IPv4.modal.application.errors'>"+"</span>"+"</span>"+"</div>");self.translate()}};this.getPingState=function(state){$('input[name="IPv4Checkbox"]').prop("checked",state.isEnabledIPv4)};this.displayInfo=function(rulesList){var i;if($("#empty").length>0){$("#empty").parent().hide()}$(".ipv4infos").remove();for(i=0;i<=rulesList.length-1;i+=1){fields.application[i]=rulesList[i].name;if($("#firewall_list_table tr:last").length>0){$("#firewall_list_table tr:last").after('<tr class="conf-table-row ipv4infos">'+'<td class="conf-table-cell">'+rulesList[i].name+"</td>"+'<td class="conf-table-cell">'+rulesList[i].protocol+"</td>"+'<td class="conf-table-cell">'+rulesList[i].internalIpAddress+"</td>"+'<td class="conf-table-cell">'+rulesList[i].internalMask+"</td>"+'<td class="conf-table-cell">'+rulesList[i].internalPortRange+"</td>"+'<td class="conf-table-cell">'+rulesList[i].externalIpAddress+"</td>"+'<td class="conf-table-cell">'+rulesList[i].externalMask+"</td>"+'<td class="conf-table-cell">'+rulesList[i].externalPortRange+"</td>"+'<td class="conf-table-cell">'+rulesList[i].action+"</td>"+'<td class="conf-table-blank-cell">'+'<img alt="supprimer" class="conf-table-button-delete" tabindex="0" id="'+rulesList[i].name+'" src="../../common/img/app_conf/trashbin_666.png">'+"</td>"+"</tr>")}else{$("#firewall_list_table").append('<tr class="conf-table-row ipv4infos">'+'<td class="conf-table-cell">'+rulesList[i].name+"</td>"+'<td class="conf-table-cell">'+rulesList[i].protocol+"</td>"+'<td class="conf-table-cell">'+rulesList[i].internalIpAddress+"</td>"+'<td class="conf-table-cell">'+rulesList[i].internalMask+"</td>"+'<td class="conf-table-cell">'+rulesList[i].internalPortRange+"</td>"+'<td class="conf-table-cell">'+rulesList[i].externalIpAddress+"</td>"+'<td class="conf-table-cell">'+rulesList[i].externalMask+"</td>"+'<td class="conf-table-cell">'+rulesList[i].externalPortRange+"</td>"+'<td class="conf-table-cell">'+rulesList[i].action+"</td>"+'<td class="conf-table-blank-cell">'+'<img alt="supprimer" tabindex="0" class="conf-table-button-delete" id="'+rulesList[i].name+'" src="../../common/img/app_conf/trashbin_666.png">'+"</td>"+"</tr>")}}this.fillSelect()};this.selectListener=function(){$("#application").on("change",function(event){if(event.currentTarget.value==="nouveau..."){$("#application").parents(".select-container").replaceWith("<input class='txtandfield-field' id='application' value='' type='text'>"+"<div  class='txtandfield-warning' id='application_warning'>"+"<span class='redtxt'>"+"<span  style='font-size:0.7em;' class='warning Translation' data-translation='networkFirewall.IPv4.modal.application.errors'>"+"</span>"+"</span>"+"</div>");self.translate()}})};this.hidePopup=function(){TemplateClass.hidePopup($("#popup_confirm"))};this.displayApplicationError=function(isValid){if(isValid){$("#application_warning").css("display","none");$("#application_label").css("color","#000000");$("#application").css("color","#000000");$("#application").css("border-color","#999999")}else{$("#application_warning").css("display","inline-block");$("#application_label").css("color","#CC0000");$("#application").css("color","#CC0000");$("#application").css("border-color","#CC0000")}};this.displayPortSourceError=function(isValid){if(isValid){$("#portSource_warning").css("display","none");$("#portSource_label").css("color","#000000");$("#portSource").css("color","#000000");$("#portSource").css("border-color","#999999")}else{$("#portSource_warning").css("display","inline-block");$("#portSource_label").css("color","#CC0000");$("#portSource").css("color","#CC0000");$("#portSource").css("border-color","#CC0000")}};this.displayPortDestError=function(isValid){if(isValid){$("#portDest_warning").css("display","none");$("#portDest_label").css("color","#000000");$("#portDest").css("color","#000000");$("#portDest").css("border-color","#999999")}else{$("#portDest_warning").css("display","inline-block");$("#portDest_label").css("color","#CC0000");$("#portDest").css("color","#CC0000");$("#portDest").css("border-color","#CC0000")}};this.displayIpSourceError=function(isValid){if(isValid){$("#IPsource_warning").css("display","none");$("#IPsource_label").css("color","#000000");$("#IPsource").css("color","#000000");$("#IPsource").css("border-color","#999999")}else{$("#IPsource_warning").css("display","inline-block");$("#IPsource_label").css("color","#CC0000");$("#IPsource").css("color","#CC0000");$("#IPsource").css("border-color","#CC0000")}};this.displayIpDestError=function(isValid){if(isValid){$("#IPdest_warning").css("display","none");$("#IPdest_label").css("color","#000000");$("#IPdest").css("color","#000000");$("#IPdest").css("border-color","#999999")}else{$("#IPdest_warning").css("display","inline-block");$("#IPdest_label").css("color","#CC0000");$("#IPdest").css("color","#CC0000");$("#IPdest").css("border-color","#CC0000")}};this.displayMaskSourceError=function(isValid){if(isValid){$("#maskSource_warning").css("display","none");$("#maskSource_label").css("color","#000000");$("#maskSource").css("color","#000000");$("#maskSource").css("border-color","#999999")}else{$("#mac_warning").css("display","inline-block");$("#mac_label").css("color","#CC0000");$("#mac").css("color","#CC0000");$("#mac").css("border-color","#CC0000")}};this.displayMaskDestError=function(isValid){if(isValid){$("#maskDest_warning").css("display","none");$("#maskDest_label").css("color","#000000");$("#maskDest").css("color","#000000");$("#maskDest").css("border-color","#999999")}else{$("#maskDest_warning").css("display","inline-block");$("#maskDest_label").css("color","#CC0000");$("#maskDest").css("color","#CC0000");$("#maskDest").css("border-color","#CC0000")}}}return NetworkFirewallIPv4ViewClass});