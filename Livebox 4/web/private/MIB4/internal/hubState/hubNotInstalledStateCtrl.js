define(["utils/console","utils/basics","lib/stateCtrlInterface"],function(console,basicUtilities,StateCtrlClass){"use strict";function HubNotInstalledStateCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,globalResult,onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("HubNotInstalledStateCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewCancelled"){console.debug("HubNotInstalledStateCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));this.quit()}else if(aEventId==="ViewSubmitted"){console.debug("HubNotInstalledStateCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));if(aData.state==="start_install"){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.MediaCloud.getFormattingState",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){if(aResult.data.isRunning){this.startFormatting(aNext);this.getViewObj().displayPopupInfo("format");if(fields.loadingTimer){window.clearTimeout(fields.loadingTimer)}fields.loadingTimer=window.setTimeout(function(){this.getFormattingState()}.bind(this),2e4)}else{this.getFormattingState(aNext)}basicUtilities.callback(null,false,0,null)}else{this.getViewObj().notifyError("HubNotInstalledStateCtrlClass: internal Error getFormattingState failed","rra0225");basicUtilities.callback(null,false,-1,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(null,false,0,null)}else{basicUtilities.callback(null,false,-1,null);this.getViewObj().notifyError("HubNotInstalledStateCtrlClass: Releasing state '"+this.getId()+"'","rra0220")}}],this)}else if(aData.state==="get_format_state"){this.getFormattingState()}else if(aData.state==="get_storage_state"){this.getStorageState()}}else{console.warn("HubNotInstalledStateCtrlClass: Unexpected event '"+aEventId+"'")}};fields={loadingTimer:null};globalResult={};StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("HubNotInstalledStateCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("HubNotInstalledStateCtrlClass: Initialising state '"+this.getId()+"'","rra0219")}}],this)};this.quit=function(aCallback){console.debug("HubNotInstalledStateCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("HubNotInstalledStateCtrlClass: Releasing state '"+this.getId()+"'","rra0220")}}],this)};this.enable=function(aCallback){console.debug("HubNotInstalledStateCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().enable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("HubNotInstalledStateCtrlClass: Enabling state '"+this.getId()+"'","rra0221")}}],this)};this.disable=function(aCallback){console.debug("HubNotInstalledStateCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("HubNotInstalledStateCtrlClass: Disabling state '"+this.getId()+"'","rra0222")}}],this)};this.getFormattingState=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.MediaCloud.getFormattingState",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!aResult.data.isRunning){this.activateHub(aNext)}else{this.getViewObj().displayPopupInfo("notactivate")}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("HubNotInstalledStateCtrlClass: internal Error getFormattingState failed","rra0225");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getStorageState=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.MediaCloud.getGlobalState",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){if(aResult.data.device.status==="ok"){this.getViewObj().toggleInstallButton(false)}else{this.getViewObj().toggleInstallButton(true)}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().toggleInstallButton(true);basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.startFormatting=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.MediaCloud.startFormatting",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getViewObj().displayPopupInfo("format");basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("HubNotInstalledStateCtrlClass: internal Error startFormatting failed","rra0227");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.activateHub=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.MediaCloud.setServiceState",aNext,{isEnabled:true})},function(aNext){this.callSahApi("sah.Device.MediaCloud.getGlobalState",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){if(aResult.data.isEnabled){this.getViewObj().displayPopupInfo("activate")}else{this.getViewObj().displayPopupInfo("notactivate")}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("HubNotInstalledStateCtrlClass: internal Error getGlobalState failed","rra0226");basicUtilities.callback(aCallback,false,-1,null)}}],this)}}return HubNotInstalledStateCtrlClass});