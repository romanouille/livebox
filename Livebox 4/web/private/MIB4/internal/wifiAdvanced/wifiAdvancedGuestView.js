define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","json!app/config/wifiGuestConfig.json","app/wifiAdvancedSharedView"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config,SharedViewClass){"use strict";function WifiAdvancedGuestViewClass(aStateId,aTranslateObj){var mapSecurityModes=function(securityMode){var knownSecurityModesBase={open:"None",wpamixp:"WPA-WPA2-Personal",wpamixe:"WPA-WPA2-Enterprise",wpa2p:"WPA2-Personal",wpa2e:"WPA2-Enterprise"},knownSecurityModes={},key;for(key in knownSecurityModesBase){if(knownSecurityModesBase.hasOwnProperty(key)){knownSecurityModes[key]=knownSecurityModesBase[key];knownSecurityModes[knownSecurityModesBase[key]]=key}}if(knownSecurityModes.hasOwnProperty(securityMode)){return knownSecurityModes[securityMode]}return false};this.fields={loggedUserBehaviour:{lastFocusedElt:[],lastClickedElt:[],lastRelevantElt:""},currentData:{}};StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("WifiAdvancedGuestViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){SharedViewClass.import(aNext,this)},function(aNext,aResult){if(!aResult||aResult.status===0){this.setStyle(aNext)}else{basicUtilities.callback(aNext,false,0,null);this.notifyError("WifiAdvancedGuestViewClass: Failed to import shared view class","aba0179")}},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("WifiAdvancedGuestViewClass: Failed to set style","aba0180")}}],this)};this.quit=function(aCallback){console.debug("WifiAdvancedGuestViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("WifiAdvancedGuestViewClass: Failed to unset style","aba0181")}}],this)};this.enable=function(aCallback){console.debug("WifiAdvancedGuestViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){$(document).off("click","#app_close");$(document).off("keypress","#app_close");$(document).on("click","#app_close",function(event){event.preventDefault();window.location.hash="#summary"});$(document).on("keypress","#app_close",function(event){var keyCode=event.keyCode||event.which;if(keyCode===13){event.preventDefault();$("#app_close").trigger("click")}});basicUtilities.callback(aNext,false,0,null)},function(aNext,aResult){if(!aResult||aResult.status===0){this.viewDisplayPage(aNext)}else{basicUtilities.callback(aNext,false,0,null);this.notifyError("WifiAdvancedGuestViewClass: Failed to set app close button","aba0182")}},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("WifiAdvancedGuestViewClass: Failed to display view","aba0183")}}],this)};this.disable=function(aCallback){console.debug("WifiAdvancedGuestViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("WifiAdvancedGuestViewClass: Failed to empty view","aba0184")}}],this)};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){$(window.document.body).html(aResult.data);this.translate();aNext()},function(aNext){$("#cancel").on("click",function(event){event.preventDefault();window.location.hash="#summary"}.bind(this));this.setCheckedInput(aNext,"wifi_guest_activation_id_1",this.fields.currentData.isGuestEnabled)},function(aNext,aResult){if(!aResult||aResult.status===0){this.viewDisplayRemainingTime(aNext)}else{basicUtilities.callback(aNext,false,0,null);this.notifyError("WifiAdvancedGuestViewClass: Failed to set activation state","aba0212")}},function(aNext,aResult){if(!aResult||aResult.status===0){if(this.fields.currentData.guest24VapRoot){$(".header-title").children("h1").html($(".header-title").children("h1").html()+this.escapeString("js",this.escapeString("html",this.fields.currentData.guest24VapRoot.ssid)));this.setValue(null,"wifi_guest_ssid",this.fields.currentData.guest24VapRoot.ssid);this.setOptionByValue(null,"wifi_guest_securitytype",mapSecurityModes(this.fields.currentData.guest24VapRoot.securityMode));this.setValue(null,"wifi_guest_securitykey",this.fields.currentData.guest24VapRoot.securityKey)}$("#wifi_guest_securitytype").css({width:"20em"});$("#wifi_guest_activation_id_1, #wifi_guest_ssid, #wifi_guest_securitytype, #wifi_guest_securitykey, #wifi_guest_duration").change(function(){this.setDisabledInput(null,"save",false)}.bind(this));$("#wifi_guest_ssid, #wifi_guest_securitykey").on("input",function(){this.setDisabledInput(null,"save",false)}.bind(this));this.setPageTitle(null,$(".header-title").find("h1").html());$("#save").on("click",function(event){var value,value2;event.preventDefault();if(this.viewCheckValues()){value=this.viewRetrieveAndFormatAccessPointValues();value2=this.viewRetrieveAndFormatGuestLimitationValue();this.fireEvent("ViewSubmitted",{value:{vap:value,glim:value2}})}}.bind(this));this.setDisabledInput(null,"save",true);basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("WifiAdvancedGuestViewClass: Failed to set guest form","aba0213")}}],this)};this.viewRetrieveAndFormatAccessPointValues=function(){var result={};result.ssid=$("#wifi_guest_ssid").val().trim();result.isEnabled=$("#wifi_guest_activation_id_1").prop("checked");result.securityMode=mapSecurityModes($("select#wifi_guest_securitytype option:selected").val());result.securityKey=$("#wifi_guest_securitykey").val();return result};this.viewRetrieveAndFormatGuestLimitationValue=function(){var result={};result.timeRemaining=parseInt($("select#wifi_guest_duration option:selected").val(),10);return result};this.viewDisplayRemainingTime=function(aCallback){var result;if(this.fields.currentData.isGuestEnabled){if(this.fields.currentData.getGuestLimitation.timeRemaining===0){result="0mn";$("#wifi_guest_remaining_time_value").html(result);$("#wifi_guest_remaining_time").show()}else if(this.fields.currentData.getGuestLimitation.timeRemaining>=3600){result=Math.floor(this.fields.currentData.getGuestLimitation.timeRemaining/3600).toString()+"h "+Math.floor(this.fields.currentData.getGuestLimitation.timeRemaining%3600/60).toString()+"mn";$("#wifi_guest_remaining_time_value").html(result);$("#wifi_guest_remaining_time").show()}else if(this.fields.currentData.getGuestLimitation.timeRemaining<3600){result=Math.floor(this.fields.currentData.getGuestLimitation.timeRemaining/60).toString()+"mn";$("#wifi_guest_remaining_time_value").html(result);$("#wifi_guest_remaining_time").show()}else{$("#wifi_guest_remaining_time").hide()}}else{$("#wifi_guest_remaining_time").hide()}basicUtilities.callback(aCallback,false,0,null)};this.viewCheckValues=function(){var selectedSecurityTypeTest=$("select#wifi_guest_securitytype option:selected").val()==="wpamixp"||$("select#wifi_guest_securitytype option:selected").val()==="wpamixe"||$("select#wifi_guest_securitytype option:selected").val()==="wpa2p"||$("select#wifi_guest_securitytype option:selected").val()==="wpa2e",index,ssidTest,ssidTest2=true,ssidListToCheck=[],keyTest;$("#wifi_guest_ssid_warning").hide();if(this.isValidSSID($("#wifi_guest_ssid").val())){ssidTest=true}else{ssidTest=false}if(this.fields.currentData.ssidCollision.hasOwnProperty("secureHotspot")){ssidListToCheck.push(this.fields.currentData.ssidCollision.secureHotspot)}if(this.fields.currentData.ssidCollision.hasOwnProperty("openHotspot")){ssidListToCheck.push(this.fields.currentData.ssidCollision.openHotspot)}if(this.fields.currentData.ssidCollision.hasOwnProperty("private24")){ssidListToCheck.push(this.fields.currentData.ssidCollision.private24)}if(this.fields.currentData.ssidCollision.hasOwnProperty("private5")){ssidListToCheck.push(this.fields.currentData.ssidCollision.private5)}for(index=0;index<ssidListToCheck.length;index=index+1){if($("#wifi_guest_ssid").val().trim()===ssidListToCheck[index].trim()){ssidTest2=false;break}}if(ssidTest===false){if($("#wifi_guest_ssid").val().length>32){$("#wifi_guest_ssid_warning_txt").attr("data-translation","wifiAdvanced.error2")}else if($("#wifi_private_ssid").val().trim()!==$("#wifi_private_ssid").val()){$("#wifi_private_ssid_warning_txt").attr("data-translation","wifiAdvanced.error2blanks")}else{$("#wifi_guest_ssid_warning_txt").attr("data-translation","wifiAdvanced.wificonfiguration.ssid.warning")}this.translate("#wifi_guest_ssid_warning");$("#wifi_guest_ssid_warning").css("display","inline-block")}if(ssidTest2===false){$("#wifi_guest_ssid_warning_txt").attr("data-translation","wifiAdvanced.error1");this.translate("#wifi_guest_ssid_warning");$("#conflicting_ssid").html("'"+$("#wifi_guest_ssid").val()+"'");$("#wifi_guest_ssid_warning").css("display","inline-block")}if(this.isValidWPAKey($("#wifi_guest_securitykey").val())&&selectedSecurityTypeTest){$("#wifi_guest_securitykey_warning").hide();keyTest=true}else if($("select#wifi_guest_securitytype option:selected").val()==="open"){$("#wifi_guest_securitykey_warning").hide();keyTest=true}else{$("#wifi_guest_securitykey_warning").css("display","inline-block");keyTest=false}return ssidTest&&ssidTest2&&keyTest}}return WifiAdvancedGuestViewClass});