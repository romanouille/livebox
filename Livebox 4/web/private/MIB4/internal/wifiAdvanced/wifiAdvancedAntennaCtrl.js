define(["utils/console","utils/basics","lib/stateCtrlInterface"],function(console,basicUtilities,StateCtrlClass){"use strict";function WifiAdvancedAntennaCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields={currentData:{getAccessPoints:{},getDevices:{},knownActiveDevices:{},isWifiUsedByDevices:false}},onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("WifiAdvancedAntennaCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewCancelled"){console.debug("WifiAdvancedAntennaCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewSubmitted"){console.debug("WifiAdvancedAntennaCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));if(aData.reason==="24Change"){this.setRadio24(null,aData.value?true:false)}else if(aData.reason==="5Change"){this.setRadio5(null,aData.value?true:false)}window.location.hash="#summary"}else{console.warn("WifiAdvancedAntennaCtrlClass: Unexpected event '"+aEventId+"'")}};StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("WifiAdvancedAntennaCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: init failed","aba0042")}}],this)};this.quit=function(aCallback){console.debug("WifiAdvancedAntennaCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: quit failed","aba0043")}}],this)};this.enable=function(aCallback){console.debug("WifiAdvancedAntennaCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.listenEvents(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getAccessPoints(aNext)}else{console.error("WifiAdvancedAntennaCtrlClass: Internal error");basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: listenEvents failed","aba0044")}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getDevices(aNext)}else{console.error("WifiAdvancedAntennaCtrlClass: Internal error");basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: getAccessPoints failed","aba0045")}},function(aNext,aResult){var index,subindex,rootvap,rootdevice,rootradio,privateVapIds=[];if(!aResult||aResult.status===0){fields.currentData.isWifiUsedByDevices=false;fields.currentData.isRadio24Enabled=false;fields.currentData.isRadio5Enabled=false;for(index=0;index<fields.currentData.getAccessPoints.accessPointList.length;index=index+1){rootvap=fields.currentData.getAccessPoints.accessPointList[index];if(rootvap.linkType==="WIFI_2.4_PRIVATE"||rootvap.linkType==="WIFI_5_PRIVATE"){privateVapIds.push(rootvap.accessPointId)}}outer_loop:for(index=0;index<fields.currentData.getDevices.deviceList.length;index=index+1){rootdevice=fields.currentData.getDevices.deviceList[index];for(subindex=0;subindex<privateVapIds.length;subindex=subindex+1){if(rootdevice.WIFI.accessPointId===privateVapIds[subindex]){fields.currentData.knownActiveDevices[rootdevice.deviceId]=rootdevice;fields.currentData.isWifiUsedByDevices=true;break outer_loop}}}for(index=0;index<fields.currentData.getAccessPoints.radioList.length;index=index+1){rootradio=fields.currentData.getAccessPoints.radioList[index];if(rootradio.frequencyBand.toLowerCase()==="2.4ghz"){fields.currentData.isRadio24Enabled=rootradio.isEnabled}else if(rootradio.frequencyBand.toLowerCase()==="5ghz"){fields.currentData.isRadio5Enabled=rootradio.isEnabled}}this.getViewObj().fields.currentData=fields.currentData;aNext()}else{console.error("WifiAdvancedAntennaCtrlClass: Internal error");basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: getDevice failed","aba0046")}},function(aNext){this.getViewObj().enable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){if(fields.currentData.isRadio24Enabled||fields.currentData.isRadio5Enabled){this.getViewObj().setCheckedInput(null,"wifi_allantenna_id_all",true);this.getViewObj().setDisabledInput(null,"wifi_24antenna_id_24",false);this.getViewObj().setDisabledInput(null,"wifi_5antenna_id_5",false)}else{this.getViewObj().setCheckedInput(null,"wifi_allantenna_id_all",false);this.getViewObj().setDisabledInput(null,"wifi_24antenna_id_24",true);this.getViewObj().setDisabledInput(null,"wifi_5antenna_id_5",true)}this.getViewObj().setCheckedInput(null,"wifi_24antenna_id_24",fields.currentData.isRadio24Enabled);this.getViewObj().setCheckedInput(null,"wifi_5antenna_id_5",fields.currentData.isRadio5Enabled);basicUtilities.callback(aNext,false,0,null)}else{basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: enable of view failed","aba0047")}},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: setting input in view according to configuration failed","aba0048")}}],this)};this.disable=function(aCallback){console.debug("WifiAdvancedAntennaCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.unlistenEvents(aNext)}else{console.error("WifiAdvancedAntennaCtrlClass: Internal error");basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: disable of view failed","aba0049")}},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: unlisten events failed","aba0050")}}],this)};this.listenEvents=function(aCallback){aSahObj.listenEvent("sah.HomeNetwork.NetworkMapEvents",this.handleDeviceEvents.bind(this));aSahObj.startEventListener();basicUtilities.callback(aCallback,false,0,null)};this.unlistenEvents=function(aCallback){aSahObj.stopEventListener();basicUtilities.callback(aCallback,false,0,null)};this.handleDeviceEvents=function(id,data){var key,count;if(id==="sah.HomeNetwork.NetworkMapEvents"){if(data.reason==="wifi_device_added"){if(data.attributes.hasOwnProperty(data.location)){fields.currentData.knownActiveDevices[data.location]=data.attributes[data.location];fields.currentData.isWifiUsedByDevices=true;this.getViewObj().fields.currentData.isWifiUsedByDevices=true}}else if(data.reason==="wifi_device_removed"){if(data.attributes.hasOwnProperty(data.location)){delete fields.currentData.knownActiveDevices[data.location];count=0;for(key in fields.currentData.knownActiveDevices){if(fields.currentData.knownActiveDevices.hasOwnProperty(key)){count+=1}}if(count){fields.currentData.isWifiUsedByDevices=true;this.getViewObj().fields.currentData.isWifiUsedByDevices=true}else{fields.currentData.isWifiUsedByDevices=false;this.getViewObj().fields.currentData.isWifiUsedByDevices=false}}}else if(data.reason==="wifi_device_updated"){if(data.attributes.hasOwnProperty(data.location)){fields.currentData.knownActiveDevices[data.location]=data.attributes[data.location]}if(data.attributes[data.location].hasOwnProperty("Active")){if(data.attributes[data.location].Active===true){fields.currentData.isWifiUsedByDevices=true;this.getViewObj().fields.currentData.isWifiUsedByDevices=true}else{if(data.attributes.hasOwnProperty(data.location)){delete fields.currentData.knownActiveDevices[data.location];count=0;for(key in fields.currentData.knownActiveDevices){if(fields.currentData.knownActiveDevices.hasOwnProperty(key)){count+=1}}if(count){fields.currentData.isWifiUsedByDevices=true;this.getViewObj().fields.currentData.isWifiUsedByDevices=true}else{fields.currentData.isWifiUsedByDevices=false;this.getViewObj().fields.currentData.isWifiUsedByDevices=false}}}}}}};this.getAccessPoints=function(aCallback){var index;basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.WiFi.listAccessPoints",aNext,null)},function(aNext,aResult){if(aResult.status===0){if(aResult.hasOwnProperty("data")){fields.currentData.getAccessPoints=aResult.data;if(aResult.data.hasOwnProperty("radioList")){for(index=0;index<aResult.data.radioList.length;index=index+1){if(aResult.data.radioList[index].frequencyBand.toLowerCase().indexOf("2.4ghz")>-1){fields.radio24Id=aResult.data.radioList[index].radioId}else if(aResult.data.radioList[index].frequencyBand.toLowerCase().indexOf("5ghz")>-1){fields.radio5Id=aResult.data.radioList[index].radioId}}}}basicUtilities.callback(aCallback,false,0,aResult.data)}else{console.warn("WifiAdvancedAntennaCtrlClass: Failed to retrieve access points");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: getAccessPoints failed","aba0051")}}],this)};this.setRadio24=function(aCallback,aParam){if(typeof aParam==="boolean"){basicUtilities.queue([function(aNext){this.getViewObj().showLoadingScreen(aNext)},function(aNext){if(typeof fields.radio24Id==="string"){this.callSahApi("sah.Connection.Server.WiFi.configureRadio",aNext,{radioId:fields.radio24Id,isEnabled:aParam})}else{console.error("WifiAdvancedAntennaCtrlClass: 2.4Ghz radio ID is not known");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: setRadio24 failed, no 2.4Ghz radio ID is known","aba0052")}},function(aNext,aResult){this.getViewObj().hideLoadingScreen(null);if(aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{console.warn("WifiAdvancedAntennaCtrlClass: Failed to set 2.4Ghz private radio status");basicUtilities.callback(aCallback,false,0,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: setRadio24 failed on configuring the radio","aba0053")}}],this)}else{console.error("WifiAdvancedAntennaCtrlClass: no value was given to set 2.4Ghz private radio");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: setRadio24 failed, no value was given to set","aba0054")}};this.setRadio5=function(aCallback,aParam){if(typeof aParam==="boolean"){basicUtilities.queue([function(aNext){this.getViewObj().showLoadingScreen(aNext)},function(aNext){if(typeof fields.radio5Id==="string"){this.callSahApi("sah.Connection.Server.WiFi.configureRadio",aNext,{radioId:fields.radio5Id,isEnabled:aParam})}else{console.error("WifiAdvancedAntennaCtrlClass: 5Ghz radio ID is not known");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: setRadio5 failed, no 5Ghz radio ID is known","aba0055")}},function(aNext,aResult){this.getViewObj().hideLoadingScreen(null);if(aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{console.warn("WifiAdvancedAntennaCtrlClass: Failed to set 5Ghz private radio status");basicUtilities.callback(aCallback,false,0,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: setRadio5 failed on configuring the radio","aba0056")}}],this)}else{console.error("WifiAdvancedAntennaCtrlClass: no value was given to set 5Ghz private radio");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: setRadio5 failed, no value was given to set","aba0057")}};this.getDevices=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.NetworkMap.listDevices",aNext,{filter:{linkModeList:"WIFI",isActive:true}})},function(aNext,aResult){if(aResult.status===0){fields.currentData.getDevices=aResult.data;basicUtilities.callback(aCallback,false,0,aResult.data)}else{console.warn("WifiAdvancedSummaryCtrlClass: Failed to retrieve active devices on WiFi");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedAntennaCtrlClass: Failed to retrieve active devices on WiFi","aba0058")}}],this)}}return WifiAdvancedAntennaCtrlClass});