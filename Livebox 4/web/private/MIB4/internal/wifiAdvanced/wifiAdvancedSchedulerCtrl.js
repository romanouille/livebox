define(["utils/console","utils/basics","lib/stateCtrlInterface"],function(console,basicUtilities,StateCtrlClass){"use strict";function WifiAdvancedSchedulerCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("WifiAdvancedSchedulerCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewCancelled"){console.debug("WifiAdvancedSchedulerCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewSubmitted"){console.debug("WifiAdvancedSchedulerCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));basicUtilities.queue([function(aNext){this.getViewObj().showLoadingScreen(aNext)},function(aNext){this.setSchedule(aNext,{scheduleList:aData.value.scheduleList})},function(aNext,aResult){if(!aResult||aResult.status===0){this.setGlobalWifiStatus(aNext,{useSchedule:aData.value.useSchedule})}else{this.getViewObj().hideLoadingScreen(null);basicUtilities.callback(null,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed set schedule","aba0066")}},function(aNext,aResult){this.getViewObj().hideLoadingScreen(null);if(!aResult||aResult.status===0){window.location.hash="#summary";basicUtilities.callback(null,false,0,null)}else{basicUtilities.callback(null,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed set global wifi status","aba0067")}}],this)}else{console.warn("WifiAdvancedSchedulerCtrlClass: Unexpected event '"+aEventId+"'")}};fields={currentData:{getGlobalWifiStatus:{},getSchedule:{},getTime:{},getAccessPoints:{},getDevices:{},knownActiveDevices:{},isWifiUsedByDevices:false}};StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("WifiAdvancedSchedulerCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to init","aba0068")}}],this)};this.quit=function(aCallback){console.debug("FakeFirstCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to quit","aba0069")}}],this)};this.enable=function(aCallback){console.debug("WifiAdvancedSchedulerCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.listenEvents(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getGlobalWifiStatus(aNext)}else{console.error("WifiAdvancedSchedulerCtrlClass: Internal error");basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to listen to events","aba0070")}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getAccessPoints(aNext)}else{console.error("WifiAdvancedSchedulerCtrlClass: Internal error");basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to get global wifi status","aba0071")}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getTime(aNext)}else{console.error("WifiAdvancedSchedulerCtrlClass: Internal error");basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to get access points","aba0072")}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getSchedule(aNext)}else{console.error("WifiAdvancedSchedulerCtrlClass: Internal error");basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to get time","aba0073")}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getDevices(aNext)}else{console.error("WifiAdvancedSchedulerCtrlClass: Internal error");basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to get schedule","aba0074")}},function(aNext,aResult){if(!aResult||aResult.status===0){var index,subindex,rootvap,rootdevice,privateVapIds=[];fields.currentData.isWifiUsedByDevices=false;for(index=0;index<fields.currentData.getAccessPoints.accessPointList.length;index=index+1){rootvap=fields.currentData.getAccessPoints.accessPointList[index];if(rootvap.linkType==="WIFI_2.4_PRIVATE"||rootvap.linkType==="WIFI_5_PRIVATE"){privateVapIds.push(rootvap.accessPointId)}}outer_loop:for(index=0;index<fields.currentData.getDevices.deviceList.length;index=index+1){rootdevice=fields.currentData.getDevices.deviceList[index];for(subindex=0;subindex<privateVapIds.length;subindex=subindex+1){if(rootdevice.WIFI.accessPointId===privateVapIds[subindex]){fields.currentData.knownActiveDevices[rootdevice.deviceId]=rootdevice;fields.currentData.isWifiUsedByDevices=true;break outer_loop}}}this.getViewObj().fields.currentData=fields.currentData;aNext()}else{console.error("WifiAdvancedSchedulerCtrlClass: Internal error");basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to get device","aba0075")}},function(aNext){this.getViewObj().enable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to enable view","aba0076")}}],this)};this.disable=function(aCallback){console.debug("WifiAdvancedSchedulerCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.unlistenEvents(aNext)}else{console.error("WifiAdvancedSchedulerCtrlClass: Internal error");basicUtilities.callback(aNext,false,0,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to disable view","aba0077")}},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to unlisten events","aba0078")}}],this)};this.listenEvents=function(aCallback){aSahObj.listenEvent("sah.HomeNetwork.NetworkMapEvents",this.handleDeviceEvents.bind(this));aSahObj.startEventListener();basicUtilities.callback(aCallback,false,0,null)};this.unlistenEvents=function(aCallback){aSahObj.stopEventListener();basicUtilities.callback(aCallback,false,0,null)};this.handleDeviceEvents=function(id,data){var key,count;if(id==="sah.HomeNetwork.NetworkMapEvents"){if(data.reason==="wifi_device_added"){if(data.attributes.hasOwnProperty(data.location)){fields.currentData.knownActiveDevices[data.location]=data.attributes[data.location];fields.currentData.isWifiUsedByDevices=true;this.getViewObj().fields.currentData.isWifiUsedByDevices=true}}else if(data.reason==="wifi_device_removed"){if(data.attributes.hasOwnProperty(data.location)){delete fields.currentData.knownActiveDevices[data.location];count=0;for(key in fields.currentData.knownActiveDevices){if(fields.currentData.knownActiveDevices.hasOwnProperty(key)){count+=1}}if(count){fields.currentData.isWifiUsedByDevices=true;this.getViewObj().fields.currentData.isWifiUsedByDevices=true}else{fields.currentData.isWifiUsedByDevices=false;this.getViewObj().fields.currentData.isWifiUsedByDevices=false}}}else if(data.reason==="wifi_device_updated"){if(data.attributes.hasOwnProperty(data.location)){fields.currentData.knownActiveDevices[data.location]=data.attributes[data.location]}if(data.attributes[data.location].hasOwnProperty("Active")){if(data.attributes[data.location].Active===true){fields.currentData.isWifiUsedByDevices=true;this.getViewObj().fields.currentData.isWifiUsedByDevices=true}else{if(data.attributes.hasOwnProperty(data.location)){delete fields.currentData.knownActiveDevices[data.location];count=0;for(key in fields.currentData.knownActiveDevices){if(fields.currentData.knownActiveDevices.hasOwnProperty(key)){count+=1}}if(count){fields.currentData.isWifiUsedByDevices=true;this.getViewObj().fields.currentData.isWifiUsedByDevices=true}else{fields.currentData.isWifiUsedByDevices=false;this.getViewObj().fields.currentData.isWifiUsedByDevices=false}}}}}}};this.getGlobalWifiStatus=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.WiFi.getActivationState",aNext,null)},function(aNext,aResult){if(aResult.status===0){fields.currentData.getGlobalWifiStatus=aResult.data;basicUtilities.callback(aCallback,false,0,aResult.data)}else{console.warn("WifiAdvancedSchedulerCtrlClass: Failed to retrieve global wifi status");basicUtilities.callback(aCallback,false,0,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to get global wifi status","aba0079")}}],this)};this.setGlobalWifiStatus=function(aCallback,aParam){if(typeof aParam!=="undefined"){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.WiFi.setActivationState",aNext,aParam)},function(aNext,aResult){if(aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{console.warn("WifiAdvancedSchedulerCtrlClass: Failed to set global wifi settings");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to set global wifi status","aba0080")}}],this)}else{console.error("WifiAdvancedSchedulerCtrlClass: no value was given to set global wifi settings");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: No value was given to set global wifi settings","aba0081")}};this.getAccessPoints=function(aCallback){var index;basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.WiFi.listAccessPoints",aNext,null)},function(aNext,aResult){if(aResult.status===0){if(aResult.hasOwnProperty("data")){fields.currentData.getAccessPoints=aResult.data;if(aResult.data.hasOwnProperty("accessPointList")){for(index=0;index<aResult.data.accessPointList.length;index=index+1){if(aResult.data.accessPointList[index].frequencyBand.toLowerCase().indexOf("2.4ghz")>-1){fields.currentData.private24Id=aResult.data.accessPointList[index].accessPointId}else if(aResult.data.accessPointList[index].frequencyBand.toLowerCase().indexOf("5ghz")>-1){fields.currentData.private5Id=aResult.data.accessPointList[index].accessPointId}}}if(aResult.data.hasOwnProperty("radioList")){for(index=0;index<aResult.data.radioList.length;index=index+1){if(aResult.data.radioList[index].frequencyBand.toLowerCase().indexOf("2.4ghz")>-1){fields.currentData.radio24Id=aResult.data.radioList[index].radioId}else if(aResult.data.radioList[index].frequencyBand.toLowerCase().indexOf("5ghz")>-1){fields.currentData.radio5Id=aResult.data.radioList[index].radioId}}}}basicUtilities.callback(aCallback,false,0,aResult.data)}else{console.warn("WifiAdvancedSchedulerCtrlClass: Failed to retrieve access points");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to retrieve access points","aba0082")}}],this)};this.getSchedule=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.WiFi.getSchedule",aNext,null)},function(aNext,aResult){if(aResult.status===0){fields.currentData.getSchedule=aResult.data;basicUtilities.callback(aCallback,false,0,aResult.data)}else{console.warn("WifiAdvancedSchedulerCtrlClass: Failed to retrieve wifi schedule");basicUtilities.callback(aCallback,false,0,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to retrieve wifi schedule","aba0083")}}],this)};this.getTime=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.Time.getTime",aNext,null)},function(aNext,aResult){if(aResult.status===0){fields.currentData.getTime=aResult.data;basicUtilities.callback(aCallback,false,0,aResult.data)}else{console.warn("WifiAdvancedSchedulerCtrlClass: Failed to retrieve time");basicUtilities.callback(aCallback,false,0,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to retrieve time","aba0084")}}],this)};this.setSchedule=function(aCallback,aParam){if(typeof aParam!=="undefined"){if(aParam.hasOwnProperty("scheduleList")){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.WiFi.setSchedule",aNext,aParam)},function(aNext,aResult){if(aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{console.warn("WifiAdvancedSchedulerCtrlClass: Failed to set wifi schedule");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to set wifi schedule","aba0085")}}],this)}else{console.error("WifiAdvancedSchedulerCtrlClass: no wifi schedule was given to set");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: No wifi schedule was given to set","aba0086")}}else{console.error("WifiAdvancedSchedulerCtrlClass: no value was given to set wifi schedule");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: No value was given to set wifi schedule","aba0087")}};this.getDevices=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.NetworkMap.listDevices",aNext,{filter:{linkModeList:["WIFI"],isActive:true}})},function(aNext,aResult){if(aResult.status===0){fields.currentData.getDevices=aResult.data;basicUtilities.callback(aCallback,false,0,aResult.data)}else{console.warn("WifiAdvancedSchedulerCtrlClass: Failed to retrieve active devices on WiFi");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("WifiAdvancedSchedulerCtrlClass: Failed to retrieve active devices on WiFi","aba0088")}}],this)}}return WifiAdvancedSchedulerCtrlClass});