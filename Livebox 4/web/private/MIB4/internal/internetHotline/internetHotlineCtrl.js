define(["utils/console","utils/basics","lib/stateCtrlInterface"],function(console,basicUtilities,StateCtrlClass){"use strict";function InternetHotlineCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("InternetHotlineCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewCancelled"){console.debug("InternetHotlineCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));this.stopRemote()}else if(aEventId==="ViewSubmitted"){console.debug("InternetHotlineCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));if(aData.state==="get"){this.getSupportStatus()}else if(aData.state==="start"){this.startRemote()}else if(aData.state==="restart"){this.restartTimeout()}}else{console.warn("InternetHotlineCtrlClass: Unexpected event '"+aEventId+"'")}};fields={password:null,loadInfoTimer:null,userRemoteAdmin:null};StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("InternetHotlineCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("InternetHotlineCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("InternetHotlineCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().enable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("InternetHotlineCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.restartTimeout=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.RemoteAccess.restartTimeout",aNext,null)},function(aNext,aResult){if(aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("<span class='Translation' data-translation='internetHotline.notifyError.restartTimeout'></span>","yke0001");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.startRemote=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.RemoteAccess.getState",aNext,null)},function(aNext,aResult){if(aResult.status===0){console.debug(aResult.data.isActivated);this.callSahApi("sah.Connection.Server.RemoteAccess.activate",aNext,{login:"support",password:this.generatePassword(8),portNumber:this.generatePort(),timeout:900});this.getViewObj().toggleStopButton()}},function(aNext,aResult){if(!aResult||aResult.status===0){if(fields.loadingTimer){window.clearTimeout(fields.loadInfoTimer)}fields.loadInfoTimer=window.setTimeout(function(){this.getState(aNext)}.bind(this),2e3)}else{this.getViewObj().notifyError("<span class='Translation' data-translation='internetHotline.notifyError.remoteAccess'></span>","yke0003");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getState=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.RemoteAccess.getState",aNext,null)},function(aNext,aResult){if(aResult.status===0){if(aResult.data.isActivated===true){this.getViewObj().fillForm("support",fields.password||"********",aResult.data.ipIpv4,aResult.data.port,aResult.data.url);this.getViewObj().switchButton(aResult.data.timeLeft>0);this.getViewObj().handleProgressBar(aResult.data.timeout,aResult.data.timeLeft);this.getViewObj().toggleStopButton()}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.stopRemote=function(){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.RemoteAccess.deactivate",aNext,null)},function(aNext,aResult){if(aResult.status===0){console.debug("disabling previous remote access...");this.getViewObj().fillForm("","","","","");basicUtilities.callback(null,false,0,null)}else{basicUtilities.callback(null,false,-1,null)}}],this)};this.searchRAUser=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.User.listGroups",aNext,null)},function(aNext,aResult){if(aResult.status===0){if(aResult.data.groupList.length>0&&aResult.data.groupList.join().indexOf("remoteadmin")>=0){this.callSahApi("sah.Device.User.listUsers",aNext,null)}else{this.getViewObj().notifyError("<span class='Translation' data-translation='internetRemote.notifyError.remote'></span>","yke0004");basicUtilities.callback(aCallback,false,-1,null)}}else{this.getViewObj().notifyError("<span class='Translation' data-translation='internetRemote.notifyError.remote'></span>","yke0004");basicUtilities.callback(aCallback,false,-1,null)}},function(aNext,aResult){var indexUser,userGroupParticipation;if(aResult.status===0){for(indexUser=0;indexUser<aResult.data.userList.length;indexUser+=1){userGroupParticipation=aResult.data.userList[indexUser].groupList.join(" ");if(userGroupParticipation.indexOf("remoteadmin")>=0&&aResult.data.userList[indexUser].login!=="support"){fields.userRemoteAdmin=aResult.data.userList[indexUser].login}}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("<span class='Translation' data-translation='internetRemote.notifyError.remote'></span>","yke0004");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getSupportStatus=function(aCallback){basicUtilities.queue([function(aNext){this.searchRAUser(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!fields.userRemoteAdmin){this.getState(aNext)}else{basicUtilities.callback(aNext,false,-1,null)}}else{basicUtilities.callback(aNext,false,-1,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.generatePassword=function(length){var text,possible,index;text="";possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!#%&()?+-;:";for(index=0;index<length;index+=1){text+=possible.charAt(Math.floor(Math.random()*possible.length))}fields.password=text;return text};this.generatePort=function(){return Math.floor(Math.random()*2e4+1e4)}}return InternetHotlineCtrlClass});