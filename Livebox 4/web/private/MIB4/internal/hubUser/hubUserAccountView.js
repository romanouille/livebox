define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","text!app/config/users.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function HubUserAccountViewClass(aStateId,aTranslateObj){var fields,deleteUser=function(event){event.preventDefault();fields.selected=parseInt(event.currentTarget.id.split("_")[4],10);this.generateEvent("ViewSubmitted",{origin:fields.id,state:"delete",param:{userId:fields.dataUser[fields.selected].userId}})},displayUserTable=function(){var context={type:"dynamictable",label:"",id:"user_hubuser_table",sortable:0,titlevalue:["<span class='Translation' data-translation='hubUser.user.ident.label'></span>","<span class='Translation' data-translation='hubUser.user.name.label'></span>","<span class='Translation' data-translation='hubUser.user.usedSpace.label'></span>","<span class='Translation' data-translation='hubUser.user.state.label'></span>"],value:fields.dataUsersTable};if(fields.dataUsersTable.length===0){context={type:"dynamictable",label:"",id:"user_hubuser_table",emptyLabel:"<span class='Translation' data-translation='hubUser.journal.empty'></span>",sortable:0,titlevalue:["<span class='Translation' data-translation='hubUser.user.ident.label'></span>","<span class='Translation' data-translation='hubUser.user.name.label'></span>","<span class='Translation' data-translation='hubUser.user.usedSpace.label'></span>","<span class='Translation' data-translation='hubUser.user.state.label'></span>"],value:[]}}basicUtilities.queue([function(aNext){TemplateClass.boundDataTable($("#user_hubuser_table"),context);aNext()},function(){var indexUser;for(indexUser=0;indexUser<fields.dataUser.length;indexUser+=1){if(fields.dataUser[indexUser].status==="ok"){$("#userState_"+indexUser).val("ok")}else{$("#userState_"+indexUser).val("suspend")}}listenViewEvents.call(this);this.translate()}],this)},listenViewEvents=function(){var index;$("#tab_template_container").off().on("keydown",function(event){var keyCode=event.keyCode||event.which;if(keyCode===39){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"account"})}else if(keyCode===37){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"journal"})}}.bind(this));$("#tab_userHub_account").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"account"})}.bind(this));$("#tab_userHub_journal").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"journal"})}.bind(this));$("#add_user").off().on("click",function(event){event.preventDefault();$("#input_password").val("");$("#input_mail").val("");TemplateClass.showPopup($("#popup_addUser_hub"));this.displayPopupInfo("user")}.bind(this));$("#popup_user_hub_add").off().on("click",function(event){event.preventDefault();if(this.isValidAccount($("#input_mail").val().toString(),$("#input_password").val().toString())){this.generateEvent("ViewSubmitted",{origin:fields.id,state:"add_user",param:{userId:$("#input_mail").val().toString(),password:$("#input_password").val().toString()}})}}.bind(this));$("#popup_user_hub_cancel").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_addUser_hub"));this.generateEvent("ViewSubmitted",{origin:fields.id,state:"list_user"})}.bind(this));$("#popup_user_hub_error_close").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_addUser_hub"))}.bind(this));$("#popup_user_hub_success_close").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_addUser_hub"));this.generateEvent("ViewSubmitted",{origin:fields.id,state:"list_user"})}.bind(this));for(index=0;index<fields.dataUsersTable.length;index+=1){$("#user_hubuser_table_delete_"+index).off().on("click",deleteUser.bind(this))}$("#popup_userState_hub_suspend").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"suspend",param:{userId:fields.dataUser[fields.selected].userId,isEnabled:false}})}.bind(this));$("#save_user").off().on("click",function(event){event.preventDefault();this.updateListUser()}.bind(this));$("#popup_user_hub_suspend_close").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_updateState_hub"));this.generateEvent("ViewSubmitted",{origin:fields.id,state:"list_user"})}.bind(this));$("#popup_userState_hub_close").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_updateState_hub"));this.generateEvent("ViewSubmitted",{origin:fields.id,state:"list_user"})}.bind(this));$("#popup_user_hub_delete_close").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_updateState_hub"));this.generateEvent("ViewSubmitted",{origin:fields.id,state:"list_user"})}.bind(this));$("#popup_user_hub_activate_close").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_updateState_hub"));this.generateEvent("ViewSubmitted",{origin:fields.id,state:"list_user"})}.bind(this));$("#popup_confirmDelete_hub_close").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_updateState_hub"));this.generateEvent("ViewSubmitted",{origin:fields.id,state:"list_user"})}.bind(this));$("#popup_userState_hub_activate").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"suspend",param:{userId:fields.dataUser[fields.selected].userId,isEnabled:true}})}.bind(this));$("#popup_confirmDelete_hub_delete").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"delete",param:{userId:fields.dataUser[fields.selected].userId}})}.bind(this));this.toggleSaveButton();$("#input_mail, #input_password").on("input",function(){this.toggleSaveButton()}.bind(this))};fields={language:{id:"",data:{}},loggedUserBehaviour:{lastFocusedElt:[],lastClickedElt:[],lastRelevantElt:""},currentData:{},selected:0,dataUser:[],dataUsersTable:[]};StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("HubUserAccountViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserAccountViewClass: Initialising state '"+this.getId()+"'","rra0099")}}],this)};this.quit=function(aCallback){console.debug("HubUserAccountViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserAccountViewClass: Releasing state '"+this.getId()+"'","rra0100")}}],this)};this.enable=function(aCallback){console.debug("HubUserAccountViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setAppCloseButton(aNext,"app_close")},function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){fields.reverseName=false;fields.reverseTime=false;fields.reverseType=false;fields.sortBy="type";basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserAccountViewClass: Enabling state '"+this.getId()+"'","rra0101")}}],this)};this.disable=function(aCallback){console.debug("HubUserAccountViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){fields.dataUsersTable=[];this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserAccountViewClass: Disabling state '"+this.getId()+"'","rra0102")}}],this)};this.logUserBehaviour=function(aCallback){$(window.document).on("click",function(event){if(fields.loggedUserBehaviour.lastClickedElt.length>10){fields.loggedUserBehaviour.lastClickedElt.shift()}fields.loggedUserBehaviour.lastClickedElt.push($(event.target))});$(window.document).on("focus",function(event){if(fields.loggedUserBehaviour.lastFocusedElt.length>10){fields.loggedUserBehaviour.lastFocusedElt.shift()}fields.loggedUserBehaviour.lastFocusedElt.push($(event.target))});basicUtilities.callback(aCallback,false,0,null)};this.logLastRelevantElt=function(aCallback,aObj){fields.loggedUserBehaviour.lastRelevantElt=aObj;basicUtilities.callback(aCallback,false,0,null)};this.getLastClickedHistory=function(){return fields.loggedUserBehaviour.lastClickedElt};this.getLastFocusedHistory=function(){return fields.loggedUserBehaviour.lastFocusedElt};this.getLastRelevantElt=function(){return fields.loggedUserBehaviour.lastRelevantElt};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserAccountViewClass fillTemplate failed","rra0103")}}],this)};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+aResult.data+"</style>")}if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserAccountViewClass setStyle failed","rra0104")}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.setDisabledInput=function(aCallback,aId,aDisabled){if(aDisabled){$("#"+aId).prop("disabled",true)}else{$("#"+aId).prop("disabled",false)}basicUtilities.callback(aCallback,false,0,null)};this.displayUsers=function(aList){var indexUser,user,undef;fields.dataUsersTable=[];fields.dataUser=aList;if(aList!==undef){for(indexUser=0;indexUser<fields.dataUser.length;indexUser+=1){user={type:"static",defaultvalue:[fields.dataUser[indexUser].userId,fields.dataUser[indexUser].name,parseInt(fields.dataUser[indexUser].usedSpace/1024,10)+" Go","<select id='userState_"+indexUser+'\' class="select small-select-padding"><option class="Translation" data-translation="hubUser.user.state.ok" value="ok" ></option><option  class="Translation" data-translation="hubUser.user.state.disabled" value="suspend"></option></select>']};fields.dataUsersTable.push(user)}}displayUserTable.call(this);$("#hubUser_user_desc2").hide()};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);this.translate();TemplateClass.enablePopOver();$(window).resize(function(){TemplateClass.enablePopOver()});aNext()}else{basicUtilities.callback(aCallback,false,-1,null)}},function(){$("#tab_template_container").focus();listenViewEvents.call(this);this.setPageTitle(null,$(".header-title").find("h1").find("span").html());basicUtilities.callback(aCallback,false,0,null)}],this)};this.displayPopupInfo=function(state,error){$("#user_title").css("width","10em");$("#user_title").css("display","block");$("#user_title").css("margin","0 auto");$("#success_title").css("width","10em");$("#success_title").css("display","block");$("#success_title").css("margin","0 auto");$("#error_title").css("width","20em");$("#error_title").css("display","block");$("#error_title").css("margin","0 auto");this.displayPasswordError(true);if(state==="user"){$("#user_firstDesc").show();$("#user_secondDesc").show();$("#user_title").show();$("#user_firstLine").show();$("#user_secondLine").show();$(".txtandfield-container").show();$("#user_password").show();$("#user_forgetPassword").show();$("#user_help").show();$("#popup_user_button").show();$("#error_title").hide();$("#error_firstDesc").hide();$("#error_firstLine").hide();$("#error_secondLine").hide();$("#error_cgu_link").hide();$("#error_internet_link").hide();$("#popup_error_button").hide();$("#success_firstDesc").hide();$("#success_title").hide();$("#success_firstLine").hide();$("#popup_success_button").hide()}else if(state==="error"){$("#error_title").show();$("#error_firstDesc").show();$("#error_firstLine").show();$("#error_secondLine").show();$("#error_cgu_link").hide();$("#error_internet_link").hide();$("#popup_error_button").show();$("#user_firstDesc").hide();$("#user_secondDesc").hide();$("#user_title").hide();$("#user_firstLine").hide();$("#user_secondLine").hide();$(".txtandfield-container").hide();$("#user_forgetPassword").hide();$("#user_help").hide();$("#popup_user_button").hide();$("#success_firstDesc").hide();$("#success_title").hide();$("#success_firstLine").hide();$("#popup_success_button").hide();if(error==="cgu"){$("#error_cgu_link").show()}else if(error==="internet"){$("#error_internet_link").show()}if(error){$("#error_title").html('<img class="warning" src="../../common/img/app_conf/warning_big.png"><span data-translation=hubUser.user.popup.error.'+error+'.title class="Translation"></span>');$("#error_firstDesc span").attr("data-translation","hubUser.user.popup.error."+error+".desc")}else{$("#error_title").html('<img class="warning" src="../../common/img/app_conf/warning_big.png"><span data-translation=hubUser.user.popup.error.undefined.title class="Translation"></span>');$("#error_firstDesc span").attr("data-translation","hubUser.user.popup.error.undefined.desc")}this.translate()}else if(state==="success"){$("#success_firstDesc").show();$("#success_title").show();$("#success_firstLine").show();$("#popup_success_button").show();$("#user_firstDesc").hide();$("#user_secondDesc").hide();$("#user_title").hide();$("#user_firstLine").hide();$("#user_secondLine").hide();$(".txtandfield-container").hide();$("#user_forgetPassword").hide();$("#user_help").hide();$("#popup_user_button").hide();$("#error_title").hide();$("#error_firstDesc").hide();$("#error_firstLine").hide();$("#error_secondLine").hide();$("#error_cgu_link").hide();$("#error_internet_link").hide();$("#popup_error_button").hide()}else if(state==="suspend"){$("#userState_title").hide();$(".puce-orange").hide();$("#userState_firstLine").hide();$("#userState_firstDesc").hide();$("#user_hubUpdateState_table").hide();$("#popup_userState_button").hide();$("#suspend_title").show();$("#suspend_firstLine").show();$("#suspend_firstDesc").show();$("#popup_suspend_button").show();$("#delete_title").hide();$("#delete_firstLine").hide();$("#delete_firstDesc").hide();$("#popup_delete_button").hide();$("#popup_confirmDelete_button").hide();$("#confirmDelete_secondDesc").hide();$("#confirmDelete_firstDesc").hide();$("#confirmDelete_firstLine").hide();$("#confirmDelete_title").hide();$("#activate_title").hide();$("#activate_firstLine").hide();$("#activate_firstDesc").hide();$("#popup_activate_button").hide()}else if(state==="accountActivated"){$("#userState_title").show();$(".puce-orange").show();$("#userState_firstLine").show();$("#userState_firstDesc").show();$("#user_hubUpdateState_table").show();$("#popup_userState_button").show();$("#popup_userState_hub_activate").hide();$("#popup_userState_hub_suspend").show();$("#suspend_title").hide();$("#suspend_firstLine").hide();$("#suspend_firstDesc").hide();$("#popup_suspend_button").hide();$("#delete_title").hide();$("#delete_firstLine").hide();$("#delete_firstDesc").hide();$("#popup_delete_button").hide();$("#popup_confirmDelete_button").hide();$("#confirmDelete_secondDesc").hide();$("#confirmDelete_firstDesc").hide();$("#confirmDelete_firstLine").hide();$("#confirmDelete_title").hide();$("#activate_title").hide();$("#activate_firstLine").hide();$("#activate_firstDesc").hide();$("#popup_activate_button").hide();$("#user_hubUpdateState_table_table td:eq(8)").text("actif")}else if(state==="accountSuspended"){$("#userState_title").show();$(".puce-orange").show();$("#userState_firstLine").show();$("#userState_firstDesc").show();$("#user_hubUpdateState_table").show();$("#popup_userState_button").show();$("#popup_userState_hub_activate").show();$("#popup_userState_hub_suspend").hide();$("#suspend_title").hide();$("#suspend_firstLine").hide();$("#suspend_firstDesc").hide();$("#popup_suspend_button").hide();$("#delete_title").hide();$("#delete_firstLine").hide();$("#delete_firstDesc").hide();$("#popup_delete_button").hide();$("#popup_confirmDelete_button").hide();$("#confirmDelete_secondDesc").hide();$("#confirmDelete_firstDesc").hide();$("#confirmDelete_firstLine").hide();$("#confirmDelete_title").hide();$("#activate_title").hide();$("#activate_firstLine").hide();$("#activate_firstDesc").hide();$("#popup_activate_button").hide();$("#user_hubUpdateState_table_table td:eq(8)").text("suspendu")}else if(state==="delete"){$("#userState_title").hide();$(".puce-orange").hide();$("#userState_firstLine").hide();$("#userState_firstDesc").hide();$("#user_hubUpdateState_table").hide();$("#popup_userState_button").hide();$("#suspend_title").hide();$("#suspend_firstLine").hide();$("#suspend_firstDesc").hide();$("#popup_suspend_button").hide();$("#delete_title").show();$("#delete_firstLine").show();$("#delete_firstDesc").show();$("#popup_delete_button").show();$("#popup_confirmDelete_button").hide();$("#confirmDelete_secondDesc").hide();$("#confirmDelete_firstDesc").hide();$("#confirmDelete_firstLine").hide();$("#confirmDelete_title").hide();$("#activate_title").hide();$("#activate_firstLine").hide();$("#activate_firstDesc").hide();$("#popup_activate_button").hide()}else if(state==="confirmDelete"){$("#userState_title").hide();$(".puce-orange").hide();$("#userState_firstLine").hide();$("#userState_firstDesc").hide();$("#user_hubUpdateState_table").show();$("#popup_userState_button").hide();$("#suspend_title").hide();$("#suspend_firstLine").hide();$("#suspend_firstDesc").hide();$("#popup_suspend_button").hide();$("#delete_title").hide();$("#delete_firstLine").hide();$("#delete_firstDesc").hide();$("#popup_delete_button").hide();$("#popup_confirmDelete_button").show();$("#confirmDelete_secondDesc").show();$("#confirmDelete_firstDesc").show();$("#confirmDelete_firstLine").show();$("#confirmDelete_title").show();$("#activate_title").hide();$("#activate_firstLine").hide();$("#activate_firstDesc").hide();$("#popup_activate_button").hide()}else if(state==="activate"){$("#userState_title").hide();$(".puce-orange").hide();$("#userState_firstLine").hide();$("#userState_firstDesc").hide();$("#user_hubUpdateState_table").hide();$("#popup_userState_button").hide();$("#suspend_title").hide();$("#suspend_firstLine").hide();$("#suspend_firstDesc").hide();$("#popup_suspend_button").hide();$("#delete_title").hide();$("#delete_firstLine").hide();$("#delete_firstDesc").hide();$("#popup_delete_button").hide();$("#popup_confirmDelete_button").hide();$("#confirmDelete_secondDesc").hide();$("#confirmDelete_firstDesc").hide();$("#confirmDelete_firstLine").hide();$("#confirmDelete_title").hide();$("#activate_title").show();$("#activate_firstLine").show();$("#activate_firstDesc").show();$("#popup_activate_button").show()}TemplateClass.positionPopup($("#popup_addUser_hub"));TemplateClass.positionPopup($("#popup_updateState_hub"))};this.displayPasswordError=function(isValid){if(isValid){$("#user_input_warning").hide()}else{$("#user_input_warning").show();$("#user_input_warning").css("color","red")}};this.isValidAccount=function(userId,password){if(userId.trim()===""||password.trim()===""){this.displayPasswordError(false);return false}this.displayPasswordError(true);return true};this.toggleSaveButton=function(){if($("#input_mail").val().toString()===""||$("#input_password").val().toString()===""){$("#popup_user_hub_add").attr("disabled",true)}else{$("#popup_user_hub_add").attr("disabled",false)}};this.updateListUser=function(){var indexUser;for(indexUser=0;indexUser<fields.dataUser.length;indexUser+=1){if($("#userState_"+indexUser).val()!==fields.dataUser[indexUser].status){this.generateEvent("ViewSubmitted",{origin:fields.id,state:"update_state",param:{userId:fields.dataUser[fields.selected].userId,isEnabled:$("#userState_"+indexUser).val()==="ok"}})}}}}return HubUserAccountViewClass});