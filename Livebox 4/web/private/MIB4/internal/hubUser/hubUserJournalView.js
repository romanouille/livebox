define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","text!app/config/journal.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function HubUserJournalViewClass(aStateId,aTranslateObj){var fields,formatDate=function(date,isDate){var hours,minutes,day,month,year,strTime,strDay;hours=date.getHours();minutes=date.getMinutes();day=date.getDate();month=date.getMonth()+1;year=date.getFullYear();hours=hours%24;hours=hours<10?"0"+hours:hours;minutes=minutes<10?"0"+minutes:minutes;strTime=hours+":"+minutes+" ";month=date.getMonth()+1;year=date.getFullYear();day=day<10?"0"+day:day;month=month<10?"0"+month:month;year=year<10?"0"+year:year;strDay=day+"/"+month+"/"+year;if(isDate){return strDay}return strTime},listenViewEvents=function(){$("#tab_template_container").off().on("keydown",function(event){var keyCode=event.keyCode||event.which;if(keyCode===39){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"account"})}else if(keyCode===37){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"journal"})}}.bind(this));$("#tab_userHub_account").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"account"})}.bind(this));$("#tab_userHub_journal").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"journal"})}.bind(this))},displayJournalTable=function(){var context={type:"dynamictable",label:"",id:"journal_hubuser_table",sortable:0,titlevalue:["<span class='Translation' data-translation='hubUser.journal.date.label'></span>","<span class='Translation' data-translation='hubUser.journal.heure.label'></span>","<span class='Translation' data-translation='hubUser.journal.user.label'></span>","<span class='Translation' data-translation='hubUser.journal.activity.label'></span>"],value:fields.dataJournalTable};if(fields.dataJournalTable.length===0){context={type:"dynamictable",label:"",id:"journal_telephone_table",emptyLabel:"<span class='Translation' data-translation='hubUser.journal.empty'></span>",sortable:0,titlevalue:["<span class='Translation' data-translation='hubUser.journal.date.label'></span>","<span class='Translation' data-translation='hubUser.journal.heure.label'></span>","<span class='Translation' data-translation='hubUser.journal.user.label'></span>","<span class='Translation' data-translation='hubUser.journal.activity.label'></span>"],value:[]}}basicUtilities.queue([function(aNext){TemplateClass.boundDataTable($("#journal_hubuser_table"),context);aNext()},function(){listenViewEvents.call(this);$(".conf-table-blank-cell-empty").hide();this.translate()}],this)};fields={language:{id:"",data:{}},loggedUserBehaviour:{lastFocusedElt:[],lastClickedElt:[],lastRelevantElt:""},currentData:{},selected:0,dataActivity:[],dataJournalTable:[]};StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("HubUserJournalViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserJournalViewClass: Initialising state '"+this.getId()+"'","rra0099")}}],this)};this.quit=function(aCallback){console.debug("HubUserJournalViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserJournalViewClass: Releasing state '"+this.getId()+"'","rra0100")}}],this)};this.enable=function(aCallback){console.debug("HubUserJournalViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setAppCloseButton(aNext,"app_close")},function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){fields.reverseName=false;fields.reverseTime=false;fields.reverseType=false;fields.sortBy="type";basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserJournalViewClass: Enabling state '"+this.getId()+"'","rra0101")}}],this)};this.disable=function(aCallback){console.debug("HubUserJournalViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){fields.dataJournalTable=[];this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserJournalViewClass: Disabling state '"+this.getId()+"'","rra0102")}}],this)};this.logUserBehaviour=function(aCallback){$(window.document).on("click",function(event){if(fields.loggedUserBehaviour.lastClickedElt.length>10){fields.loggedUserBehaviour.lastClickedElt.shift()}fields.loggedUserBehaviour.lastClickedElt.push($(event.target))});$(window.document).on("focus",function(event){if(fields.loggedUserBehaviour.lastFocusedElt.length>10){fields.loggedUserBehaviour.lastFocusedElt.shift()}fields.loggedUserBehaviour.lastFocusedElt.push($(event.target))});basicUtilities.callback(aCallback,false,0,null)};this.logLastRelevantElt=function(aCallback,aObj){fields.loggedUserBehaviour.lastRelevantElt=aObj;basicUtilities.callback(aCallback,false,0,null)};this.getLastClickedHistory=function(){return fields.loggedUserBehaviour.lastClickedElt};this.getLastFocusedHistory=function(){return fields.loggedUserBehaviour.lastFocusedElt};this.getLastRelevantElt=function(){return fields.loggedUserBehaviour.lastRelevantElt};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserJournalViewClass fillTemplate failed","rra0103")}}],this)};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+aResult.data+"</style>")}if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("HubUserJournalViewClass setStyle failed","rra0104")}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.setDisabledInput=function(aCallback,aId,aDisabled){if(aDisabled){$("#"+aId).prop("disabled",true)}else{$("#"+aId).prop("disabled",false)}basicUtilities.callback(aCallback,false,0,null)};this.displayJournal=function(aList){var indexActivity,activity,undef;fields.dataJournalTable=[];fields.dataActivity=aList;console.log(JSON.stringify(fields.dataActivity));if(aList!==undef){for(indexActivity=0;indexActivity<fields.dataActivity.length;indexActivity+=1){activity={type:"noDeleteIcon",defaultvalue:[formatDate.call(this,new Date(fields.dataActivity[indexActivity].date),true),formatDate.call(this,new Date(fields.dataActivity[indexActivity].date),false),fields.dataActivity[indexActivity].userId,"<span class='Translation' data-translation=hubUser.journal.activity."+fields.dataActivity[indexActivity].event+"></span>"]};fields.dataJournalTable.push(activity)}}displayJournalTable.call(this)};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);this.translate();TemplateClass.enablePopOver();$(window).resize(function(){TemplateClass.enablePopOver()});aNext()}else{basicUtilities.callback(aCallback,false,-1,null)}},function(){$("#delete_historic").hide();$("#tab_template_container").focus();listenViewEvents.call(this);this.setPageTitle(null,$(".header-title").find("h1").find("span").html());basicUtilities.callback(aCallback,false,0,null)}],this)}}return HubUserJournalViewClass});