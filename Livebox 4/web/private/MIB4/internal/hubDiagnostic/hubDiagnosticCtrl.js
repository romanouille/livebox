define(["utils/console","utils/basics","lib/stateCtrlInterface"],function(console,basicUtilities,StateCtrlClass){"use strict";function HubDiagnosticCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,globalResult,onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("HubDiagnosticCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewCancelled"){console.debug("HubDiagnosticCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));this.quit()}else if(aEventId==="ViewSubmitted"){console.debug("HubDiagnosticCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));if(aData.state==="start_check"){this.startDiagnostic(fields.deviceId)}else if(aData.state==="get_check_state"){this.getStorageState(fields.deviceId)}}else{console.warn("HubDiagnosticCtrlClass: Unexpected event '"+aEventId+"'")}};fields={deviceId:-1};globalResult={};StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("HubDiagnosticCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("HubDiagnosticCtrlClass: Initialising state '"+this.getId()+"'","rra0219")}}],this)};this.quit=function(aCallback){console.debug("HubDiagnosticCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("HubDiagnosticCtrlClass: Releasing state '"+this.getId()+"'","rra0220")}}],this)};this.enable=function(aCallback){console.debug("HubDiagnosticCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().enable(aNext)},function(aNext){this.getDeviceId(aNext)},function(aNext){this.getTemperature(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("HubDiagnosticCtrlClass: Enabling state '"+this.getId()+"'","rra0221")}}],this)};this.disable=function(aCallback){console.debug("HubDiagnosticCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("HubDiagnosticCtrlClass: Disabling state '"+this.getId()+"'","rra0222")}}],this)};this.getStorageState=function(uri,aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.Storage.getStorageHddCheckState",aNext,{deviceId:uri})},function(aNext,aResult){if(!aResult||aResult.status===0){if(aResult.data.lastError!==0){this.getViewObj().displayPopupInfo("error_check")}else{this.getViewObj().displayPopupInfo("success_check")}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().displayPopupInfo("error_check");this.getViewObj().notifyError("HubDiagnosticCtrlClass: internal Error getStorageHddCheckState failed","rra0226");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.startDiagnostic=function(uri,aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.Storage.startStorageHddCheck",aNext,{deviceId:uri,checkMethod:0})},function(aNext,aResult){if(!aResult||aResult.status===0){this.getViewObj().displayPopupInfo("inprogress_check");if(this.isEmulated()){window.setTimeout(function(){this.getStorageState(fields.deviceId)}.bind(this),5e3)}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().displayPopupInfo("error_check");this.getViewObj().notifyError("HubDiagnosticCtrlClass: internal Error diagnostic Hub failed","rra0227");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getDeviceId=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.MediaCloud.getStorage",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){fields.deviceId=aResult.data.deviceId;basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("HubDiagnosticCtrlClass: internal Error getDeviceId failed","rra0227");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getTemperature=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.MediaCloud.getGlobalState",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getViewObj().displayInfo(aResult.data.device.temperature);basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("HubInstalledStateCtrlClass: internal Error getTemperature failed","rra0224");basicUtilities.callback(aNext,false,0,null)}}],this)}}return HubDiagnosticCtrlClass});