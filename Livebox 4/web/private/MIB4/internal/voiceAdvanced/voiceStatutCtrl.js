define(["utils/console","utils/basics","lib/stateCtrlInterface","jquery"],function(console,basicUtilities,StateCtrlClass,$){"use strict";function VoiceStatutCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,onViewEvent=function(aEventId,aData){if(aEventId==="ViewSubmitted"){console.debug("VoiceStatutCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));if(aData.state==="status"){window.location.hash="#statut"}else if(aData.state==="journal"){window.location.hash="#journal"}else if(aData.state==="contacts"){window.location.hash="#contacts"}else if(aData.state==="associate"){window.location.hash="#associate"}else if(aData.state==="ringtest"){this.ring(null)}}else{console.warn("VoiceStatutCtrlClass: Unexpected event '"+aEventId+"'");this.getViewObj().notifyError("VoiceStatutCtrlClass: Unexpected event '"+aEventId+"'","rra0000")}};fields={ringTimeout:null};StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("VoiceStatutCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("VoiceStatutCtrlClass init failed","rra0001")}}],this)};this.quit=function(aCallback){console.debug("FakeFirstCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("VoiceStatutCtrlClass view quit failed","rra0002")}}],this)};this.enable=function(aCallback){console.debug("VoiceStatutCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getVoiceStatuts(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getViewObj().enable(aNext);aViewObj.displayStatuts(aResult.data)}else{console.error("VoiceStatutCtrlClass: Internal error");this.getViewObj().notifyError("VoiceStatutCtrlClass getVoiceStatuts failed","rra0003")}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getListAssociate(aNext)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("VoiceStatutCtrlClass displayStatuts failed","rra0004")}},function(aNext,aResult){if(!aResult||aResult.status===0){aViewObj.displayStatuts(aResult.data)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("VoiceStatutCtrlClass getListAssociate failed","rra0005")}}],this)};this.disable=function(aCallback){console.debug("VoiceStatutCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("VoiceStatutCtrlClass view disable failed","rra0006")}}],this)};this.getVoiceStatuts=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.Phone.getServerState",aNext,null)},function(aNext,aResult){if(aResult.status===0){basicUtilities.callback(aCallback,false,0,aResult.data)}else{console.warn("VoiceStatutCtrlClass: Failed to retrieve voice status");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("VoiceStatutCtrlClass: Failed to retrieve voice status","rra0007")}}],this)};this.getListAssociate=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.NetworkMap.listDevices",aNext,{filter:{linkModeList:["CATIQ2"],isActive:true}})},function(aNext,aResult){if(aResult.status===0){basicUtilities.callback(aCallback,false,0,aResult.data)}else{console.warn("VoiceStatutCtrlClass: Failed to retrieve voice status");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("VoiceStatutCtrlClass: Failed to retrieve list dect device","rra0008")}}],this)};this.ring=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.Phone.startRingTest",aNext,null)},function(aNext,aResult){if(aResult.status===0){if(fields.ringTimeout){window.clearTimeout(fields.ringTimeout)}fields.ringTimeout=window.setTimeout(function(){this.getViewObj().stopLoading()}.bind(this),5e3);basicUtilities.callback(aCallback,false,0,aResult.data)}else{console.warn("VoiceStatutCtrlClass: Failed to retrieve voice status");basicUtilities.callback(aCallback,false,-1,null);this.getViewObj().notifyError("VoiceStatutCtrlClass: Failed to start ring test","rra0009")}}],this)};this.OnRingEvent=function(id,data){var isVoiceEvent=false;$.each(data.attributes,function(i,val){if(val.Tags.indexOf("orange")>=0){isVoiceEvent=true}});if(id==="sah.HomeNetwork.NetworkMapEvents"&&isVoiceEvent){this.getViewObj().stopLoading();this.stopEventListener()}};this.listenToRingEvent=function(RingEventHandler){this.startEventListener();this.listenEvent("sah.HomeNetwork.NetworkMapEvents",RingEventHandler)}}return VoiceStatutCtrlClass});