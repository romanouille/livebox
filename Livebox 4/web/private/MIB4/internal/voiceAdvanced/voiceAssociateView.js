define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","text!app/config/associate.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function VoiceAssociateViewClass(aStateId,aTranslateObj){var fields,validatePIN=function(codepin){var codePINPattern=/^(\d{4})$/;return codePINPattern.test(codepin)},validateCaracter=function(codepin){var codePINPattern=/^([0-9]+)$/;return codePINPattern.test(codepin)},toggleUpdateDectSaveButton=function(){if($("#input_updatedect").val().trim().length===0){$("#popup_updatedect_rename").attr("disabled",true)}else{$("#popup_updatedect_rename").attr("disabled",false)}},toggleCodePINSaveButton=function(){if($("#input_pin").val().trim().length===0){$("#popup_updatepin_update").attr("disabled",true)}else{$("#popup_updatepin_update").attr("disabled",false);if(!validateCaracter($("#input_pin").val())){$("#updatepin_error").show();$("#updatepin_error span").attr("class","redtxt")}else{$("#updatepin_error span").attr("class","");$("#updatepin_error").hide()}}},deleteFXS=function(event){event.preventDefault();fields.selected=-1;$("#deletedect_title").html('<span class="Translation" data-translation="voiceAdvanced.associate.popup.delete"></span> combiné1');TemplateClass.showPopup($("#popup_associate_deletedect"));this.translate()},deleteDect=function(event){event.preventDefault();fields.selected=parseInt(event.currentTarget.id.split("_")[4],10);$("#deletedect_title").html('<span class="Translation" data-translation="voiceAdvanced.associate.popup.delete"></span> '+this.escapeString("js",this.escapeString("html",fields.dataDect[fields.selected].deviceName)));TemplateClass.showPopup($("#popup_associate_deletedect"));this.translate()},renameDect=function(event){event.preventDefault();TemplateClass.showPopup($("#popup_associate_updatedect"));$("#popup_updatedect_rename").attr("disabled",true);fields.selected=parseInt(event.target.id,10);$("#input_updatedect").attr("maxlength","16");$("#input_updatedect").val(this.escapeString("js",this.escapeString("html",fields.dataDect[fields.selected].deviceName)));$("#input_updatedect").on("keyup",function(event){event.preventDefault();if(this.value.length>16){this.value=this.value.slice(0,16)}toggleUpdateDectSaveButton()});this.translate()},displayDectTable=function(aList){var context={type:"dynamictable",style:"notitle",label:'<span class="Translation" data-translation="voiceAdvanced.associate.label2"></span>',id:"associate_telephone_table2",value:aList};if(aList.length>0){$("#empty_dect").hide()}else{$("#empty_dect").show()}basicUtilities.queue([function(aNext){TemplateClass.boundDataTable($("#associate_telephone_table2"),context);aNext()},function(){listenViewEvents.call(this);this.translate();$("#associate_telephone_table_table .conf-table-row .conf-table-cell:even").attr("class","conf-table-cell col-xs-1");$("#associate_telephone_table2_table .conf-table-row .conf-table-cell:even").attr("class","conf-table-cell col-xs-1");$("#associate_telephone_table_table .conf-table-row .conf-table-cell:odd").css("padding-left","1em");$("#associate_telephone_table2_table .conf-table-row .conf-table-cell:odd").css("padding-left","1em");$("#associate_telephone_table_table").attr("class","conf-table-row");$("#associate_telephone_table2_table").attr("class","conf-table-row")}],this)},listenViewEvents=function(){$(".header-title span").after('<span id="telnumber"></span>');$("#tab_template_container").off().on("keydown",function(event){var keyCode=event.keyCode||event.which;if(keyCode===39){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"status"})}else if(keyCode===37){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"contacts"})}}.bind(this));$("#tab_telephone_status").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"status"})}.bind(this));$("#tab_telephone_contacts").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"contacts"})}.bind(this));$("#tab_telephone_journal").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"journal"})}.bind(this));$("#tab_telephone_associate").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"associate"})}.bind(this));if(basicUtilities.getCookie("missedCall")>0){$("#missedCall").text(" ("+basicUtilities.getCookie("missedCall")+") ")}else{$("#missedCall").text("")}$("#updatepin_error").hide();$("#link_newdect").off().on("click",function(event){event.preventDefault();TemplateClass.showPopup($("#popup_associate_newdect"));fields.associateAttempt=10;$("#loading_suffix").hide();$("#loading").hide();$("#progressId").hide();this.translate()}.bind(this));$("#associate_telephone_table_table .conf-table-cell:eq(1)").off().on("click",function(event){event.preventDefault();fields.selected=-1;$("#input_updatedect").val("combiné 1");TemplateClass.showPopup($("#popup_associate_updatedect"));this.translate()}.bind(this));this.translate();$("#update_code_pin").off().on("click",function(event){event.preventDefault();TemplateClass.showPopup($("#popup_associate_updatepin"));$("#popup_associate_updatepin label").attr("class","col-xs-4");$("#input_pin").attr("class","inlinetextfield-mediuminput");$("#popup_updatepin_update").attr("disabled",true);$("#input_pin").on("keyup",function(event){event.preventDefault();if(this.value.length>4){this.value=this.value.slice(0,4)}toggleCodePINSaveButton()});this.translate()}.bind(this));$("#reset_code_pin").off().on("click",function(event){event.preventDefault();TemplateClass.showPopup($("#popup_associate_resetpin"));this.translate()}.bind(this));$("#popup_newdect_associate").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"startpairing"});fields.associateAttempt=10;this.displayLoading.call(this,true);if($("#progressBarId").length===0){TemplateClass.progressBarCreate("progressId","progressBarId")}TemplateClass.progressBarStop("progressBarId");TemplateClass.progressBarSetValue("progressBarId",0);TemplateClass.progressBarStartTimer("progressBarId",59,null)}.bind(this));$("#popup_newdect_cancel").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"stoppairing"});this.displayLoading.call(this,false);TemplateClass.progressBarStop("progressBarId");TemplateClass.progressBarSetValue("progressBarId",0);TemplateClass.hidePopup($("#popup_associate_newdect"))}.bind(this));$("#popup_updatedect_rename").off().on("click",function(event){event.preventDefault();if(fields.selected>=0){this.generateEvent("ViewSubmitted",{origin:fields.id,state:"rename",param:{deviceId:fields.dataDect[fields.selected].deviceId,deviceType:fields.dataDect[fields.selected].deviceType,deviceName:$("#input_updatedect").val()}})}TemplateClass.hidePopup($("#popup_associate_updatedect"))}.bind(this));$("#popup_updatedect_cancel").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_associate_updatedect"))}.bind(this));$("#associate_telephone_table_table .conf-table-blank-cell:eq(0) a").off().on("click",deleteFXS.bind(this));$("#associate_telephone_table2_table .conf-table-blank-cell a").off().on("click",deleteDect.bind(this));$("#associate_telephone_table2_table .conf-table-cell").off().on("click",renameDect.bind(this));$("#popup_deletedect_delete").off().on("click",function(event){event.preventDefault();if(fields.selected>=0){this.generateEvent("ViewSubmitted",{origin:fields.id,state:"delete",param:{deviceId:fields.dataDect[fields.selected].deviceId}})}TemplateClass.hidePopup($("#popup_associate_deletedect"))}.bind(this));$("#popup_deletedect_cancel").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_associate_deletedect"))}.bind(this));$("#popup_updatepin_update").off().on("click",function(event){event.preventDefault();if(!validatePIN($("#input_pin").val())){$("#updatepin_error").show();$("#updatepin_error span").attr("class","redtxt")}else{$("#updatepin_error span").attr("class","");this.generateEvent("ViewSubmitted",{origin:fields.id,state:"setpincode",param:{pairingPinCode:$("#input_pin").val()}});$("#updatepin_error").hide();TemplateClass.hidePopup($("#popup_associate_updatepin"))}}.bind(this));$("#popup_updatepin_cancel").off().on("click",function(event){event.preventDefault();$("#updatepin_error span").attr("class","");$("#input_pin").val("");$("#updatepin_error").hide();TemplateClass.hidePopup($("#popup_associate_updatepin"))}.bind(this));$("#popup_resetpin_cancel").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_associate_resetpin"))}.bind(this));$("#popup_resetpin_reset").off().on("click",function(event){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"reset"});TemplateClass.hidePopup($("#popup_associate_resetpin"))}.bind(this));if($("#associate_telephone_table_table .conf-table-row").length===0){$("#empty_FXS").show()}else{$("#empty_FXS").hide()}if($("#associate_telephone_table2_table .conf-table-row").length===0){$("#empty_dect").show()}else{$("#empty_dect").hide()}$("#input_updatedect").on("input",function(event){event.preventDefault();toggleUpdateDectSaveButton.call(this)}.bind(this));$("#input_pin").on("input",function(event){event.preventDefault();toggleCodePINSaveButton.call(this)}.bind(this));$("#input_pin").attr("maxlength","4")};fields={language:{id:"",data:{}},loggedUserBehaviour:{lastFocusedElt:[],lastClickedElt:[],lastRelevantElt:""},currentData:{},dataDectTable:[],oldDectTable:[],dataDect:[],loadingTimer:null,associateAttempt:10,selected:0};StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("VoiceAssociateViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceAssociateViewClass: Initialising state '"+this.getId()+"'","rra0092")}}],this)};this.quit=function(aCallback){console.debug("VoiceAssociateViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceAssociateViewClass: Releasing state '"+this.getId()+"'","rra0093")}}],this)};this.enable=function(aCallback){console.debug("VoiceAssociateViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setAppCloseButton(aNext,"app_close")},function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceAssociateViewClass: Enabling state '"+this.getId()+"'","rra0094")}}],this)};this.disable=function(aCallback){console.debug("VoiceAssociateViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceAssociateViewClass: Disabling state '"+this.getId()+"'","rra0095")}}],this)};this.logUserBehaviour=function(aCallback){$(window.document).on("click",function(event){if(fields.loggedUserBehaviour.lastClickedElt.length>10){fields.loggedUserBehaviour.lastClickedElt.shift()}fields.loggedUserBehaviour.lastClickedElt.push($(event.target))});$(window.document).on("focus",function(event){if(fields.loggedUserBehaviour.lastFocusedElt.length>10){fields.loggedUserBehaviour.lastFocusedElt.shift()}fields.loggedUserBehaviour.lastFocusedElt.push($(event.target))});basicUtilities.callback(aCallback,false,0,null)};this.logLastRelevantElt=function(aCallback,aObj){fields.loggedUserBehaviour.lastRelevantElt=aObj;basicUtilities.callback(aCallback,false,0,null)};this.getLastClickedHistory=function(){return fields.loggedUserBehaviour.lastClickedElt};this.getLastFocusedHistory=function(){return fields.loggedUserBehaviour.lastFocusedElt};this.getLastRelevantElt=function(){return fields.loggedUserBehaviour.lastRelevantElt};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceAssociateViewClass fillTemplate failed","rra0096")}}],this)};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+aResult.data+"</style>")}if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceAssociateViewClass setStyle failed","rra0097")}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.setDisabledInput=function(aCallback,aId,aDisabled){if(aDisabled){$("#"+aId).prop("disabled",true)}else{$("#"+aId).prop("disabled",false)}basicUtilities.callback(aCallback,false,0,null)};this.displayLoading=function(refresh){if(fields.loadingTimer){window.clearTimeout(fields.loadingTimer)}if($("#loading_suffix").text().length===3){$("#loading_suffix").text(".")}else if($("#loading_suffix").text().length===1){$("#loading_suffix").text("..")}else if($("#loading_suffix").text().length===2){$("#loading_suffix").text("...");fields.associateAttempt-=1;this.generateEvent("ViewSubmitted",{origin:fields.id,state:"list_associate_dect"})}if(refresh&&fields.associateAttempt>0){$("#loading_suffix").show();$("#loading").show();$("#progressId").show();fields.loadingTimer=window.setTimeout(function(){this.displayLoading.call(this,true)}.bind(this),2e3)}else if(fields.associateAttempt<=0){TemplateClass.hidePopup($("#popup_associate_newdect"))}else{$("#loading_suffix").hide();$("#loading").hide();$("#progressId").hide();fields.associateAttempt=10}};this.displayStatuts=function(aStatut){var undef;if(aStatut.phoneNumber!==undef&&aStatut.phoneNumber!==""){var prefix,indexPrefix,phoneNumber;prefix=["262","590","594","596"];phoneNumber=aStatut.phoneNumber;for(indexPrefix=0;indexPrefix<prefix.length;indexPrefix+=1){if(phoneNumber===aStatut.phoneNumber){phoneNumber=phoneNumber.replace(new RegExp(prefix[indexPrefix],"g"),"0")}}$("#telnumber").text(" (N° "+phoneNumber+")")}if(aStatut.pairingPinCode!==undef){$("#code_pin").text(aStatut.pairingPinCode)}if(aStatut.catIqVersion!==undef){$(".form-toggleinfo-container:eq(1)").text(aStatut.catIqVersion)}if(aStatut.firmwareVersion!==undef){$(".form-toggleinfo-container:eq(2)").text(aStatut.firmwareVersion)}if(aStatut.rfpi!==undef){$(".form-toggleinfo-container:eq(3)").text(aStatut.rfpi)}$("#voice_associate_form .txtandfield-text-input").attr("class","col-xs-1 txtandfield-text-input form-toggleinfo-voice-container");$("#voice_associate_form .txtandfield-label:eq(0)").attr("class","col-xs-3 txtandfield-label bodytxt");$("#voice_associate_form .txtandfield-label:eq(1)").attr("class","col-xs-1 txtandfield-label bodytxt");this.translate()};this.displayListAssociateDect=function(aList){var indexDect,dect,max_list;fields.dataDectTable=[];fields.dataDect=aList;max_list=aList.length>4?4:aList.length;for(indexDect=0;indexDect<max_list;indexDect+=1){dect={type:"static",defaultvalue:[indexDect+2,"<a id='"+indexDect+"' href='#'>"+this.escapeString("js",this.escapeString("html",aList[indexDect].deviceName))+"</a>"]};fields.dataDectTable.push(dect)}if(aList.length>=4){$("#max_dect_msg").show();$("#link_newdect").hide()}else{$("#max_dect_msg").hide();$("#link_newdect").show()}if(Object.doCompare(fields.oldDectTable,aList)!==""){displayDectTable.call(this,fields.dataDectTable)}fields.oldDectTable=aList};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);this.translate();TemplateClass.enablePopOver();$(window).resize(function(){TemplateClass.enablePopOver()});aNext()}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceAssociateViewClass fillTemplate failed","rra0098")}},function(){$("#max_dect_msg").hide();$("#link_newdect").hide();$("#content_template_container h2:eq(0)").attr("class","title associate-title-margin");$("#tab_template_container").focus();fields.oldDectTable=[];listenViewEvents.call(this);this.setPageTitle(null,$(".header-title").find("h1").find("span").html());basicUtilities.callback(aCallback,false,0,null)}],this)}}return VoiceAssociateViewClass});