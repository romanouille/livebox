define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","text!app/config/status.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function VoiceStatutViewClass(aStateId,aTranslateObj){var fields,displayLoading=function(){if(fields.loadingTimer){window.clearTimeout(fields.loadingTimer)}if($("#loading_suffix").text().length===1){$("#loading_suffix").text("..")}else if($("#loading_suffix").text().length===2){$("#loading_suffix").text("...")}else{$("#loading_suffix").text(".")}fields.loadingTimer=window.setTimeout(function(){displayLoading.call(this)},1e3)};fields={language:{id:"",data:{}},loggedUserBehaviour:{lastFocusedElt:[],lastClickedElt:[],lastRelevantElt:""},currentData:{},loadingTimer:null};StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("VoiceStatutViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceStatutViewClass: Initialising state '"+this.getId()+"'","rra0010")}}],this)};this.quit=function(aCallback){console.debug("VoiceStatutViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceStatutViewClass: Releasing state '"+this.getId()+"'","rra0011")}}],this)};this.enable=function(aCallback){console.debug("VoiceStatutViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setAppCloseButton(aNext,"app_close")},function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceStatutViewClass: Enabling state '"+this.getId()+"'","rra0012")}}],this)};this.disable=function(aCallback){console.debug("VoiceStatutViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceStatutViewClass: Disabling state '"+this.getId()+"'","rra0013")}}],this)};this.logUserBehaviour=function(aCallback){$(window.document).on("click",function(event){if(fields.loggedUserBehaviour.lastClickedElt.length>10){fields.loggedUserBehaviour.lastClickedElt.shift()}fields.loggedUserBehaviour.lastClickedElt.push($(event.target))});$(window.document).on("focus",function(event){if(fields.loggedUserBehaviour.lastFocusedElt.length>10){fields.loggedUserBehaviour.lastFocusedElt.shift()}fields.loggedUserBehaviour.lastFocusedElt.push($(event.target))});basicUtilities.callback(aCallback,false,0,null)};this.logLastRelevantElt=function(aCallback,aObj){fields.loggedUserBehaviour.lastRelevantElt=aObj;basicUtilities.callback(aCallback,false,0,null)};this.getLastClickedHistory=function(){return fields.loggedUserBehaviour.lastClickedElt};this.getLastFocusedHistory=function(){return fields.loggedUserBehaviour.lastFocusedElt};this.getLastRelevantElt=function(){return fields.loggedUserBehaviour.lastRelevantElt};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+aResult.data+"</style>")}if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.setDisabledInput=function(aCallback,aId,aDisabled){if(aDisabled){$("#"+aId).prop("disabled",true)}else{$("#"+aId).prop("disabled",false)}basicUtilities.callback(aCallback,false,0,null)};this.displayStatuts=function(aStatut){var undef;if(aStatut.phoneNumber!==undef&&aStatut.phoneNumber!==""){var prefix,indexPrefix,phoneNumber;prefix=["262","590","594","596"];phoneNumber=aStatut.phoneNumber;for(indexPrefix=0;indexPrefix<prefix.length;indexPrefix+=1){if(phoneNumber===aStatut.phoneNumber){phoneNumber=phoneNumber.replace(new RegExp(prefix[indexPrefix],"g"),"0")}}$("#telnumber").text(" (NÂ° "+phoneNumber+")")}if(aStatut.isAvailable){$(".form-toggleinfo-container span").attr("data-translation","voiceAdvanced.status.service.disponible")}else if(aStatut.isAvailable!==undef&&!aStatut.isAvailable){$(".form-toggleinfo-container span").attr("data-translation","voiceAdvanced.status.service.indisponible")}if(aStatut.deviceList!==undef){$("#nbConnectedPhone").text(aStatut.deviceList.length+1);$("#ringtest").show()}this.translate()};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);this.translate();TemplateClass.enablePopOver();$(window).resize(function(){TemplateClass.enablePopOver()});aNext()}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("VoiceStatutViewClass:  Failed to fill template with config data","aba0014")}},function(){$(".header-title span").after('<span id="telnumber"></span>');$("#ringtest").hide();$("#tab_template_container").focus();$("#tab_template_container").off().on("keydown",function(event){var keyCode=event.keyCode||event.which;if(keyCode===39){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"journal"})}else if(keyCode===37){event.preventDefault();this.generateEvent("ViewSubmitted",{origin:fields.id,state:"associate"})}}.bind(this));$("#tab_telephone_status").on("click",function(){this.generateEvent("ViewSubmitted",{origin:fields.id,state:"status"})}.bind(this));$("#tab_telephone_contacts").off().on("click",function(){this.generateEvent("ViewSubmitted",{origin:fields.id,state:"contacts"})}.bind(this));$("#tab_telephone_journal").off().on("click",function(){this.generateEvent("ViewSubmitted",{origin:fields.id,state:"journal"})}.bind(this));$("#tab_telephone_associate").off().on("click",function(){this.generateEvent("ViewSubmitted",{origin:fields.id,state:"associate"})}.bind(this));if(basicUtilities.getCookie("missedCall")>0){$("#missedCall").text(" ("+basicUtilities.getCookie("missedCall")+") ")}else{$("#missedCall").text("")}$("#content_template_container p:eq(1) span:eq(1)").attr("class","bodytxtorange");TemplateClass.enablePopOver();$("#ringtest").off().on("click",function(event){event.preventDefault();TemplateClass.showPopup($("#popup_test"));$("#popup_test h2 span").attr("data-translation","voiceAdvanced.status.popup.loading");this.translate();displayLoading.call(this);this.generateEvent("ViewSubmitted",{origin:fields.id,state:"ringtest"})}.bind(this));$("#popup_restart").off().on("click",function(event){event.preventDefault();if(fields.loadingTimer){window.clearTimeout(fields.loadingTimer)}$("#popup_test h2 span").attr("data-translation","voiceAdvanced.status.popup.loading");this.translate();displayLoading.call(this);this.generateEvent("ViewSubmitted",{origin:fields.id,state:"ringtest"})}.bind(this));$("#popup_back").off().on("click",function(event){event.preventDefault();TemplateClass.hidePopup($("#popup_test"));if(fields.loadingTimer){window.clearTimeout(fields.loadingTimer)}}.bind(this));this.setPageTitle(null,$(".header-title").find("h1").find("span").html());basicUtilities.callback(aCallback,false,0,null)}],this)};this.stopLoading=function(){if(fields.loadingTimer){window.clearTimeout(fields.loadingTimer)}$("#loading_suffix").text("");$("#popup_test h2 span").attr("data-translation","voiceAdvanced.status.popup.end");this.translate()}}return VoiceStatutViewClass});