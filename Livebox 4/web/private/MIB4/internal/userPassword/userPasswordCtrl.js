define(["utils/console","utils/basics","lib/stateCtrlInterface"],function(console,basicUtilities,StateCtrlClass){"use strict";function UserPasswordCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,regexLengthPwd,login,onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("UserPasswordCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewCancelled"){console.debug("UserPasswordCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));this.quit()}else if(aEventId==="ViewSubmitted"){console.debug("UserPasswordCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));this.matchPassword(null,aData.currentPassword,aData.newPassword,aData.newPasswordConfirm)}else{console.warn("UserPasswordCtrlClass: Unexpected event '"+aEventId+"'")}};fields={};login={};regexLengthPwd=new RegExp(/^[a-zA-Z0-9]{4,32}$/);StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("UserPasswordCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("UserPasswordCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("UserPasswordCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().enable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("UserPasswordCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.restart=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.System.reboot",aNext,null)},function(aNext,aResult){if(aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.matchPassword=function(aCallback,currentPwd,newPwd,newPwdConfirm){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.User.listUsers",aNext,null)},function(aNext,aResult){if(aResult.status===0){login=aResult.data.userList[0].login;this.callSahApi("sah.Device.User.isPasswordValid",aNext,{login:login,password:currentPwd})}else{basicUtilities.callback(aNext,false,-1,null)}},function(aNext,aResult){if(aResult.status===0&&aResult.data.isValid===true){if(regexLengthPwd.test(newPwd)){if(newPwdConfirm===newPwd){this.getViewObj().displayCurrentPasswordError(true);this.getViewObj().displayPasswordErrorMatch(true);this.getViewObj().displayPasswordErrorLength(true);this.callSahApi("sah.Device.User.changePassword",aNext,{login:login,password:newPwd})}else{this.getViewObj().displayCurrentPasswordError(true);this.getViewObj().displayPasswordErrorLength(true);this.getViewObj().displayPasswordErrorMatch(false)}}else{this.getViewObj().displayCurrentPasswordError(true);this.getViewObj().displayPasswordErrorMatch(true);this.getViewObj().displayPasswordErrorLength(false)}}else if(aResult.status===0&&aResult.data.isValid===false){this.getViewObj().displayCurrentPasswordError(false);this.getViewObj().displayPasswordErrorMatch(true);this.getViewObj().displayPasswordErrorLength(true)}else{this.getViewObj().notifyError("UserPasswordCtrlClass: Failed to valid password","yke0001");basicUtilities.callback(aCallback,false,-1,null)}},function(aNext,aResult){if(aResult.status===0){this.logOut();this.goToMhs();basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("UserPasswordCtrlClass: Failed to change password","yke0002");basicUtilities.callback(aCallback,false,-1,null)}}],this)}}return UserPasswordCtrlClass});