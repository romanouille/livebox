define(["utils/console","utils/basics","lib/stateCtrlInterface","jquery"],function(console,basicUtilities,StateCtrlClass,$){"use strict";function InternetRemoteCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("InternetRemoteCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewCancelled"){console.debug("InternetRemoteCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));this.quit()}else if(aEventId==="ViewSubmitted"){console.debug("InternetRemoteCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));if(aData.action==="get"){this.getRemoteAdminStatus()}else if(aData.action==="activer"){this.verifForm(null,aData.login,aData.password,aData.port)}else{this.stopRemote(null)}}else{console.warn("InternetRemoteCtrlClass: Unexpected event '"+aEventId+"'")}};fields={userRemoteAdmin:null};StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("InternetRemoteCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("InternetRemoteCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("InternetRemoteCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().enable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getRemoteAdminStatus(aNext)}else{basicUtilities.callback(aNext,false,-1,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("InternetRemoteCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.restart=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.System.reboot",aNext,null)},function(aNext,aResult){if(aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.searchRAUser=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Device.User.listGroups",aNext,null)},function(aNext,aResult){if(aResult.status===0){if(aResult.data.groupList.length>0&&aResult.data.groupList.join().indexOf("remoteadmin")>=0){this.callSahApi("sah.Device.User.listUsers",aNext,null)}else{this.getViewObj().notifyError("<span class='Translation' data-translation='common.error_system'></span>","yke0004");basicUtilities.callback(aCallback,false,-1,null)}}else{this.getViewObj().notifyError("<span class='Translation' data-translation='common.error_system'></span>","yke0004");basicUtilities.callback(aCallback,false,-1,null)}},function(aNext,aResult){var indexUser,userGroupParticipation;if(aResult.status===0){for(indexUser=0;indexUser<aResult.data.userList.length;indexUser+=1){userGroupParticipation=aResult.data.userList[indexUser].groupList.join(" ");if(userGroupParticipation.indexOf("remoteadmin")>=0&&userGroupParticipation.indexOf("mediahub")<0&&aResult.data.userList[indexUser].login!=="support"){fields.userRemoteAdmin=aResult.data.userList[indexUser].login}}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("<span class='Translation' data-translation='common.error_system'></span>","yke0004");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getState=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.RemoteAccess.getState",aNext,null)},function(aNext,aResult){if(aResult.status===0){if(aResult.data.isActivated){this.getViewObj().setCheckbox(aResult.data.isActivated);this.getViewObj().toggleFormAction();this.getViewObj().initLabelInfo();this.getViewObj().setFormInfo(fields.userRemoteAdmin,"********",aResult.data.port);this.getViewObj().getUrl(aResult.data.url);this.getViewObj().getIP(aResult.data.ipIpv4)}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("<span class='Translation' data-translation='common.error_system'></span>","yke0004");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.activateRemote=function(aCallback,login,password,port){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.RemoteAccess.getState",aNext,null)},function(aNext,aResult){if(aResult.status===0){if(aResult.data.isActivated&&$("#admin_true").is(":checked")){console.debug("warning !");this.getViewObj().notifyUser("<span class='Translation' data-translation='internetRemote.notifyError.remoteActivate'></span>",1,5)}this.callSahApi("sah.Connection.Server.RemoteAccess.activate",aNext,{login:login,password:password,portNumber:parseInt(port,10),timeout:0})}else{this.getViewObj().notifyError("<span class='Translation' data-translation='common.error_system'></span>","yke0002");basicUtilities.callback(aNext,false,-1,null)}},function(aNext,aResult){if(aResult.status===0){this.getViewObj().setCheckbox(true);this.callSahApi("sah.Connection.Client.getCurrentConfiguration",aNext,null)}else{basicUtilities.callback(aNext,false,0,null)}},function(aNext,aResult){if(aResult.status===0){this.getViewObj().initLabelInfo();this.getViewObj().getUrl("https://"+aResult.data.linkModeList[0].gatewayIpv4+":"+port);this.getViewObj().getIP(aResult.data.linkModeList[0].gatewayIpv4);basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.verifForm=function(aCallback,login,password,port){basicUtilities.queue([function(aNext){var isValid;isValid=true;if(login===""||login==="admin"||login==="root"||login==="support"||!login.match(/^[\w-]{0,32}$/)){this.getViewObj().displayLoginError(false);isValid=false}else{this.getViewObj().displayLoginError(true)}if(password.length<=7||!password.match(/\d/)||!password.match(/[^\da-zA-Z]/)){this.getViewObj().displayPasswordError(false);isValid=false}else{this.getViewObj().displayPasswordError(true)}if(port>0&&port<=3e4){this.getViewObj().displayPortError(true)}else{isValid=false;this.getViewObj().displayPortError(false)}if(isValid){this.activateRemote(aNext,login,password,port)}},function(aNext,aResult){if(aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.stopRemote=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.Connection.Server.RemoteAccess.deactivate",aNext,null)},function(aNext,aResult){if(aResult.status===0){console.debug("disabling previous remote access...");basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getRemoteAdminStatus=function(aCallback){basicUtilities.queue([function(aNext){this.searchRAUser(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){if(fields.userRemoteAdmin){this.getState(aNext)}else{basicUtilities.callback(aNext,false,-1,null)}}else{basicUtilities.callback(aNext,false,-1,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)}}return InternetRemoteCtrlClass});