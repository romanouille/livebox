define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","text!app/config/devicesHistoryDevice.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function DevicesHistoryDeviceViewClass(aStateId,aTranslateObj){var fields,arrayDevices,arrayInfo;fields={defaultScheduleValues:{disable:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],enable:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},renembArray:{}};arrayDevices={};StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("DevicesHistoryDeviceViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("DevicesHistoryDeviceViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("DevicesHistoryDeviceViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("DevicesHistoryDeviceViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+aResult.data+"</style>")}if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){var self=this;if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);this.translate();this.setPageTitle(null,"test");this.constructDeviceArrray();this.addIcons($("#equipType").val(),true);$("#name").val(window.device.deviceName);$(".header-title").find("h1").find("span").html(window.device.deviceName);this.setPageTitle(null,$(".header-title").find("h1").find("span").html());$("#submit").attr("disabled",true);TemplateClass.enableSchedule("internet_scheduler");$("#internet_scheduler").hide();this.renemberInput();this.checkChange();$("#name, #equipType, input[name=scheduler_mode_choice]").on("change keyup",function(){self.checkChange()});this.changeSchedulerDisplay();$("input[name=scheduler_mode_choice]").on("change",function(){self.changeSchedulerDisplay()});TemplateClass.enableSchedule("internet_scheduler",this.translate);$("#submit").on("click",function(event){if(self.isDeviceNameValid($("#name").val())){$("#name_warning").css("display","none");event.preventDefault();self.fireEvent("ViewSubmitted",{value:self.retrieveAllInfoInView()})}else{$("#name_warning").css("display","inline-block")}});$("#cancel").on("click",function(){self.fireEvent("ViewCancelled",null)});$("#app_close").on("click",function(event){event.preventDefault();event.stopPropagation();self.fireEvent("ViewCancelled",null)});$("#equipType").on("change",function(){self.addIcons($(this).val(),false)});$("#equipType").css({"margin-left":"5px",width:"268px"});basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.schedulerActive=function(schedule){var aScheduleObj;if(!schedule){this.setValuesOnScheduler(null,"internet_scheduler",fields.defaultScheduleValues)}else{aScheduleObj=schedule;if(aScheduleObj.hasOwnProperty("scheduleList")){this.setValuesOnScheduler(null,"internet_scheduler",this.unformatSchedule(aScheduleObj.scheduleList))}}};this.changeSchedulerDisplay=function(){if($("input[name=scheduler_mode_choice]:checked").val()==="allow"){$("#internet_scheduler").hide()}else if($("input[name=scheduler_mode_choice]:checked").val()==="block"){$("#internet_scheduler").hide()}else if($("input[name=scheduler_mode_choice]:checked").val()==="manage"){$("#internet_scheduler").show()}};this.renemberInput=function(){fields.renembArray.deviceName=$("#name").val();fields.renembArray.deviceType=arrayDevices[$("#equipType").val()].en;fields.renembArray.plan=$('input[name="scheduler_mode_choice"]').val()};this.checkChange=function(){if($('input[name="scheduler_mode_choice"]:checked').val()!==fields.renembArray.plan||$("#equipType").val()!==fields.renembArray.deviceType||$("#name").val()!==fields.renembArray.deviceName){$("#submit").attr("disabled",false)}else if($('input[name="scheduler_mode_choice"]:checked').val()===fields.renembArray.plan&&$("#equipType").val()===fields.renembArray.deviceType&&$("#name").val()===fields.renembArray.deviceName){$("#submit").attr("disabled",true)}};this.formatSchedule=function(aTimetable){var result=[],topLimit=0,bottomLimit=0,previousState=1,index;if(aTimetable.length>0){aTimetable[aTimetable.length]=1;for(index=0;index<aTimetable.length;index=index+1){if(aTimetable[index]===0&&previousState===1){topLimit=index}else if(aTimetable[index]===1&&previousState===0){bottomLimit=index;result.push({start:topLimit*3600,end:bottomLimit*3600})}previousState=aTimetable[index]}}return result};this.unformatSchedule=function(timeTable){var result=[],index,subindex,start=0,stop=0;for(index=0;index<168;index=index+1){result[index]=1}for(index=0;index<timeTable.length;index=index+1){start=timeTable[index].start/3600;stop=timeTable[index].end/3600;for(subindex=start;subindex<stop;subindex=subindex+1){result[subindex]=0}}return result};this.retrieveScheduleListInView=function(){var result={},scheduleList=[];result.deviceId=window.device.deviceId;$("#internet_scheduler").find(".scheduler-case").each(function(){if($(this).hasClass("scheduler-case-filled")){scheduleList.push(1)}else{scheduleList.push(0)}});if(scheduleList.length===168){if($("input[name=scheduler_mode_choice]:checked").val()==="block"){result.scheduleList=this.formatSchedule(fields.defaultScheduleValues.disable)}else{result.scheduleList=this.formatSchedule(scheduleList)}return result}return false};this.retrieveDeviceInfoInView=function(){var result={};result.deviceId=window.device.deviceId;result.deviceType=arrayDevices[$("#equipType option:selected").val()].en;result.deviceName=$("#name").val();console.debug(result);if($("input[name=scheduler_mode_choice]:checked").val()==="allow"){result.useSchedule=false}else if($("input[name=scheduler_mode_choice]:checked").val()==="block"||$("input[name=scheduler_mode_choice]:checked").val()==="manage"){result.useSchedule=true}return result};this.retrieveAllInfoInView=function(){var result={};result.setDeviceScheduleObj=this.retrieveScheduleListInView();result.configureDeviceObj=this.retrieveDeviceInfoInView();return result};this.setValuesOnScheduler=function(aCallback,aSchedulerId,aValues){TemplateClass.setValuesOnScheduler(aSchedulerId,aValues,this.translate);basicUtilities.callback(aCallback,false,0,null)};this.hidePopup=function(aId){TemplateClass.hidePopup($("#"+aId))};this.constructDeviceArrray=function(){arrayInfo=[{img:"device_ordibureau.png",en:"Computer"},{img:"device_mobile.png",en:"Mobile"},{img:"device_tablette.png",en:"Tablet"},{img:"device_imprimante.png",en:"Printer"},{img:"device_decodeurTV.png",en:"SetTopBox"},{img:"device_ordiportable.png",en:"Laptop"},{img:"device_consolejeux.png",en:"Console"},{img:"device_TV.png",en:"TV"},{img:"device_liveradio.png",en:"Liveradio"},{img:"device_periphstockage.png",en:"Disk"},{img:"device_telephonenew.png",en:"Phone"},{img:"device_notebook.png",en:"Notebook"},{img:"device_homelibrary.png",en:"HomeLibrary"},{img:"device_liveplugsolo.png",en:"HomePlug"},{img:"device_squeezebox.png",en:"SqueezeBox"},{img:"device_sensorhome.png",en:"SmokeDetector"},{img:"device_homelive.png",en:"HomeLive"},{img:"device_homepoint.png",en:"HomePoint"}];arrayDevices["Ordinateur"]=arrayInfo[0];arrayDevices["Smartphone"]=arrayInfo[1];arrayDevices["Tablette"]=arrayInfo[2];arrayDevices["Imprimante"]=arrayInfo[3];arrayDevices["Décodeur TV"]=arrayInfo[4];arrayDevices["Ordinateur portable"]=arrayInfo[5];arrayDevices["Console de jeu"]=arrayInfo[6];arrayDevices["TV"]=arrayInfo[7];arrayDevices["LiveRadio"]=arrayInfo[8];arrayDevices["Périphérique de stockage"]=arrayInfo[9];arrayDevices["Téléphone"]=arrayInfo[10];arrayDevices["Notebook"]=arrayInfo[11];arrayDevices["Home Library"]=arrayInfo[12];arrayDevices["Liveplug Wi-Fi"]=arrayInfo[13];arrayDevices["Squeezebox"]=arrayInfo[14];arrayDevices["Détecteur de fumée"]=arrayInfo[15];arrayDevices["Home Live"]=arrayInfo[16];arrayDevices["Home Point"]=arrayInfo[17]};this.addIcons=function(target,firstUse){var currentIcon=window.device.deviceType;if(firstUse){$('#equipType option[value="'+currentIcon+'"]').prop("selected",true)}if($("#currentDevice").length===0){$("#equipType").parent().prepend('<img id="currentDevice" src="../../common/img/app_conf/'+(firstUse?arrayDevices[currentIcon].img:arrayDevices[target].img)+'">')}else{$("#currentDevice").attr("src","../../common/img/app_conf/"+(firstUse?arrayDevices[currentIcon].img:arrayDevices[target].img))}};this.isDeviceNameValid=function(name){return typeof name==="string"&&name.length>0&&name.length<65}}return DevicesHistoryDeviceViewClass});