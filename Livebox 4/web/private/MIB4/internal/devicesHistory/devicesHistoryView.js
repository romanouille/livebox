define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","text!app/config/devicesHistory.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function DevicesHistoryViewClass(aStateId,aTranslateObj){var fields,self,devicePhisicalAdress,displayDeviceTable=function(){var context={type:"dynamictable",label:"",id:"devices_list",sortable:1,titlevalue:["<span class='Translation' data-translation='devicesHistory.main.tab.firstTitle'></span>","<span class='Translation' data-translation='devicesHistory.main.tab.secondTitle'></span>","<span class='Translation' data-translation='devicesHistory.main.tab.thirdTitle'></span>"],value:fields.datadeviceTable};if(fields.datadeviceTable.length===0){context={type:"dynamictable",label:"",id:"devices_list",sortable:1,titlevalue:["<span class='Translation' data-translation='devicesHistory.main.tab.firstTitle'></span>","<span class='Translation' data-translation='devicesHistory.main.tab.secondTitle'></span>","<span class='Translation' data-translation='devicesHistory.main.tab.thirdTitle'></span>"],value:[]}}basicUtilities.queue([function(aNext){TemplateClass.boundDataTable($("#devices_list"),context);$("#devices_list_table").css("width","100%");$("#devices_list_col2_sort").attr("class","conf-table-title-sortable-arrow-selected");$("#devices_list_col0_sort").attr("tabindex",0);$("#devices_list_col1_sort").attr("tabindex",0);$("#devices_list_col2_sort").attr("tabindex",0);$("#devices_list_table tr td:nth-child(2)").each(function(){$(this).css("text-align","left");$(this).css("padding-left","5px")});$("#devices_list_table span > img").css({"margin-left":"0"});aNext()},function(){listenViewEvents.call(this);this.translate()}],this)},sortDeviceTable=function(){function sortByName(a,b){var aName,bName;aName=a.deviceName.toString();bName=b.deviceName.toString();return aName.localeCompare(bName)}function reverseByName(a,b){var aName,bName;aName=a.deviceName.toString();bName=b.deviceName.toString();return bName.localeCompare(aName)}function sortByTime(a,b){return new Date(a.lastConnection).toLocaleString("fr-fr")>new Date(b.lastConnection).toLocaleString("fr-fr")}function reverseByTime(a,b){return new Date(b.lastConnection).toLocaleString("fr-fr")>new Date(a.lastConnection).toLocaleString("fr-fr")}function sortByType(a,b){if(a.linkMode===b.linkMode){return 0}if(a.linkMode==="ETHERNET"){return-1}if(b.linkMode==="ETHERNET"){return 1}if(a.linkMode==="WIFI"){return-1}return 1}function reverseByType(a,b){if(a.linkMode===b.linkMode){return 0}if(a.linkMode==="ETHERNET"){return 1}if(b.linkMode==="ETHERNET"){return-1}if(a.linkMode==="WIFI"){return 1}return-1}if(fields.sortBy==="name"){if(fields.reverseName){fields.dataCall.sort(reverseByName)}else{fields.dataCall.sort(sortByName)}}else if(fields.sortBy==="time"){if(fields.reverseTime){fields.dataCall.sort(reverseByTime)}else{fields.dataCall.sort(sortByTime)}}else if(fields.sortBy==="type"){if(fields.reverseType){fields.dataCall.sort(reverseByType)}else{fields.dataCall.sort(sortByType)}}},listenViewEvents=function(){$("#devices_list_col0_sort").off().on("click keypress",function(event){if(event.which===13||event.type==="click"){event.preventDefault();fields.sortBy="time";fields.reverseTime=!fields.reverseTime;this.listDevices(fields.dataCall);$("#devices_list_col0_sort").attr("class","conf-table-title-sortable-arrow-selected");$("#devices_list_col1_sort").attr("class","conf-table-title-sortable-arrow");$("#devices_list_col2_sort").attr("class","conf-table-title-sortable-arrow")}}.bind(this));$("#devices_list_col1_sort").off().on("click keypress",function(event){if(event.which===13||event.type==="click"){event.preventDefault();fields.sortBy="name";fields.reverseName=!fields.reverseName;this.listDevices(fields.dataCall);$("#devices_list_col0_sort").attr("class","conf-table-title-sortable-arrow");$("#devices_list_col1_sort").attr("class","conf-table-title-sortable-arrow-selected");$("#devices_list_col2_sort").attr("class","conf-table-title-sortable-arrow")}}.bind(this));$("#devices_list_col2_sort").off().on("click keypress",function(event){if(event.which===13||event.type==="click"){event.preventDefault();fields.sortBy="type";fields.reverseType=!fields.reverseType;this.listDevices(fields.dataCall);$("#devices_list_col0_sort").attr("class","conf-table-title-sortable-arrow");$("#devices_list_col1_sort").attr("class","conf-table-title-sortable-arrow");$("#devices_list_col2_sort").attr("class","conf-table-title-sortable-arrow-selected")}}.bind(this))};fields={currentData:[],reverseName:false,reverseTime:false,reverseType:false,sortBy:"type",selected:0,dataCall:[],datadeviceTable:[]};devicePhisicalAdress=[];self=this;StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("DevicesHistoryViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("DevicesHistoryViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("DevicesHistoryViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setAppCloseButton(aNext,"app_close")},function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("DevicesHistoryViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+aResult.data+"</style>")}if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);this.translate();this.setPageTitle(null,$(".header-title").find("h1").find("span").html());this.initCustomStyle();$("#delete").on("click keypress",function(event){if(event.which===13||event.type==="click"){self.fireEvent("ViewCancelled",null)}}.bind(this));$(document).on("click keypress",".conf-table-blank-cell > a",function(event){if(event.which===13||event.type==="click"){event.preventDefault();self.fireEvent("ViewUpdated",{deviceId:devicePhisicalAdress[$(this).attr("id").split("_")[3]]})}});basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.initCustomStyle=function(){$("#devices_list").css("margin-top","1.5em")};this.deleteDevices=function(){return};this.constructDeviceArrray=function(){var arrayDevices,arrayInfo;arrayDevices={};arrayInfo=[{fr:"Ordinateur",img:"device_ordibureau.png"},{fr:"Smartphone",img:"device_mobile.png"},{fr:"Décodeur TV",img:"device_decodeurTV.png"},{fr:"Tablette",img:"device_tablette.png"},{fr:"Imprimante",img:"device_imprimante.png"},{fr:"Ordinateur portable",img:"device_ordiportable.png"},{fr:"Console de jeu",img:"device_consolejeux.png"},{fr:"TV",img:"device_TV.png"},{fr:"LiveRadio",img:"device_liveradio.png"},{fr:"Périphérique de stockage",img:"device_periphstockage.png"},{fr:"Téléphone",img:"device_telephonenew.png"},{fr:"Notebook",img:"device_notebook.png"},{fr:"Home Library",img:"device_homelibrary.png"},{fr:"Liveplug Wi-Fi",img:"device_liveplugsolo.png"},{fr:"Squeezebox",img:"device_squeezebox.png"},{fr:"Détecteur de fumée",img:"device_sensorhome.png"},{fr:"Home Live",img:"device_homelive.png"},{fr:"Home Point",img:"device_homepoint.png"}];arrayDevices["Computer"]=arrayInfo[0];arrayDevices["Mobile"]=arrayInfo[1];arrayDevices["SetTopBox"]=arrayInfo[2];arrayDevices["Tablet"]=arrayInfo[3];arrayDevices["Printer"]=arrayInfo[4];arrayDevices["Laptop"]=arrayInfo[5];arrayDevices["Console"]=arrayInfo[6];arrayDevices["TV"]=arrayInfo[7];arrayDevices["Liveradio"]=arrayInfo[8];arrayDevices["Disk"]=arrayInfo[9];arrayDevices["Phone"]=arrayInfo[10];arrayDevices["Notebook"]=arrayInfo[11];arrayDevices["Homelibrary"]=arrayInfo[12];arrayDevices["HomePlug"]=arrayInfo[13];arrayDevices["Squeezebox"]=arrayInfo[14];arrayDevices["SmokeDetector"]=arrayInfo[15];arrayDevices["HomeLive"]=arrayInfo[16];arrayDevices["HomePoint"]=arrayInfo[17];return arrayDevices};this.listDevices=function(devicesList){var arrayDevices,deviceType,call,ind;arrayDevices=this.constructDeviceArrray(devicesList);fields.dataCall=devicesList;fields.datadeviceTable=[];sortDeviceTable.call(this);for(ind=0;ind<=fields.dataCall.length-1;ind+=1){deviceType=fields.dataCall[ind].deviceType;devicePhisicalAdress[ind]=fields.dataCall[ind].deviceId;call={};call={type:"static",defaultvalue:[new Date(fields.dataCall[ind].lastConnection).toLocaleString("fr-fr"),'<span tabindex="0" id="'+fields.dataCall[ind].deviceId+'" name="'+fields.dataCall[ind].deviceName+'" class="deviceLink  txt-underline orangetxt"  style="cursor:pointer;">'+'<img class="'+(deviceType in arrayDevices?arrayDevices[deviceType]["fr"]:"Ordinateur")+'" style="margin-left:5px;margin-right:1em;" alt="image-terminal" src="../../common/img/app_conf/'+(deviceType in arrayDevices?arrayDevices[deviceType]["img"]:"device_ordibureau.png")+'">'+this.escapeString("js",this.escapeString("html",fields.dataCall[ind].deviceName))+"<span>",'<span class="Translation" data-translation="devicesHistory.main.types.'+fields.dataCall[ind].linkMode.toString()+'"></span>']};self.translate();fields.datadeviceTable.push(call)}displayDeviceTable.call(this);$(".deviceLink").on("click keypress",function(event){if(event.which===13||event.type==="click"){self.fireEvent("ViewSubmitted",{deviceName:$(this).attr("name"),deviceId:$(this).attr("id"),deviceType:$(this).children("img").attr("class")})}})}}return DevicesHistoryViewClass});