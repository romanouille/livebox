define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","text!app/config/backup.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function SystemBackupViewClass(aStateId,aTranslateObj){var fields,formatDate=function(strDate){var day,month,year,date,strDay;date=new Date(strDate);day=date.getDate();month=date.getMonth()+1;year=date.getFullYear();day=day<10?"0"+day:day;month=month<10?"0"+month:month;year=year<10?"0"+year:year;strDay=day+"/"+month+"/"+year;return strDay},listenViewEvents=function(){$("#restoreFileName").attr("readonly",true);$("#restoreFileName_button").on("click",function(){$("#restoreFileName_file").click();$("#restoreFileName").val("")});$("input:eq(2)").on("click",function(){$("#restoreFileName_file").click();$("#restoreFileName").val("")});$("#restoreFileName").on("click",function(){$("#restoreFileName_button").focus();$("#restoreFileName_file").click();$("#restoreFileName").val("")});$("#restoreFileName_file").on("change",function(){$("#restoreFileName").val($("#restoreFileName_file").val());this.toggleRestoreButton()}.bind(this));$("#restoreButton").on("click",function(){if($("#restoreFileName_file").val()!==""){this.fireEvent("ViewSubmitted",{state:"restore",inputFileId:"restoreFileName_file"});$("#app_close").attr("disabled",true)}}.bind(this));$("#backup_cloud").on("click",function(){this.fireEvent("ViewSubmitted",{state:"enableNetworkBR",enable:!fields.enableNetwork})}.bind(this));$("#save").on("click",function(){this.fireEvent("ViewSubmitted",{state:"local_backup"})}.bind(this));$("#backup_cloud").on("click",null,function(){var value;if($("#backup_cloud").hasClass("toggleoff")){value=1}else{value=0}this.setToggleOnOff(null,"backup_cloud",value);this.translate("#backup_cloud")}.bind(this));this.toggleRestoreButton()};fields={enableNetwork:true,language:{id:"",data:{}}};StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("SystemBackupViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("SystemBackupViewClass: Initialising state '"+this.getId()+"'","rra0112")}}],this)};this.quit=function(aCallback){console.debug("SystemBackupViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("SystemBackupViewClass: Releasing state '"+this.getId()+"'","rra0113")}}],this)};this.enable=function(aCallback){console.debug("SystemBackupViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setAppCloseButton(aNext,"app_close")},function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("SystemBackupViewClass: Enabling state '"+this.getId()+"'","rra0114")}}],this)};this.disable=function(aCallback){console.debug("SystemBackupViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){fields.dataJournalTable=[];this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("SystemBackupViewClass: Disabling state '"+this.getId()+"'","rra0115")}}],this)};this.logUserBehaviour=function(aCallback){$(window.document).on("click",function(event){if(fields.loggedUserBehaviour.lastClickedElt.length>10){fields.loggedUserBehaviour.lastClickedElt.shift()}fields.loggedUserBehaviour.lastClickedElt.push($(event.target))});$(window.document).on("focus",function(event){if(fields.loggedUserBehaviour.lastFocusedElt.length>10){fields.loggedUserBehaviour.lastFocusedElt.shift()}fields.loggedUserBehaviour.lastFocusedElt.push($(event.target))});basicUtilities.callback(aCallback,false,0,null)};this.logLastRelevantElt=function(aCallback,aObj){fields.loggedUserBehaviour.lastRelevantElt=aObj;basicUtilities.callback(aCallback,false,0,null)};this.getLastClickedHistory=function(){return fields.loggedUserBehaviour.lastClickedElt};this.getLastFocusedHistory=function(){return fields.loggedUserBehaviour.lastFocusedElt};this.getLastRelevantElt=function(){return fields.loggedUserBehaviour.lastRelevantElt};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("SystemBackupViewClass: fillTemplate failed","rra0116")}}],this)};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+aResult.data+"</style>")}if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("SystemBackupViewClass: setStyle failed","rra0117")}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.setDisabledInput=function(aCallback,aId,aDisabled){if(aDisabled){$("#"+aId).prop("disabled",true)}else{$("#"+aId).prop("disabled",false)}basicUtilities.callback(aCallback,false,0,null)};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);$("#restoreFileName").addClass("Translation");$("#restoreFileName").attr("data-translation","systemBackup.restore.local.placeHolder");$("#restoreButton").addClass("Translation");$("#restoreButton").attr("data-translation","systemBackup.restore.local.button");this.translate();TemplateClass.enablePopOver();$(window).resize(function(){TemplateClass.enablePopOver()});aNext()}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("SystemBackupViewClass:  Failed to fill template with config data","rra0118")}},function(){if(this.getMobileOperatingSystem()!=="unknown"){$("#restoreFileName").attr("disabled",true);$("input:eq(2)").attr("disabled",true);$("#save").attr("disabled",true)}$("#backup_cloud").css("margin-top","0.5em");listenViewEvents.call(this);this.setPageTitle(null,$(".header-title").find("h1").find("span").html());basicUtilities.callback(aCallback,false,0,null)}],this)};this.toggleRestoreButton=function(){if($("#restoreFileName_file").val()===""){$("#restoreButton").attr("disabled",true)}else{$("#restoreButton").attr("disabled",false)}};this.displayPopupRestore=function(){TemplateClass.showPopup($("#popup_restore"));this.translate();TemplateClass.spinnerAnimate();window.setTimeout(function(){this.fireEvent("ViewSubmitted",{state:"reboot"})}.bind(this),1e3)};this.setToggleOnOff=function(aCallback,aId,aValue){if(aValue){$("#"+aId).find("span").attr("data-translation","common.on");$("#"+aId).attr("aria-pressed",true)}else{$("#"+aId).find("span").attr("data-translation","common.off");$("#"+aId).attr("aria-pressed",false)}basicUtilities.callback(aCallback,false,0,null)};this.displayBackupAndRestoreState=function(aData){if(aData.Enable){$("#backup_cloud").find("span").html("ON");fields.enableNetwork=true}else{$("#backup_cloud").find("span").html("OFF");fields.enableNetwork=false}$("#backup_cloud").attr("aria-pressed",fields.enableNetwork);$("#backup_cloud_afterlabel").css("font-style","italic");if(aData.lastBackupDate){if(formatDate(aData.lastBackupDate)==="01/01/01"){$("#backup_cloud_afterlabel").hide()}else{$("#backup_cloud_afterlabel").show();$("#backup_cloud_afterlabel span:eq(1)").text(formatDate(aData.lastBackupDate))}}else{this.notifyError("SystemBackupViewClass:  Empty lastBackupDate","rra0119")}}}return SystemBackupViewClass});