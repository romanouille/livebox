define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","text!app/config/DMZ.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function NetworkAdvancedDMZViewClass(aStateId,aTranslateObj){var fields,self;fields={listDevice:[],associatedDevices:[],ipv4:""};self=this;StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("NetworkAdvancedDMZViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("NetworkAdvancedDMZViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("NetworkAdvancedDMZViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setAppCloseButton(aNext,"app_close")},function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("NetworkAdvancedDMZViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+aResult.data+"</style>")}if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);this.translate();this.setPageTitle(null,$(".header-title").find("h1").find("span").html());$("#warning").parent().css({"margin-top":"1.5em","margin-bottom":"1.5em"});$(".title").css({"margin-top":"1.5em","margin-bottom":"1.5em"});$("#DMZEquip").css("width","23em");aNext()}else{basicUtilities.callback(aCallback,false,-1,null)}},function(){$("#tab_information_dhcp").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DHCP"})}.bind(this));$("#tab_information_natpat").on("click",function(){this.generateEvent("ViewSubmitted",{state:"NATPAT"})}.bind(this));$("#tab_information_dns").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DNS"})}.bind(this));$("#tab_information_upnp").on("click",function(){this.generateEvent("ViewSubmitted",{state:"UPnP"})}.bind(this));$("#tab_information_dyndns").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DynDNS"})}.bind(this));$("#tab_information_dmz").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DMZ"})}.bind(this));$("#tab_information_ntp").on("click",function(){this.generateEvent("ViewSubmitted",{state:"NTP"})}.bind(this));$("#tab_template_container").off().on("keydown",function(event){var keyCode=event.keyCode||event.which;if(keyCode===39){event.preventDefault();this.generateEvent("ViewSubmitted",{state:"NTP"})}else if(keyCode===37){event.preventDefault();this.generateEvent("ViewSubmitted",{state:"DynDNS"})}}.bind(this));$("#DMZEquip").on("change",function(){var i;if(this.value===""){$("#DMZIP").html("");$("#DMZmac").html("")}else{for(i=0;i<=fields.listDevice.length-1;i+=1){if(fields.listDevice[i].deviceName===$("#DMZEquip").val()){$("#DMZIP").html(fields.listDevice[i][fields.listDevice[i].linkMode].ipIpv4);$("#DMZmac").html(fields.listDevice[i][fields.listDevice[i].linkMode].macAddress)}}}});this.saveListener();basicUtilities.callback(aCallback,false,0,null)}],this)};this.saveListener=function(){$("#submit").on("click",function(){var enable,ip;enable=true;ip=$("#DMZIP").text();console.debug($("#DMZEquip").val());if($("#DMZEquip").val()===""){enable=false;ip=""}self.fireEvent("ViewSubmitted",{enableDMZ:enable,ip:ip})})};this.InputInit=function(listDeviceGet){var i;this.associatedDevices(listDeviceGet);fields.listDevice=listDeviceGet;$("#DMZEquip").prepend('<option value="">Aucun</option>');for(i=0;i<=fields.listDevice.length-1;i+=1){if(i===fields.listDevice.length-1){$("#DMZIP").html(fields.listDevice[i][fields.listDevice[i].linkMode].ipIpv4);$("#DMZmac").html(fields.listDevice[i][fields.listDevice[i].linkMode].macAddress)}$("#DMZEquip").append('<option value="'+fields.listDevice[i].deviceName+'">'+fields.listDevice[i].deviceName+"</option>")}};this.associatedDevices=function(listDevice){var i;for(i=0;i<=listDevice.length-1;i+=1){if(!$.isEmptyObject(listDevice[i].ETHERNET)){fields.associatedDevices[listDevice[i].ETHERNET.ipIpv4]=listDevice[i].deviceName}else if(!$.isEmptyObject(listDevice[i].DONGLE)){fields.associatedDevices[listDevice[i].DONGLE.ipIpv4]=listDevice[i].deviceName}else if(!$.isEmptyObject(listDevice[i].CATIQ2)){fields.associatedDevices[listDevice[i].CATIQ2.ipIpv4]=listDevice[i].deviceName}else if(!$.isEmptyObject(listDevice[i].PRINTER)){fields.associatedDevices[listDevice[i].PRINTER.ipIpv4]=listDevice[i].deviceName}else if(!$.isEmptyObject(listDevice[i].WIFI)){fields.associatedDevices[listDevice[i].WIFI.ipIpv4]=listDevice[i].deviceName}}};this.linkDMZDevice=function(state){if(state.isDmzEnabled){$("#info").show();$("#info2").hide();$("#DMZEquip option[value="+fields.associatedDevices[state.ipAddress]+"]").attr("selected","selected");if($("#currentDevice").length>0){$("#currentDevice").html(fields.associatedDevices[state.ipAddress]+" (adresse ip :"+state.ipAddress+")"+"</span>")}else{$("#info").append("</br>"+'<span style="font-weight:normal;" id="currentDevice" class="orangetxt">'+fields.associatedDevices[state.ipAddress]+" (adresse ip: "+state.ipAddress+")"+"</span>")}}else{$('#DMZEquip option[value=""]').attr("selected","selected");$("#DMZmac").html(" ");$("#DMZIP").html(" ");$("#info").hide();$("#info2").show()}}}return NetworkAdvancedDMZViewClass});