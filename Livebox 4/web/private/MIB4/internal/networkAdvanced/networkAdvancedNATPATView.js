define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","text!app/config/NATPAT.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function NetworkAdvancedNATPATViewClass(aStateId,aTranslateObj){var fields,self;fields={rules:{FTPserver:{name:"FTP Server",HostIPAddress:"0.0.0.0",Enable:0,Rule:{description:"FTP Server",ports:"21",DestinationIPAddress:"",Enable:false,ExternalPort:"21",InternalPort:"21",LeaseDuration:0,Origin:"webui",Protocol:"TCP",SourceInterface:"data",SourcePrefix:"",Status:"Enabled"}},FTPdata:{name:"FTP Data",HostIPAddress:"0.0.0.0",Enable:0,Rule:{description:"FTP Data",ports:"20",DestinationIPAddress:"",Enable:false,ExternalPort:"20",InternalPort:"20",LeaseDuration:0,Origin:"webui",Protocol:"TCP",SourceInterface:"data",SourcePrefix:"",Status:"Enabled"}},Telnet:{name:"Telnet",HostIPAddress:"0.0.0.0",Enable:0,Rule:{description:"Telnet",ports:"23",DestinationIPAddress:"",Enable:false,ExternalPort:"23",InternalPort:"23",LeaseDuration:0,Origin:"webui",Protocol:"TCP",SourceInterface:"data",SourcePrefix:"",Status:"Enabled"}},SSH:{name:"Secure Shell Server (SSH)",HostIPAddress:"0.0.0.0",Enable:0,Rule:{description:"Secure Shell Server (SSH)",ports:"22",DestinationIPAddress:"",Enable:false,ExternalPort:"22",InternalPort:"22",LeaseDuration:0,Origin:"webui",Protocol:"TCP",SourceInterface:"data",SourcePrefix:"",Status:"Enabled"}},HTTPS:{name:"Secure Web Server (HTTPS)",HostIPAddress:"0.0.0.0",Enable:0,Rule:{description:"Secure Web Server (HTTPS)",ports:"443",DestinationIPAddress:"",Enable:false,ExternalPort:"443",InternalPort:"443",LeaseDuration:0,Origin:"webui",Protocol:"TCP",SourceInterface:"data",SourcePrefix:"",Status:"Enabled"}},HTTP:{name:"Web Server(HTTP)",HostIPAddress:"0.0.0.0",Enable:0,Rule:{description:"Web Server (HTTP)",ports:"80",DestinationIPAddress:"",Enable:false,ExternalPort:"80",InternalPort:"80",LeaseDuration:0,Origin:"webui",Protocol:"TCP",SourceInterface:"data",SourcePrefix:"",Status:"Enabled"}},nouveau:{name:"nouveau..."}}};self=this;StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("NetworkAdvancedNATPATViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("NetworkAdvancedNATPATViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("NetworkAdvancedNATPATViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setAppCloseButton(aNext,"app_close")},function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("NetworkAdvancedNATPATViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+aResult.data+"</style>")}if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);$("#natPortInt").after('<span style="display:block;color:gray;font-style:italic;" class=" Translation" data-translation="networkAdvanced.NATPAT.firstSection.exampleSecondPlaceholder"></span>');$("#natPortExt").after('<span style="display:block;color:gray;font-style:italic;" class=" Translation" data-translation="networkAdvanced.NATPAT.firstSection.exampleThirdPlaceholder"></span>');this.translate();this.setPageTitle(null,$(".header-title").find("h1").find("span").html());aNext()}else{basicUtilities.callback(aCallback,false,-1,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){this.createButtonListener(aNext)}else{basicUtilities.callback(aCallback,false,-1,null)}},function(aNext){$("#tab_information_dhcp").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DHCP"})}.bind(this));$("#tab_information_natpat").on("click",function(){this.generateEvent("ViewSubmitted",{state:"NATPAT"})}.bind(this));$("#tab_information_dns").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DNS"})}.bind(this));$("#tab_information_upnp").on("click",function(){this.generateEvent("ViewSubmitted",{state:"UPnP"})}.bind(this));$("#tab_information_dyndns").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DynDNS"})}.bind(this));$("#tab_information_dmz").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DMZ"})}.bind(this));$("#tab_information_ntp").on("click",function(){this.generateEvent("ViewSubmitted",{state:"NTP"})}.bind(this));$("#tab_template_container").off().on("keydown",function(event){var keyCode=event.keyCode||event.which;if(keyCode===39){event.preventDefault();this.generateEvent("ViewSubmitted",{state:"DNS"})}else if(keyCode===37){event.preventDefault();this.generateEvent("ViewSubmitted",{state:"DHCP"})}}.bind(this));basicUtilities.callback(aNext,false,0,null)},function(aNext,aResult){if(!aResult||aResult.status===0){this.initCustomStyle();this.fillSelect();this.selectListener();basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.initCustomStyle=function(){$("#password").prop("type","password");$(".title").css("margin-top","1.5em");$("#natFTP").css({"text-overflow":"ellipsis",overflow:"hidden","padding-right":"2em","white-space":"nowrap","max-width":"10em"});$("#natFTP").parents(".button-container").css({width:"auto","float":"left","margin-top":"51px","margin-right":"15px"});$("#natPortInt").parents(".txtandfield-container").css({"float":"left",margin:"55px 15px 40px 0"});$("#natPortInt").css("width","6em");$("#natPortExt").css("width","6em");$("#equip").css({"text-overflow":"ellipsis",overflow:"hidden","padding-right":"2em","white-space":"nowrap","max-width":"10em"});$("#protocole").parents(".button-container").css({width:"12%","float":"left","margin-top":"51px"});$("#equip").parents(".button-container").css({width:"auto","float":"left","margin-top":"51px","margin-left":"15px"});$("#natPortExt").parents(".txtandfield-container").css({"float":"left",margin:"55px 15px 40px 0"});$("#submit").parents(".button-container").css({width:"auto","margin-top":"55px"});$(".warning").css("font-size","1.4em");$("#submit").css({cursor:"pointer",display:"inline-block","float":"right","margin-top":"60px"});$("#nat_rules_list").css("clear","left");$("#natPortInt_warning").css({position:"absolute",top:"26em",left:"18em","max-width":"20em"});$("#natPortExt_warning").css({position:"absolute",top:"26em",left:"35em","max-width":"20em"});$("#protocole").css("min-width","6em");$("#nat_rules_list_table").css({width:"100%"})};this.createButtonListener=function(aCallback){basicUtilities.queue([function(aNext){$("#submit").on("click keypress",function(event){if(event.which===13||event.type==="click"){self.fireEvent("ViewSubmitted",{action:"cr√©er",name:$("#natFTP").val(),isEnabled:true,protocole:$("#protocole").val(),internalPortRange:$("#natPortInt").val(),externalPortRange:$("#natPortExt").val(),ipAddress:$("#equip").val()})}});aNext()},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.displayNATPortIntError=function(isValid,msg){if(msg){$("#natPortInt_warning").find(".warning").attr("data-translation","networkAdvanced.NATPAT.firstSection.errors."+msg);this.translate("#natPortInt_warning")}if(isValid){$("#natPortInt_warning").css("display","none");$("#natPortInt_label").css("color","#000000");$("#natPortInt").css("color","#000000");$("#natPortInt").css("border-color","#999999")}else{$("#natPortInt_warning").css("display","inline-block");$("#natPortInt_label").css("color","#CC0000");$("#natPortInt").css("color","#CC0000");$("#natPortInt").css("border-color","#CC0000")}};this.displayNATPortExtError=function(isValid,msg){if(msg){$("#natPortExt_warning").find(".warning").attr("data-translation","networkAdvanced.NATPAT.firstSection.errors."+msg);this.translate("#natPortExt_warning")}if(isValid){$("#natPortExt_warning").css("display","none");$("#natPortExt_label").css("color","#000000");$("#natPortExt").css("color","#000000");$("#natPortExt").css("border-color","#999999")}else{$("#natPortExt_warning").css("display","inline-block");$("#natPortExt_label").css("color","#CC0000");$("#natPortExt").css("color","#CC0000");$("#natPortExt").css("border-color","#CC0000")}};this.displayNatFtpError=function(isValid,msg){if(msg){$("#natFTP_warning").find(".warning").attr("data-translation","networkAdvanced.NATPAT.firstSection.errors."+msg);this.translate("#natFTP_warning")}if(isValid){$("#natFTP_warning").css("display","none");$("#natFTP_label").css("color","#000000");$("#natFTP").css("color","#000000");$("#natFTP").css("border-color","#999999")}else{$("#natFTP_warning").css("display","inline-block");$("#natFTP_label").css("color","#CC0000");$("#natFTP").css("color","#CC0000");$("#natFTP").css("border-color","#CC0000")}};this.InputInit=function(listDevice){var i;for(i=0;i<=listDevice.length-1;i+=1){if(!$.isEmptyObject(listDevice[i].ETHERNET)){$("#equip").prepend('<option selected="selected" value='+listDevice[i].ETHERNET.ipIpv4+">"+listDevice[i].deviceName+"</option>")}else if(!$.isEmptyObject(listDevice[i].DONGLE)){$("#equip").prepend('<option selected="selected" value='+listDevice[i].DONGLE.ipIpv4+">"+listDevice[i].deviceName+"</option>")}else if(!$.isEmptyObject(listDevice[i].CATIQ2)){$("#equip").prepend('<option selected="selected" value='+listDevice[i].CATIQ2.ipIpv4+">"+listDevice[i].deviceName+"</option>")}else if(!$.isEmptyObject(listDevice[i].PRINTER)){$("#equip").prepend('<option selected="selected" value='+listDevice[i].PRINTER.ipIpv4+">"+listDevice[i].deviceName+"</option>")}else if(!$.isEmptyObject(listDevice[i].WIFI)){$("#equip").prepend('<option selected="selected" value='+listDevice[i].WIFI.ipIpv4+">"+listDevice[i].deviceName+"</option>")}}};this.displayInfo=function(rulesList){if($("#empty").length>0){$("#empty").parent().hide()}$("#nat_rules_list_table").find("tr:gt(1)").remove();var i;for(i=0;i<=rulesList.length-1;i+=1){$("#nat_rules_list_table tr:last").after('<tr id="'+rulesList[i].name+'" class="conf-table-row">'+'<td class="conf-table-cell">'+'<input id="activateRule_'+i+'" type="checkbox" value="true" class="checkbox" name="activateCheckbox" style="display:none;" '+(rulesList[i].isEnabled?"checked":"")+">"+'<label for="activateRule_'+i+'" style="margin:0;background-size: 2em 2em;height: 2em;width: 2em;"></label>'+"</td>"+'<td class="conf-table-cell">'+rulesList[i].name+"</td>"+'<td id="intPort" class="conf-table-cell">'+rulesList[i].internalPortRange+"</td>"+'<td id="extPort" class="conf-table-cell">'+rulesList[i].externalPortRange+"</td>"+'<td class="conf-table-cell" id="protocole">'+rulesList[i].protocol+"</td>"+'<td class="conf-table-cell">'+rulesList[i].ipAddress+"</td>"+'<td class="conf-table-blank-cell">'+'<img alt="supprimer" tabindex="0" class="conf-table-button-delete" src="../../common/img/app_conf/trashbin_666.png">'+"</td>"+"</tr>")}this.checkboxListener();this.deleteListener()};this.fillSelect=function(){$.each(fields.rules,function(key,value){$("#natFTP").append("<option value="+value.name+">"+value.name+"</option>")})};this.selectListener=function(){$("#natFTP").on("change",function(event){if(event.currentTarget.value==="nouveau..."){$("#natFTP").parents(".button-container").replaceWith("<div style='float: left; margin: 55px 15px 40px 0px;' class='txtandfield-container'>"+"<div class='txtandfield-text-input'>"+"<input style='width: 10em; height:2em;' id='natFTP' value='' type='text'>"+"</div>"+"<div style='position: absolute; top: 26em; left: -1em; max-width: 20em;' class='txtandfield-warning' id='natFTP_warning'>"+"<span class='redtxt'>"+"<span style='font-size: 1.4em;' class='warning Translation' data-translation='networkAdvanced.NATPAT.firstSection.errors.nom'>"+"</span>"+"</span>"+"</div>"+"</div>");self.translate()}})};this.checkboxListener=function(){$(".checkbox").on("change",function(event){self.fireEvent("ViewSubmitted",{action:"maj",name:$(event.currentTarget).closest("tr").attr("id"),isEnabled:$(event.currentTarget).is(":checked")})})};this.deleteListener=function(){$(".conf-table-button-delete").on("click keypress",function(event){if(event.which===13||event.type==="click"){self.fireEvent("ViewSubmitted",{action:"supprimer",name:$(event.currentTarget).closest("tr").attr("id"),protocole:$(event.currentTarget).closest("tr").find("td#protocole").text(),target:$(event.currentTarget).closest("tr"),internalPort:$(event.currentTarget).closest("tr").find("td#intPort").text(),externalPort:$(event.currentTarget).closest("tr").find("td#extPort").text()})}})};this.deleteCurrentRow=function(target){target.remove();if($("#nat_rules_list_table tr:last td").is(":hidden")){$("#empty").parent().show()}}}return NetworkAdvancedNATPATViewClass});