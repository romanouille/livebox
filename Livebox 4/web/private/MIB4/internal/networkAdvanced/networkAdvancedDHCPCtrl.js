define(["utils/console","utils/basics","lib/stateCtrlInterface"],function(console,basicUtilities,StateCtrlClass){"use strict";function NetworkAdvancedDHCPCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,globalResult,regexIP,regexMAC,regexMASK,onViewEvent=function(aEventId,aData){if(aEventId==="ViewCancelled"){this.quit()}else if(aEventId==="ViewSubmitted"){if(aData.action==="modification"){this.verifForm(null,aData.ip,aData.mask,aData.IPBegin,aData.IPEnd,aData.dhcpState)}else if(aData.action==="ajouter"){this.addStaticAddress(null,aData.id,aData.ip,aData.ipv4List,aData.macList)}else if(aData.action==="supprimer"){this.deleteStaticAddress(null,aData.id,aData.device,aData.ip)}if(aData.state==="DHCP"){window.location.hash="#DHCP"}else if(aData.state==="NATPAT"){window.location.hash="#NATPAT"}else if(aData.state==="DNS"){window.location.hash="#DNS"}else if(aData.state==="UPnP"){window.location.hash="#UPnP"}else if(aData.state==="DynDNS"){window.location.hash="#DynDNS"}else if(aData.state==="DMZ"){window.location.hash="#DMZ"}else if(aData.state==="NTP"){window.location.hash="#NTP"}}else{console.warn("NetworkAdvancedDHCPCtrlClass: Unexpected event '"+aEventId+"'")}};fields={privateClassA:new RegExp(/^10/),privateClassB:new RegExp(/^172.16/),privateClassC:new RegExp(/^192.168/),forbiddenAddress:new RegExp(/^192.168.128/)};globalResult={informations:[],devices:[]};regexMASK=new RegExp(/^((128|192|224|240|248|252|254)\.0\.0\.0)|(255\.(((0|128|192|224|240|248|252|254)\.0\.0)|(255\.(((0|128|192|224|240|248|252|254)\.0)|255\.(0|128|192|224|240|248|252|254)))))$/);regexMAC=new RegExp(/^([0-9A-F]{2}[:-]){5}([0-9A-F]{2})$/);regexIP=new RegExp(/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/);StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("NetworkAdvancedDHCPCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("NetworkAdvancedDHCPCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("NetworkAdvancedDHCPCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().enable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getConfiguration(aNext)}else{basicUtilities.callback(aNext,false,-1,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getDeviceList(aCallback,false)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("NetworkAdvancedDHCPCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getConfiguration=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.DhcpServerIpv4.getConfiguration",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){globalResult.informations=aResult.data;this.getViewObj().dhcpInputInit(globalResult.informations);basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("Failed to get  DHCP configuration","yke0001");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getDeviceList=function(aCallback,update){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.NetworkMap.listDevices",aNext,{filter:{linkModeList:["ETHERNET","WIFI"],isActive:true}})},function(aNext,aResult){if(!aResult||aResult.status===0){globalResult.devices.list=aResult.data.deviceList;this.callSahApi("sah.HomeNetwork.DhcpServerIpv4.listStaticLeases",aNext,null)}else{this.getViewObj().notifyError("Failed to get devices list","yke0002");basicUtilities.callback(aCallback,false,-1,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){globalResult.devices.staticList=aResult.data.staticLeaseList;this.getViewObj().displayInfo(globalResult.devices,update);this.getViewObj().deleteButtonListener();basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("Failed to get static lease list","yke0003");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.addStaticAddress=function(aCallback,deviceId,deviceIP,ipv4List,macList){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.DhcpServerIpv4.getConfiguration",aNext,null)},function(aNext,aResult){if(aResult.status===0){globalResult.configuration=aResult.data;if(regexIP.test(deviceIP)&&(globalResult.configuration.minIpAddress<deviceIP&&deviceIP<globalResult.configuration.maxIpAddress)&&deviceIP.substr(deviceIP.lastIndexOf(".")-3,3)!=="144"&&!fields.forbiddenAddress.test(deviceIP.substr(0,deviceIP.lastIndexOf(".")))&&(fields.privateClassA.test(deviceIP)||fields.privateClassB.test(deviceIP)||fields.privateClassC.test(deviceIP))&&(ipv4List.length===0||ipv4List.indexOf(deviceIP)===-1)){this.getViewObj().displayIPStaticError(true);if(regexMAC.test(deviceId)&&(macList.length===0||macList.indexOf(deviceId)===-1)){this.getViewObj().displayMacStaticError(true);this.callSahApi("sah.HomeNetwork.DhcpServerIpv4.addStaticLease",aNext,{deviceId:deviceId,ipAddress:deviceIP})}else{this.getViewObj().displayMacStaticError(false);basicUtilities.callback(aNext,false,-1,null)}}else{this.getViewObj().displayIPStaticError(false);basicUtilities.callback(aNext,false,-1,null)}}else{basicUtilities.callback(aNext,false,-1,null)}},function(aNext,aResult){if(aResult.status===0){this.getDeviceList(aCallback,true);this.getViewObj().removeFromSelect(deviceId);this.getViewObj().updateSelect()}else{this.getViewObj().notifyError("NetworkAdvancedDHCPCtrlClass: Failed to add static address","yke0004");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.deleteStaticAddress=function(aCallback,deviceId,deviceName,deviceIp){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.DhcpServerIpv4.deleteStaticLease",aNext,{deviceId:deviceId})},function(aNext,aResult){if(aResult.status===0){this.getDeviceList(aNext,true)}else{this.getViewObj().notifyError("NetworkAdvancedDHCPCtrlClass: Failed to delete static address","yke0005");basicUtilities.callback(aNext,false,-1,null)}},function(aNext,aResult){if(aResult.status===0){this.getViewObj().addToInput(deviceName,deviceIp,deviceId);basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.verifForm=function(aCallback,IP,Mask,IPBegin,IPEnd,state){basicUtilities.queue([function(aNext){if(regexIP.test(IP)&&IP.substr(IP.lastIndexOf(".")-3,3)!=="144"&&!fields.forbiddenAddress.test(IP.substr(0,IP.lastIndexOf(".")))&&(fields.privateClassA.test(IP)||fields.privateClassB.test(IP)||fields.privateClassC.test(IP))){this.getViewObj().displayIPError(true);if(regexMASK.test(Mask)){this.getViewObj().displayMacError(true);if(regexIP.test(IPBegin)&&IPBegin.indexOf(IP.substr(0,IP.lastIndexOf(".")+1))!==-1){this.getViewObj().displayIPbeginError(true);if(regexIP.test(IPEnd)&&IPEnd.indexOf(IP.substr(0,IP.lastIndexOf(".")+1))!==-1){this.getViewObj().displayIPendError(true);this.callSahApi("sah.HomeNetwork.DhcpServerIpv4.setConfiguration",aNext,{isDhcpEnabled:state,ipAddress:IP,mask:Mask,minIpAddress:IPBegin,maxIpAddress:IPEnd})}else{this.getViewObj().displayIPendError(false)}}else{this.getViewObj().displayIPbeginError(false)}}else{this.getViewObj().displayMacError(false)}}else{this.getViewObj().displayIPError(false)}basicUtilities.callback(aNext,false,0,null)},function(aNext){this.pingSahApi(aNext)},function(aNext,aResult){if(aResult.status===0){this.goToHomePage(aNext)}else{this.getViewObj().displayIPbeginError(false);this.getViewObj().displayIPendError(false);this.getViewObj().notifyError("NetworkAdvancedDHCPCtrlClass: Failed to modify DHCP information","yke0006");basicUtilities.callback(aNext,false,-1,null)}},function(aNext,aResult){if(aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("NetworkAdvancedDHCPCtrlClass: Failed to logout","yke0007");basicUtilities.callback(aNext,false,-1,null)}}],this)};this.goToHomePage=function(aCallback){this.goToMhs();basicUtilities.callback(aCallback,false,0,null)}}return NetworkAdvancedDHCPCtrlClass});