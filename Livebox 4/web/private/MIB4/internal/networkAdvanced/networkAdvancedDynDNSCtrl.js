define(["utils/console","utils/basics","lib/stateCtrlInterface"],function(console,basicUtilities,StateCtrlClass){"use strict";function NetworkAdvancedDynDNSCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,globalResult,hostNameRegex,mailRegex,onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("NetworkAdvancedDynDNSCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewCancelled"){console.debug("NetworkAdvancedDynDNSCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));this.quit()}else if(aEventId==="ViewSubmitted"){console.debug("NetworkAdvancedDynDNSCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData));if(aData.action==="enregistrer"){this.setNewService(null,aData.service,aData.hostname,aData.mail,aData.password)}else if(aData.action==="supprimer"){this.deleteService(null,aData.hostname,aData.target)}if(aData.state==="DHCP"){window.location.hash="#DHCP"}else if(aData.state==="NATPAT"){window.location.hash="#NATPAT"}else if(aData.state==="DNS"){window.location.hash="#DNS"}else if(aData.state==="UPnP"){window.location.hash="#UPnP"}else if(aData.state==="DynDNS"){window.location.hash="#DynDNS"}else if(aData.state==="DMZ"){window.location.hash="#DMZ"}else if(aData.state==="NTP"){window.location.hash="#NTP"}}else{console.warn("NetworkAdvancedDynDNSCtrlClass: Unexpected event '"+aEventId+"'")}};hostNameRegex=new RegExp(/^(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z]|[A-Za-z][A-Za-z0-9\-]*[A-Za-z0-9])$/);mailRegex=new RegExp(/^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/);fields={};globalResult={};StateCtrlClass.call(this,aStateId,aStateManager,aSahObj,aViewObj);this.init=function(aCallback){console.debug("NetworkAdvancedDynDNSCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),onViewEvent.bind(this));this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("NetworkAdvancedDynDNSCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("NetworkAdvancedDynDNSCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().enable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getSupportedServices(aNext)}else{basicUtilities.callback(aCallback,false,0,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getServiceList(aNext)}else{basicUtilities.callback(aCallback,false,0,null)}},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("NetworkAdvancedDynDNSCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.setNewService=function(aCallback,service,hostname,login,password){basicUtilities.queue([function(aNext){if(globalResult.servicesList){for(var i=0;i<globalResult.servicesList.length;i+=1){if(globalResult.servicesList[i].hostname===hostname){globalResult.isUsedHost=true;break}else{globalResult.isUsedHost=false}}}this.getViewObj().displaypasswordError(true);this.getViewObj().displayHostError(true);this.getViewObj().displayMailError(true);if(globalResult.isUsedHost){this.getViewObj().displayHostError(false,"same")}else if(!hostNameRegex.test(hostname)||!(hostname.length>0&&hostname.length<=63)){this.getViewObj().displayHostError(false)}else if(!mailRegex.test(login)||!(login.length>0&&login.length<=63)||service==="No-IP"&&!(login.length>=6&&login.length<=15)){this.getViewObj().displayMailError(false)}else if(!(password.length>0&&password.length<=63)||service==="No-IP"&&!(password.length>=6&&password.length<=63)){this.getViewObj().displaypasswordError(false)}else{this.callSahApi("sah.HomeNetwork.DynDns.addUserAccount",aNext,{service:service,hostname:hostname,login:login,password:password})}},function(aNext,aResult){if(!aResult||aResult.status===0){this.getServiceList(aCallback)}else{this.getViewObj().notifyError("NetworkAdvancedDynDNSCtrlClass: Failed to new service","yke0001");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.deleteService=function(aCallback,hostname,target){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.DynDns.deleteUserAccount",aNext,hostname)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getViewObj().deleteCurrentRow(target);basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("NetworkAdvancedDynDNSCtrlClass: Failed to delete service","yke0002");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getServiceList=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.DynDns.listUserAccount",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){if(aResult.data.accountList.length>0){globalResult.servicesList=aResult.data.accountList;this.getViewObj().displayInfo(globalResult.servicesList)}basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("NetworkAdvancedDynDNSCtrlClass: Failed to get services list","yke0003");basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.getSupportedServices=function(aCallback){basicUtilities.queue([function(aNext){this.callSahApi("sah.HomeNetwork.DynDns.listServices",aNext,null)},function(aNext,aResult){if(!aResult||aResult.status===0){this.getViewObj().initSelect(aResult.data.serviceList);basicUtilities.callback(aCallback,false,0,null)}else{this.getViewObj().notifyError("NetworkAdvancedDynDNSCtrlClass: Failed to get supported services list","yke0004");basicUtilities.callback(aCallback,false,-1,null)}}],this)}}return NetworkAdvancedDynDNSCtrlClass});