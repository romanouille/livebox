define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_app/template","text!bootstrap/bootstrap.css","text!app/config/NTP.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function NetworkAdvancedNTPViewClass(aStateId,aTranslateObj){var fields,self,currentTime,timeOptions;self=this;fields={timezone:[]};timeOptions={weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"};StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("NetworkAdvancedNTPViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("NetworkAdvancedNTPViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("NetworkAdvancedNTPViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setAppCloseButton(aNext,"app_close")},function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("NetworkAdvancedNTPViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+aResult.data+"</style>")}if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);this.translate();this.setPageTitle(null,$(".header-title").find("h1").find("span").html());this.saveButtonListener();aNext()}else{basicUtilities.callback(aCallback,false,-1,null)}},function(){$("#tab_information_dhcp").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DHCP"})}.bind(this));$("#tab_information_natpat").on("click",function(){this.generateEvent("ViewSubmitted",{state:"NATPAT"})}.bind(this));$("#tab_information_dns").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DNS"})}.bind(this));$("#tab_information_upnp").on("click",function(){this.generateEvent("ViewSubmitted",{state:"UPnP"})}.bind(this));$("#tab_information_dyndns").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DynDNS"})}.bind(this));$("#tab_information_dmz").on("click",function(){this.generateEvent("ViewSubmitted",{state:"DMZ"})}.bind(this));$("#tab_information_ntp").on("click",function(){this.generateEvent("ViewSubmitted",{state:"NTP"})}.bind(this));$("#tab_template_container").off().on("keydown",function(event){var keyCode=event.keyCode||event.which;if(keyCode===39){event.preventDefault();this.generateEvent("ViewSubmitted",{state:"DHCP"})}else if(keyCode===37){event.preventDefault();this.generateEvent("ViewSubmitted",{state:"DMZ"})}}.bind(this));this.initCustomStyle();basicUtilities.callback(aCallback,false,0,null)}],this)};this.selectListener=function(equip){var pixel,value;$("#NTPtime").on("change",function(){value=$(this).val();pixel=fields.timezone[value].pixel.toString();$("#divMap").css("left",pixel);if($("#date").length===0){$("#associateDate > div:last-child").append('<span aria-live="polite" class="orangetxt" style="top:3px;position: relative;" id="date">'+self.convertToNewDateFormat(fields.timezone[value].convert)+"<span>")}else{$("#date").html(self.convertToNewDateFormat(fields.timezone[value].convert,fields.timezone[equip].convert))}if($("#NTPtime").val()!==equip){$("#submit").attr("disabled",false)}else{$("#submit").attr("disabled",true)}})};this.initSelect=function(timezone){var i,equip,cityObject,arrayTimeZone=[{pixel:"28px",convert:-12},{pixel:"48px",convert:-11},{pixel:"67px",convert:-10},{pixel:"85px",convert:-8},{pixel:"104px",convert:-7},{pixel:"123px",convert:-7},{pixel:"142px",convert:-5},{pixel:"161px",convert:-5},{pixel:"180px",convert:-3},{pixel:"199px",convert:-2.3},{pixel:"199px",convert:-2},{pixel:"218px",convert:-2},{pixel:"237px",convert:0},{pixel:"256px",convert:1},{pixel:"275px",convert:2},{pixel:"295px",convert:3},{pixel:"313px",convert:3},{pixel:"313px",convert:3.3},{pixel:"332px",convert:4},{pixel:"332px",convert:4.3},{pixel:"350px",convert:5},{pixel:"350px",convert:5.3},{pixel:"350px",convert:5.45},{pixel:"370px",convert:6},{pixel:"370px",convert:6.3},{pixel:"389px",convert:7},{pixel:"408px",convert:8},{pixel:"427px",convert:9},{pixel:"427px",convert:9.3},{pixel:"446px",convert:10},{pixel:"465px",convert:11},{pixel:"484px",convert:12}];cityObject={"International Date Line West":0,"Midway Island, Samoa":1,Hawaii:2,Alaska:3,"Pacific Time (US/Canada), Tijuana":4,Arizona:5,"Mountain Time (US/Canada)":5,"Chihuahua, Mazatlan":5,"Central America":6,"Central Time (US/Canada)":6,"Guadalajara, Mexico City, Monterrey":6,Saskatchewan:6,"Bogota, Lima, Quito":7,"Eastern Time (US/Canada)":7,"Indiana (East)":7,"Atlantic Time (Canada)":8,"Caracas, La Paz":8,Santiago:8,Newfoundland:9,Brasilia:10,"Buenos Aires, GeorgetownT":10,GreenlandT:10,"Mid-AtlantiT":11,"Azores, Cape Verde Is.":12,"Casablanca, Lisbon, Monrovia":13,"GMT: Dublin, Edinburgh, London":13,Paris:14,"Amsterdam, Bern, Rome, Stockholm":14,"Belgrade, Berlin, Budapest, Ljubljana":14,"Brussels, Copenhagen, Madrid":14,"Bratislava, Prague, Vienna":14,"Sarajevo, Skopje, Warsaw, Zagreb":14,"West Central Africaa":14,"Bucharest, Cairo":15,"Harare, Pretoria":15,"Helsinki, Kyiv, Riga, Sofia, Tallinn, Vilnius":15,Jerusalem:15,"Baghdad, Kuwait, Riyadh":15,"Moscow, St. Petersburg, Volgograd":16,Mayotte:16,Nairobi:16,Tehran:17,"Abu Dhabi, Muscat":18,"Baku, Tbilisi, Yerevan":18,Kabul:19,Ekaterinburg:20,"Islamabad, Karachi, Tashkent":20,"Chennay, Kolkata, Mumbal, New Delhi":21,Katmandu:22,"Almaty, Novosibirsko":23,"Astana, Dhaka":23,Rangoon:24,"Bangkok, Hanoi, Jakarta":25,Krasnoyarsk:25,"Beijing, Chongqing, Hong Kong, Urumqi":26,"Irkutsk, Ulaan Bataar":26,"Kuala Lumpur, Singapore":26,"Perth, Taipei":26,"Osaka, Sapporo, Tokyo":27,"Seoul, Yakutsk":27,"Adelaide, Darwin":28,Brisbane:29,"Canberra, Melbourne, Sydney":29,"Hobart, Vladivosto":29,"Guam, Port Moresby":29,"Magadan, Solomon Is., New Caledonia":30,"Auckland, Wellington":31,"Fiji, Kamchatka, Marshall Is.":31,Antilles:8,Guyane:10,"Reunion, Yerevan":18};timezone.timezoneList.sort();for(i=0;i<=timezone.timezoneList.length-1;i+=1){if(timezone.timezoneList[i]!==""){fields.timezone[timezone.timezoneList[i]]=arrayTimeZone[cityObject[timezone.timezoneList[i]]];if(timezone.timezoneList[i]===timezone.timezone){if(timezone.timezone==="Paris"){$("#NTPtime").prepend('<option selected="selected" value="'+timezone.timezoneList[i].toString()+'">'+timezone.timezoneList[i].toString()+"</option>")}else{$("#NTPtime").append('<option selected="selected" value="'+timezone.timezoneList[i].toString()+'">'+timezone.timezoneList[i].toString()+"</option>")}}else{if(timezone.timezoneList[i]==="Paris"){$("#NTPtime").prepend('<option value="'+timezone.timezoneList[i].toString()+'">'+timezone.timezoneList[i].toString()+"</option>")}else{$("#NTPtime").append('<option value="'+timezone.timezoneList[i].toString()+'">'+timezone.timezoneList[i].toString()+"</option>")}}}}equip=$("#NTPtime").find("option:selected").val();this.selectListener(equip)};this.saveButtonListener=function(){$("#submit").on("click",function(){self.fireEvent("ViewSubmitted",{timezone:$("#NTPtime").val()})})};this.displayCurrentTime=function(){currentTime=this.convertToNewDateFormat(fields.timezone[$("#NTPtime").val()].convert,0);if($("#current").length===0){$("#currentDate > div:last-child").append('<span aria-live="polite" style="top:3px;position: relative;" id="current" class="orangetxt">'+currentTime.toLocaleString("fr-fr",timeOptions)+"</span>")}else{$("#current").html(currentTime.toLocaleString("fr-fr",timeOptions))}};this.convertToNewDateFormat=function(value,oldValue){var newDate,hours,utc;newDate=new Date;if(value!==oldValue){utc=newDate.getTime()+newDate.getTimezoneOffset()*6e4;hours=new Date(utc+36e5*value).toLocaleString("fr-fr",timeOptions)}else{hours=new Date(newDate).toLocaleString("fr-fr",timeOptions)}return hours};this.initCustomStyle=function(){$("#NTPtime").parents(".row").css("margin","0");$("#timezone").css("margin-top","3em");$("#associateDate").css("margin-top","1.5em");$("#NTPtime").css({"text-overflow":"ellipsis",overflow:"hidden","padding-right":"2em","white-space":"nowrap","max-width":"22em"});$("#NTPtime").css("width","21.6em");$("img").after('<div style="background-color: #F60;opacity: 0.7;position:relative;height:22em;width:21px;bottom:330px;left:275px;" id="divMap"></div>');$("#submit").attr("disabled",true)}}return NetworkAdvancedNTPViewClass});