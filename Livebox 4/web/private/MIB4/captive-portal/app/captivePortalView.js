define(["utils/console","utils/basics","lib/eventHandler","lib/stateViewInterface","jquery","text","templates_install/template","text!bootstrap/bootstrap.css","text!app/config/captivePortal.json"],function(console,basicUtilities,EventHandlerClass,StateViewClass,$,Text,TemplateClass,Bootstrap,Config){"use strict";function CaptivePortalViewClass(aStateId,aTranslateObj){var fields;fields={errorCode:null};StateViewClass.call(this,aStateId,aTranslateObj);this.init=function(aCallback){console.debug("CaptivePortalViewClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.setStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("CaptivePortalViewClass: Initialising state '"+this.getId()+"'","rra0165")}}],this)};this.quit=function(aCallback){console.debug("CaptivePortalViewClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.unsetStyle(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("CaptivePortalViewClass: Releasing state '"+this.getId()+"'","rra0166")}}],this)};this.enable=function(aCallback){console.debug("CaptivePortalViewClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewDisplayPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){this.setHeaderButtons();this.setContrast();basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("CaptivePortalViewClass: Enabling state '"+this.getId()+"'","rra0167")}}],this)};this.disable=function(aCallback){console.debug("CaptivePortalViewClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.viewEmptyPage(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("CaptivePortalViewClass: Disabling state '"+this.getId()+"'","rra0168")}}],this)};this.stripLines=function(aCallback,aString){basicUtilities.callback(aCallback,false,0,aString.replace(/(\r\n|\n|\r|\t)/gm,""))};this.fillTemplate=function(aCallback,template,context){basicUtilities.queue([function(aNext){this.stripLines(aNext,context)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,template(JSON.parse(aResult.data)))}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("CaptivePortalViewClass: Internal Error fillTemplate failed","rra0169")}}],this)};this.setHeaderButtons=function(){$("#header_translate_fr").removeAttr("data-translation");$("#header_translate_en").removeAttr("data-translation");$("#header_translate_fr").removeClass("Translation");$("#header_translate_en").removeClass("Translation");$("#header_translate_fr").attr("alt","Version fran√ßaise");$("#header_translate_fr").attr("role","button");$("#header_translate_en").attr("alt","English version");$("#header_translate_en").attr("role","button");$("#header_translate_fr").on("click",function(event){event.preventDefault();basicUtilities.queue([function(aNext){this.fireEvent("ViewUpdated",{langId:"fr"});this.updateTranslationLanguage(aNext,"fr")},function(aNext,aResult){if(!aResult||aResult.status===0){this.translate();$("#errorMessages").focus();basicUtilities.callback(null,false,0,null)}else{basicUtilities.callback(null,false,-1,null);this.notifyError("CaptivePortalViewClass: Internal Error updateTranslationLanguage failed","rra0170")}}],this)}.bind(this));$("#header_translate_fr").closest("a").on("keydown",function(event){var keyCode=event.keyCode||event.which;if(keyCode===13){event.preventDefault();$("#header_translate_fr").trigger("click")}});$("#header_translate_en").on("click",function(event){event.preventDefault();basicUtilities.queue([function(aNext){this.fireEvent("ViewUpdated",{langId:"en"});this.updateTranslationLanguage(aNext,"en")},function(aNext,aResult){if(!aResult||aResult.status===0){this.translate();$("#errorMessages").focus();basicUtilities.callback(null,false,0,null)}else{basicUtilities.callback(null,false,-1,null);this.notifyError("CaptivePortalViewClass: Internal Error updateTranslationLanguage failed","rra0171")}}],this)}.bind(this));$("#header_translate_en").closest("a").on("keydown",function(event){var keyCode=event.keyCode||event.which;if(keyCode===13){event.preventDefault();$("#header_translate_en").trigger("click")}});$("#header_contrast").on("click",function(event){event.preventDefault();this.toggleContrast()}.bind(this))};this.setContrast=function(){var elements=["body, #header_template_container, .popup_window"],displayAttr,fontsizeAttr;if(basicUtilities.getCookie("UIContrast")==="1"){$(elements).each(function(){$(this).css({color:"#FFFFFF",backgroundColor:"#000000"})})}else{$(elements).each(function(){displayAttr=$(this).css("display");fontsizeAttr=$(this).css("font-size");$(this).removeAttr("style");$(this).css("display",displayAttr);$(this).css("font-size",fontsizeAttr)})}};this.toggleContrast=function(){if(basicUtilities.getCookie("UIContrast")==="0"){basicUtilities.setCookie("UIContrast","1")}else{basicUtilities.setCookie("UIContrast","0")}this.setContrast()};this.setStyle=function(aCallback){basicUtilities.queue([function(aNext){this.stripLines(aNext,Bootstrap)},function(aNext,aResult){if(!aResult||aResult.status===0){if(!$("#app_conf_style_sheet").length){$("head").append('<style id="app_conf_style_sheet">'+aResult.data+"</style>")}if(!$("#bootstrap_style_sheet").length){$("head").append('<style id="bootstrap_style_sheet">'+TemplateClass.style+"</style>")}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("CaptivePortalViewClass: Internal Error stripLines failed","rra0172")}}],this)};this.unsetStyle=function(aCallback){if($("#app_conf_style_sheet").length){$("head").children("#app_conf_style_sheet").remove()}if($("#bootstrap_style_sheet").length){$("head").children("#bootstrap_style_sheet").remove()}basicUtilities.callback(aCallback,false,0,null)};this.viewEmptyPage=function(aCallback){$(window.document.body).html();basicUtilities.callback(aCallback,false,0,null)};this.viewDisplayPage=function(aCallback){basicUtilities.queue([function(aNext){this.fillTemplate(aNext,TemplateClass.template,Config)},function(aNext,aResult){if(!aResult||aResult.status===0){$(window.document.body).html(aResult.data);fields.errorCode=this.getUrlParameter("errorcode");$("#errorMessages").attr("tabindex","-1");if(typeof fields.errorCode!=="undefined"&&fields.errorCode!==""){this.displayErrorMsg(fields.errorCode)}else{this.fireEvent("ViewSubmitted",null)}basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null);this.notifyError("CaptivePortalViewClass: Failed to fill template with config data","rra0173")}}],this)};this.getUrlParameter=function(sParam){var sPageURL,sURLVariables,i,sParameterName;sPageURL=window.location.search.substring(1);sURLVariables=sPageURL.split("&");for(i=0;i<sURLVariables.length;i+=1){sParameterName=sURLVariables[i].split("=");if(sParameterName[0]===sParam){return sParameterName[1]}}};this.displayErrorMsg=function(errorCode){$("#errorMessages").attr("class","Translation");if(errorCode!==""){$("#errorMessages").attr("data-translation","captivePortal."+errorCode+".messages")}else{$("#errorMessages").attr("data-translation","captivePortal.Error_01.messages")}this.translate();$("#errorMessages").focus()}}return CaptivePortalViewClass});