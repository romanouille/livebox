define(["utils/console","utils/basics"],function(console,basicUtilities){"use strict";function StateCtrlClass(aStateId,aStateManager,aSahObj,aViewObj){var fields,onViewEvent=function(aEventId,aData){if(aEventId==="ViewUpdated"){console.debug("StateCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewCancelled"){console.debug("StateCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else if(aEventId==="ViewSubmitted"){console.debug("StateCtrlClass: View event '"+aEventId+"' with data "+JSON.stringify(aData))}else{console.warn("StateCtrlClass: Unexpected event '"+aEventId+"'")}},doPingSahApi=function(aCallback){basicUtilities.queue([function(aNext){fields.sahObj.invokeApi("semantic","sah.Device.System.getServicesState",aNext,{serviceList:[]})},function(aNext,aResult){if(aResult&&(aResult.status===0||aResult.status===true)){basicUtilities.callback(aCallback,false,0,null)}else{window.setTimeout(doPingSahApi.bind(this,aCallback),1e4)}}],this)};fields={stateId:aStateId+"Ctrl",stateManager:aStateManager,sahObj:aSahObj,viewObj:aViewObj};this.getId=function(){return fields.stateId};this.getCapabilities=function(){return fields.sahObj.getCapabilities()};this.isEmulated=function(){return fields.sahObj.isEmulated()};this.callSahApi=function(aApi,aCallback,aData){basicUtilities.queue([function(aNext){fields.sahObj.invokeApi("semantic",aApi,aNext,aData)},function(aNext,aResult){var apiStatus;if(aResult&&(aResult.status===0||aResult.status)&&(typeof aResult.data==="undefined"||JSON.stringify(aResult.data)==="{}")||typeof aResult.data.contactId!=="undefined"&&typeof aResult.data.familyName==="undefined"){apiStatus=aResult.status;fields.sahObj.invokeApi("semantic","sah.Device.System.getBackupAndRestoreNetworkState",aNext.bind(this,apiStatus))}else{basicUtilities.callback(aCallback,false,aResult.status,aResult.data)}},function(aNext,aApiStatus,aResult){if(aResult&&aResult.status===0&&aResult.data&&aResult.data.Enable){console.debug("StateCtrlClass: Requesting networked backup on result of api  '"+aApi+"'");fields.sahObj.invokeApi("semantic","sah.Device.System.backupNetwork",aNext.bind(this,aApiStatus),{activate:true})}else{basicUtilities.callback(aCallback,false,aApiStatus,null)}},function(aNext,aApiStatus){basicUtilities.callback(aCallback,false,aApiStatus,null)}],this)};this.pingSahApi=function(aCallback){if(this.isEmulated()){window.setTimeout(function(){basicUtilities.callback(aCallback,false,0,null)},1e4)}else{window.setTimeout(doPingSahApi.bind(this,aCallback),12e4)}};this.startEventListener=function(){fields.sahObj.startEventListener()};this.listenEvent=function(eventId,handler){fields.sahObj.listenEvent(eventId,handler)};this.stopEventListener=function(){fields.sahObj.stopEventListener()};this.getViewObj=function(){return fields.viewObj};this.switchState=function(aCallback,aNewState,aContext){fields.stateManager.switchState(aCallback,aNewState,aContext)};this.init=function(aCallback){console.debug("StateCtrlClass: Initialising state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().subscribeEvents(this.getId(),aNext);this.getViewObj().init(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.quit=function(aCallback){console.debug("StateCtrlClass: Releasing state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().quit(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.enable=function(aCallback){console.debug("StateCtrlClass: Enabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().enable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.disable=function(aCallback){console.debug("StateCtrlClass: Disabling state '"+this.getId()+"'");basicUtilities.queue([function(aNext){this.getViewObj().disable(aNext)},function(aNext,aResult){if(!aResult||aResult.status===0){basicUtilities.callback(aCallback,false,0,null)}else{basicUtilities.callback(aCallback,false,-1,null)}}],this)};this.goToMhs=function(){console.debug("StateCtrlClass: Logginh out and reloading application");fields.sahObj.logOut();if(window.parent.location.href===window.location.href){window.location.href=window.location.href.split("?")[0].split("/").slice(0,-1).join("/")+"/index.html"+window.location.search}else{window.parent.location.href=window.parent.location.href.split("?")[0].split("/").slice(0,-1).join("/")+"/index.html"+window.parent.location.search}};this.logIn=function(login,pwd){fields.sahObj.logIn(login,pwd)};this.logOut=function(){fields.sahObj.logOut()}}return StateCtrlClass});