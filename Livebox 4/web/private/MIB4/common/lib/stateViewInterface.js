define(["utils/console","utils/basics","lib/eventHandler","jquery"],function(console,basicUtilities,EventHandlerClass,$){"use strict";function StateViewClass(aStateId,aTranslateObj){var fields,longestNotificationAnimationTime=0,lastNotificationTimeout,isNotificationBannerDisplayed=false,notify=function(aContent,aAnimationTime,aStayTime){var buffer,id,animationTime,stayTime,target_container,target_element,ref_element;if(typeof aTranslateObj==="undefined"){console.warn("StateViewClass: Translate Object was not found")}if(typeof aAnimationTime!=="number"){animationTime=1}else{animationTime=aAnimationTime}if(typeof aStayTime!=="number"){stayTime=5}else{stayTime=aStayTime}if(longestNotificationAnimationTime<aAnimationTime){longestNotificationAnimationTime=aAnimationTime}if(lastNotificationTimeout){window.clearTimeout(lastNotificationTimeout)}function generateId(l){var result,charSet,i;result="";charSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(i=0;i<l;i+=1){result+=charSet.charAt(Math.floor(Math.random()*charSet.length))}return result}function generateAndCheckId(aLength){var attempt;attempt=generateId(aLength);while(window.document.getElementById(attempt)){attempt=generateId(aLength)}return attempt}function rollUp(){isNotificationBannerDisplayed=false;var origin=parseInt(ref_element.position().top,10)+parseInt(ref_element.css("height"),10)-parseInt(target_container.css("height"),10);target_container.animate({top:origin.toString()},longestNotificationAnimationTime*1e3,function(){target_container.css("top","-1000")});longestNotificationAnimationTime=0}function rollDown(){isNotificationBannerDisplayed=true;var origin=parseInt(ref_element.position().top,10)+parseInt(ref_element.css("height"),10)-parseInt(target_container.css("height"),10),offset=parseInt(target_container.css("height"),10);target_container.css("top",origin);target_container.animate({top:"+="+offset.toString()},longestNotificationAnimationTime*1e3)}id=generateAndCheckId(8);buffer="<div class='notification-content' id='"+id+"'>"+aContent+"</div>";ref_element=$(".return-button");target_container=$(".notification-container");target_element=$("#"+id);target_container.prepend(buffer);aTranslateObj.putTranslation("#"+id);rollDown();lastNotificationTimeout=window.setTimeout(function(){rollUp()},stayTime*1e3);window.setTimeout(function(){$("#"+id).remove()},(stayTime+longestNotificationAnimationTime)*1e3)},spinnerAnimate=function(){$({deg:0}).animate({deg:360},{duration:1e3,step:function(now){$(".loading_screen_spinner").css({transform:"rotate("+now+"deg)"})},complete:function(){spinnerAnimate()}})};fields={stateId:aStateId+"View",translateObj:aTranslateObj,loadingScreenTimeout:null};EventHandlerClass.call(this,aStateId,["ViewUpdated","ViewCancelled","ViewSubmitted"]);this.getId=function(){return fields.stateId};this.subscribeEvents=function(aClientId,aCallback){this.subscribeEvent(["ViewUpdated","ViewCancelled","ViewSubmitted"],aClientId,aCallback);return};this.fireEvent=function(aEventId,aData){if(!aData){aData={}}aData.origin={type:"view",stateId:fields.stateId};this.generateEvent(aEventId,aData)};this.setAppCloseButton=function(aCallback,aId){$(document).off("click","#"+aId);$(document).off("keypress","#"+aId);if(typeof window.parent.SAH!=="undefined"){$(document).on("click","#"+aId,function(){$("#"+aId).off("click");this.closeApp(this._launchedAppManifest)}.bind(window.parent.SAH.WM))}else{$(document).on("click","#"+aId,function(){$("#"+aId).off("click");window.history.back()})}$(document).on("keypress","#"+aId,function(event){var keyCode=event.keyCode||event.which;if(keyCode===13){event.preventDefault();$("#"+aId).trigger("click");$("#"+aId).off("keypress")}});basicUtilities.callback(aCallback,false,0,null)};this.setPageTitle=function(aCallback,aValue){var map,result;map={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'"};result=aValue.toString().replace(/(<([^>]+)>)/g,"");result=result.replace(/&amp;|&lt;|&gt;|&quot;|&#039;/g,function(m){return map[m]});window.document.title=result+" - Livebox Orange";window.parent.document.title=result+" - Livebox Orange";basicUtilities.callback(aCallback,false,0,null);if($(document).find(".tab-menu-col").length>0){$(document).find(".tab-menu-col").eq(0).focus()}else{$(document).find("#app_close").prop("tabindex",0).focus()}};this.init=function(aCallback){console.debug("StateViewClass: Initialising state '"+this.getId()+"'");basicUtilities.callback(aCallback,false,0,null)};this.quit=function(aCallback){console.debug("StateViewClass: Releasing state '"+this.getId()+"'");basicUtilities.callback(aCallback,false,0,null)};this.enable=function(aCallback){console.debug("StateViewClass: Enabling state '"+this.getId()+"'");basicUtilities.callback(aCallback,false,0,null)};this.disable=function(aCallback){console.debug("StateViewClass: Disabling state '"+this.getId()+"'");basicUtilities.callback(aCallback,false,0,null)};this.updateTranslationLanguage=function(aCallback,aLanguage){fields.translateObj.loadTranslation(aCallback,aLanguage)};this.translate=function(aTarget){fields.translateObj.putTranslation(aTarget)};this.notifyError=function(aContent,aErrorCode){if(console.getLogLevel()>0){notify.call(this,"[Error "+aErrorCode+"] "+aContent,1,60)}};this.notifyUser=function(aContent,aAnimationTime,aStayTime){notify.call(this,aContent,aAnimationTime,aStayTime)};this.getMobileOperatingSystem=function(){var userAgent=window.navigator.userAgent||window.navigator.vendor||window.opera;if(userAgent.match(/iPad/i)||userAgent.match(/iPhone/i)||userAgent.match(/iPod/i)){return"iOS"}if(userAgent.match(/Android/i)){return"Android"}return"unknown"};this.showLoadingScreen=function(aCallback){spinnerAnimate();$(".loading_screen").show();fields.loadingScreenTimeout=window.setTimeout(function(){this.hideLoadingScreen(null)}.bind(this),3e4);basicUtilities.callback(aCallback,false,0,null)};this.hideLoadingScreen=function(aCallback){window.clearTimeout(fields.loadingScreenTimeout);$(".loading_screen").hide();$(".loading_screen_spinner").stop();basicUtilities.callback(aCallback,false,0,null)};this.escapeString=function(type,str,unescape){var str_buffer,html_array,uri_array,array_used,array_used_temp,val;function addslashes(str){return(str+"").replace(/[\\"']/g,"\\$&").replace(/\u0000/g,"\\0").replace(/\u000A/g,"\\n").replace(/\u000B/g,"\\t").replace(/\u000C/g,"\\f").replace(/\u000D/g,"\\r")}function stripslashes(str){return(str+"").replace(/\\(.?)/g,function(s,n1){switch(n1){case"\\":return"\\";case"0":return"\x00";case"n":return"\n";case"t":return"";case"f":return"\f";case"r":return"\r";case"":return"";default:return n1}})}function array_flip(trans){var key,tmp_ar={};for(key in trans){if(trans.hasOwnProperty(key)){tmp_ar[trans[key]]=stripslashes(key)}}return tmp_ar}str_buffer=str;if(type==="js"){if(unescape===1){str_buffer=stripslashes(str_buffer)}else{str_buffer=addslashes(str_buffer)}}else{html_array={"&":"&amp",'"':"&quot","<":"&lt",">":"&gt"};uri_array={"%":"%25"," ":"%20","!":"%21","@":"%40","#":"%23","\\$":"%24","\\^":"%5E","&":"%26","\\*":"%2A","\\(":"%28","\\)":"%29","-":"%2D",_:"%5F","=":"%3D","\\+":"%2B",":":"%3A",";":"%3B","\\.":"%2E",'"':"%22","'":"%27","\\\\":"%5C","/":"%2F","\\?":"%3F","<":"%3C",">":"%3E","~":"%7E","\\[":"%5B","\\]":"%5D","\\{":"%7B","\\}":"%7D","`":"%60"};array_used={};array_used_temp={};if(type==="html"){array_used_temp=html_array}else if(type==="uri"){array_used_temp=uri_array}if(unescape===1){array_used=array_flip(array_used_temp)}else{array_used=array_used_temp}for(val in array_used){if(array_used.hasOwnProperty(val)){str_buffer=str_buffer.replace(new RegExp(val,"g"),array_used[val])}}}return str_buffer}}return StateViewClass});