define(["utils/console","utils/basics"],function(console,basicUtilities){"use strict";function StateManagerClass(aApplicationId,aSahObj,aTranslateObj){var fields,doReleaseAllStates=function(aCallback,aStateTab){var state;if(aStateTab.length>0){state=aStateTab.pop();this.releaseState(doReleaseAllStates.bind(this,aCallback,aStateTab),aStateTab)}else{basicUtilities.callback(aCallback,false,0,null)}};fields={applicationId:aApplicationId,sahObj:aSahObj,translateObj:aTranslateObj,curState:"",stateList:{}};this.getCurrentState=function(){return{status:0,data:{stateId:fields.curState}}};this.registerState=function(aCallback,aStateId,StateCtrlClass,StateViewClass,aForceInitialisation){var viewObj,controllerObj;if(!fields.stateList.hasOwnProperty(aStateId)){console.info("StateManagerClass: Registering state '"+aStateId+"'");viewObj=new StateViewClass(aStateId,fields.translateObj);controllerObj=new StateCtrlClass(aStateId,this,fields.sahObj,viewObj);fields.stateList[aStateId]={controllerObj:controllerObj,viewObj:viewObj,isInitialised:false};if(aForceInitialisation){console.info("StateManagerClass: Initialising state '"+aStateId+"'");fields.stateList[aStateId].isInitialised=true;controllerObj.init(aCallback)}else{basicUtilities.callback(aCallback,false,0,null)}}else{console.warn("StateManagerClass: State '"+aStateId+"' has already been registered");basicUtilities.callback(aCallback,false,-1,null)}};this.switchState=function(aCallback,aNewState,aContext){if(fields.stateList.hasOwnProperty(aNewState)){console.info("StateManagerClass: Switching from state '"+fields.curState+"' fo state '"+aNewState+"'");basicUtilities.queue([function(aNext){if(!fields.stateList[aNewState].isInitialised){console.debug("StateManagerClass: Initialising state '"+aNewState+"'");fields.stateList[aNewState].isInitialised=true;fields.stateList[aNewState].controllerObj.init(aNext)}else{aNext()}},function(aNext,aResult){if(aResult&&aResult.status!==0){console.warn("StateManagerClass: Failed to initialise state '"+aNewState+"' from state '"+fields.curState+"'")}if(fields.curState){console.debug("StateManagerClass: Disabling current state '"+fields.curState+"'");fields.stateList[fields.curState].controllerObj.disable(aNext)}else{aNext()}},function(aNext,aResult){if(aResult&&aResult.status!==0){console.warn("StateManagerClass: Failed to disable state '"+fields.curState+"'")}console.debug("StateManagerClass: Enabling state '"+aNewState+"'");fields.curState=aNewState;fields.stateList[aNewState].controllerObj.enable(aCallback,aContext)}],this)}else{console.warn("StateManagerClass: Invalid request to switch to unregistered state '"+aNewState+"' from state '"+fields.curState+"'");basicUtilities.callback(aCallback,false,-1,null)}};this.releaseState=function(aCallback,aStateId){if(fields.stateList.hasOwnProperty(aStateId)){if(fields.stateList[aStateId].isInitialised){basicUtilities.queue([function(aNext){console.info("StateManagerClass: Disabling state '"+aStateId+"'");fields.stateList[aStateId].controllerObj.disable(aNext)},function(aNext,aResult){if(aResult&&aResult.status!==0){console.warn("StateManagerClass: Failed to disable state '"+aStateId+"'")}console.info("StateManagerClass: Releasing state '"+aStateId+"'");fields.stateList[aStateId].isInitialised=false;fields.stateList[aStateId].controllerObj.quit(aCallback)}],this)}else{console.info("StateManagerClass: Releasing state '"+aStateId+"'");basicUtilities.callback(aCallback,false,0,null)}}else{console.warn("StateManagerClass: Invalid request to release an unregistered state '"+aStateId+"' from state '"+fields.curState+"'");basicUtilities.callback(aCallback,false,-1,null)}};this.releaseAllStates=function(aCallback){var stateTab,state;stateTab=[];for(state in fields.stateList){if(fields.stateList.hasOwnProperty(state)){stateTab.push(state)}}doReleaseAllStates.call(this,aCallback,stateTab)};this.requestAppClose=function(aCallback){console.debug("StateCtrlClass: Close app requested");if(typeof window.parent.SAH!=="undefined"){console.debug("StateCtrlClass: Closing app");window.parent.SAH.WM.closeApp(window.parent.SAH.WM._launchedAppManifest)}basicUtilities.callback(aCallback,false,0,null)}}return StateManagerClass});