define(["utils/console","text","handlebars","jquery","text!templates_app/layoutTemplate.html","text!templates_app/headerTemplate.html","text!templates_app/tabTemplate.html","text!templates_app/infoTemplate.html","text!templates_app/contentTemplate.html","text!templates_app/submenuTemplate.html","text!templates_app/titleTemplate.html","text!templates_app/subtitleTemplate.html","text!templates_app/textTemplate.html","text!templates_app/textfieldTemplate.html","text!templates_app/inlinetextfieldTemplate.html","text!templates_app/searchfieldTemplate.html","text!templates_app/tableTemplate.html","text!templates_app/dynamicTableTemplate.html","text!templates_app/radioTemplate.html","text!templates_app/checkboxTemplate.html","text!templates_app/buttonTemplate.html","text!templates_app/selectTemplate.html","text!templates_app/formTemplate.html","text!templates_app/tickTemplate.html","text!templates_app/separatorTemplate.html","text!templates_app/bulletTemplate.html","text!templates_app/scheduleTemplate.html","text!templates_app/popupTemplate.html","text!templates_app/spinnerTemplate.html","text!templates_app/fileTemplate.html","text!templates_app/template.css"],function(console,Text,Handlebars,$,aLayout,aHeader,aTab,aInfo,aContent,aSubmenu,aTitle,aSubtitle,aText,aTextfield,aInlineTextfield,aSearchField,aTable,aDynamicTable,aRadio,aCheckbox,aButton,aSelect,aForm,aTick,aSeparator,aBullet,aSchedule,aPopup,aSpinner,aFile,aStyle){"use strict";var result={},spinnerAnimate,positionPopup,showPopup,hidePopup,allPartials,enablePopOver,enableSchedule,enableScheduleClickMode,isPointInSelection,isCaseSame,enableScheduleDragMode,toggleScheduleCase,setValuesOnScheduler,getPositionFromScheduleData,getScheduleDataFromPosition,boundDataTable,enableHover,progressBarCreate,progressBarStop,progressBarStartTimer,progressBarStartCountDownTimer,progressBarSetValue,progressBarHandler,aProgressBarTimer,focusPopup,prevFocus,adjustIndexFocus;Handlebars.registerHelper("ifEqual",function(v1,v2,options){return v1===v2?options.fn(this):options.inverse(this)});Handlebars.registerHelper("ifLower",function(v1,v2,options){return v1<v2?options.fn(this):options.inverse(this)});Handlebars.registerHelper("ifGreater",function(v1,v2,options){return v1>v2?options.fn(this):options.inverse(this)});function stripLines(string){return string.replace(/(\r\n|\n|\r|\t)/gm,"")}spinnerAnimate=function(){$({deg:0}).animate({deg:360},{duration:1e3,step:function(now){$(".spinner").css({transform:"rotate("+now+"deg)"})},complete:function(){spinnerAnimate()}})};progressBarCreate=function(aTargetId,aId,aStyle,aMetrics){var style,c,index,position,cumulated_offset,offset,scale;style=["progress_bar","outer_progress_bar","inner_progress_bar"];if(aStyle==="thin"){style=["progress_bar_thin","outer_progress_bar outer_progress_bar_thin","inner_progress_bar inner_progress_bar_thin"]}if($("#"+aTargetId)){c='<div class="'+style[0]+'" id="'+aId+'" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"><div class="'+style[1]+'"><div class="'+style[2]+'"></div></div></div>';$("#"+aTargetId).append(c);if(aMetrics){scale=$("#"+aId).css("font-size").substr(0,$("#"+aId).css("font-size").indexOf("px"));cumulated_offset=0;for(index=0;index<aMetrics.length;index=index+1){console.log("test : "+cumulated_offset);$("#"+aId).append('<div class="progress_bar_metrics" id="'+aId+"_metrics_"+index+'" style="left:0em; top:0.5em;">'+aMetrics[index]+"</div>");if(index===0){cumulated_offset+=$("#"+aId+"_metrics_"+index).width()/scale}else if(index===aMetrics.length-1){offset=$("#"+aId+"_metrics_"+index).width()/scale;position=$("#"+aId).width()/scale-cumulated_offset;console.log("TEST: "+position+", "+offset);$("#"+aId+"_metrics_"+index).css("left",(position-offset).toString()+"em")}else{position=index*$("#"+aId).width()/scale/(aMetrics.length-1)-cumulated_offset;offset=.5*$("#"+aId+"_metrics_"+index).width()/scale;$("#"+aId+"_metrics_"+index).css("left",(position-offset).toString()+"em");cumulated_offset+=$("#"+aId+"_metrics_"+index).width()/scale}}}}else{return 0}};progressBarStop=function(aId,aReset){if($("#"+aId)){if(aProgressBarTimer){window.clearTimeout(aProgressBarTimer)}$("#"+aId).find(".inner_progress_bar").stop(true,false);if(aReset){$("#"+aId).find(".inner_progress_bar").css({left:0})}}else{return 0}};progressBarStartTimer=function(aId,aTimeout,aCallback){if($("#"+aId)){var total=$("#"+aId).find(".outer_progress_bar").width();if(aProgressBarTimer){window.clearTimeout(aProgressBarTimer)}aProgressBarTimer=window.setTimeout(progressBarHandler,1e3,aId);if(aCallback){$("#"+aId).find(".inner_progress_bar").animate({left:total},aTimeout*1e3,aCallback)}else{$("#"+aId).find(".inner_progress_bar").animate({left:total},aTimeout*1e3)}}else{return 0}};progressBarStartCountDownTimer=function(aId,aTimeout,aCallback){if($("#"+aId)){if(aProgressBarTimer){window.clearTimeout(aProgressBarTimer)}aProgressBarTimer=window.setTimeout(progressBarHandler,1e3,aId);if(aCallback){$("#"+aId).find(".inner_progress_bar").animate({left:0},aTimeout*1e3,aCallback)}else{$("#"+aId).find(".inner_progress_bar").animate({left:0},aTimeout*1e3)}}else{return 0}};progressBarSetValue=function(aId,aValue){var total,value;if($("#"+aId)){total=$("#"+aId).find(".outer_progress_bar").width();value=(aValue/100*total).toString()+"px";$("#"+aId).find(".inner_progress_bar").css("left",value)}else{return 0}};progressBarHandler=function(aId){var undef,left,width;left=$("#"+aId+" .inner_progress_bar").css("left");width=$("#"+aId+" .outer_progress_bar").css("width");if(left!==undef&&width!==undef){if(parseInt(left,10)>parseInt(width,10)){left=width}$("#"+aId).attr("aria-valuenow",parseInt(parseInt(left,10)/parseInt(width,10)*100,10))}if(aProgressBarTimer){window.clearTimeout(aProgressBarTimer)}if(left!==width){aProgressBarTimer=window.setTimeout(progressBarHandler,2e3,aId)}};positionPopup=function(aPopup){var availableXScreen,availableYScreen,popup_newleft,popup_newtop;availableXScreen=Math.max(window.innerWidth||0);availableYScreen=Math.max(window.innerHeight||0);popup_newleft=availableXScreen/2-(aPopup.width()+parseInt(aPopup.css("padding-left"),10)+parseInt(aPopup.css("padding-right"),10))/2+"px";popup_newtop=availableYScreen/2-(aPopup.height()+parseInt(aPopup.css("padding-top"),10)+parseInt(aPopup.css("padding-bottom"),10))/2+"px";aPopup.css({position:"fixed",left:popup_newleft,top:popup_newtop})};enablePopOver=function(){var availableXScreen,selector;availableXScreen=Math.max(window.document.documentElement.clientWidth,window.innerWidth||0);selector=$(".help-img-size");selector.off("click");if(availableXScreen<1024){selector.css("cursor","pointer");selector.on("click",function(event){console.log("tell me tell me: "+$(event.target).parent(".help-img").siblings(".help-pop-over").css("display"));console.log("tell me tell me: %o",$(event.target).parent(".help-img"));selector.each(function(){if($(event.target).parent(".help-img").siblings(".help-pop-over").is($(this).parent(".help-img").siblings(".help-pop-over"))&&$(event.target).parent(".help-img").siblings(".help-pop-over").css("display")==="none"){$(this).parent(".help-img").siblings(".help-pop-over").show();$(this).parent(".help-img").siblings(".help-pop-over").css({left:event.pageX-$(this).parent(".help-img").siblings(".help-pop-over").width()+"px",top:event.pageY+"px"})}else{$(this).parent(".help-img").siblings(".help-pop-over").hide()}})})}else{selector.off("click");selector.css("cursor","default")}};showPopup=function(aPopup){positionPopup(aPopup);$(window).resize(function(){positionPopup(aPopup)}.bind(this,aPopup));$(".popup_screen").show();aPopup.show();prevFocus=$(":focus");focusPopup(aPopup)};hidePopup=function(aPopup){$(".popup_screen").hide();aPopup.hide();$(document).off("keydown");var undef;if($(prevFocus)!==undef&&$(prevFocus).length>0){$(prevFocus).focus()}else{$("#app_close").focus()}};focusPopup=function(aPopup){var listFocusedElement=$(aPopup.selector+" input,"+aPopup.selector+" select,"+aPopup.selector+" a,"+aPopup.selector+" area,"+aPopup.selector+" button,"+aPopup.selector+" textarea"),indexFocus=0;if(listFocusedElement.length>0){listFocusedElement[indexFocus].focus();$(document).keydown(function(event){if($(aPopup).is(":visible")){var keyCode=event.keyCode||event.which;if(keyCode===9){event.preventDefault();if(event.shiftKey){indexFocus-=1;indexFocus=adjustIndexFocus(indexFocus,listFocusedElement);while($(listFocusedElement[indexFocus]).is(":disabled")||$(listFocusedElement[indexFocus]).is(":hidden")){indexFocus-=1;indexFocus=adjustIndexFocus(indexFocus,listFocusedElement)}}else{indexFocus+=1;indexFocus=adjustIndexFocus(indexFocus,listFocusedElement);while($(listFocusedElement[indexFocus]).is(":disabled")||$(listFocusedElement[indexFocus]).is(":hidden")){indexFocus+=1;indexFocus=adjustIndexFocus(indexFocus,listFocusedElement)}}listFocusedElement[indexFocus].focus()}}})}adjustIndexFocus=function(index,listElement){if(index>=listElement.length){index=0}else if(index<0){index=listElement.length-1}return index};$(aPopup.selector).off().on("click",function(event){event.preventDefault();var index=0;while(event.target!==listFocusedElement[index]&&index<listFocusedElement.length){index+=1}if(index!==listFocusedElement.length){indexFocus=index}})};enableSchedule=function(aScheduleId,aCallback){enableScheduleClickMode(aScheduleId,aCallback);enableScheduleDragMode(aScheduleId,aCallback)};enableScheduleClickMode=function(aScheduleId,aCallback){$("#"+aScheduleId).find("div.scheduler-case").on("click",function(){toggleScheduleCase($(this),"normal",0,aCallback)});$("#"+aScheduleId).find("div.scheduler-case").on("keypress",function(event){var keyCode=event.keyCode||event.which;if(keyCode===13){$(this).trigger("click")}})};isPointInSelection=function(startCoordinates,endCoordinates,pointCoordinates){var testAgainstTop=false,testAgainstRight=false,testAgainstBottom=false,testAgainstLeft=false;if(pointCoordinates.y>=Math.min(startCoordinates.y,endCoordinates.y)){testAgainstTop=true}if(pointCoordinates.y<=Math.max(startCoordinates.y,endCoordinates.y)){testAgainstBottom=true}if(pointCoordinates.x<=Math.max(startCoordinates.x,endCoordinates.x)){testAgainstRight=true}if(pointCoordinates.x>=Math.min(startCoordinates.x,endCoordinates.x)){testAgainstLeft=true}return testAgainstTop&&testAgainstRight&&testAgainstBottom&&testAgainstLeft};isCaseSame=function(point1Coordinates,point2Coordinates){if(point1Coordinates.x===point2Coordinates.x&&point1Coordinates.y===point2Coordinates.y){return true}return false};enableScheduleDragMode=function(aScheduleId,aCallback){var origin={},current={},points=[],point,originvalue,lastknownvalues=[];points=$("#"+aScheduleId).find(".scheduler-case");points.on("mousedown",function(event){event.preventDefault();origin=getPositionFromScheduleData($(this).attr("data-schedule"));current.x=origin.x;current.y=origin.y;originvalue=$(this).hasClass("scheduler-case-filled")?0:1;$.each(points,function(index,value){lastknownvalues[index]=$(value).hasClass("scheduler-case-filled")?1:0});points.on("mouseover",function(){current=getPositionFromScheduleData($(this).attr("data-schedule"));if(!isCaseSame(current,origin)){points.each(function(index){if(typeof $(points[index]).attr("data-schedule")==="string"){point=getPositionFromScheduleData($(points[index]).attr("data-schedule"));if(isPointInSelection(origin,current,point)){toggleScheduleCase($(points[index]),"mark",originvalue)}else{toggleScheduleCase($(points[index]),"force",lastknownvalues[index])}}})}else{setValuesOnScheduler(aScheduleId,lastknownvalues)}});$(window.document).on("mouseup",function(){points.each(function(index){toggleScheduleCase($(points[index]),"confirm",0,null)});points.off("mouseover");$(window.document).off("mouseup");aCallback()})})};toggleScheduleCase=function(aCase,aMode,originvalue,aCallback){var positiveLegend=aCase.closest(".scheduler-container").find(".scheduler-legend-row").children(".scheduler-bottom-legend").eq(0).children(".scheduler-bottom-legend-txt-container").children("span").eq(0).attr("data-translation"),negativeLegend=aCase.closest(".scheduler-container").find(".scheduler-legend-row").children(".scheduler-bottom-legend").eq(1).children(".scheduler-bottom-legend-txt-container").children("span").eq(0).attr("data-translation");if(typeof aMode==="undefined"){aMode="normal"}if(aMode==="mark"){if(originvalue){aCase.removeClass("scheduler-case-marked-empty");aCase.addClass("scheduler-case-marked-filled")}else{aCase.addClass("scheduler-case-marked-empty");aCase.removeClass("scheduler-case-marked-filled")}}else if(aMode==="force"){if(originvalue){aCase.removeClass("scheduler-case-filled");aCase.removeClass("scheduler-case-marked-empty");aCase.removeClass("scheduler-case-marked-filled");aCase.addClass("scheduler-case-filled");aCase.find("span").eq(2).attr("data-translation",positiveLegend);if(aCallback){aCallback()}}else{aCase.removeClass("scheduler-case-filled");aCase.removeClass("scheduler-case-marked-empty");aCase.removeClass("scheduler-case-marked-filled");aCase.find("span").eq(2).attr("data-translation",negativeLegend);if(aCallback){aCallback()}}}else if(aMode==="confirm"){if(aCase.hasClass("scheduler-case-marked-empty")){aCase.removeClass("scheduler-case-filled");aCase.removeClass("scheduler-case-marked-empty");aCase.find("span").eq(2).attr("data-translation",negativeLegend);if(aCallback){aCallback()}}else if(aCase.hasClass("scheduler-case-marked-filled")){aCase.removeClass("scheduler-case-filled");aCase.removeClass("scheduler-case-marked-empty");aCase.removeClass("scheduler-case-marked-filled");aCase.addClass("scheduler-case-filled");aCase.find("span").eq(2).attr("data-translation",positiveLegend);if(aCallback){aCallback()}}}else if(aMode==="normal"){if(aCase.hasClass("scheduler-case-filled")){aCase.removeClass("scheduler-case-filled");aCase.find("span").eq(2).attr("data-translation",negativeLegend);if(aCallback){aCallback()}}else{aCase.addClass("scheduler-case-filled");aCase.find("span").eq(2).attr("data-translation",positiveLegend);if(aCallback){aCallback()}}}};setValuesOnScheduler=function(aSchedulerId,aValues,aCallback){var index,scheduler,criteria,displayState,positiveLegend,negativeLegend;scheduler=$("#"+aSchedulerId).find(".scheduler-case");if(scheduler.length!==168||aValues.length!==168){console.log("scheduler with id '"+aSchedulerId+"' is not a valid scheduler or values given are not in valid format.");return false}displayState=$("#"+aSchedulerId).css("display");for(index=0;index<aValues.length;index=index+1){criteria="day"+Math.floor(index/24)+"_"+((index%24).toString().length===1?"0":"")+(index%24).toString();$("#"+aSchedulerId).find(".scheduler-case[data-schedule='"+criteria+"']").removeClass("scheduler-case-marked-empty");$("#"+aSchedulerId).find(".scheduler-case[data-schedule='"+criteria+"']").removeClass("scheduler-case-marked-filled");if(aValues[index]===1){$("#"+aSchedulerId).find(".scheduler-case[data-schedule='"+criteria+"']").addClass("scheduler-case-filled");positiveLegend=$("#"+aSchedulerId).find(".scheduler-legend-row").children(".scheduler-bottom-legend").eq(0).children(".scheduler-bottom-legend-txt-container").children("span").eq(0).attr("data-translation");$("#"+aSchedulerId).find(".scheduler-case[data-schedule='"+criteria+"']").find("span").eq(2).attr("data-translation",positiveLegend)}else if(aValues[index]===0){$("#"+aSchedulerId).find(".scheduler-case[data-schedule='"+criteria+"']").removeClass("scheduler-case-filled");negativeLegend=$("#"+aSchedulerId).find(".scheduler-legend-row").children(".scheduler-bottom-legend").eq(1).children(".scheduler-bottom-legend-txt-container").children("span").eq(0).attr("data-translation");$("#"+aSchedulerId).find(".scheduler-case[data-schedule='"+criteria+"']").find("span").eq(2).attr("data-translation",negativeLegend)}}if(aCallback){aCallback()}$("#"+aSchedulerId).css("display",displayState);return true};getPositionFromScheduleData=function(aScheduleData){var result={x:-1,y:-1},splittedData;splittedData=aScheduleData.split("_");result.x=splittedData[0].substr(3);result.y=parseInt(splittedData[1],10);return result};getScheduleDataFromPosition=function(aPosition){return"day"+aPosition.x+"_"+(aPosition.y.length===2)?aPosition.y.toString():"0"+aPosition.y.toString()};boundDataTable=function(aId,aData){var template_table,html;template_table=Handlebars.compile(allPartials.dynamicTableTemplate);html=template_table(aData);aId.replaceWith(html)};enableHover=function(){$("img.conf-table-button-add").hover(function(){$(this).attr("src","../../common/img/app_conf/add_000.png")},function(){$(this).attr("src","../../common/img/app_conf/add_666.png")});$("img.conf-table-button-delete").hover(function(){$(this).attr("src","../../common/img/app_conf/trashbin_000.png")},function(){$(this).attr("src","../../common/img/app_conf/trashbin_666.png")})};function quickRegisterPartial(aPartial){var partialName;for(partialName in aPartial){if(aPartial.hasOwnProperty(partialName)){Handlebars.registerPartial(partialName,stripLines(aPartial[partialName]))}}}allPartials={tabTemplate:aTab,submenuTemplate:aSubmenu,titleTemplate:aTitle,subtitleTemplate:aSubtitle,textTemplate:aText,textfieldTemplate:aTextfield,inlinetextfieldTemplate:aInlineTextfield,searchfieldTemplate:aSearchField,tableTemplate:aTable,dynamicTableTemplate:aDynamicTable,radioTemplate:aRadio,checkboxTemplate:aCheckbox,buttonTemplate:aButton,selectTemplate:aSelect,formTemplate:aForm,tickTemplate:aTick,separatorTemplate:aSeparator,bulletTemplate:aBullet,scheduleTemplate:aSchedule,popupTemplate:aPopup,fileTemplate:aFile,spinnerTemplate:aSpinner,headerTemplate:aHeader,infoTemplate:aInfo,contentTemplate:aContent};quickRegisterPartial(allPartials);result.template=Handlebars.compile(stripLines(aLayout));result.style=aStyle;result.spinnerAnimate=spinnerAnimate;result.positionPopup=positionPopup;result.showPopup=showPopup;result.hidePopup=hidePopup;result.enablePopOver=enablePopOver;result.enableSchedule=enableSchedule;result.enableScheduleClickMode=enableScheduleClickMode;result.isPointInSelection=isPointInSelection;result.isCaseSame=isCaseSame;result.enableScheduleDragMode=enableScheduleDragMode;result.setValuesOnScheduler=setValuesOnScheduler;result.toggleScheduleCase=toggleScheduleCase;result.getPositionFromScheduleData=getPositionFromScheduleData;result.getScheduleDataFromPosition=getScheduleDataFromPosition;result.boundDataTable=boundDataTable;result.enableHover=enableHover;result.progressBarCreate=progressBarCreate;result.progressBarStartCountDownTimer=progressBarStartCountDownTimer;result.progressBarStop=progressBarStop;result.progressBarStartTimer=progressBarStartTimer;result.progressBarSetValue=progressBarSetValue;return result});